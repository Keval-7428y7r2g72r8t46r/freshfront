import React, { useState, useMemo, useEffect, useRef, useCallback } from 'react';
import { LiveVideoEditor } from './LiveVideoEditor';
import { upload } from '@vercel/blob/client';
import { lumaService, LumaModifyRequest } from '../services/lumaService';
import { createPortal } from 'react-dom';
import ReactMarkdown from 'react-markdown';
import { ResearchProject, SavedResearch, SavedWebsiteVersion, NoteNode, Slide, BlogPost, SocialPost, DualTheme, KnowledgeBaseFile, UploadedFile, BookAsset, BookPage, TableAsset, UserProfile, AssetItem, LeadFormField, LeadFormAsset, CapturedLead, StripeProduct, EmailTemplate, ResearchReport } from '../types';
import { storageService } from '../services/storageService';
import { createVideoFromText, createVideoFromImage, pollVideoUntilComplete, downloadVideoBlob, GeneratedImage, SoraModel } from '../services/soraService';
import { generateStructuredBlogPost, streamWebsiteCode, refineWebsiteCode, generateImageWithReferences, editImageWithReferences, ImageReference, generateVideoTitleFromContext, generatePodcastScript, generatePodcastAudio, generateBookFromProjectContext, GeneratedBook, generateVeoVideo, generateTableFromProjectContext, generateChartFromTable, generateTableTitle, detectWizaTableIntent, refinePromptWithGemini3, editImageWithGeminiNano, editImageWithMultipleReferences, generateImageWithIngredients, streamLeadFormWebsite, streamEcommerceWebsite, EcommerceProduct, WebsiteMedia, editWebsiteWithAI, deleteUploadedFile, listUploadedFiles } from '../services/geminiService';
import { createVoiceoverVideoWithCreatomate, createOverviewVideoWithCreatomate, createVideoOverview, listVideoOverviewJobs, resumeVideoOverviewPolling, VideoOverviewJobStatus, createSlideshowVideoWithCreatomate } from '../services/creatomateService';
import { createPatch } from 'diff';
import { html as diff2html, parse as parseDiff } from 'diff2html';
import 'diff2html/bundles/css/diff2html.min.css';
import { PDFDocument } from 'pdf-lib';
import { SpreadsheetTable } from './SpreadsheetTable';
import { generateEmailHtml } from './EmailBuilder';
import { authFetch } from '../services/authFetch';
import { contextService } from '../services/contextService';
import { deductCredits, hasEnoughCredits, getUserCredits, CREDIT_COSTS, CreditOperation } from '../services/creditService';
import { InsufficientCreditsModal } from './InsufficientCreditsModal';
import { UsageLimitModal } from './UsageLimitModal';
import { checkUsageLimit, incrementUsage, UsageType } from '../services/usageService';
import Papa from 'papaparse';
import * as XLSX from 'xlsx';
import mammoth from 'mammoth';

interface ProjectAssetsProps {
  project: ResearchProject;
  isDarkMode: boolean;
  onLoadResearch: (research: SavedResearch, version?: SavedWebsiteVersion) => void;
  localProjectPodcasts?: KnowledgeBaseFile[];
  onPlayPodcast?: (podcast: { id: string; title: string; url?: string; researchTopic: string }) => void;
  onProjectUpdate?: (project: ResearchProject) => void;
  assetCount?: number;
  initialFilter?: 'all' | 'images' | 'videos' | 'blogs' | 'websites' | 'podcasts' | 'books' | 'tables' | 'docs' | 'forms' | 'products';
  onFilterChange?: (filter: string) => void;
  onShareToX?: (asset: AssetItem) => void;
  initialTable?: TableAsset;
  userProfile?: UserProfile | null;
  isSubscribed?: boolean;
  onAssetCountChange?: (count: number) => void;
  // Edit Request from other tabs (e.g. Data Tab)
  editRequest?: AssetItem | null;
  onEditRequestCleared?: () => void;
}


interface DataReferenceSelection {
  file: UploadedFile;
  reference: ImageReference;
}

type ImageReferenceCandidate =
  | {
    key: string;
    label: string;
    url: string;
    score: number;
    file: UploadedFile;
  }
  | {
    key: string;
    label: string;
    url: string;
    score: number;
  };

interface GeminiGeneratedImage {
  url: string;
  prompt: string;
  parts?: any[]; // Optional thinking parts from Gemini 3 Pro
}


const MAX_DATA_REFERENCES = 14;
const IMAGE_FILE_REGEX = /\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i;

const getFileKey = (file: UploadedFile) => file.uri || file.name || `${file.displayName || 'file'}-${file.uploadedAt || Date.now()}`;

const getFileLabel = (file: UploadedFile) => file.displayName || file.name || 'Untitled image';

const isImageLikeFile = (file: UploadedFile) => {
  const mime = (file.mimeType || '').toLowerCase();
  if (mime.startsWith('image/')) return true;
  const name = (file.displayName || file.name || '').toLowerCase();
  return IMAGE_FILE_REGEX.test(name);
};

const truncateText = (value: string, max = 140) => {
  if (!value) return '';
  return value.length > max ? `${value.slice(0, max).trim()}` : value;
};

const buildSearchTokens = (value: string) =>
  (value || '')
    .toLowerCase()
    .split(/[^a-z0-9]+/)
    .filter(token => token.length > 2);

const scoreByQueryTokens = (text: string, tokens: string[]) => {
  if (!tokens.length) return 0;
  const haystack = text.toLowerCase();
  let score = 0;
  tokens.forEach(token => {
    if (!token) return;
    if (haystack.includes(token)) {
      score += token.length >= 6 ? 2 : 1;
    }
  });
  return score;
};

// Color palette for session/project containers in the All tab grid view
const SESSION_COLORS = [
  { border: 'border-l-[#5e5ce6]', bg: 'bg-[#5e5ce6]/5', bgDark: 'bg-[#5e5ce6]/10' },   // Purple
  { border: 'border-l-[#0a84ff]', bg: 'bg-[#0a84ff]/5', bgDark: 'bg-[#0a84ff]/10' },   // Blue
  { border: 'border-l-[#30d158]', bg: 'bg-[#30d158]/5', bgDark: 'bg-[#30d158]/10' },   // Green
  { border: 'border-l-[#ff9f0a]', bg: 'bg-[#ff9f0a]/5', bgDark: 'bg-[#ff9f0a]/10' },   // Orange
  { border: 'border-l-[#bf5af2]', bg: 'bg-[#bf5af2]/5', bgDark: 'bg-[#bf5af2]/10' },   // Violet
  { border: 'border-l-[#ff375f]', bg: 'bg-[#ff375f]/5', bgDark: 'bg-[#ff375f]/10' },   // Red
  { border: 'border-l-[#34c759]', bg: 'bg-[#34c759]/5', bgDark: 'bg-[#34c759]/10' },   // Mint
  { border: 'border-l-[#06b6d4]', bg: 'bg-[#06b6d4]/5', bgDark: 'bg-[#06b6d4]/10' },   // Cyan
];

const PLATFORM_LOGOS: Record<string, string> = {
  facebook: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/2021_Facebook_icon.svg.webp',
  instagram: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/Instagram_logo_2016.svg.webp',
  tiktok: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/tiktok-6338432_1280.webp',
  youtube: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/YouTube_full-color_icon_%282017%29.svg.png',
  linkedin: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/LinkedIn_logo_initials.png',
  x: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/X-Logo-Round-Color.png',
  googledocs: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/Docs_2020.webp',
  googlesheets: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/Google_Sheets_logo_%282014-2020%29.svg.png',
  googledrive: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/Google_Drive_icon_%282020%29.svg.png',
  blog: 'https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/blog-8419.svg.png',
};

const STRIPE_COUNTRIES = [
  { code: 'US', name: 'United States' },
  { code: 'CA', name: 'Canada' },
  { code: 'GB', name: 'United Kingdom' },
  { code: 'AU', name: 'Australia' },
  { code: 'DE', name: 'Germany' },
  { code: 'FR', name: 'France' },
  { code: 'JP', name: 'Japan' },
  { code: 'NZ', name: 'New Zealand' },
  { code: 'IE', name: 'Ireland' },
  { code: 'ES', name: 'Spain' },
  { code: 'IT', name: 'Italy' },
  { code: 'NL', name: 'Netherlands' },
  { code: 'SE', name: 'Sweden' },
  { code: 'CH', name: 'Switzerland' },
  { code: 'SG', name: 'Singapore' },
  { code: 'MY', name: 'Malaysia' },
  { code: 'HK', name: 'Hong Kong' },
  { code: 'BR', name: 'Brazil' },
  { code: 'MX', name: 'Mexico' },
  { code: 'IN', name: 'India' },
].sort((a, b) => a.name.localeCompare(b.name));

const getSessionColor = (index: number) => SESSION_COLORS[index % SESSION_COLORS.length];

// Helper to clean markdown fences from streaming HTML code
const cleanStreamingCode = (code: string): string => {
  return code
    .replace(/^```(?:html)?\s*\n?/i, '')
    .replace(/\n?```\s*$/i, '')
    .trim();
};

export const ProjectAssets: React.FC<ProjectAssetsProps> = ({
  project,
  isDarkMode,
  onLoadResearch,
  localProjectPodcasts = [],
  onPlayPodcast,
  onProjectUpdate,
  assetCount,
  initialFilter = 'all',
  onShareToX,
  onFilterChange,
  initialTable,
  userProfile,
  isSubscribed,
  onAssetCountChange,
  editRequest,
  onEditRequestCleared,
}) => {
  const [selectedWebsite, setSelectedWebsite] = useState<SavedWebsiteVersion | null>(null);
  const [selectedImage, setSelectedImage] = useState<AssetItem | null>(null);
  const [selectedVideo, setSelectedVideo] = useState<AssetItem | null>(null);
  const [activePodcast, setActivePodcast] = useState<AssetItem | null>(null);
  const [filterType, setFilterType] = useState<'all' | 'images' | 'videos' | 'blogs' | 'websites' | 'podcasts' | 'books' | 'tables' | 'docs' | 'forms' | 'products'>(initialFilter);
  const [stripeProducts, setStripeProducts] = useState<StripeProduct[]>([]);
  const [stripeConnectStatus, setStripeConnectStatus] = useState<{
    accountId: string;
    chargesEnabled: boolean;
    payoutsEnabled: boolean;
    detailsSubmitted: boolean;
    createdAt: number;
  } | null>(null);
  const [selectedStripeCountry, setSelectedStripeCountry] = useState('US');

  /* Slideshow Mode State */
  const [slideshowAssets, setSlideshowAssets] = useState<Array<{
    assetId: string;
    url: string;
    type: 'image' | 'video';
    duration: 4 | 6 | 8 | 'full';
    order: number;
    title?: string;
  }>>([]);









  const [expandedSessions, setExpandedSessions] = useState<Set<string>>(new Set());
  const [assetSearch, setAssetSearch] = useState('');
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const videoProgressInterval = useRef<NodeJS.Timeout | null>(null);
  const topRef = useRef<HTMLDivElement>(null);

  // Notify parent component of filter changes (for Live Assistant context)
  // Notify parent component of filter changes (for Live Assistant context)
  // Use a ref to avoid re-triggering when the callback function identity changes
  const onFilterChangeRef = useRef(onFilterChange);
  useEffect(() => {
    onFilterChangeRef.current = onFilterChange;
  }, [onFilterChange]);

  useEffect(() => {
    if (onFilterChangeRef.current) {
      onFilterChangeRef.current(filterType);
    }
  }, [filterType]);

  // Sync filterType with initialFilter prop when it changes from parent
  useEffect(() => {
    if (initialFilter) {
      setFilterType(initialFilter);
    }
  }, [initialFilter]);

  // Auto-expand all type groups when viewing the "All" tab
  useEffect(() => {
    if (filterType === 'all') {
      // Expand all type groups by their keys
      setExpandedSessions(new Set(['images', 'videos', 'blogs', 'websites', 'podcasts', 'books', 'tables', 'docs', 'forms', 'products']));
    }
  }, [filterType]);

  // Handle Edit Requests from parent (e.g. Data Tab)
  useEffect(() => {
    if (!editRequest) return;

    const processEditRequest = async () => {
      // 1. Identify Type
      const isImage = ['header', 'slide', 'notemap', 'social'].includes(editRequest.type) || editRequest.type.startsWith('image/');
      const isDoc = editRequest.type === 'doc' || editRequest.type === 'blog' || editRequest.type === 'table';

      if (isImage) {
        console.log('[ProjectAssets] Processing image edit request:', editRequest);
        setFilterType('images');
        await handleEditImage(editRequest);
      } else if (editRequest.type === 'video' || editRequest.type.startsWith('video/')) {
        console.log('[ProjectAssets] Processing video edit request:', editRequest);
        setFilterType('videos');
        setVideoType('edit'); // Switch to Luma Modify mode
        setLumaVideoAssetId(editRequest.id);
        setLumaVideoPreviewUrl(editRequest.url);
        setLumaVideoTitle(editRequest.title);
        setLumaVideoFile(null); // Clear manual file implementation
        setIsLumaVideoPickerOpen(false); // Ensure picker is closed
      } else if (isDoc) {
        // Alias for clarity
        const docAsset = editRequest;

        // Preempltively switch tab based on specific type
        if (editRequest.type === 'table') {
          setFilterType('tables');
        } else if (editRequest.type === 'doc' || editRequest.type === 'blog') {
          setFilterType('docs');
        }

        // Just call handleAssetClick which handles fetching content or setting description
        handleAssetClick(docAsset);
      }

      // Clear request
      if (onEditRequestCleared) {
        onEditRequestCleared();
      }
    };

    processEditRequest();
  }, [editRequest]);

  // Fetch Stripe products if connected
  useEffect(() => {
    if (userProfile?.stripeConnect?.accountId) {
      authFetch(`/api/stripe?op=list-products&accountId=${userProfile.stripeConnect.accountId}`)
        .then(res => res.json())
        .then(data => {
          if (data.products && Array.isArray(data.products)) {
            setStripeProducts(data.products);
          }
        })
        .catch(err => console.error('Failed to fetch Stripe products:', err));
    }
  }, [userProfile?.stripeConnect?.accountId]);

  // --- First Frame Extraction & Editing ---
  const handleExtractFirstFrame = async () => {
    if (!lumaVideoPreviewUrl && !lumaVideoFile) return;
    setIsExtractingFrame(true);
    try {
      let src = lumaVideoPreviewUrl;
      // If we have a file but no URL (shouldn't happen given logic, but safe check)
      if (lumaVideoFile && !src) {
        src = URL.createObjectURL(lumaVideoFile);
      }

      if (!src) throw new Error("No video source found");

      const video = document.createElement('video');
      video.src = src;
      video.crossOrigin = 'anonymous'; // Try anonymous for Vercel Blobs
      video.muted = true;
      video.playsInline = true;

      await new Promise((resolve, reject) => {
        video.onloadeddata = () => resolve(true);
        video.onerror = (e) => reject(e);
        video.load();
      });

      // Seek slightly to ensure frame context
      // Some browsers might not behave well at 0.0, so 0.1 is safer
      video.currentTime = 0.1;
      await new Promise((resolve) => {
        video.onseeked = () => resolve(true);
      });

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.drawImage(video, 0, 0);

        canvas.toBlob((blob) => {
          if (blob) {
            const file = new File([blob], "first_frame.png", { type: "image/png" });
            setLumaFirstFrameFile(file);
            setLumaFirstFramePreviewUrl(URL.createObjectURL(file));
            setLumaFirstFrameAssetId(null);
          }
          // Cleanup local blob url
          if (lumaVideoFile && !lumaVideoPreviewUrl) {
            URL.revokeObjectURL(src!);
          }
          setIsExtractingFrame(false);
        }, 'image/png');
      } else {
        setIsExtractingFrame(false);
      }

    } catch (e: any) {
      console.error("Frame extraction error", e);
      setIsExtractingFrame(false);
      alert("Could not extract frame. Note: Remote videos might have CORS restrictions. Try with a locally uploaded video if this fails.");
    }
  };

  const handleEditFrameWithGemini = async () => {
    if (!lumaFirstFrameFile || !frameEditPrompt) return;
    setIsEditingFrame(true);
    try {
      const reader = new FileReader();
      reader.readAsDataURL(lumaFirstFrameFile);
      reader.onloadend = async () => {
        if (typeof reader.result === 'string') {
          const base64data = reader.result;
          // strip prefix
          const parts = base64data.split(',');
          const base64Content = parts.length > 1 ? parts[1] : parts[0];
          // Safe mime type extraction
          const mimeMatch = base64data.match(/data:([^;]+);/);
          const mimeType = mimeMatch ? mimeMatch[1] : 'image/png';

          const blob = await editImageWithGeminiNano(base64Content, mimeType, frameEditPrompt);
          const file = new File([blob], `edited_frame_${Date.now()}.png`, { type: "image/png" });
          setLumaFirstFrameFile(file);
          setLumaFirstFramePreviewUrl(URL.createObjectURL(file));
          // Clear prompt/mode
          setIsEditingFrame(false);
          setFrameEditPrompt('');
        }
      };
    } catch (e) {
      console.error("Gemini Edit Error", e);
      alert("Failed to edit image with Gemini.");
      setIsEditingFrame(false);
    }
  };

  // Refresh Stripe account status when Products tab is accessed
  useEffect(() => {
    if (filterType === 'products' && userProfile?.stripeConnect?.accountId) {
      // Fetch latest account status from Stripe
      authFetch(`/api/stripe?op=account-status&accountId=${userProfile.stripeConnect.accountId}`)
        .then(res => res.json())
        .then(async (data) => {
          if (data.id) {
            const newStatus = {
              accountId: data.id,
              chargesEnabled: data.chargesEnabled,
              payoutsEnabled: data.payoutsEnabled,
              detailsSubmitted: data.detailsSubmitted,
              createdAt: userProfile.stripeConnect?.createdAt || Date.now(),
            };

            // Update local state immediately for UI refresh
            setStripeConnectStatus(newStatus);

            // Also persist to Firestore if status changed
            if (
              data.chargesEnabled !== userProfile.stripeConnect?.chargesEnabled ||
              data.payoutsEnabled !== userProfile.stripeConnect?.payoutsEnabled ||
              data.detailsSubmitted !== userProfile.stripeConnect?.detailsSubmitted
            ) {
              try {
                await storageService.updateUserProfile({ stripeConnect: newStatus });
              } catch (e) {
                console.error('Failed to update Stripe account status:', e);
              }
            }
          }
        })
        .catch(err => console.error('Failed to refresh Stripe account status:', err));
    }
  }, [filterType, userProfile?.stripeConnect?.accountId]);

  // Initialize local stripeConnectStatus from userProfile
  useEffect(() => {
    if (userProfile?.stripeConnect && !stripeConnectStatus) {
      setStripeConnectStatus(userProfile.stripeConnect);
    }
  }, [userProfile?.stripeConnect]);


  // Prototype-only generation state (not persisted)
  const [imagePrompt, setImagePrompt] = useState('');
  const [mobileMenuAssetId, setMobileMenuAssetId] = useState<string | null>(null);
  const [imageModel, setImageModel] = useState<'fast' | 'pro'>('fast');
  const [imageAspectRatio, setImageAspectRatio] = useState<'auto' | '1:1' | '2:3' | '3:2' | '3:4' | '4:3' | '4:5' | '5:4' | '9:16' | '16:9' | '21:9'>('auto');
  const [hasUserSetAspectRatio, setHasUserSetAspectRatio] = useState(false);
  const [imageResolution, setImageResolution] = useState<'1K' | '2K' | '4K'>('1K');
  const [generatedImage, setGeneratedImage] = useState<GeminiGeneratedImage | null>(null);

  // Utility function to detect aspect ratio from an image file
  const detectImageAspectRatio = async (file: File): Promise<'1:1' | '2:3' | '3:2' | '3:4' | '4:3' | '4:5' | '5:4' | '9:16' | '16:9' | '21:9'> => {
    return new Promise((resolve) => {
      const img = new Image();
      const url = URL.createObjectURL(file);

      img.onload = () => {
        URL.revokeObjectURL(url);
        const ratio = img.width / img.height;

        // Map to closest supported aspect ratio with tolerance of 0.1
        if (Math.abs(ratio - 1) < 0.1) resolve('1:1');
        else if (Math.abs(ratio - 2 / 3) < 0.1) resolve('2:3');
        else if (Math.abs(ratio - 3 / 2) < 0.1) resolve('3:2');
        else if (Math.abs(ratio - 3 / 4) < 0.1) resolve('3:4');
        else if (Math.abs(ratio - 4 / 3) < 0.1) resolve('4:3');
        else if (Math.abs(ratio - 4 / 5) < 0.1) resolve('4:5');
        else if (Math.abs(ratio - 5 / 4) < 0.1) resolve('5:4');
        else if (Math.abs(ratio - 9 / 16) < 0.1) resolve('9:16');
        else if (Math.abs(ratio - 16 / 9) < 0.1) resolve('16:9');
        else if (Math.abs(ratio - 21 / 9) < 0.1) resolve('21:9');
        else resolve('1:1'); // Default fallback
      };

      img.onerror = () => {
        URL.revokeObjectURL(url);
        resolve('1:1'); // Fallback on error
      };

      img.src = url;
    });
  };


  const [isGeneratingImage, setIsGeneratingImage] = useState(false);
  const [imageError, setImageError] = useState<string | null>(null);
  const [imageReferenceFiles, setImageReferenceFiles] = useState<File[]>([]);
  const [imageReferencePreviewUrls, setImageReferencePreviewUrls] = useState<string[]>([]);
  const imageReferencePreviewUrl = imageReferencePreviewUrls[0] || null;
  const [isAnnotatingReference, setIsAnnotatingReference] = useState(false);
  const [referenceAnnotateError, setReferenceAnnotateError] = useState<string | null>(null);
  const [referenceAnnotateBrushColor, setReferenceAnnotateBrushColor] = useState('#ff3b30');
  const [referenceAnnotateBrushSize, setReferenceAnnotateBrushSize] = useState(18);
  const [referenceAnnotateTool, setReferenceAnnotateTool] = useState<'brush' | 'eraser' | 'text'>('brush');
  const [referenceAnnotateText, setReferenceAnnotateText] = useState('');
  const [annotateHistory, setAnnotateHistory] = useState<{ stack: string[]; index: number }>({
    stack: [],
    index: -1,
  });
  const annotateCanvasRef = useRef<HTMLCanvasElement | null>(null);
  const annotateDrawingRef = useRef(false);
  const annotateLastPointRef = useRef<{ x: number; y: number } | null>(null);
  const [autoReferenceHints, setAutoReferenceHints] = useState<string[]>([]);
  const [imageEditPrompt, setImageEditPrompt] = useState('');
  const [isEditingGeneratedImage, setIsEditingGeneratedImage] = useState(false);
  const [nanoBananaEditPrompt, setNanoBananaEditPrompt] = useState('');
  const [isNanoBananaEditing, setIsNanoBananaEditing] = useState(false);
  const [nanoBananaError, setNanoBananaError] = useState<string | null>(null);
  const [dataReferenceQuery, setDataReferenceQuery] = useState('');
  const [dataReferenceSelections, setDataReferenceSelections] = useState<DataReferenceSelection[]>([]);
  const [dataReferenceError, setDataReferenceError] = useState<string | null>(null);
  const [dataReferenceLoading, setDataReferenceLoading] = useState(false);
  const [dataReferenceResults, setDataReferenceResults] = useState<UploadedFile[]>([]);
  const [addingDataReferenceId, setAddingDataReferenceId] = useState<string | null>(null);
  const [showDataReferencePicker, setShowDataReferencePicker] = useState(false);

  const [videoPrompt, setVideoPrompt] = useState('');

  const [videoEngine, setVideoEngine] = useState<'sora' | 'veo'>('veo');
  // Luma State
  const [lumaPrompt, setLumaPrompt] = useState('');
  const [lumaMode, setLumaMode] = useState<LumaModifyRequest['mode']>('adhere_1');
  const [lumaVideoFile, setLumaVideoFile] = useState<File | null>(null);
  const [lumaVideoPreviewUrl, setLumaVideoPreviewUrl] = useState<string | null>(null);
  const [lumaVideoAssetId, setLumaVideoAssetId] = useState<string | null>(null);
  const [lumaVideoTitle, setLumaVideoTitle] = useState<string | null>(null);
  const [lumaFirstFrameFile, setLumaFirstFrameFile] = useState<File | null>(null);
  const [lumaFirstFramePreviewUrl, setLumaFirstFramePreviewUrl] = useState<string | null>(null);
  const [lumaFirstFrameAssetId, setLumaFirstFrameAssetId] = useState<string | null>(null);
  const [isModifyingLuma, setIsModifyingLuma] = useState(false);
  const [lumaError, setLumaError] = useState<string | null>(null);
  const [lumaResult, setLumaResult] = useState<string | null>(null);
  const [videoType, setVideoType] = useState<'clip' | 'overview' | 'slideshow' | 'live' | 'edit'>('clip');
  const [videoSlides, setVideoSlides] = useState<number>(12);
  const [videoModel, setVideoModel] = useState<SoraModel>('veo-3.1');
  const [videoSize, setVideoSize] = useState<'720x1280' | '1280x720' | '1024x1792' | '1792x1024'>('720x1280');
  const [videoSeconds, setVideoSeconds] = useState<'4' | '8' | '12'>('8');
  const [isVideoAssetPickerOpen, setIsVideoAssetPickerOpen] = useState(false);
  const [videoAssetSearch, setVideoAssetSearch] = useState('');
  const [isLoadingVideoAsset, setIsLoadingVideoAsset] = useState(false);
  const [isFormAssetPickerOpen, setIsFormAssetPickerOpen] = useState(false);
  const [formAssetSearch, setFormAssetSearch] = useState('');
  const [isLoadingFormAsset, setIsLoadingFormAsset] = useState(false);
  const [selectedFormAssetIds, setSelectedFormAssetIds] = useState<string[]>([]);
  const [isImageAssetPickerOpen, setIsImageAssetPickerOpen] = useState(false);
  const [imageAssetSearch, setImageAssetSearch] = useState('');
  const [isLoadingImageAsset, setIsLoadingImageAsset] = useState(false);
  const [selectedImageAssetIds, setSelectedImageAssetIds] = useState<string[]>([]);
  const [selectedVeoAssetIds, setSelectedVeoAssetIds] = useState<string[]>([]);

  // Dedicated Veo Asset Picker State

  const [isLoadingVeoAsset, setIsLoadingVeoAsset] = useState(false);

  // Dedicated Luma Video Picker State
  const [isLumaVideoPickerOpen, setIsLumaVideoPickerOpen] = useState(false);
  const [lumaVideoAssetSearch, setLumaVideoAssetSearch] = useState('');
  const [isLoadingLumaVideoAsset, setIsLoadingLumaVideoAsset] = useState(false);

  const [assetPickerTarget, setAssetPickerTarget] = useState<'video' | 'image' | 'blog' | 'website' | 'podcast' | 'sora' | 'veo' | 'live-video-image' | 'luma-source' | 'luma-first-frame'>('video');
  const assetPickerTargetRef = useRef<'video' | 'image' | 'blog' | 'website' | 'podcast' | 'sora' | 'veo' | 'live-video-image' | 'luma-source' | 'luma-first-frame'>('video');

  // Luma Polling
  const [lumaJob, setLumaJob] = useState<{ id: string, status: string } | null>(null);
  const [isExtractingFrame, setIsExtractingFrame] = useState(false);
  const [isEditingFrame, setIsEditingFrame] = useState(false);
  const [frameEditPrompt, setFrameEditPrompt] = useState('');


  // Live Video Image State
  const [liveVideoImageFile, setLiveVideoImageFile] = useState<File | null>(null);
  const [liveVideoImagePreviewUrl, setLiveVideoImagePreviewUrl] = useState<string | null>(null);

  // Keep ref in sync with state
  useEffect(() => {
    assetPickerTargetRef.current = assetPickerTarget;
  }, [assetPickerTarget]);



  // Veo engine only supports 8 seconds
  useEffect(() => {
    if (videoEngine === 'veo' && videoSeconds !== '8') {
      setVideoSeconds('8');
    }
  }, [videoEngine, videoSeconds]);

  // Video Overview only supports 16:9
  useEffect(() => {
    if (videoType === 'overview' && videoSize !== '1280x720') {
      setVideoSize('1280x720');
    }
  }, [videoType, videoSize]);

  const [isGeneratingVideo, setIsGeneratingVideo] = useState(false);
  const [videoProgress, setVideoProgress] = useState<number | null>(null);
  const [videoStatus, setVideoStatus] = useState<string | null>(null);
  const [videoError, setVideoError] = useState<string | null>(null);
  const [videoUrl, setVideoUrl] = useState<string | null>(null);
  const [videoImageFile, setVideoImageFile] = useState<File | null>(null);
  const [videoReferenceFiles, setVideoReferenceFiles] = useState<File[]>([]);
  const [videoImagePreviewUrl, setVideoImagePreviewUrl] = useState<string | null>(null);
  const [videoBlob, setVideoBlob] = useState<Blob | null>(null);
  const [imageSaveMessage, setImageSaveMessage] = useState<string | null>(null);
  const [videoSaveMessage, setVideoSaveMessage] = useState<string | null>(null);

  // Track active video overview job for persistence across page reloads
  const [activeVideoOverviewJob, setActiveVideoOverviewJob] = useState<{ jobId: string; status: string; progress?: string } | null>(null);
  const isResumingVideoJobRef = useRef(false);

  // Track all video overview jobs for this project (for queue display)
  const [allVideoOverviewJobs, setAllVideoOverviewJobs] = useState<Array<{
    jobId: string;
    status: string;
    progress?: string;
    createdAt: number;
  }>>([]);
  const jobRefreshIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);

  // Luma Polling Effect
  useEffect(() => {
    if (!lumaJob) return;
    if (lumaJob.status === 'completed' || lumaJob.status === 'failed') return;

    const interval = setInterval(async () => {
      try {
        const gen = await lumaService.getGeneration(lumaJob.id);
        console.log('[Luma Polling]', gen.state, gen);

        if (gen.state === 'completed') {
          setLumaJob({ id: gen.id, status: 'completed' });
          setLumaResult(gen.id);
          if (gen.assets?.video) {
            setLumaVideoPreviewUrl(gen.assets.video); // Show result temporarily

            try {
              // Upload to Vercel Blob
              const videoRes = await fetch(gen.assets.video);
              const videoBlob = await videoRes.blob();
              const newBlob = await upload(`luma-gen-${Date.now()}.mp4`, videoBlob, {
                access: 'public',
                handleUploadUrl: '/api/media?op=upload-token',
              });

              setLumaVideoPreviewUrl(newBlob.url); // Update to permanent URL

              // Auto-save: new asset
              const newAsset: AssetItem = {
                id: gen.id,
                type: 'video',
                title: `Luma Modify: ${lumaVideoTitle || 'Video'}`,
                url: newBlob.url,
                researchTopic: project.name,
                researchId: project.id,
                timestamp: Date.now(),
                data: { prompt: lumaPrompt, mode: lumaMode }
              };

              // Correctly update assets in the first research session
              if (project.researchSessions && project.researchSessions.length > 0) {
                const updatedSessions = [...project.researchSessions];
                const firstSession = { ...updatedSessions[0] };
                firstSession.assets = [newAsset, ...(firstSession.assets || [])];
                updatedSessions[0] = firstSession;

                const updatedProject = { ...project, researchSessions: updatedSessions };
                onProjectUpdate?.(updatedProject);
                storageService.updateResearchProject(project.id, { researchSessions: updatedSessions });
              }

              setLumaVideoFile(null); // Reset input
              alert('Video modified and saved (Luma -> Vercel)!');
            } catch (err) {
              console.error('Failed to upload Luma video to Vercel:', err);
              alert('Video generated but upload to Vercel failed. See console.');
            }
          }
        } else if (gen.state === 'failed') {
          setLumaJob({ id: gen.id, status: 'failed' });
          setLumaError(gen.failure_reason || 'Generation failed');
          alert(`Generation failed: ${gen.failure_reason}`);
        } else {
          // Still dreaming/queued
          setLumaJob({ id: gen.id, status: gen.state });
        }
      } catch (e) {
        console.error('Luma poll error:', e);
      }
    }, 5000);

    return () => clearInterval(interval);
  }, [lumaJob, project, lumaVideoTitle, lumaPrompt, lumaMode]);

  useEffect(() => {
    if (imageReferenceFiles.length === 0) {
      setImageReferencePreviewUrls([]);
      return;
    }

    const newUrls = imageReferenceFiles.map(file => URL.createObjectURL(file));
    setImageReferencePreviewUrls(newUrls);
    return () => {
      newUrls.forEach(url => URL.revokeObjectURL(url));
    };
  }, [imageReferenceFiles]);

  const [downloadingBookPdf, setDownloadingBookPdf] = useState<string | null>(null);
  const [currentBookPage, setCurrentBookPage] = useState(0);

  // Create preview URLs for video reference files (Veo mode)
  const videoReferencePreviewUrls = useMemo(() => {
    return videoReferenceFiles.map(file => URL.createObjectURL(file));
  }, [videoReferenceFiles]);

  // Cleanup video reference preview URLs on unmount or when files change
  useEffect(() => {
    return () => {
      videoReferencePreviewUrls.forEach(url => URL.revokeObjectURL(url));
    };
  }, [videoReferencePreviewUrls]);

  useEffect(() => {
    if (!videoImageFile) {
      setVideoImagePreviewUrl(null);
      return;
    }

    const url = URL.createObjectURL(videoImageFile);
    setVideoImagePreviewUrl(url);
    return () => {
      URL.revokeObjectURL(url);
    };
  }, [videoImageFile]);

  // Keyboard navigation for book preview
  useEffect(() => {
    if (!selectedImage || selectedImage.type !== 'book') return;

    const handleKeyDown = (e: KeyboardEvent) => {
      const book = selectedImage.data as BookAsset;
      if (!book?.pages) return;

      if (e.key === 'ArrowRight') {
        setCurrentBookPage(prev => Math.min(book.pages.length - 1, prev + 1));
      } else if (e.key === 'ArrowLeft') {
        setCurrentBookPage(prev => Math.max(0, prev - 1));
      } else if (e.key === 'Escape') {
        setSelectedImage(null);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [selectedImage]);

  const [blogPrompt, setBlogPrompt] = useState('');
  const [isGeneratingBlog, setIsGeneratingBlog] = useState(false);
  const [blogError, setBlogError] = useState<string | null>(null);
  const [generatedBlog, setGeneratedBlog] = useState<BlogPost | null>(null);
  const [localGeneratedBlogs, setLocalGeneratedBlogs] = useState<AssetItem[]>([]);
  const [blogSaveMessage, setBlogSaveMessage] = useState<string | null>(null);
  const [websitePrompt, setWebsitePrompt] = useState('');
  const [isGeneratingWebsite, setIsGeneratingWebsite] = useState(false);
  const [websiteLogs, setWebsiteLogs] = useState<string[]>([]);
  const [showWebsiteLogs, setShowWebsiteLogs] = useState(false);
  const [websiteStreamingCode, setWebsiteStreamingCode] = useState('');
  const [websiteError, setWebsiteError] = useState<string | null>(null);
  const [websiteSaveMessage, setWebsiteSaveMessage] = useState<string | null>(null);
  const [websiteShareLoading, setWebsiteShareLoading] = useState<string | null>(null); // Asset ID being shared
  const [convertingPdf, setConvertingPdf] = useState<string | null>(null); // Asset ID being converted to PDF
  const [generatedWebsiteHtml, setGeneratedWebsiteHtml] = useState<string>('');
  const [localProjectWebsites, setLocalProjectWebsites] = useState<AssetItem[]>([]);
  const [websiteMediaFiles, setWebsiteMediaFiles] = useState<File[]>([]);
  const [isWebsiteAssetPickerOpen, setIsWebsiteAssetPickerOpen] = useState(false);
  const [selectedWebsiteAssetIds, setSelectedWebsiteAssetIds] = useState<string[]>([]);
  const [mediaPickerSearch, setMediaPickerSearch] = useState('');
  const [isPdfMode, setIsPdfMode] = useState(false);

  const handleGeneratePdfWebsite = async (overridePrompt?: string) => {
    try {
      setIsGeneratingWebsite(true);
      setWebsiteError(null);
      setWebsiteStreamingCode('');
      setGeneratedWebsiteHtml('');

      const projectContext = await contextService.buildProjectContext(project);
      const contextString = typeof projectContext === 'string' ? projectContext : JSON.stringify(projectContext);
      const promptToUse = (overridePrompt || websitePrompt).trim();
      const pdfPrompt = `Generate a STUNNING, professionally designed HTML document optimized for PDF conversion based on: ${promptToUse}. 
      
**CREATIVE DESIGN REQUIREMENTS:**
- Create magazine-quality aesthetics with decorative icons (Lucide), gradients, color-coded sections, and geometric accents.
- Think "Premium Brochure" or "Design Portfolio", NOT "Plain Report".

**FORMAT-AGNOSTIC LAYOUT:**
- Design for FLEXIBILITY: the user may print in portrait, landscape, A4, or custom sizes.
- Use max-width: 900px centered content, with percentage-based widths and CSS Grid/Flexbox for reflow.
- Avoid fixed heights. Use page-break-inside: avoid on cards/figures, page-break-after: always for major sections.

**PRINT OPTIMIZATION:**
- Use @media print to ensure backgrounds print and add 0.5in margins.
- High-contrast, readable typography. No JavaScript or animations.`;

      // 1. Process uploaded files - Upload to Vercel Blob + Get Base64 for AI Vision
      let processedMedia: { url: string, base64: string, mimeType: string, type: 'image' | 'video', file?: File }[] = [];

      if (websiteMediaFiles.length > 0) {
        // Import Vercel Blob client dynamically
        const { upload } = await import('@vercel/blob/client');

        processedMedia = await Promise.all(websiteMediaFiles.map(async (f) => {
          // Get Base64 for AI Vision
          const base64 = await new Promise<string>((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result as string);
            reader.readAsDataURL(f);
          });

          let hostedUrl = '';
          try {
            // Upload to Vercel Blob for persistent public URL
            const blob = await upload(`pdf-assets/${Date.now()}-${f.name}`, f, {
              access: 'public',
              handleUploadUrl: '/api/media?op=upload-token'
            });
            hostedUrl = blob.url;
          } catch (e) {
            console.error("Failed to upload PDF asset to Vercel Blob, falling back to base64", e);
            // Fallback: If upload fails, AI will use placeholder or base64 if permitted, 
            // but PDF generation prompt prefers hosted. We'll pass empty string as URL 
            // and geminiService will recognize base64 is present.
          }

          return {
            url: hostedUrl,
            base64: base64,
            mimeType: f.type,
            type: f.type.startsWith('video') ? 'video' : 'image',
            file: f
          };
        }));
      }

      // 2. Process selected existing assets
      if (selectedWebsiteAssetIds.length > 0) {
        console.log(`[PDF Gen] Resolving ${selectedWebsiteAssetIds.length} IDs from ${allAssets.length} total assets.`);

        for (const assetId of selectedWebsiteAssetIds) {
          const asset = allAssets.find(a => a.id === assetId);
          if (asset) {
            const hasUrl = asset.url && (asset.url.startsWith('http://') || asset.url.startsWith('https://'));

            // Critical for vision: Ensure we have base64 data for the multimodal analysis step
            let base64 = asset.data?.base64 || '';
            if (!base64 && hasUrl) {
              try {
                const proxyUrl = `/api/media?op=proxy-image&url=${encodeURIComponent(asset.url!)}`;
                const res = await fetch(proxyUrl);
                if (res.ok) {
                  const blob = await res.blob();
                  base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result as string);
                    reader.readAsDataURL(blob);
                  });
                }
              } catch (e) {
                console.warn(`[PDF Gen] Auto-resolution failed for ${assetId}`, e);
              }
            }

            processedMedia.push({
              url: hasUrl ? asset.url! : '',
              base64: base64,
              mimeType: asset.data?.mimeType || 'image/png',
              type: asset.type === 'video' || asset.type.startsWith('video/') ? 'video' : 'image'
            });
            console.log(`[PDF Gen] Resolved ${assetId} -> ${hasUrl ? 'URL' : 'Base64/Empty'} ${base64 ? '(Vision Ready)' : '(URL Only)'}`);
          } else {
            console.warn(`[PDF Gen] Failed to find asset with ID: ${assetId}`);
          }
        }
      }

      // Pass undefined for theme to avoid type mismatch - PDF uses print styles
      console.log(`[PDF Gen] Calling refineWebsiteCode with ${processedMedia.length} media items.`);
      processedMedia.forEach((m, i) => console.log(`  - MEDIA_${i + 1}: ${m.url || '(Base64 only)'} [${m.type}]`));

      const finalHtml = await refineWebsiteCode(
        pdfPrompt,
        contextString,
        undefined,
        chunk => setWebsiteStreamingCode(prev => prev + chunk),
        thought => console.log('[PDF Gen]:', thought),
        processedMedia,
        true // isPdf
      );

      const cleanedHtml = finalHtml
        .replace(/^```(?:html)?\s*\n?/i, '')
        .replace(/\n?```\s*$/i, '')
        .trim();

      // Open in new window and trigger print dialog
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(cleanedHtml);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
        }, 500);
      }

      setGeneratedWebsiteHtml(cleanedHtml);
      setWebsiteSaveMessage('PDF-ready HTML generated! Auto-saving to project assets...');

      // Auto-save to project assets as a BookAsset in the library
      try {
        const bookId = `pdf-${Date.now()}`;
        const latestSession = project.researchSessions?.[project.researchSessions.length - 1];
        const sessionId = latestSession?.id;

        const bookAsset: BookAsset = {
          id: bookId,
          title: (promptToUse.length > 40 ? promptToUse.substring(0, 40) + '...' : promptToUse) || 'Generated PDF',
          description: `Interactive PDF generated for: ${promptToUse}`,
          pages: [], // Interactive PDFs don't use standard bitmap pages
          createdAt: Date.now(),
          html: cleanedHtml,
          isInteractive: true
        };

        // If a research session exists, update it. Otherwise, we just rely on local state if needed.
        if (project.id && sessionId && latestSession && latestSession.researchReport) {
          const existingBooks = latestSession.researchReport.books || [];
          const updatedReport = {
            ...latestSession.researchReport,
            books: [bookAsset, ...existingBooks],
          };

          await storageService.updateResearchInProject(project.id, sessionId, { researchReport: updatedReport });

          const updatedSessions = (project.researchSessions || []).map(session =>
            session.id === sessionId ? { ...session, researchReport: updatedReport } : session
          );

          if (onProjectUpdate) {
            onProjectUpdate({
              ...project,
              researchSessions: updatedSessions,
              lastModified: Date.now(),
            });
          }
          setWebsiteSaveMessage('Saved to Project Assets! Download button available in PDFs tab.');
        }
      } catch (saveError) {
        console.error('Failed to auto-save PDF asset:', saveError);
        setWebsiteSaveMessage('PDF generated, but failed to auto-save. You can still print from the preview window.');
      }

      setTimeout(() => setWebsiteSaveMessage(null), 5000);
    } catch (error: any) {
      console.error('PDF generation error:', error);
      setWebsiteError(error?.message || 'Failed to generate PDF');
    } finally {
      setIsGeneratingWebsite(false);
    }
  };

  // Website AI Edit State
  const [isEditingWebsite, setIsEditingWebsite] = useState(false);
  const [websiteEditPrompt, setWebsiteEditPrompt] = useState('');
  const [isApplyingEdit, setIsApplyingEdit] = useState(false);
  const [editDiffHtml, setEditDiffHtml] = useState<string | null>(null);
  const [pendingEditHtml, setPendingEditHtml] = useState<string | null>(null);
  const [websiteEditError, setWebsiteEditError] = useState<string | null>(null);
  const [editSummary, setEditSummary] = useState<string | null>(null);
  // Lead Form AI Edit State
  const [isEditingForm, setIsEditingForm] = useState(false);
  const [formEditPrompt, setFormEditPrompt] = useState('');
  const [formEditError, setFormEditError] = useState<string | null>(null);

  const [selectedForm, setSelectedForm] = useState<AssetItem | null>(null); // Lead form full preview

  // Custom domain state
  const [customDomainModalOpen, setCustomDomainModalOpen] = useState<string | null>(null); // slug
  const [customDomainInput, setCustomDomainInput] = useState('');
  const [customDomainLoading, setCustomDomainLoading] = useState(false);
  const [customDomainError, setCustomDomainError] = useState<string | null>(null);
  const [customDomainStatus, setCustomDomainStatus] = useState<{
    hasDomain: boolean;
    domain?: string;
    verified?: boolean;
    verification?: { type: string; domain: string; value: string; reason: string }[];
  } | null>(null);

  const [podcastPrompt, setPodcastPrompt] = useState('');
  const [podcastStyle, setPodcastStyle] = useState<'conversational' | 'educational' | 'debate' | 'interview'>('conversational');
  const [podcastDuration, setPodcastDuration] = useState<'short' | 'medium' | 'long'>('medium');
  const [isGeneratingPodcast, setIsGeneratingPodcast] = useState(false);
  const [podcastError, setPodcastError] = useState<string | null>(null);
  const [podcastSaveMessage, setPodcastSaveMessage] = useState<string | null>(null);

  const [bookPrompt, setBookPrompt] = useState('');
  const [bookPageCount, setBookPageCount] = useState(8);
  const [isGeneratingBook, setIsGeneratingBook] = useState(false);
  const [bookError, setBookError] = useState<string | null>(null);
  const [bookSaveMessage, setBookSaveMessage] = useState<string | null>(null);
  const [generatedBookPages, setGeneratedBookPages] = useState<BookPage[]>([]);

  const [hiddenAssetIds, setHiddenAssetIds] = useState<Set<string>>(new Set());

  // Table generation state
  const [tablePrompt, setTablePrompt] = useState('');
  const [isGeneratingTable, setIsGeneratingTable] = useState(false);
  const [tableError, setTableError] = useState<string | null>(null);
  const [tableSaveMessage, setTableSaveMessage] = useState<string | null>(null);
  const [generatedTable, setGeneratedTable] = useState<TableAsset | null>(null);
  const [isSaveTableNameModalOpen, setIsSaveTableNameModalOpen] = useState(false);
  const [saveTableName, setSaveTableName] = useState('');
  const [editingCell, setEditingCell] = useState<{ row: number; col: number } | null>(null);
  const [editValue, setEditValue] = useState('');
  const [isGeneratingChart, setIsGeneratingChart] = useState(false);
  const [chartError, setChartError] = useState<string | null>(null);
  const [generatedChartHtml, setGeneratedChartHtml] = useState<string | null>(null);
  const [chartType, setChartType] = useState<'bar' | 'bar_horizontal' | 'line' | 'area' | 'pie' | 'donut' | 'table'>('bar');
  const [isVisualizeOpen, setIsVisualizeOpen] = useState(false);
  const chartRequestIdRef = useRef(0);

  // Table file upload state
  const [isUploadingTable, setIsUploadingTable] = useState(false);
  const [tableUploadError, setTableUploadError] = useState<string | null>(null);
  const tableFileInputRef = useRef<HTMLInputElement>(null);

  const [googleDriveConnected, setGoogleDriveConnected] = useState(false);
  const [googleDriveStatusLoading, setGoogleDriveStatusLoading] = useState(false);
  const [googleSheetsPickerOpen, setGoogleSheetsPickerOpen] = useState(false);
  const [googleSheetsQuery, setGoogleSheetsQuery] = useState('');
  const [googleSheetsFiles, setGoogleSheetsFiles] = useState<
    { id: string; name: string; mimeType: string; modifiedTime?: string }[]
  >([]);
  const [googleSheetsNextPageToken, setGoogleSheetsNextPageToken] = useState<string | null>(null);
  const [googleSheetsListLoading, setGoogleSheetsListLoading] = useState(false);
  const [googleSheetsTabs, setGoogleSheetsTabs] = useState<{ sheetId: number; title: string }[]>([]);
  const [googleSheetsSelectedSpreadsheet, setGoogleSheetsSelectedSpreadsheet] = useState<{
    spreadsheetId: string;
    title: string;
  } | null>(null);
  const [googleSheetsSelectedTab, setGoogleSheetsSelectedTab] = useState<string>('');
  const [googleSheetsLoadLoading, setGoogleSheetsLoadLoading] = useState(false);
  const [googleSheetsSaveLoading, setGoogleSheetsSaveLoading] = useState(false);
  const [googleSheetsMessage, setGoogleSheetsMessage] = useState<string | null>(null);

  const [googleDocsPickerOpen, setGoogleDocsPickerOpen] = useState(false);
  const [googleDocsQuery, setGoogleDocsQuery] = useState('');
  const [googleDocsFiles, setGoogleDocsFiles] = useState<
    { id: string; name: string; mimeType: string; modifiedTime?: string }[]
  >([]);
  const [googleDocsNextPageToken, setGoogleDocsNextPageToken] = useState<string | null>(null);
  const [googleDocsListLoading, setGoogleDocsListLoading] = useState(false);
  const [googleDocsSelected, setGoogleDocsSelected] = useState<{ documentId: string; title: string } | null>(null);
  const [googleDocsText, setGoogleDocsText] = useState('');
  const [googleDocsLastLoadedText, setGoogleDocsLastLoadedText] = useState('');
  const [googleDocsLastSavedAt, setGoogleDocsLastSavedAt] = useState<number | null>(null);
  const [googleDocsLoadLoading, setGoogleDocsLoadLoading] = useState(false);
  const [googleDocsSaveLoading, setGoogleDocsSaveLoading] = useState(false);
  const [googleDocsMessage, setGoogleDocsMessage] = useState<string | null>(null);

  const [googleDocsInsertImageMenuOpen, setGoogleDocsInsertImageMenuOpen] = useState(false);
  const googleDocsInsertImageMenuRef = useRef<HTMLDivElement | null>(null);
  const googleDocsUploadImageInputRef = useRef<HTMLInputElement | null>(null);
  const [googleDocsGenerateImageOpen, setGoogleDocsGenerateImageOpen] = useState(false);
  const [googleDocsGenerateImagePrompt, setGoogleDocsGenerateImagePrompt] = useState('');
  const [googleDocsGenerateImageLoading, setGoogleDocsGenerateImageLoading] = useState(false);

  const [googleDocsImagePickerOpen, setGoogleDocsImagePickerOpen] = useState(false);
  const [googleDocsImageWidthPx, setGoogleDocsImageWidthPx] = useState('480');
  const [googleDocsImageHeightPx, setGoogleDocsImageHeightPx] = useState('');
  const googleDocsTextareaRef = useRef<HTMLTextAreaElement | null>(null);
  const [googleDocsPreviewMode, setGoogleDocsPreviewMode] = useState(false);

  // Lead Form State
  const [leadFormPrompt, setLeadFormPrompt] = useState('');
  const [leadFormTitle, setLeadFormTitle] = useState('');
  const [leadFormFields, setLeadFormFields] = useState<LeadFormField[]>([
    { id: 'email', name: 'email', label: 'Email Address', type: 'email', required: true, placeholder: 'Enter your email' },
  ]);
  const [leadFormUseProfileLogo, setLeadFormUseProfileLogo] = useState(false);
  const [leadFormImages, setLeadFormImages] = useState<File[]>([]);
  const [isGeneratingLeadForm, setIsGeneratingLeadForm] = useState(false);
  const [generatedLeadFormHtml, setGeneratedLeadFormHtml] = useState('');
  const [leadFormStreamingCode, setLeadFormStreamingCode] = useState('');
  const [leadFormError, setLeadFormError] = useState<string | null>(null);
  const [leadFormSaveMessage, setLeadFormSaveMessage] = useState<string | null>(null);
  const [localLeadForms, setLocalLeadForms] = useState<LeadFormAsset[]>([]);
  const [capturedLeads, setCapturedLeads] = useState<CapturedLead[]>([]);
  const [loadingLeads, setLoadingLeads] = useState(false);
  const [leadsError, setLeadsError] = useState<string | null>(null);
  const [expandedLeadId, setExpandedLeadId] = useState<string | null>(null);
  const [deletingLeadId, setDeletingLeadId] = useState<string | null>(null);
  const [selectedLeadFormId, setSelectedLeadFormId] = useState<string | null>(null);

  // Lead Email Modal State
  const [isLeadEmailModalOpen, setIsLeadEmailModalOpen] = useState(false);
  const [selectedLead, setSelectedLead] = useState<CapturedLead | null>(null);
  const [leadEmailSubject, setLeadEmailSubject] = useState('');
  const [leadEmailBody, setLeadEmailBody] = useState('');
  const [isSendingLeadEmail, setIsSendingLeadEmail] = useState(false);
  const [leadEmailError, setLeadEmailError] = useState<string | null>(null);
  const [leadEmailSuccess, setLeadEmailSuccess] = useState<string | null>(null);
  const [emailAttachments, setEmailAttachments] = useState<File[]>([]);

  // Lead Email Scheduling State
  const [leadEmailScheduleMode, setLeadEmailScheduleMode] = useState<'now' | 'schedule'>('now');
  const [leadEmailScheduledDateTime, setLeadEmailScheduledDateTime] = useState('');
  const [isSchedulingLeadEmail, setIsSchedulingLeadEmail] = useState(false);

  // Product Creation State
  const [productName, setProductName] = useState('');
  const [productDescription, setProductDescription] = useState('');
  const [productPrice, setProductPrice] = useState('');
  const [productCurrency, setProductCurrency] = useState('usd');
  const [isCreatingProduct, setIsCreatingProduct] = useState(false);
  const [productError, setProductError] = useState<string | null>(null);
  const [productSaveMessage, setProductSaveMessage] = useState<string | null>(null);
  const [creatingPaymentLink, setCreatingPaymentLink] = useState<string | null>(null);

  // E-commerce Website Generation State
  const [ecommerceMode, setEcommerceMode] = useState(false);
  const [selectedEcommerceProductIds, setSelectedEcommerceProductIds] = useState<string[]>([]);
  const [isEcommerceProductPickerOpen, setIsEcommerceProductPickerOpen] = useState(false);
  const [ecommercePrompt, setEcommercePrompt] = useState('');
  const [isGeneratingEcommerce, setIsGeneratingEcommerce] = useState(false);
  const [ecommerceStreamingHtml, setEcommerceStreamingHtml] = useState('');
  const [ecommerceError, setEcommerceError] = useState<string | null>(null);
  const [ecommerceSaveMessage, setEcommerceSaveMessage] = useState<string | null>(null);

  // Product Images State
  const [productImages, setProductImages] = useState<File[]>([]);
  const [selectedProductAssetIds, setSelectedProductAssetIds] = useState<string[]>([]);
  const [isProductAssetPickerOpen, setIsProductAssetPickerOpen] = useState(false);
  const [productAssetSearch, setProductAssetSearch] = useState('');
  const [isGeneratingDescription, setIsGeneratingDescription] = useState(false);

  // Payment Link Options
  const [customFields, setCustomFields] = useState<Array<{ id: string; key: string; label: string; type: 'text' | 'numeric' }>>([]);
  const [quantityEnabled, setQuantityEnabled] = useState(false);
  const [quantityMin, setQuantityMin] = useState('1');
  const [quantityMax, setQuantityMax] = useState('10');
  const [showPaymentOptions, setShowPaymentOptions] = useState(false);

  // Order Tracking & Fulfillment State
  const [expandedProductOrders, setExpandedProductOrders] = useState<string | null>(null);
  const [productOrders, setProductOrders] = useState<Record<string, any[]>>({});
  const [loadingOrders, setLoadingOrders] = useState(false);
  const [isFulfillmentModalOpen, setIsFulfillmentModalOpen] = useState(false);
  const [selectedOrder, setSelectedOrder] = useState<any | null>(null);
  const [fulfillmentFile, setFulfillmentFile] = useState<File | null>(null);
  const [fulfillmentMessage, setFulfillmentMessage] = useState('');
  const [isSendingFulfillment, setIsSendingFulfillment] = useState(false);
  const [fulfillmentError, setFulfillmentError] = useState<string | null>(null);
  const [fulfillmentSuccess, setFulfillmentSuccess] = useState<string | null>(null);

  // Gmail Integration State
  const [sentEmailLeads, setSentEmailLeads] = useState<Set<string>>(new Set());
  const [sentEmailCustomers, setSentEmailCustomers] = useState<Set<string>>(new Set());

  // Bulk Email & Templates State
  const [emailRecipients, setEmailRecipients] = useState<string[]>([]);
  const [isBulkEmail, setIsBulkEmail] = useState(false);
  const [templateName, setTemplateName] = useState('');
  const [isSavingTemplate, setIsSavingTemplate] = useState(false);
  const [showSaveTemplateInput, setShowSaveTemplateInput] = useState(false);

  const allAssets = useMemo((): AssetItem[] => {
    const assets: AssetItem[] = [];
    const seenIds = new Set<string>();
    const seenUrls = new Set<string>();

    const addAsset = (asset: AssetItem) => {
      if (seenIds.has(asset.id)) return;

      // Deduplicate by URL for media assets (images/videos) to prevent context-based duplicates
      const url = asset.url || (asset.data as any)?.url || (asset.data as any)?.uri;
      if (url && typeof url === 'string' && url.length > 5 && !url.includes('placehold.co')) {
        if (seenUrls.has(url)) return;
        seenUrls.add(url);
      }

      seenIds.add(asset.id);
      assets.push(asset);
    };

    // 1. Process research sessions and their derived assets
    (project.researchSessions || []).forEach(session => {
      // Direct session assets
      (session.assets || []).forEach(addAsset);

      const report = session.researchReport;
      if (!report) return;

      if (report.headerImageUrl && !report.headerImageUrl.includes('placehold.co')) {
        addAsset({
          id: `header-${session.id}`,
          type: 'header',
          url: report.headerImageUrl,
          title: 'Hero Image',
          description: report.headerImagePrompt,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: session.timestamp
        });
      }

      if (report.slides) {
        report.slides.forEach((slide, idx) => {
          if (slide.imageUrl && !slide.imageUrl.includes('placehold.co')) {
            addAsset({
              id: `slide-${session.id}-${idx}`,
              type: 'slide',
              url: slide.imageUrl,
              title: slide.title || `Slide ${idx + 1}`,
              description: slide.imagePrompt,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: session.timestamp
            });
          }
          if (slide.imageUrls) {
            slide.imageUrls.forEach((url, imgIdx) => {
              if (url && !url.includes('placehold.co')) {
                addAsset({
                  id: `slide-${session.id}-${idx}-${imgIdx}`,
                  type: 'slide',
                  url: url,
                  title: `${slide.title || `Slide ${idx + 1}`} - Image ${imgIdx + 1}`,
                  researchId: session.id,
                  researchTopic: session.topic,
                  timestamp: session.timestamp
                });
              }
            });
          }
        });
      }

      if (session.noteMapState) {
        session.noteMapState.forEach((node, idx) => {
          if (node.imageUrl && !node.imageUrl.includes('placehold.co')) {
            addAsset({
              id: `notemap-${session.id}-${node.id}`,
              type: 'notemap',
              url: node.imageUrl,
              title: node.title || `Note ${idx + 1}`,
              description: node.content,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: session.timestamp
            });
          }
        });
      }

      const blog = report.blogPost;
      if (blog && blog.content) {
        addAsset({
          id: `blog-${session.id}`,
          type: 'blog',
          url: blog.imageUrl,
          title: blog.title,
          description: blog.subtitle,
          data: blog,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: session.timestamp
        });
      }

      if (report.socialCampaign?.posts) {
        report.socialCampaign.posts.forEach((post, idx) => {
          if (post.imageUrl && !post.imageUrl.includes('placehold.co')) {
            addAsset({
              id: `social-${session.id}-${idx}`,
              type: 'social',
              url: post.imageUrl,
              title: `${post.platform} Post`,
              description: post.caption,
              data: post,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: session.timestamp
            });
          }
        });
      }

      const video = report.videoPost;
      if (video && video.videoUrl) {
        addAsset({
          id: `video-${session.id}`,
          type: 'video',
          url: video.videoUrl,
          title: video.caption || 'Social video',
          description: video.hashtags,
          data: video,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: session.timestamp,
        });
      }

      (session.websiteVersions || []).forEach((version, idx) => {
        addAsset({
          id: `website-${session.id}-${version.id}`,
          type: 'website',
          title: version.description || `Website v${idx + 1}`,
          data: version,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: version.timestamp
        });
      });

      (report.books || []).forEach(book => {
        addAsset({
          id: `book-${session.id}-${book.id}`,
          type: 'book',
          title: book.title,
          description: book.description,
          data: book,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: book.createdAt || session.timestamp,
        });
        (book.pages || []).forEach(page => {
          if (page.imageUrl) {
            addAsset({
              id: `book-page-${session.id}-${book.id}-${page.pageNumber}`,
              type: 'social',
              url: page.imageUrl,
              title: `${book.title} - Page ${page.pageNumber}`,
              description: page.text || book.description,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: book.createdAt || session.timestamp,
            });
          }
        });
      });

      (report.tables || []).forEach(table => {
        addAsset({
          id: `table-${session.id}-${table.id}`,
          type: 'table',
          title: table.title,
          description: table.description,
          data: table,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: table.createdAt || session.timestamp,
        });
      });
    });

    // 2. Process project-level assets (uploaded files, knowledge base)
    (project.uploadedFiles || []).forEach(file => {
      const mime = (file.mimeType || '').toLowerCase();
      let type: AssetItem['type'] = 'doc';
      if (mime.startsWith('image/')) type = 'social';
      else if (mime.startsWith('video/')) type = 'video';
      else if (mime.startsWith('audio/')) type = 'podcast';
      else if (mime === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) type = 'book';
      else if (mime === 'text/csv' || mime.includes('excel') || mime.includes('spreadsheet') || file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.xlsx')) type = 'table';

      addAsset({
        id: file.id || file.name, // Use stable database ID or Gemini filename as fallback
        type,
        title: file.displayName || file.name,
        description: file.summary || 'Uploaded file',
        url: file.url || file.uri,
        data: file,
        researchId: 'project-assets',
        researchTopic: 'Uploads',
        timestamp: file.uploadedAt || Date.now(),
      });
    });

    (project.knowledgeBase || []).forEach(file => {
      const mime = (file.type || '').toLowerCase();
      let type: AssetItem['type'] = 'doc';
      if (mime.startsWith('image/')) type = 'social';
      else if (mime.startsWith('video/') || file.name.toLowerCase().endsWith('.mp4')) type = 'video';
      else if (mime.startsWith('audio/')) type = 'podcast';

      addAsset({
        id: file.id.startsWith('kb-') ? file.id : `kb-${file.id}`, // Ensure stable ID prefix for knowledge base
        type,
        url: file.url,
        title: file.name,
        description: file.summary,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: file.uploadedAt,
      });
    });

    // 3. Process local generated assets (pending sync)
    localGeneratedBlogs.forEach(asset => addAsset({ ...asset, researchId: 'project-assets' }));
    localProjectWebsites.forEach(asset => addAsset({ ...asset, researchId: 'project-assets' }));

    return assets;
  }, [project.researchSessions, project.uploadedFiles, project.knowledgeBase, localGeneratedBlogs, localProjectWebsites, project.name]);
  // Gmail & Outlook Integration State
  const [gmailConnected, setGmailConnected] = useState(false);
  const [outlookConnected, setOutlookConnected] = useState(false);
  const [emailProvider, setEmailProvider] = useState<'gmail' | 'outlook'>('gmail');
  const [checkingGmail, setCheckingGmail] = useState(false);
  const [showPreview, setShowPreview] = useState(false);

  useEffect(() => {
    if (isFulfillmentModalOpen && userProfile?.stripeConnect?.accountId) {
      setCheckingGmail(true);

      // Check Gmail
      authFetch('/api/email?op=status&provider=gmail')
        .then(res => res.json())
        .then(data => {
          const connected = !!data.connected;
          setGmailConnected(connected);
          if (connected && !outlookConnected) setEmailProvider('gmail');
        })
        .catch(() => setGmailConnected(false));

      // Check Outlook
      authFetch('/api/email?op=status&provider=outlook')
        .then(res => res.json())
        .then(data => {
          const connected = !!data.connected;
          setOutlookConnected(connected);
          if (connected && !gmailConnected) setEmailProvider('outlook');
        })
        .catch(() => setOutlookConnected(false))
        .finally(() => setCheckingGmail(false));
    }
  }, [isFulfillmentModalOpen, userProfile]);

  // Check email status when lead email modal opens
  useEffect(() => {
    if (isLeadEmailModalOpen) {
      setCheckingGmail(true);

      authFetch('/api/email?op=status&provider=gmail')
        .then(res => res.json())
        .then(data => {
          const connected = !!data.connected;
          setGmailConnected(connected);
          if (connected && !outlookConnected) setEmailProvider('gmail');
        })
        .catch(() => setGmailConnected(false));

      authFetch('/api/email?op=status&provider=outlook')
        .then(res => res.json())
        .then(data => {
          const connected = !!data.connected;
          setOutlookConnected(connected);
          if (connected && !gmailConnected) setEmailProvider('outlook');
        })
        .catch(() => setOutlookConnected(false))
        .finally(() => setCheckingGmail(false));
    }
  }, [isLeadEmailModalOpen]);

  // Listen for OAuth completion messages from popup windows
  useEffect(() => {
    const handleMessage = (event: MessageEvent) => {
      // Security: verify origin matches current origin
      if (event.origin !== window.location.origin) return;

      // Check if this is an OAuth completion message
      if (event.data?.type === 'gmail:connected' || event.data?.type === 'outlook:connected') {
        const isGmail = event.data?.type === 'gmail:connected';

        // Optimistic update
        if (isGmail) {
          setGmailConnected(true);
          if (!outlookConnected) setEmailProvider('gmail');
        } else {
          setOutlookConnected(true);
          if (!gmailConnected) setEmailProvider('outlook');
        }

        // Helper to check status with retries
        const checkStatus = async (provider: 'gmail' | 'outlook', retries = 3, delay = 1000) => {
          try {
            const res = await authFetch(`/api/email?op=status&provider=${provider}`);
            const data = await res.json();
            if (data.connected) {
              if (provider === 'gmail') setGmailConnected(true);
              else setOutlookConnected(true);
              return;
            }
          } catch (e) {
            console.error(`Check ${provider} status failed`, e);
          }

          if (retries > 0) {
            setTimeout(() => checkStatus(provider, retries - 1, delay * 2), delay);
          } else {
            // Revert optimistic update if final check fails
            if (provider === 'gmail') setGmailConnected(false);
            else setOutlookConnected(false);
          }
        };

        // Start checks
        if (isGmail) checkStatus('gmail');
        else checkStatus('outlook');
      }
    };

    window.addEventListener('message', handleMessage);
    return () => window.removeEventListener('message', handleMessage);
  }, [gmailConnected, outlookConnected]);
  const uploadedFiles = useMemo(() => {
    const projectFiles: UploadedFile[] = project.uploadedFiles || [];
    const sessionFiles: KnowledgeBaseFile[] = (project.researchSessions || []).flatMap(session => session.uploadedFiles || []);
    const knowledgeBaseFiles: KnowledgeBaseFile[] = project.knowledgeBase || [];

    const normalizedSessionFiles: UploadedFile[] = sessionFiles.map(file => ({
      name: file.name,
      uri: file.url,
      mimeType: file.type,
      sizeBytes: file.size,
      displayName: file.name,
      uploadedAt: file.uploadedAt,
      summary: file.summary || file.extractedText || '',
    }));

    const normalizedKnowledgeBaseFiles: UploadedFile[] = knowledgeBaseFiles.map(file => ({
      name: file.name,
      uri: file.url,
      mimeType: file.type || '',
      sizeBytes: file.size,
      displayName: file.name,
      uploadedAt: file.uploadedAt,
      summary: file.summary || file.extractedText || '',
    }));
    return [...projectFiles, ...normalizedSessionFiles, ...normalizedKnowledgeBaseFiles];
  }, [project.uploadedFiles, project.researchSessions, project.knowledgeBase]);

  const fetchOrders = async (productId: string, priceId: string) => {
    if (!userProfile?.stripeConnect?.accountId) return;

    setLoadingOrders(true);
    // Don't clear existing orders to avoid flash, or clear only specific key if needed
    try {
      const res = await authFetch(`/api/stripe?op=list-orders&accountId=${userProfile.stripeConnect.accountId}&priceId=${priceId}`);
      const data = await res.json();
      if (data.orders) {
        setProductOrders(prev => ({
          ...prev,
          [productId]: data.orders
        }));
      }
    } catch (e) {
      console.error('Failed to fetch orders:', e);
    } finally {
      setLoadingOrders(false);
    }
  };

  const handleFulfillOrder = (order: any) => {
    setSelectedOrder(order);
    setFulfillmentFile(null);
    setFulfillmentMessage('');
    setFulfillmentError(null);
    setFulfillmentSuccess(null);
    setIsFulfillmentModalOpen(true);
  };

  const handleSendFulfillment = async () => {
    if (!selectedOrder || !fulfillmentFile) {
      setFulfillmentError('Please select a file to send.');
      return;
    }

    const isConnected = emailProvider === 'gmail' ? gmailConnected : outlookConnected;
    if (!isConnected) {
      setFulfillmentError(`Please connect your ${emailProvider === 'gmail' ? 'Gmail' : 'Outlook'} account first.`);
      return;
    }

    setIsSendingFulfillment(true);
    setFulfillmentError(null);

    try {
      const reader = new FileReader();
      reader.readAsDataURL(fulfillmentFile);

      reader.onload = async () => {
        const base64File = reader.result as string;

        try {
          const endpoint = `/api/email?op=send&provider=${emailProvider}`;
          const res = await authFetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: selectedOrder.customerEmail,
              subject: `Your Order #${selectedOrder.id.slice(-6)} is ready`,
              html: `
                  <h1>Order Fulfillment</h1>
                  <p>Hi ${selectedOrder.customerName || 'there'},</p>
                  <p>Thank you for your purchase!</p>
                  <p>${fulfillmentMessage || 'Please find your purchased digital product attached.'}</p>
                  <br/>
                  <p>Order ID: ${selectedOrder.id}</p>
                `,
              attachments: [
                {
                  filename: fulfillmentFile.name,
                  content: base64File.split(',')[1],
                  type: fulfillmentFile.type,
                }
              ]
            }),
          });

          const data = await res.json();

          if (data.success) {
            setFulfillmentSuccess(`Order fulfilled successfully! Email sent via ${emailProvider === 'gmail' ? 'Gmail' : 'Outlook'}.`);
            setTimeout(() => {
              setIsFulfillmentModalOpen(false);
              setFulfillmentSuccess(null);
              setFulfillmentFile(null);
            }, 2000);
          } else {
            setFulfillmentError(data.error || 'Failed to send email.');
          }
        } catch (e: any) {
          setFulfillmentError(e.message || 'API Error');
        }
      };

      reader.onerror = () => {
        setFulfillmentError('Failed to read file.');
        setIsSendingFulfillment(false);
      };

    } catch (e: any) {
      console.error('Fulfillment error:', e);
      setFulfillmentError(e.message || 'An error occurred.');
    } finally {
      setIsSendingFulfillment(false);
    }
  };

  const handleEmailLead = (lead: CapturedLead) => {
    setSelectedLead(lead);
    setLeadEmailSubject(`Hello from ${project.name}`);
    setLeadEmailBody('');
    setLeadEmailError(null);
    setLeadEmailSuccess(null);
    setIsLeadEmailModalOpen(true);
  };

  const handleSaveTemplate = async () => {
    if (!project || !templateName.trim()) return;

    setIsSavingTemplate(true);
    try {
      const newTemplate: EmailTemplate = {
        id: crypto.randomUUID(),
        name: templateName.trim(),
        subject: leadEmailSubject,
        body: leadEmailBody
      };

      const updatedTemplates = [...(project.emailTemplates || []), newTemplate];
      await storageService.updateResearchProject(project.id, { emailTemplates: updatedTemplates });
      onProjectUpdate?.({ ...project, emailTemplates: updatedTemplates });

      setTemplateName('');
      setShowSaveTemplateInput(false);
      alert('Template saved!');
    } catch (error) {
      console.error('Failed to save template:', error);
      alert('Failed to save template');
    } finally {
      setIsSavingTemplate(false);
    }
  };

  const handleSelectTemplate = (templateId: string) => {
    const template = project.emailTemplates?.find(t => t.id === templateId);
    if (template) {
      setLeadEmailSubject(template.subject || template.name);
      if (template.blocks && template.blocks.length > 0) {
        const html = generateEmailHtml(template.blocks);
        setLeadEmailBody(html);
        // Auto-switch to preview if it looks like HTML
        if (html.trim().startsWith('<')) {
          setShowPreview(true);
        }
      } else {
        setLeadEmailBody(template.body || '');
        // Auto-switch to preview if it looks like HTML
        if ((template.body || '').trim().startsWith('<')) {
          setShowPreview(true);
        }
      }
    }
  };

  const handleSendEmail = async () => {
    // Check provider connection
    const isConnected = emailProvider === 'gmail' ? gmailConnected : outlookConnected;
    if (!isConnected) {
      setLeadEmailError(`Please connect ${emailProvider === 'gmail' ? 'Gmail' : 'Outlook'} first.`);
      return;
    }

    if (!leadEmailSubject.trim() || !leadEmailBody.trim()) {
      setLeadEmailError('Please enter a subject and message.');
      return;
    }

    setIsSendingLeadEmail(true);
    setLeadEmailError(null);
    setLeadEmailSuccess(null);

    try {
      const recipients = isBulkEmail ? emailRecipients : (selectedLead ? [
        (selectedLead.data?.email || selectedLead.data?.Email || Object.values(selectedLead.data || {}).find((v: any) => typeof v === 'string' && v.includes('@'))) as string
      ] : []); // Fallback for single lead

      const filteredRecipients = recipients.filter(Boolean);

      if (filteredRecipients.length === 0) {
        throw new Error('No valid recipients found.');
      }

      // Process attachments
      const processedAttachments = await Promise.all(emailAttachments.map(async (file) => {
        return new Promise<{ filename: string; content: string; type: string }>((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const result = reader.result as string;
            const base64 = result.split(',')[1];
            resolve({
              filename: file.name,
              content: base64,
              type: file.type
            });
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }));

      let sentCount = 0;
      const errors: string[] = [];

      for (const toEmail of filteredRecipients) {
        try {
          await authFetch(`/api/email?op=send&provider=${emailProvider}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: toEmail,
              subject: leadEmailSubject,
              html: `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;">
                  <p>${leadEmailBody.replace(/\n/g, '<br/>')}</p>
                </div>
              `,
              attachments: processedAttachments
            }),
          });
          sentCount++;

          // Update sent status based on context
          if (isBulkEmail) {
            setSentEmailCustomers(prev => new Set(prev).add(toEmail));
            // For leads, find ID by email
            const lead = capturedLeads.find(l => {
              const d = l.data || {};
              return (d.email === toEmail || d.Email === toEmail);
            });
            if (lead) {
              setSentEmailLeads(prev => new Set(prev).add(lead.id));
            }
          } else if (selectedLead) {
            setSentEmailLeads(prev => new Set(prev).add(selectedLead.id));
          }

        } catch (e: any) {
          console.error(`Failed to send to ${toEmail}:`, e);
          errors.push(toEmail);
        }
      }

      if (sentCount > 0) {
        setLeadEmailSuccess(`Successfully sent ${sentCount} email${sentCount > 1 ? 's' : ''}!`);
        setTimeout(() => {
          setIsLeadEmailModalOpen(false);
          setLeadEmailSuccess(null);
          setSelectedLead(null);
          setIsBulkEmail(false);
          setEmailRecipients([]);
          setEmailAttachments([]);
        }, 2000);
      }

      if (errors.length > 0) {
        setLeadEmailError(`Failed to send to ${errors.length} recipients.`);
      }

    } catch (e: any) {
      console.error('Email error:', e);
      setLeadEmailError(e.message || 'An error occurred.');
    } finally {
      setIsSendingLeadEmail(false);
    }
  };

  // Handle scheduling lead email with QStash
  const handleScheduleLeadEmail = async () => {
    const isConnected = emailProvider === 'gmail' ? gmailConnected : outlookConnected;
    if (!isConnected) {
      setLeadEmailError(`Please connect ${emailProvider === 'gmail' ? 'Gmail' : 'Outlook'} first.`);
      return;
    }

    if (!leadEmailSubject.trim() || !leadEmailBody.trim()) {
      setLeadEmailError('Please enter a subject and message.');
      return;
    }

    if (!leadEmailScheduledDateTime) {
      setLeadEmailError('Please select a scheduled date and time.');
      return;
    }

    const scheduledDate = new Date(leadEmailScheduledDateTime);
    const now = new Date();
    const minTime = new Date(now.getTime() + 10 * 60 * 1000);
    const maxTime = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

    if (scheduledDate < minTime) {
      setLeadEmailError('Scheduled time must be at least 10 minutes in the future.');
      return;
    }
    if (scheduledDate > maxTime) {
      setLeadEmailError('Scheduled time cannot be more than 7 days in the future.');
      return;
    }

    setIsSchedulingLeadEmail(true);
    setLeadEmailError(null);
    setLeadEmailSuccess(null);

    try {
      const recipients = isBulkEmail ? emailRecipients : (selectedLead ? [
        (selectedLead.data?.email || selectedLead.data?.Email || Object.values(selectedLead.data || {}).find((v: any) => typeof v === 'string' && v.includes('@'))) as string
      ].filter(Boolean) : []);

      if (recipients.length === 0) {
        throw new Error('No valid recipients found.');
      }

      // Process attachments
      const processedAttachments = await Promise.all(emailAttachments.map(async (file) => {
        return new Promise<{ filename: string; content: string; type: string }>((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const result = reader.result as string;
            const base64 = result.split(',')[1];
            resolve({
              filename: file.name,
              content: base64,
              type: file.type
            });
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }));

      // Create HTML content
      const html = `
        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;">
          <p>${leadEmailBody.replace(/\n/g, '<br/>')}</p>
        </div>
      `;

      const scheduledAtUnix = Math.floor(scheduledDate.getTime() / 1000);

      const res = await authFetch('/api/email?op=email-schedule-create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          projectId: project.id,
          scheduledAt: scheduledAtUnix,
          provider: emailProvider,
          to: recipients.length === 1 ? recipients[0] : recipients,
          subject: leadEmailSubject,
          html,
          attachments: processedAttachments,
        }),
      });

      const data = await res.json();
      if (data.success) {
        setLeadEmailSuccess(` Email scheduled for ${scheduledDate.toLocaleString()}!`);
        setTimeout(() => {
          setIsLeadEmailModalOpen(false);
          setLeadEmailSuccess(null);
          setSelectedLead(null);
          setIsBulkEmail(false);
          setEmailRecipients([]);
          setEmailAttachments([]);
          setLeadEmailScheduleMode('now');
          setLeadEmailScheduledDateTime('');
        }, 2000);
      } else {
        setLeadEmailError(data.error || 'Failed to schedule email.');
      }
    } catch (e: any) {
      setLeadEmailError(e.message || 'An error occurred while scheduling.');
    } finally {
      setIsSchedulingLeadEmail(false);
    }
  };


  const handleEmailAllLeads = async () => {
    // Filter leads by selected form if one is selected
    const leadsToEmail = selectedLeadFormId
      ? capturedLeads.filter(lead => lead.formId === selectedLeadFormId)
      : capturedLeads;

    const leadsWithEmail = leadsToEmail.filter(lead => {
      const data = lead.data || {};
      return data.email || data.Email || Object.keys(data).some(k => k.toLowerCase().includes('email') && data[k]);
    });

    if (leadsWithEmail.length === 0) {
      alert('No leads with email addresses found.');
      return;
    }

    const recipients = leadsWithEmail.map(lead => {
      const data = lead.data || {};
      return (data.email || data.Email || Object.values(data).find(v => typeof v === 'string' && v.includes('@'))) as string;
    }).filter(Boolean);

    setEmailRecipients(recipients);
    setIsBulkEmail(true);
    setLeadEmailSubject(`Update from ${project.name}`);
    setLeadEmailBody(`Hello,\n\nThis is an update from ${project.name}.`);
    setIsLeadEmailModalOpen(true);
  };

  const handleEmailAllCustomers = async () => {
    // Collect all loaded orders
    // Note: productOrders is a Record<productId, Order[]>
    const allOrders = Object.values(productOrders).flatMap(orders => orders || []);
    const ordersWithEmail = allOrders.filter(order => order.customer_details?.email || order.customerEmail);

    const uniqueEmails = [...new Set(
      ordersWithEmail
        .map(order => order.customer_details?.email || order.customerEmail)
        .filter(Boolean) as string[]
    )];

    if (uniqueEmails.length === 0) {
      alert('No customer email addresses found in loaded orders. Please view orders first.');
      return;
    }

    setEmailRecipients(uniqueEmails);
    setIsBulkEmail(true);
    setLeadEmailSubject(`Update from ${project.name}`);
    setLeadEmailBody(`Hello,\n\nThis is an update regarding your purchase from ${project.name}.`);
    setIsLeadEmailModalOpen(true);
  };



  const handleGenerateEcommerceWebsite = async (overridePrompt?: string) => {
    const promptToUse = overridePrompt || ecommercePrompt;

    if (!promptToUse.trim()) {
      setEcommerceError('Please enter a design prompt for your store.');
      return;
    }

    if (selectedEcommerceProductIds.length === 0) {
      setEcommerceError('Please select at least one product.');
      return;
    }

    if (!userProfile?.stripeConnect?.accountId) {
      setEcommerceError('Please connect your Stripe account first.');
      return;
    }

    setIsGeneratingEcommerce(true);
    setEcommerceError(null);
    setEcommerceSaveMessage(null);
    setEcommerceStreamingHtml('');

    try {
      // Build products with payment links
      const productsToUse: EcommerceProduct[] = [];

      for (const productId of selectedEcommerceProductIds) {
        const product = (project.stripeProducts || []).find(p => p.id === productId);
        if (!product) continue;

        // Generate payment link if not exists
        let paymentLinkUrl = product.paymentLinkUrl;
        if (!paymentLinkUrl && product.priceId) {
          try {
            const linkRes = await authFetch('/api/stripe?op=create-payment-link', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                accountId: userProfile.stripeConnect.accountId,
                priceId: product.priceId,
                customFields: product.customFields,
                quantityOptions: product.quantityOptions,
              }),
            });
            const linkData = await linkRes.json();
            if (linkData.paymentLink?.url) {
              paymentLinkUrl = linkData.paymentLink.url;
            }
          } catch (e) {
            console.error('Failed to create payment link for', product.name, e);
          }
        }

        if (paymentLinkUrl) {
          productsToUse.push({
            id: product.id,
            name: product.name,
            description: product.description,
            price: product.unitAmount,
            currency: product.currency,
            imageUrl: product.images?.[0],
            paymentLinkUrl,
          });
        }
      }

      if (productsToUse.length === 0) {
        setEcommerceError('Could not create payment links for selected products.');
        setIsGeneratingEcommerce(false);
        return;
      }

      // Collect media assets for e-commerce store
      const ecommerceMedia: WebsiteMedia[] = [];

      // 1. Process uploaded files
      if (websiteMediaFiles.length > 0) {
        for (const file of websiteMediaFiles) {
          try {
            const base64 = await fileToBase64(file);
            const isVideo = file.type.startsWith('video/');
            ecommerceMedia.push({
              url: base64, // Local file doesn't have a URL yet, use base64 for embedding
              base64: base64,
              mimeType: file.type,
              type: isVideo ? 'video' : 'image'
            });
          } catch (e) {
            console.error('Failed to process uploaded file for e-commerce:', file.name, e);
          }
        }
      }

      // 2. Process selected existing assets
      if (selectedWebsiteAssetIds.length > 0) {
        const allAssets: AssetItem[] = [];
        if (project.researchSessions) {
          project.researchSessions.forEach(session => {
            if (session.assets) allAssets.push(...session.assets);
          });
        }

        for (const assetId of selectedWebsiteAssetIds) {
          const asset = allAssets.find(a => a.id === assetId);
          if (asset) {
            try {
              let assetBase64 = asset.data?.base64;
              const hasUrl = asset.url && (asset.url.startsWith('http://') || asset.url.startsWith('https://'));

              // We always want base64 for vision if possible
              if (!assetBase64 && hasUrl) {
                try {
                  assetBase64 = await fetchImageAsBase64(asset.url!);
                } catch (e) {
                  console.warn('Failed to fetch base64 for vision, will use URL only:', asset.url);
                }
              }

              const isVideo = asset.type === 'video' || (asset.type === 'social' && asset.data?.videoUrl);
              const mimeType = asset.data?.mimeType || (isVideo ? 'video/mp4' : 'image/jpeg');

              ecommerceMedia.push({
                url: hasUrl ? asset.url! : (assetBase64 || asset.url!), // Prefer real URL for embedding
                base64: assetBase64,
                mimeType,
                type: isVideo ? 'video' : 'image'
              });
            } catch (e) {
              console.error('Failed to process selected asset for e-commerce:', asset.title, e);
            }
          }
        }
      }

      // Generate the e-commerce website
      const finalHtml = await streamEcommerceWebsite(
        promptToUse,
        productsToUse,
        chunk => {
          // Strip markdown fences from streaming chunks
          const cleanChunk = chunk.replace(/^```(?:html)?\s*\n?/i, '').replace(/\n?```\s*$/i, '');
          setEcommerceStreamingHtml(prev => prev + cleanChunk);
        },
        project.name || 'Store',
        null, // logoUrl
        ecommerceMedia
      );

      // Strip any remaining markdown fences from the final result
      const cleanedHtml = finalHtml
        .replace(/^```(?:html)?\s*\n?/i, '')
        .replace(/\n?```\s*$/i, '')
        .trim();

      // Save the generated website as an asset
      const websiteId = `ecommerce-${Date.now()}`;
      const newWebsite: AssetItem = {
        id: websiteId,
        type: 'website',
        title: `E-commerce Store - ${project.name}`,
        description: `Store with ${productsToUse.length} products`,
        url: '',
        data: {
          id: websiteId,
          name: `E-commerce Store`,
          savedAt: Date.now(),
          html: cleanedHtml,
          timestamp: Date.now(),
          description: `Store with ${productsToUse.length} products`,
        } as SavedWebsiteVersion,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: Date.now(),
      };

      setLocalProjectWebsites(prev => [newWebsite, ...prev]);

      // Persist to Firestore (same pattern as regular websites)
      // Persist to Firestore (same pattern as regular websites)
      let latestSession = project.researchSessions?.[project.researchSessions.length - 1];

      if (!latestSession) {
        // Create a fallback session if none exists
        try {
          const mockReport: ResearchReport = {
            topic: project.name,
            tldr: 'Auto-generated session for project assets',
            summary: 'Auto-generated session for project assets',
            headerImagePrompt: 'Abstract minimalist digital architecture visualization',
            dynamicSections: [],
            keyPoints: [],
            marketImplications: '',
            sources: []
          };
          latestSession = await storageService.addResearchToProject(project.id, mockReport);

          // Helper to update local project state so UI reflects the new session
          const updatedSessions = [...(project.researchSessions || []), latestSession];
          const updatedProjectForState = { ...project, researchSessions: updatedSessions };
          onProjectUpdate(updatedProjectForState);
        } catch (e) {
          console.error('Failed to create fallback session:', e);
        }
      }

      if (latestSession) {
        const websiteVersion = newWebsite.data as SavedWebsiteVersion;
        const updatedVersions = [websiteVersion, ...(latestSession.websiteVersions || [])];
        try {
          await storageService.updateResearchInProject(project.id, latestSession.id, {
            websiteVersions: updatedVersions
          });
          setEcommerceSaveMessage(`E-commerce store saved with ${productsToUse.length} products!`);
        } catch (err: any) {
          console.error('Failed to save e-commerce store to Firestore:', err);
          setEcommerceSaveMessage(`E-commerce store generated (local only - sync failed)`);
        }
      } else {
        setEcommerceSaveMessage(`E-commerce store generated with ${productsToUse.length} products (failed to create session)`);
      }

      // Open the generated website
      setSelectedWebsite(newWebsite.data as SavedWebsiteVersion);

    } catch (e: any) {
      console.error('E-commerce generation error:', e);
      setEcommerceError(e.message || 'Failed to generate e-commerce store.');
    } finally {
      setIsGeneratingEcommerce(false);
    }
  };

  const handleSendFulfillmentOld = async () => {
    if (!selectedOrder || !fulfillmentFile) {
      setFulfillmentError('Please select a file to send.');
      return;
    }

    setIsSendingFulfillment(true);
    setFulfillmentError(null);

    try {
      // 1. Upload file to storage first (simulated or real upload)
      // For now, we'll assume we pass the file to the email API directly if small, 
      // or we would upload to Firebase Storage and send the link.
      // Given we don't have a backend to handle FormData easily in the placeholder,
      // let's convert to base64 for the mock email.

      const reader = new FileReader();
      reader.readAsDataURL(fulfillmentFile);

      reader.onload = async () => {
        const base64File = reader.result as string;

        // 2. Call Email API
        const res = await authFetch('/api/email?op=send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: selectedOrder.customerEmail,
            subject: `Your Order #${selectedOrder.id.slice(-6)} is ready`,
            html: `
              <h1>Order Fulfillment</h1>
              <p>Hi ${selectedOrder.customerName || 'there'},</p>
              <p>Thank you for your purchase!</p>
              <p>${fulfillmentMessage || 'Please find your purchased digital product attached.'}</p>
              <br/>
              <p>Order ID: ${selectedOrder.id}</p>
            `,
            attachments: [
              {
                filename: fulfillmentFile.name,
                content: base64File.split(',')[1],
                type: fulfillmentFile.type,
              }
            ]
          }),
        });

        const data = await res.json();

        if (data.success) {
          setFulfillmentSuccess('Order fulfilled successfully! Email sent.');
          setTimeout(() => {
            setIsFulfillmentModalOpen(false);
            setFulfillmentSuccess(null);
          }, 2000);
        } else {
          setFulfillmentError(data.error || 'Failed to send email.');
        }
      };

      reader.onerror = () => {
        setFulfillmentError('Failed to read file.');
        setIsSendingFulfillment(false);
      };

    } catch (e: any) {
      console.error('Fulfillment error:', e);
      setFulfillmentError(e.message || 'An error occurred.');
    } finally {
      setIsSendingFulfillment(false);
    }
  };

  const createBlankTableAsset = useCallback((): TableAsset => {
    const id = typeof crypto !== 'undefined' && (crypto as any).randomUUID
      ? (crypto as any).randomUUID()
      : `table-${Date.now()}`;
    const columns = Array.from({ length: 6 }, (_, i) => `${String.fromCharCode(65 + i)}`);
    const rows = Array.from({ length: 12 }, () => new Array(columns.length).fill(''));
    return {
      id,
      title: '',
      description: undefined,
      columns,
      rows,
      createdAt: Date.now(),
    };
  }, []);

  useEffect(() => {
    if (filterType !== 'tables') return;
    if (isGeneratingTable) return;
    if (generatedTable) return;
    setGeneratedTable(createBlankTableAsset());
  }, [createBlankTableAsset, filterType, generatedTable, isGeneratingTable]);

  // Handle initialTable prop from SEO tab
  useEffect(() => {
    if (initialTable) {
      setGeneratedTable(initialTable);
      setFilterType('tables');
    }
  }, [initialTable]);

  const getColumnLabel = (index: number): string => {
    let label = '';
    let n = index;
    while (n >= 0) {
      label = String.fromCharCode((n % 26) + 65) + label;
      n = Math.floor(n / 26) - 1;
    }
    return label;
  };

  // Credit System State
  const [insufficientCreditsModal, setInsufficientCreditsModal] = useState<{
    isOpen: boolean;
    operation: CreditOperation;
    cost: number;
    current: number;
  } | null>(null);

  const [usageLimitModal, setUsageLimitModal] = useState<{
    isOpen: boolean;
    usageType: UsageType;
    current: number;
    limit: number;
  } | null>(null);

  const checkCredits = async (operation: CreditOperation): Promise<boolean> => {
    const hasCredits = await hasEnoughCredits(operation);
    if (!hasCredits) {
      const current = await getUserCredits();
      setInsufficientCreditsModal({
        isOpen: true,
        operation,
        cost: CREDIT_COSTS[operation],
        current
      });
      return false;
    }
    return true;
  };

  const loadGoogleDocsFiles = async (options?: { reset?: boolean }) => {
    if (!googleDriveConnected) return;
    const reset = Boolean(options?.reset);
    setGoogleDocsListLoading(true);
    setGoogleDocsMessage(null);
    try {
      const pageToken = reset ? '' : (googleDocsNextPageToken || '');
      const qs = new URLSearchParams();
      qs.set('mimeType', 'application/vnd.google-apps.document');
      if (googleDocsQuery.trim()) qs.set('q', googleDocsQuery.trim());
      if (pageToken) qs.set('pageToken', pageToken);
      qs.set('pageSize', '25');

      const res = await authFetch(`/api/google-drive-files?${qs.toString()}`, { method: 'GET' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || 'Failed to list Google Docs files');
      }
      const files = Array.isArray(data?.files) ? data.files : [];
      setGoogleDocsFiles(prev => (reset ? files : [...prev, ...files]));
      setGoogleDocsNextPageToken(data?.nextPageToken ? String(data.nextPageToken) : null);
    } catch (e: any) {
      setGoogleDocsMessage(e?.message || 'Failed to list Google Docs files');
    } finally {
      setGoogleDocsListLoading(false);
    }
  };

  const handleLoadDoc = async (documentId: string, title: string) => {
    setGoogleDocsLoadLoading(true);
    setGoogleDocsMessage(null);
    try {
      const res = await authFetch(`/api/google-docs-get?documentId=${encodeURIComponent(documentId)}`, { method: 'GET' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (data?.needsReauth) {
          throw new Error('Google connection needs Docs permission. Click Reconnect Google to re-authorize.');
        }
        throw new Error(data?.error || 'Failed to load document');
      }
      const nextTitle = String(data?.title || title || '');
      const nextText = String(data?.text || '');
      setGoogleDocsSelected({ documentId, title: nextTitle });
      setGoogleDocsText(nextText);
      setGoogleDocsLastLoadedText(nextText);
      setGoogleDocsLastSavedAt(null);
      setGoogleDocsPickerOpen(false);

      // Persist to project for AI context
      if (onProjectUpdate) {
        const existingSyncedDocs = project.googleIntegrations?.syncedDocs || [];
        const updatedSyncedDocs = [
          ...existingSyncedDocs.filter(d => d.documentId !== documentId),
          {
            documentId,
            title: nextTitle,
            text: nextText,
            lastSyncedAt: Date.now(),
          }
        ];
        onProjectUpdate({
          ...project,
          googleIntegrations: {
            ...project.googleIntegrations,
            syncedDocs: updatedSyncedDocs,
          },
          lastModified: Date.now(),
        });
      }
    } catch (e: any) {
      setGoogleDocsMessage(e?.message || 'Failed to load document');
    } finally {
      setGoogleDocsLoadLoading(false);
    }
  };

  const handleSaveDoc = useCallback(async (): Promise<boolean> => {
    if (!googleDocsSelected) {
      setGoogleDocsMessage('Pick a Google Doc first');
      return false;
    }

    const { documentId } = googleDocsSelected;
    const isBlog = documentId.startsWith('blog-') || documentId.startsWith('local-blog-');

    setGoogleDocsSaveLoading(true);
    setGoogleDocsMessage(null);
    try {
      if (!isBlog) {
        // Traditional Google Docs save path
        const res = await authFetch('/api/google-docs-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ documentId: googleDocsSelected.documentId, text: googleDocsText }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          if (data?.needsReauth) {
            throw new Error('Google connection needs Docs permission. Click Reconnect Google to re-authorize.');
          }
          throw new Error(data?.error || 'Failed to save document');
        }
        setGoogleDocsMessage('Saved to Google Docs');
      } else {
        // Blog save path
        if (documentId.startsWith('blog-')) {
          const sessionId = documentId.replace('blog-', '');
          const sessions = project.researchSessions || [];
          const session = sessions.find(s => s.id === sessionId);
          if (session && session.researchReport) {
            const updatedBlog = {
              ...(session.researchReport.blogPost as BlogPost),
              content: googleDocsText
            };
            await storageService.updateResearchInProject(project.id, session.id, {
              researchReport: {
                ...session.researchReport,
                blogPost: updatedBlog,
              },
            });
            onProjectUpdate?.({
              ...project,
              researchSessions: project.researchSessions?.map(s =>
                s.id === sessionId
                  ? { ...s, researchReport: { ...s.researchReport!, blogPost: updatedBlog } }
                  : s
              ),
              lastModified: Date.now(),
            });
          }
        } else if (documentId.startsWith('local-blog-')) {
          setLocalGeneratedBlogs(prev => prev.map(asset =>
            asset.id === documentId
              ? { ...asset, data: { ...(asset.data as BlogPost), content: googleDocsText } }
              : asset
          ));
        }
        setGoogleDocsMessage('Saved to project assets');
      }

      setGoogleDocsLastLoadedText(googleDocsText);
      setGoogleDocsLastSavedAt(Date.now());
      return true;
    } catch (e: any) {
      setGoogleDocsMessage(e?.message || 'Failed to save document');
      return false;
    } finally {
      setGoogleDocsSaveLoading(false);
    }
  }, [googleDocsSelected, googleDocsText, project, onProjectUpdate]);

  const googleDocsIsDirty = useMemo(() => {
    if (!googleDocsSelected) return false;
    return googleDocsText !== googleDocsLastLoadedText;
  }, [googleDocsSelected, googleDocsText, googleDocsLastLoadedText]);

  // Dynamic Sync: Auto-save debounce timer ref
  const googleDocsAutoSaveTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const [googleDocsAutoSaving, setGoogleDocsAutoSaving] = useState(false);
  const [googleDocsSyncStatus, setGoogleDocsSyncStatus] = useState<'synced' | 'syncing' | 'error' | 'idle'>('idle');

  // Dynamic Sync: Auto-save when text changes (debounced)
  useEffect(() => {
    // Only auto-save for real Google Docs (not local blogs)
    if (!googleDocsSelected) return;
    if (googleDocsSelected.documentId.startsWith('blog-') || googleDocsSelected.documentId.startsWith('local-blog-')) return;
    if (!googleDocsIsDirty) return;

    // Clear any pending save
    if (googleDocsAutoSaveTimeoutRef.current) {
      clearTimeout(googleDocsAutoSaveTimeoutRef.current);
    }

    // Debounce: wait 2 seconds after user stops typing before auto-saving
    googleDocsAutoSaveTimeoutRef.current = setTimeout(async () => {
      setGoogleDocsAutoSaving(true);
      setGoogleDocsSyncStatus('syncing');
      try {
        const res = await authFetch('/api/google-docs-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ documentId: googleDocsSelected.documentId, text: googleDocsText }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data?.error || 'Auto-save failed');
        }
        setGoogleDocsLastLoadedText(googleDocsText);
        setGoogleDocsLastSavedAt(Date.now());
        setGoogleDocsSyncStatus('synced');

        // Persist synced content to project for AI context
        if (onProjectUpdate && googleDocsSelected) {
          const existingSyncedDocs = project.googleIntegrations?.syncedDocs || [];
          const updatedSyncedDocs = [
            ...existingSyncedDocs.filter(d => d.documentId !== googleDocsSelected.documentId),
            {
              documentId: googleDocsSelected.documentId,
              title: googleDocsSelected.title,
              text: googleDocsText,
              lastSyncedAt: Date.now(),
            }
          ];
          onProjectUpdate({
            ...project,
            googleIntegrations: {
              ...project.googleIntegrations,
              syncedDocs: updatedSyncedDocs,
            },
            lastModified: Date.now(),
          });
        }
      } catch (e: any) {
        console.error('[Google Docs Auto-save]', e?.message);
        setGoogleDocsSyncStatus('error');
      } finally {
        setGoogleDocsAutoSaving(false);
      }
    }, 2000);

    return () => {
      if (googleDocsAutoSaveTimeoutRef.current) {
        clearTimeout(googleDocsAutoSaveTimeoutRef.current);
      }
    };
  }, [googleDocsSelected, googleDocsText, googleDocsIsDirty]);

  // Dynamic Sync: Refresh document from Google Docs when window becomes visible
  const googleDocsLastRefreshRef = useRef<number>(0);

  useEffect(() => {
    if (!googleDocsSelected) return;
    // Skip for local blogs
    if (googleDocsSelected.documentId.startsWith('blog-') || googleDocsSelected.documentId.startsWith('local-blog-')) return;

    const handleVisibilityChange = async () => {
      if (document.visibilityState !== 'visible') return;

      // Throttle: don't refresh more than once every 5 seconds
      const now = Date.now();
      if (now - googleDocsLastRefreshRef.current < 5000) return;
      googleDocsLastRefreshRef.current = now;

      // Don't refresh if we have unsaved local changes (user is actively editing)
      if (googleDocsIsDirty) return;

      try {
        setGoogleDocsSyncStatus('syncing');
        const res = await authFetch(`/api/google-docs-get?documentId=${encodeURIComponent(googleDocsSelected.documentId)}`, { method: 'GET' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data?.error || 'Refresh failed');
        }
        const remoteText = String(data?.text || '');
        // Only update if remote has changed and we don't have local edits
        if (remoteText !== googleDocsLastLoadedText) {
          setGoogleDocsText(remoteText);
          setGoogleDocsLastLoadedText(remoteText);
          setGoogleDocsMessage('Synced latest changes from Google Docs');
          setTimeout(() => setGoogleDocsMessage(null), 3000);

          // Persist synced content to project for AI context
          if (onProjectUpdate) {
            const existingSyncedDocs = project.googleIntegrations?.syncedDocs || [];
            const updatedSyncedDocs = [
              ...existingSyncedDocs.filter(d => d.documentId !== googleDocsSelected.documentId),
              {
                documentId: googleDocsSelected.documentId,
                title: googleDocsSelected.title,
                text: remoteText,
                lastSyncedAt: Date.now(),
              }
            ];
            onProjectUpdate({
              ...project,
              googleIntegrations: {
                ...project.googleIntegrations,
                syncedDocs: updatedSyncedDocs,
              },
              lastModified: Date.now(),
            });
          }
        }
        setGoogleDocsSyncStatus('synced');
      } catch (e: any) {
        console.error('[Google Docs Refresh]', e?.message);
        setGoogleDocsSyncStatus('error');
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);

    // Also refresh on initial load (when doc is first selected)
    googleDocsLastRefreshRef.current = Date.now();

    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [googleDocsSelected, googleDocsIsDirty, googleDocsLastLoadedText]);

  const insertGoogleDocsInlineImageToken = useCallback((url: string) => {
    if (!googleDocsSelected) return;
    const width = Number((googleDocsImageWidthPx || '').trim());
    const height = Number((googleDocsImageHeightPx || '').trim());

    const parts: string[] = [url];
    if (Number.isFinite(width) && width > 0) parts.push(`w=${Math.round(width)}`);
    if (Number.isFinite(height) && height > 0) parts.push(`h=${Math.round(height)}`);
    const token = `[[IMAGE:${parts.join('|')}]]`;

    const el = googleDocsTextareaRef.current;
    const start = el ? el.selectionStart : googleDocsText.length;
    const end = el ? el.selectionEnd : googleDocsText.length;
    const before = googleDocsText.slice(0, start);
    const after = googleDocsText.slice(end);
    const needsNewlineBefore = before.length && !before.endsWith('\n');
    const insertion = `${needsNewlineBefore ? '\n' : ''}${token}\n`;

    const nextText = before + insertion + after;
    setGoogleDocsText(nextText);

    requestAnimationFrame(() => {
      const nextEl = googleDocsTextareaRef.current;
      if (!nextEl) return;
      const cursor = (before + insertion).length;
      nextEl.focus();
      nextEl.setSelectionRange(cursor, cursor);
    });
  }, [googleDocsSelected, googleDocsText, googleDocsImageWidthPx, googleDocsImageHeightPx]);

  useEffect(() => {
    if (!googleDocsInsertImageMenuOpen) return;

    const onMouseDown = (e: MouseEvent) => {
      const target = e.target as Node | null;
      if (!target) return;
      const container = googleDocsInsertImageMenuRef.current;
      if (!container) return;
      if (!container.contains(target)) {
        setGoogleDocsInsertImageMenuOpen(false);
      }
    };

    window.addEventListener('mousedown', onMouseDown);
    return () => window.removeEventListener('mousedown', onMouseDown);
  }, [googleDocsInsertImageMenuOpen]);

  const persistDocsInlineImageKbFile = async (kbFile: KnowledgeBaseFile) => {
    const existingKb = project.knowledgeBase || [];
    const updatedKnowledgeBase = [...existingKb, kbFile];
    try {
      await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
    } catch (err) {
      console.error('Failed to persist Docs inline image into project knowledge base', err);
    }
    onProjectUpdate?.({
      ...project,
      knowledgeBase: updatedKnowledgeBase,
      lastModified: Date.now(),
    });
  };

  const handleDocsInlineImageUpload = async (file: File) => {
    if (!googleDocsSelected) {
      setGoogleDocsMessage('Pick a Google Doc first');
      return;
    }
    if (!file) return;

    setGoogleDocsMessage(null);
    try {
      const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);
      await persistDocsInlineImageKbFile(kbFile);

      if (kbFile?.url) {
        insertGoogleDocsInlineImageToken(String(kbFile.url));
      }
    } catch (e: any) {
      setGoogleDocsMessage(e?.message || 'Failed to upload image');
    }
  };

  const handleDocsInlineImageGenerate = async () => {
    if (!googleDocsSelected) {
      setGoogleDocsMessage('Pick a Google Doc first');
      return;
    }

    const prompt = googleDocsGenerateImagePrompt.trim();
    if (!prompt) return;

    setGoogleDocsGenerateImageLoading(true);
    setGoogleDocsMessage(null);
    try {
      const ctx = contextService.buildProjectContext(project);
      const magicPrompt = await refinePromptWithGemini3(
        prompt,
        ctx.fullContext,
        'image',
        googleDocsText
      );
      const result = await generateImageWithReferences(magicPrompt, []);
      const url = result.imageDataUrl;

      const res = await fetch(url);
      const blob = await res.blob();
      const ext = (blob.type || '').includes('jpeg') ? 'jpg' : 'png';
      const fileName = `docs-inline-image-${Date.now()}.${ext}`;
      const file = new File([blob], fileName, { type: blob.type || 'image/png' });

      const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);
      await persistDocsInlineImageKbFile(kbFile);

      if (kbFile?.url) {
        insertGoogleDocsInlineImageToken(String(kbFile.url));
      }

      setGoogleDocsGenerateImagePrompt('');
      setGoogleDocsGenerateImageOpen(false);
    } catch (e: any) {
      setGoogleDocsMessage(e?.message || 'Failed to generate image');
    } finally {
      setGoogleDocsGenerateImageLoading(false);
    }
  };

  useEffect(() => {
    if (typeof window === 'undefined') return;
    const api = {
      getDraft: () => ({
        documentId: googleDocsSelected?.documentId || null,
        title: googleDocsSelected?.title || null,
        text: googleDocsText,
      }),
      setDraftText: (text: string) => {
        if (!googleDocsSelected) throw new Error('No Google Doc loaded in the Docs tab');
        setGoogleDocsText(String(text ?? ''));
      },
      appendDraftText: (text: string, separator?: string) => {
        if (!googleDocsSelected) throw new Error('No Google Doc loaded in the Docs tab');
        const sep = typeof separator === 'string' ? separator : '\n';
        setGoogleDocsText(prev => `${prev || ''}${sep}${String(text ?? '')}`);
      },
      replaceDraftText: (find: string, replace: string, opts?: { useRegex?: boolean; caseSensitive?: boolean }) => {
        if (!googleDocsSelected) throw new Error('No Google Doc loaded in the Docs tab');
        const useRegex = !!opts?.useRegex;
        const caseSensitive = !!opts?.caseSensitive;
        setGoogleDocsText(prev => {
          const base = String(prev ?? '');
          if (!find) return base;
          if (useRegex) {
            const flags = `g${caseSensitive ? '' : 'i'}`;
            const re = new RegExp(find, flags);
            return base.replace(re, String(replace ?? ''));
          }
          if (caseSensitive) {
            return base.split(find).join(String(replace ?? ''));
          }
          const escaped = find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(escaped, 'gi');
          return base.replace(re, String(replace ?? ''));
        });
      },
      insertInlineImage: (url: string, widthPx?: number, heightPx?: number) => {
        if (!googleDocsSelected) throw new Error('No Google Doc loaded in the Docs tab');
        const parts: string[] = [String(url || '').trim()];
        if (typeof widthPx === 'number' && Number.isFinite(widthPx) && widthPx > 0) parts.push(`w=${Math.round(widthPx)}`);
        if (typeof heightPx === 'number' && Number.isFinite(heightPx) && heightPx > 0) parts.push(`h=${Math.round(heightPx)}`);
        const token = `[[IMAGE:${parts.join('|')}]]`;
        const el = googleDocsTextareaRef.current;
        const start = el ? el.selectionStart : googleDocsText.length;
        const end = el ? el.selectionEnd : googleDocsText.length;
        const before = googleDocsText.slice(0, start);
        const after = googleDocsText.slice(end);
        const needsNewlineBefore = before.length && !before.endsWith('\n');
        const insertion = `${needsNewlineBefore ? '\n' : ''}${token}\n`;
        const nextText = before + insertion + after;
        setGoogleDocsText(nextText);
      },
      save: async () => {
        return await handleSaveDoc();
      },
    };

    (window as any).__researchrDocsEditor = api;
    return () => {
      try {
        if ((window as any).__researchrDocsEditor === api) {
          delete (window as any).__researchrDocsEditor;
        }
      } catch {
      }
    };
  }, [googleDocsSelected, googleDocsText, handleSaveDoc]);

  useEffect(() => {
    if (typeof window === 'undefined') return;
    const api = {
      getTable: () => {
        const t = generatedTable;
        if (!t) return { table: null };
        return {
          table: {
            id: t.id,
            title: t.title,
            description: t.description,
            columns: Array.isArray(t.columns) ? t.columns : [],
            rows: Array.isArray(t.rows) ? t.rows : [],
            googleSpreadsheetId: (t as any).googleSpreadsheetId || null,
            googleSheetTitle: (t as any).googleSheetTitle || null,
          }
        };
      },
      setTableTitle: (title: string) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          return { ...prev, title: String(title ?? '') };
        });
      },
      setTableDescription: (description: string) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          return { ...prev, description: String(description ?? '') };
        });
      },
      setCell: (rowIndex: number, colIndex: number, value: string) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          const r = Number(rowIndex);
          const c = Number(colIndex);
          if (!Number.isInteger(r) || !Number.isInteger(c)) throw new Error('rowIndex and colIndex must be integers');
          if (r < 0 || r >= prev.rows.length) throw new Error('rowIndex out of range');
          if (c < 0 || c >= prev.columns.length) throw new Error('colIndex out of range');
          const nextRows = prev.rows.map((row, ri) => {
            if (ri !== r) return row;
            return row.map((cell, ci) => (ci === c ? String(value ?? '') : cell));
          });
          return { ...prev, rows: nextRows };
        });
      },
      addRow: (index?: number) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          const newRow = new Array(prev.columns.length).fill('');
          const idx = typeof index === 'number' && Number.isFinite(index) ? Math.max(0, Math.min(prev.rows.length, Math.floor(index))) : prev.rows.length;
          const nextRows = [...prev.rows.slice(0, idx), newRow, ...prev.rows.slice(idx)];
          return { ...prev, rows: nextRows };
        });
      },
      deleteRow: (rowIndex: number) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          const r = Number(rowIndex);
          if (!Number.isInteger(r)) throw new Error('rowIndex must be an integer');
          if (r < 0 || r >= prev.rows.length) throw new Error('rowIndex out of range');
          return { ...prev, rows: prev.rows.filter((_, i) => i !== r) };
        });
      },
      addColumn: (name?: string, index?: number) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          const label = String(name ?? '').trim() || `Column ${getColumnLabel(prev.columns.length)}`;
          const idx = typeof index === 'number' && Number.isFinite(index) ? Math.max(0, Math.min(prev.columns.length, Math.floor(index))) : prev.columns.length;

          const nextColumns = [...prev.columns.slice(0, idx), label, ...prev.columns.slice(idx)];
          const nextRows = prev.rows.map(row => {
            const next = [...row];
            next.splice(idx, 0, '');
            return next;
          });

          return { ...prev, columns: nextColumns, rows: nextRows };
        });
      },
      deleteColumn: (colIndex: number) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          const c = Number(colIndex);
          if (!Number.isInteger(c)) throw new Error('colIndex must be an integer');
          if (c < 0 || c >= prev.columns.length) throw new Error('colIndex out of range');
          const nextColumns = prev.columns.filter((_, i) => i !== c);
          const nextRows = prev.rows.map(row => row.filter((_, i) => i !== c));
          return { ...prev, columns: nextColumns, rows: nextRows };
        });
      },
      renameColumn: (colIndex: number, name: string) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          const c = Number(colIndex);
          if (!Number.isInteger(c)) throw new Error('colIndex must be an integer');
          if (c < 0 || c >= prev.columns.length) throw new Error('colIndex out of range');
          const nextColumns = prev.columns.map((col, i) => (i === c ? String(name ?? '') : col));
          return { ...prev, columns: nextColumns };
        });
      },
      setColumns: (columns: string[]) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          if (!Array.isArray(columns)) throw new Error('columns must be an array');
          const nextColumns = columns.map(c => String(c ?? ''));
          const nextRows = prev.rows.map(row => {
            const next = nextColumns.map((_, i) => (row[i] == null ? '' : String(row[i])));
            return next;
          });
          return { ...prev, columns: nextColumns, rows: nextRows };
        });
      },
      setRows: (rows: string[][]) => {
        setGeneratedTable(prev => {
          if (!prev) throw new Error('No table loaded');
          if (!Array.isArray(rows)) throw new Error('rows must be an array');
          const nextRows = rows.map(r => {
            const arr = Array.isArray(r) ? r : [];
            return prev.columns.map((_, i) => (arr[i] == null ? '' : String(arr[i])));
          });
          return { ...prev, rows: nextRows };
        });
      },
    };

    (window as any).__researchrTableEditor = api;
    return () => {
      try {
        if ((window as any).__researchrTableEditor === api) {
          delete (window as any).__researchrTableEditor;
        }
      } catch {
      }
    };
  }, [generatedTable]);

  const googleDocsPreviewParts = useMemo(() => {
    const text = (googleDocsText || '').toString();
    const re = /\[\[IMAGE:([^\]]+)\]\]/g;
    const parts: Array<
      | { type: 'text'; value: string }
      | { type: 'image'; url: string; widthPx?: number; heightPx?: number }
    > = [];

    const parseToken = (raw: string) => {
      const segments = String(raw || '')
        .split('|')
        .map(s => s.trim())
        .filter(Boolean);
      const url = segments[0] || '';
      const out: { url: string; widthPx?: number; heightPx?: number } = { url };
      for (const seg of segments.slice(1)) {
        const lower = seg.toLowerCase();
        if (lower.startsWith('w=')) {
          const n = Number(lower.slice(2));
          if (Number.isFinite(n) && n > 0) out.widthPx = n;
        }
        if (lower.startsWith('h=')) {
          const n = Number(lower.slice(2));
          if (Number.isFinite(n) && n > 0) out.heightPx = n;
        }
      }
      return out;
    };

    let last = 0;
    let match: RegExpExecArray | null;
    while ((match = re.exec(text)) !== null) {
      const before = text.slice(last, match.index);
      if (before) parts.push({ type: 'text', value: before });

      const parsed = parseToken(match[1]);
      if (parsed.url && /^https?:\/\//i.test(parsed.url)) {
        parts.push({ type: 'image', url: parsed.url, widthPx: parsed.widthPx, heightPx: parsed.heightPx });
      } else {
        parts.push({ type: 'text', value: match[0] });
      }

      last = match.index + match[0].length;
    }
    const tail = text.slice(last);
    if (tail) parts.push({ type: 'text', value: tail });
    return parts;
  }, [googleDocsText]);

  useEffect(() => {
    if (filterType !== 'docs') return;
    const onKeyDown = (e: KeyboardEvent) => {
      const key = (e.key || '').toLowerCase();
      if (key !== 's') return;
      if (!(e.ctrlKey || e.metaKey)) return;
      if (!googleDocsSelected) return;
      e.preventDefault();
      if (googleDocsSaveLoading) return;
      handleSaveDoc();
    };
    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [filterType, googleDocsSelected, googleDocsSaveLoading, googleDocsText]);

  const formatSheetTitleForA1 = (title: string) => {
    const raw = (title || '').toString();
    const escaped = raw.replace(/'/g, "''");
    return `'${escaped}'`;
  };

  const sheetPrefix = (title: string) => `${formatSheetTitleForA1(title)}!`;

  const buildConservativeClearRange = (sheetTitle: string, table: TableAsset) => {
    const cols = Math.max(table.columns.length || 1, 52);
    const rows = Math.max((table.rows?.length || 0) + 1, 1000);
    const lastCol = getColumnLabel(cols - 1);
    return `${sheetPrefix(sheetTitle)}A1:${lastCol}${rows}`;
  };

  const refreshGoogleDriveStatus = async () => {
    setGoogleDriveStatusLoading(true);
    try {
      const res = await authFetch('/api/google-drive-status', { method: 'GET' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || 'Failed to load Google Drive status');
      }
      setGoogleDriveConnected(Boolean(data?.connected));
    } catch {
      setGoogleDriveConnected(false);
    } finally {
      setGoogleDriveStatusLoading(false);
    }
  };

  useEffect(() => {
    refreshGoogleDriveStatus();
  }, []);

  useEffect(() => {
    if (filterType === 'tables' || filterType === 'docs') {
      refreshGoogleDriveStatus();
    }
  }, [filterType]);

  useEffect(() => {
    const onFocus = () => {
      if (filterType === 'tables' || filterType === 'docs') {
        refreshGoogleDriveStatus();
      }
    };
    window.addEventListener('focus', onFocus);
    return () => window.removeEventListener('focus', onFocus);
  }, [filterType]);

  useEffect(() => {
    const handler = (event: MessageEvent) => {
      if (event.origin !== window.location.origin) return;
      if (!event.data || (event.data as any).type !== 'google-drive:connected') return;
      refreshGoogleDriveStatus();
    };
    window.addEventListener('message', handler);
    return () => window.removeEventListener('message', handler);
  }, []);

  // Refresh job list periodically when on Videos tab
  useEffect(() => {
    if (filterType !== 'videos') {
      // Clear interval when leaving videos tab
      if (jobRefreshIntervalRef.current) {
        clearInterval(jobRefreshIntervalRef.current);
        jobRefreshIntervalRef.current = null;
      }
      return;
    }

    // Fetch jobs immediately on mount
    const fetchJobs = async () => {
      try {
        const jobs = await listVideoOverviewJobs(project.id);
        setAllVideoOverviewJobs(jobs);
      } catch (e) {
        console.warn('[ProjectAssets] Failed to fetch video overview jobs:', e);
      }
    };

    fetchJobs();

    // Refresh every 5 seconds
    jobRefreshIntervalRef.current = setInterval(fetchJobs, 5000);

    return () => {
      if (jobRefreshIntervalRef.current) {
        clearInterval(jobRefreshIntervalRef.current);
        jobRefreshIntervalRef.current = null;
      }
    };
  }, [filterType, project.id]);

  // Restore in-progress video overview jobs when Video tab is active
  useEffect(() => {
    if (filterType !== 'videos') return;
    if (isResumingVideoJobRef.current) return;

    let cancelled = false;

    const checkForActiveJobs = async () => {
      try {
        isResumingVideoJobRef.current = true;
        console.log('[ProjectAssets] Checking for in-progress video overview jobs for project:', project.id);
        const jobs = await listVideoOverviewJobs(project.id);
        console.log('[ProjectAssets] listVideoOverviewJobs returned:', jobs);

        if (cancelled) return;

        if (jobs.length > 0) {
          // Pick the most recent in-progress job
          const activeJob = jobs[0];

          // 1:  - Skip jobs older than 2 hours (likely stuck)
          const jobAge = Date.now() - activeJob.createdAt;
          const MAX_JOB_AGE_MS = 2 * 60 * 60 * 1000; // 2 hours

          if (jobAge > MAX_JOB_AGE_MS) {
            console.warn('[ProjectAssets] Job is too old (age:', Math.round(jobAge / 60000), 'min), skipping resume. User can start fresh.');
            // Don't resume old jobs - let user start a new one
            return;
          }

          console.log('[ProjectAssets] Found in-progress video overview job:', activeJob.jobId, activeJob.status, 'age:', Math.round(jobAge / 60000), 'min');

          setActiveVideoOverviewJob({
            jobId: activeJob.jobId,
            status: activeJob.status,
            progress: activeJob.progress,
          });
          setIsGeneratingVideo(true);
          setVideoType('overview'); // Ensure UI shows overview mode
          setVideoStatus(activeJob.progress || activeJob.status);
          setVideoError(null);

          // 2:  - Resume polling with timeout protection
          try {
            const result = await Promise.race([
              resumeVideoOverviewPolling(activeJob.jobId, (status, progress) => {
                if (cancelled) return;
                setActiveVideoOverviewJob(prev => prev ? { ...prev, status, progress } : null);
                setVideoStatus(progress || status);

                // Simulate progress for avatar generation
                if (status === 'generating_avatar' || status === 'processing') {
                  setVideoProgress(prev => {
                    if (prev === null) return 10;
                    return Math.min(95, prev + 0.5);
                  });
                }
              }),
              // Timeout after 30 seconds of no response
              new Promise<null>((_, reject) =>
                setTimeout(() => reject(new Error('Job resume timed out after 30s')), 30000)
              )
            ]);

            if (cancelled) return;

            if (result) {
              console.log('[ProjectAssets] Video overview job completed:', result.url);
              // Refresh project to show new asset
              if (onProjectUpdate) {
                try {
                  const freshProject = await storageService.getResearchProject(project.id);
                  if (freshProject) {
                    onProjectUpdate(freshProject);
                  }
                } catch (e) {
                  console.warn('[ProjectAssets] Failed to refresh project after video completion:', e);
                }
              }
              setVideoProgress(100);
              setVideoSaveMessage('Video saved to project assets!');
            } else {
              setVideoError('Video generation failed or timed out.');
            }
          } catch (resumeError: any) {
            // 3:  - Clear state on any failure so user can try again
            console.warn('[ProjectAssets] Failed to resume job, clearing state:', resumeError?.message);
            setVideoError('Previous job failed to resume. You can start a new video.');
          } finally {
            setIsGeneratingVideo(false);
            setActiveVideoOverviewJob(null);
          }
        }
      } catch (e) {
        console.warn('[ProjectAssets] Failed to check for active video jobs:', e);
      } finally {
        if (!cancelled) {
          isResumingVideoJobRef.current = false;
        }
      }
    };

    checkForActiveJobs();

    return () => {
      cancelled = true;
    };
  }, [filterType, project.id, onProjectUpdate]);

  const handleConnectGoogle = async () => {
    setGoogleSheetsMessage(null);
    try {
      const returnTo = `${window.location.pathname}${window.location.search}`;
      const res = await authFetch(`/api/google-drive-auth-url?returnTo=${encodeURIComponent(returnTo)}`, {
        method: 'GET',
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || 'Failed to start Google auth');
      }
      const url = String(data?.url || '').trim();
      if (!url) throw new Error('Missing auth url');
      const popup = window.open(url, 'googleDriveConnect', 'width=520,height=650');
      if (!popup) {
        window.location.assign(url);
      }
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to connect Google');
    }
  };

  const loadGoogleSheetsFiles = async (options?: { reset?: boolean }) => {
    if (!googleDriveConnected) return;
    const reset = Boolean(options?.reset);
    setGoogleSheetsListLoading(true);
    setGoogleSheetsMessage(null);
    try {
      const pageToken = reset ? '' : (googleSheetsNextPageToken || '');
      const qs = new URLSearchParams();
      qs.set('mimeType', 'application/vnd.google-apps.spreadsheet');
      if (googleSheetsQuery.trim()) qs.set('q', googleSheetsQuery.trim());
      if (pageToken) qs.set('pageToken', pageToken);
      qs.set('pageSize', '25');

      const res = await authFetch(`/api/google-drive-files?${qs.toString()}`, { method: 'GET' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data?.error || 'Failed to list Google Sheets files');
      }
      const files = Array.isArray(data?.files) ? data.files : [];
      setGoogleSheetsFiles(prev => (reset ? files : [...prev, ...files]));
      setGoogleSheetsNextPageToken(data?.nextPageToken ? String(data.nextPageToken) : null);
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to list Google Sheets files');
    } finally {
      setGoogleSheetsListLoading(false);
    }
  };

  const normalizeValuesToTable = (values: any[][], spreadsheetId: string, sheetTitle: string, title: string) => {
    const rowsArray: string[][] = Array.isArray(values) ? values.map(r => (Array.isArray(r) ? r : [])) : [];
    const maxCols = rowsArray.reduce((acc, row) => Math.max(acc, row.length), 0);
    const safeMaxCols = Math.max(1, maxCols);

    const headerRow = rowsArray.length ? rowsArray[0] : [];
    const columns = new Array(safeMaxCols).fill('').map((_, idx) => {
      const raw = headerRow[idx];
      const v = raw === undefined || raw === null ? '' : String(raw);
      return v.trim() ? v : getColumnLabel(idx);
    });

    const bodyRows = rowsArray.length > 1 ? rowsArray.slice(1) : [];
    const normalizedRows = bodyRows.map(r => {
      const base = new Array(safeMaxCols).fill('');
      for (let i = 0; i < safeMaxCols; i++) {
        const cell = r[i];
        base[i] = cell === undefined || cell === null ? '' : String(cell);
      }
      return base;
    });

    const asset: TableAsset = {
      id:
        typeof crypto !== 'undefined' && (crypto as any).randomUUID
          ? (crypto as any).randomUUID()
          : `sheet-table-${Date.now()}`,
      title: title || sheetTitle || 'Google Sheet',
      description: `Synced from Google Sheets (${sheetTitle})`,
      columns,
      rows: normalizedRows,
      createdAt: Date.now(),
      googleSpreadsheetId: spreadsheetId,
      googleSheetTitle: sheetTitle,
    };

    setGeneratedTable(asset);
    setTableError(null);
    setTableSaveMessage(null);
    // Establish baseline for sync tracking
    setGoogleSheetsLastSyncedData({ columns, rows: normalizedRows });
    setGoogleSheetsSyncStatus('synced');

    // Persist to project for AI context
    if (onProjectUpdate) {
      const existingSyncedSheets = project.googleIntegrations?.syncedSheets || [];
      const updatedSyncedSheets = [
        ...existingSyncedSheets.filter(s => s.spreadsheetId !== spreadsheetId),
        {
          spreadsheetId,
          sheetTitle,
          title: title || sheetTitle || 'Google Sheet',
          columns,
          rows: normalizedRows,
          lastSyncedAt: Date.now(),
        }
      ];
      onProjectUpdate({
        ...project,
        googleIntegrations: {
          ...project.googleIntegrations,
          syncedSheets: updatedSyncedSheets,
        },
        lastModified: Date.now(),
      });
    }
  };

  const handleLoadSpreadsheet = async (spreadsheetId: string, title: string) => {
    setGoogleSheetsLoadLoading(true);
    setGoogleSheetsMessage(null);
    try {
      const metaRes = await authFetch(
        `/api/google-sheets-metadata?spreadsheetId=${encodeURIComponent(spreadsheetId)}`,
        { method: 'GET' },
      );
      const meta = await metaRes.json().catch(() => ({}));
      if (!metaRes.ok) {
        throw new Error(meta?.error || 'Failed to load spreadsheet metadata');
      }

      const tabs: { sheetId: number; title: string }[] = Array.isArray(meta?.sheets) ? meta.sheets : [];
      setGoogleSheetsTabs(tabs);
      setGoogleSheetsSelectedSpreadsheet({ spreadsheetId, title: title || String(meta?.title || '') });

      const firstTab = tabs.length ? tabs[0].title : 'Sheet1';
      setGoogleSheetsSelectedTab(firstTab);

      const range = `${sheetPrefix(firstTab)}A1:ZZ500`;
      const valuesRes = await authFetch(
        `/api/google-sheets-values-get?spreadsheetId=${encodeURIComponent(spreadsheetId)}&range=${encodeURIComponent(range)}`,
        { method: 'GET' },
      );
      const valuesData = await valuesRes.json().catch(() => ({}));
      if (!valuesRes.ok) {
        throw new Error(valuesData?.error || 'Failed to load sheet values');
      }
      normalizeValuesToTable(valuesData?.values || [], spreadsheetId, firstTab, title);
      setGoogleSheetsPickerOpen(false);
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to load sheet');
    } finally {
      setGoogleSheetsLoadLoading(false);
    }
  };

  const handlePrepareSpreadsheetImport = async (spreadsheetId: string, title: string) => {
    setGoogleSheetsLoadLoading(true);
    setGoogleSheetsMessage(null);
    try {
      const metaRes = await authFetch(
        `/api/google-sheets-metadata?spreadsheetId=${encodeURIComponent(spreadsheetId)}`,
        { method: 'GET' },
      );
      const meta = await metaRes.json().catch(() => ({}));
      if (!metaRes.ok) {
        throw new Error(meta?.error || 'Failed to load spreadsheet metadata');
      }

      const tabs: { sheetId: number; title: string }[] = Array.isArray(meta?.sheets) ? meta.sheets : [];
      setGoogleSheetsTabs(tabs);
      setGoogleSheetsSelectedSpreadsheet({ spreadsheetId, title: title || String(meta?.title || '') });

      const firstTab = tabs.length ? tabs[0].title : 'Sheet1';
      setGoogleSheetsSelectedTab(firstTab);
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to load sheet');
    } finally {
      setGoogleSheetsLoadLoading(false);
    }
  };

  useEffect(() => {
    if (filterType !== 'tables' && googleSheetsPickerOpen) {
      setGoogleSheetsPickerOpen(false);
    }
  }, [filterType, googleSheetsPickerOpen]);

  const handleReloadSelectedTab = async (tabTitle: string) => {
    if (!googleSheetsSelectedSpreadsheet) return;
    setGoogleSheetsSelectedTab(tabTitle);
    setGoogleSheetsLoadLoading(true);
    setGoogleSheetsMessage(null);
    try {
      const spreadsheetId = googleSheetsSelectedSpreadsheet.spreadsheetId;
      const range = `${sheetPrefix(tabTitle)}A1:ZZ500`;
      const valuesRes = await authFetch(
        `/api/google-sheets-values-get?spreadsheetId=${encodeURIComponent(spreadsheetId)}&range=${encodeURIComponent(range)}`,
        { method: 'GET' },
      );
      const valuesData = await valuesRes.json().catch(() => ({}));
      if (!valuesRes.ok) {
        throw new Error(valuesData?.error || 'Failed to load sheet values');
      }
      normalizeValuesToTable(valuesData?.values || [], spreadsheetId, tabTitle, googleSheetsSelectedSpreadsheet.title);
      setGoogleSheetsPickerOpen(false);
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to load sheet');
    } finally {
      setGoogleSheetsLoadLoading(false);
    }
  };

  const buildSheetValuesPayload = (table: TableAsset) => {
    const header = table.columns.map(c => c || '');
    const rows = table.rows.map(r => r.map(c => c || ''));
    return [header, ...rows];
  };

  const handleSaveBackToSheet = async () => {
    if (!generatedTable?.googleSpreadsheetId || !generatedTable.googleSheetTitle) {
      setGoogleSheetsMessage('Load a Google Sheet first');
      return;
    }
    setGoogleSheetsSaveLoading(true);
    setGoogleSheetsMessage(null);
    try {
      const spreadsheetId = generatedTable.googleSpreadsheetId;
      const sheetTitle = generatedTable.googleSheetTitle;
      const clearRange = buildConservativeClearRange(sheetTitle, generatedTable);

      const clearRes = await authFetch('/api/google-sheets-values-clear', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spreadsheetId, range: clearRange }),
      });
      const clearData = await clearRes.json().catch(() => ({}));
      if (!clearRes.ok) {
        if (clearData?.needsReauth) {
          throw new Error('Google connection needs Sheets permission. Click Reconnect Google to re-authorize.');
        }
        throw new Error(clearData?.error || 'Failed to clear sheet range');
      }

      const values = buildSheetValuesPayload(generatedTable);
      const updateRes = await authFetch('/api/google-sheets-values-update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spreadsheetId, range: `${sheetPrefix(sheetTitle)}A1`, values, valueInputOption: 'USER_ENTERED' }),
      });
      const updateData = await updateRes.json().catch(() => ({}));
      if (!updateRes.ok) {
        if (updateData?.needsReauth) {
          throw new Error('Google connection needs Sheets permission. Click Reconnect Google to re-authorize.');
        }
        throw new Error(updateData?.error || 'Failed to update sheet');
      }
      setGoogleSheetsMessage('Saved to Google Sheets');
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to save to Google Sheets');
    } finally {
      setGoogleSheetsSaveLoading(false);
    }
  };

  const handleExportToNewSheet = async () => {
    if (!generatedTable) {
      setGoogleSheetsMessage('Generate or load a table first');
      return;
    }
    setGoogleSheetsSaveLoading(true);
    setGoogleSheetsMessage(null);
    try {
      const title = generatedTable.title || 'Researchr Table';
      const createRes = await authFetch('/api/google-sheets-create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title }),
      });
      const createData = await createRes.json().catch(() => ({}));
      if (!createRes.ok) {
        if (createData?.needsReauth) {
          throw new Error('Google connection needs Sheets permission. Click Reconnect Google to re-authorize.');
        }
        throw new Error(createData?.error || 'Failed to create spreadsheet');
      }

      const spreadsheetId = String(createData?.spreadsheetId || '').trim();
      const sheetTitle = String(createData?.sheetTitle || 'Sheet1');
      if (!spreadsheetId) throw new Error('Create spreadsheet returned no spreadsheetId');

      const values = buildSheetValuesPayload(generatedTable);
      const updateRes = await authFetch('/api/google-sheets-values-update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spreadsheetId, range: `${sheetPrefix(sheetTitle)}A1`, values, valueInputOption: 'USER_ENTERED' }),
      });
      const updateData = await updateRes.json().catch(() => ({}));
      if (!updateRes.ok) {
        if (updateData?.needsReauth) {
          throw new Error('Google connection needs Sheets permission. Click Reconnect Google to re-authorize.');
        }
        throw new Error(updateData?.error || 'Failed to write new spreadsheet');
      }

      const url = String(createData?.url || '').trim();
      if (url) {
        window.open(url, '_blank');
      }

      const updatedTable: TableAsset = {
        ...generatedTable,
        googleSpreadsheetId: spreadsheetId,
        googleSheetTitle: sheetTitle,
      };
      setGeneratedTable(updatedTable);
      // Establish baseline for sync tracking
      setGoogleSheetsLastSyncedData({ columns: updatedTable.columns, rows: updatedTable.rows });
      setGoogleSheetsSyncStatus('synced');
      setGoogleSheetsMessage('Exported to new Google Sheet');
    } catch (e: any) {
      setGoogleSheetsMessage(e?.message || 'Failed to export to Google Sheets');
    } finally {
      setGoogleSheetsSaveLoading(false);
    }
  };

  // ========== GOOGLE SHEETS DYNAMIC SYNC ==========
  // State for tracking sync status
  const googleSheetsAutoSaveTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const [googleSheetsAutoSaving, setGoogleSheetsAutoSaving] = useState(false);
  const [googleSheetsSyncStatus, setGoogleSheetsSyncStatus] = useState<'synced' | 'syncing' | 'error' | 'idle'>('idle');
  const googleSheetsLastRefreshRef = useRef<number>(0);
  const [googleSheetsLastSyncedData, setGoogleSheetsLastSyncedData] = useState<{ columns: string[]; rows: string[][] } | null>(null);

  // Auto-save to Google Sheets when table data changes (debounced)
  useEffect(() => {
    // Only auto-save if linked to a Google Sheet
    if (!generatedTable?.googleSpreadsheetId || !generatedTable.googleSheetTitle) return;
    if (!googleSheetsLastSyncedData) return; // Skip until initial load establishes baseline

    // Compare current data to last synced data
    const currentData = JSON.stringify({ columns: generatedTable.columns, rows: generatedTable.rows });
    const lastData = JSON.stringify(googleSheetsLastSyncedData);
    if (currentData === lastData) return; // No changes to sync

    // Clear any pending auto-save
    if (googleSheetsAutoSaveTimeoutRef.current) {
      clearTimeout(googleSheetsAutoSaveTimeoutRef.current);
    }

    // Debounce: wait 2 seconds after user stops editing before auto-saving
    googleSheetsAutoSaveTimeoutRef.current = setTimeout(async () => {
      setGoogleSheetsAutoSaving(true);
      setGoogleSheetsSyncStatus('syncing');
      try {
        const spreadsheetId = generatedTable.googleSpreadsheetId!;
        const sheetTitle = generatedTable.googleSheetTitle!;
        const clearRange = buildConservativeClearRange(sheetTitle, generatedTable);

        // Clear existing data
        const clearRes = await authFetch('/api/google-sheets-values-clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spreadsheetId, range: clearRange }),
        });
        if (!clearRes.ok) {
          const clearData = await clearRes.json().catch(() => ({}));
          throw new Error(clearData?.error || 'Auto-save failed: clear');
        }

        // Write updated data
        const values = buildSheetValuesPayload(generatedTable);
        const updateRes = await authFetch('/api/google-sheets-values-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spreadsheetId, range: `${sheetPrefix(sheetTitle)}A1`, values, valueInputOption: 'USER_ENTERED' }),
        });
        if (!updateRes.ok) {
          const updateData = await updateRes.json().catch(() => ({}));
          throw new Error(updateData?.error || 'Auto-save failed: update');
        }

        // Update baseline after successful save
        setGoogleSheetsLastSyncedData({ columns: generatedTable.columns, rows: generatedTable.rows });
        setGoogleSheetsSyncStatus('synced');

        // Persist synced content to project for AI context
        if (onProjectUpdate) {
          const existingSyncedSheets = project.googleIntegrations?.syncedSheets || [];
          const updatedSyncedSheets = [
            ...existingSyncedSheets.filter(s => s.spreadsheetId !== generatedTable.googleSpreadsheetId),
            {
              spreadsheetId: generatedTable.googleSpreadsheetId!,
              sheetTitle: generatedTable.googleSheetTitle!,
              title: generatedTable.title,
              columns: generatedTable.columns,
              rows: generatedTable.rows,
              lastSyncedAt: Date.now(),
            }
          ];
          onProjectUpdate({
            ...project,
            googleIntegrations: {
              ...project.googleIntegrations,
              syncedSheets: updatedSyncedSheets,
            },
            lastModified: Date.now(),
          });
        }
      } catch (e: any) {
        console.error('[Google Sheets Auto-save]', e?.message);
        setGoogleSheetsSyncStatus('error');
      } finally {
        setGoogleSheetsAutoSaving(false);
      }
    }, 2000);

    return () => {
      if (googleSheetsAutoSaveTimeoutRef.current) {
        clearTimeout(googleSheetsAutoSaveTimeoutRef.current);
      }
    };
  }, [generatedTable?.columns, generatedTable?.rows, generatedTable?.googleSpreadsheetId, generatedTable?.googleSheetTitle, googleSheetsLastSyncedData]);

  // Auto-refresh from Google Sheets when window becomes visible
  useEffect(() => {
    if (!generatedTable?.googleSpreadsheetId || !generatedTable.googleSheetTitle) return;

    const handleVisibilityChange = async () => {
      if (document.visibilityState !== 'visible') return;

      // Throttle: max once every 5 seconds
      const now = Date.now();
      if (now - googleSheetsLastRefreshRef.current < 5000) return;
      googleSheetsLastRefreshRef.current = now;

      // Don't refresh if we have unsaved local changes (user is actively editing)
      if (googleSheetsLastSyncedData) {
        const currentData = JSON.stringify({ columns: generatedTable.columns, rows: generatedTable.rows });
        const lastData = JSON.stringify(googleSheetsLastSyncedData);
        if (currentData !== lastData) return; // Local edits pending, don't overwrite
      }

      try {
        setGoogleSheetsSyncStatus('syncing');
        const range = `${sheetPrefix(generatedTable.googleSheetTitle)}A1:ZZ500`;
        const res = await authFetch(
          `/api/google-sheets-values-get?spreadsheetId=${encodeURIComponent(generatedTable.googleSpreadsheetId)}&range=${encodeURIComponent(range)}`,
          { method: 'GET' }
        );
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data?.error || 'Refresh failed');
        }

        const remoteValues: any[][] = data?.values || [];

        // Normalize remote values
        const rowsArray: string[][] = remoteValues.map(r => (Array.isArray(r) ? r : []));
        const maxCols = rowsArray.reduce((acc, row) => Math.max(acc, row.length), 0);
        const safeMaxCols = Math.max(1, maxCols);

        const headerRow = rowsArray.length ? rowsArray[0] : [];
        const remoteColumns = new Array(safeMaxCols).fill('').map((_, idx) => {
          const raw = headerRow[idx];
          return raw === undefined || raw === null ? '' : String(raw);
        });

        const bodyRows = rowsArray.length > 1 ? rowsArray.slice(1) : [];
        const remoteRows = bodyRows.map(r => {
          const base = new Array(safeMaxCols).fill('');
          for (let i = 0; i < safeMaxCols; i++) {
            const cell = r[i];
            base[i] = cell === undefined || cell === null ? '' : String(cell);
          }
          return base;
        });

        // Compare to current table
        const remoteDataStr = JSON.stringify({ columns: remoteColumns, rows: remoteRows });
        const currentDataStr = JSON.stringify({ columns: generatedTable.columns, rows: generatedTable.rows });

        if (remoteDataStr !== currentDataStr) {
          // Remote has changed - update the table
          const updatedColumns = remoteColumns.map((c, idx) => c.trim() ? c : getColumnLabel(idx));
          setGeneratedTable(prev => prev ? {
            ...prev,
            columns: updatedColumns,
            rows: remoteRows,
          } : prev);
          setGoogleSheetsLastSyncedData({ columns: remoteColumns, rows: remoteRows });
          setGoogleSheetsMessage('Synced latest changes from Google Sheets');
          setTimeout(() => setGoogleSheetsMessage(null), 3000);

          // Persist synced content to project for AI context
          if (onProjectUpdate) {
            const existingSyncedSheets = project.googleIntegrations?.syncedSheets || [];
            const updatedSyncedSheets = [
              ...existingSyncedSheets.filter(s => s.spreadsheetId !== generatedTable.googleSpreadsheetId),
              {
                spreadsheetId: generatedTable.googleSpreadsheetId!,
                sheetTitle: generatedTable.googleSheetTitle!,
                title: generatedTable.title,
                columns: updatedColumns,
                rows: remoteRows,
                lastSyncedAt: Date.now(),
              }
            ];
            onProjectUpdate({
              ...project,
              googleIntegrations: {
                ...project.googleIntegrations,
                syncedSheets: updatedSyncedSheets,
              },
              lastModified: Date.now(),
            });
          }
        }

        setGoogleSheetsSyncStatus('synced');
      } catch (e: any) {
        console.error('[Google Sheets Refresh]', e?.message);
        setGoogleSheetsSyncStatus('error');
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);

    // Set initial refresh timestamp
    googleSheetsLastRefreshRef.current = Date.now();

    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [generatedTable?.googleSpreadsheetId, generatedTable?.googleSheetTitle, generatedTable?.columns, generatedTable?.rows, googleSheetsLastSyncedData]);
  // ========== END GOOGLE SHEETS DYNAMIC SYNC ==========

  const getRelevantUploads = (prompt: string, limit = 3) => {
    if (!uploadedFiles.length || !prompt?.trim()) return [];
    const tokens = Array.from(
      new Set(
        prompt
          .toLowerCase()
          .split(/[^a-z0-9]+/)
          .filter(token => token.length > 2)
      )
    );

    if (!tokens.length) return [];

    return uploadedFiles
      .map(file => {
        const haystack = `${file.displayName || file.name || ''} ${file.summary || ''}`.toLowerCase();
        let score = 0;
        tokens.forEach(token => {
          if (haystack.includes(token)) {
            score += token.length >= 6 ? 2 : 1;
          }
        });
        return { file, score };
      })
      .filter(entry => entry.score > 0)
      .sort((a, b) => b.score - a.score)
      .slice(0, limit)
      .map(entry => entry.file);
  };

  const handleGenerateChart = useCallback(async () => {
    if (!generatedTable) return;
    const requestId = ++chartRequestIdRef.current;
    setIsGeneratingChart(true);
    setChartError(null);
    try {
      const html = await generateChartFromTable(
        {
          title: generatedTable.title,
          description: generatedTable.description,
          columns: generatedTable.columns,
          rows: generatedTable.rows,
        },
        tablePrompt,
        chartType,
        isDarkMode,
      );
      if (requestId === chartRequestIdRef.current) {
        setGeneratedChartHtml(html);
      }
    } catch (e: any) {
      console.error('Chart generation failed', e);
      if (requestId === chartRequestIdRef.current) {
        setChartError(e?.message || 'Chart generation failed');
      }
    } finally {
      if (requestId === chartRequestIdRef.current) {
        setIsGeneratingChart(false);
      }
    }
  }, [generatedTable, tablePrompt, chartType]);

  useEffect(() => {
    if (!generatedTable) return;
    if (!isVisualizeOpen) return;
    handleGenerateChart();
  }, [generatedTable, handleGenerateChart, isVisualizeOpen]);

  const handleGenerateBook = async () => {
    if (!bookPrompt.trim()) return;

    // Credit Check
    const hasCredits = await checkCredits('bookGeneration');
    if (!hasCredits) return;

    const success = await deductCredits('bookGeneration');
    if (!success) {
      setBookError('Failed to deduct credits');
      return;
    }

    setIsGeneratingBook(true);
    setBookError(null);
    setBookSaveMessage(null);
    setGeneratedBookPages([]);
    try {
      const targetPages = Math.max(4, Math.min(24, bookPageCount || 8));

      const ctx = contextService.buildProjectContext(project);

      const refinedBookPrompt = await refinePromptWithGemini3(bookPrompt, ctx.fullContext, 'text');

      const bookSpec: GeneratedBook = await generateBookFromProjectContext(project, refinedBookPrompt, targetPages, ctx.fullContext);

      if (!bookSpec.pages || !bookSpec.pages.length) {
        throw new Error('No pages generated for book');
      }

      const latestSession = project.researchSessions?.[project.researchSessions.length - 1];
      const sessionId = latestSession?.id;

      const existingKb = project.knowledgeBase || [];
      let interimKnowledgeBase = [...existingKb];
      const newKbFiles: KnowledgeBaseFile[] = [];
      const pages: BookPage[] = [];

      const bookId = typeof crypto !== 'undefined' && (crypto as any).randomUUID
        ? (crypto as any).randomUUID()
        : `book-${Date.now()}`;

      let previousImageBase64: string | null = null;

      for (const page of bookSpec.pages.slice(0, targetPages)) {
        const references: ImageReference[] = [];
        if (previousImageBase64) {
          references.push({ base64: previousImageBase64, mimeType: 'image/png' });
        }

        const pagePrompt = `${bookSpec.title || project.name}  page ${page.pageNumber}: ${page.imagePrompt || page.text || bookPrompt}`;

        // Randomize aspect ratio for variety
        const aspectRatios = ['16:9', '4:3', '3:2', '1:1', '2:3', '3:4', '4:5'];
        const randomAspectRatio = aspectRatios[Math.floor(Math.random() * aspectRatios.length)];

        const result = await generateImageWithReferences(pagePrompt, references, {
          aspectRatio: randomAspectRatio
        });
        const imageUrl = result.imageDataUrl;

        try {
          const res = await fetch(imageUrl);
          const blob = await res.blob();
          const fileName = `book - ${bookId} -page - ${page.pageNumber} -${Date.now()}.png`;
          const file = new File([blob], fileName, { type: blob.type || 'image/png' });
          const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file, sessionId);
          newKbFiles.push(kbFile);
          interimKnowledgeBase = [...interimKnowledgeBase, kbFile];
          onProjectUpdate?.({
            ...project,
            knowledgeBase: interimKnowledgeBase,
            lastModified: Date.now(),
          });

          let base64: string | null = null;
          if (imageUrl.startsWith('data:')) {
            const parts = imageUrl.split(',');
            base64 = parts[1] || null;
          } else {
            base64 = await fileToBase64(file);
          }
          previousImageBase64 = base64;

          pages.push({
            id: kbFile.id,
            pageNumber: page.pageNumber,
            imageUrl: kbFile.url,
            prompt: pagePrompt,
            text: page.text,
          });

          setGeneratedBookPages(prev => [
            ...prev,
            {
              id: kbFile.id,
              pageNumber: page.pageNumber,
              imageUrl: kbFile.url,
              prompt: pagePrompt,
              text: page.text,
            },
          ]);
        } catch (pageError: any) {
          console.error('Failed to generate or persist book page image', pageError);
        }
      }

      if (!pages.length) {
        throw new Error('Failed to generate any book pages');
      }

      const pagesSorted = [...pages].sort((a, b) => a.pageNumber - b.pageNumber);

      let pdfKbFile: KnowledgeBaseFile | null = null;
      try {
        const pdfDoc = await PDFDocument.create();

        for (const page of pagesSorted) {
          try {
            const res = await fetch(page.imageUrl);
            const blob = await res.blob();
            const arrayBuffer = await blob.arrayBuffer();
            const contentType = (blob.type || res.headers.get('Content-Type') || 'image/png').toLowerCase();

            let image: any;
            if (contentType.includes('jpeg') || contentType.includes('jpg')) {
              image = await pdfDoc.embedJpg(arrayBuffer);
            } else if (contentType.includes('png')) {
              image = await pdfDoc.embedPng(arrayBuffer);
            } else {
              // Try PNG first, then JPG
              try {
                image = await pdfDoc.embedPng(arrayBuffer);
              } catch {
                image = await pdfDoc.embedJpg(arrayBuffer);
              }
            }

            const { width, height } = image.scale(1);
            const pdfPage = pdfDoc.addPage([width, height]);
            pdfPage.drawImage(image, { x: 0, y: 0, width, height });
          } catch (pagePdfError) {
            console.error('Failed to add page image to book PDF', pagePdfError);
          }
        }

        const pdfBytes = await pdfDoc.save();
        const pdfArrayBuffer = (pdfBytes.buffer as ArrayBuffer).slice(
          pdfBytes.byteOffset,
          pdfBytes.byteOffset + pdfBytes.byteLength
        );
        const pdfBlob = new Blob([pdfArrayBuffer], { type: 'application/pdf' });
        const pdfFileName = `book - ${bookId}.pdf`;
        const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
        pdfKbFile = await storageService.uploadKnowledgeBaseFile(project.id, pdfFile, sessionId);
        newKbFiles.push(pdfKbFile);
        // Note: PDF will be added to knowledgeBase in the final update below (line ~3296)
      } catch (pdfError) {
        console.error('Failed to generate or upload book PDF', pdfError);
      }

      const updatedKnowledgeBase = [...existingKb, ...newKbFiles];

      let updatedProject: ResearchProject = {
        ...project,
        knowledgeBase: updatedKnowledgeBase,
        lastModified: Date.now(),
      };

      let targetSession = latestSession;
      let targetSessionId = sessionId;

      // Fallback: Create a research session if none exists to ensure the asset is saved
      if (!targetSession) {
        try {
          const fallbackSession = await storageService.addResearchToProject(project.id, {
            topic: project.name,
            tldr: 'Initial project research session (auto-created)',
            summary: project.description,
            sources: [],
            keyPoints: [],
            marketImplications: '',
            headerImagePrompt: '',
            dynamicSections: []
          });
          targetSession = fallbackSession;
          targetSessionId = fallbackSession.id;
        } catch (sessErr) {
          console.error('Failed to create fallback research session for book:', sessErr);
        }
      }

      if (targetSessionId && targetSession && targetSession.researchReport) {
        const existingBooks = targetSession.researchReport.books || [];
        const bookAsset: BookAsset = {
          id: bookId,
          title: bookSpec.title || bookPrompt.trim() || project.name,
          description: bookSpec.description,
          pages,
          createdAt: Date.now(),
          pdfUrl: pdfKbFile?.url,
          pdfFileId: pdfKbFile?.id,
        };

        const updatedReport = {
          ...targetSession.researchReport,
          books: [bookAsset, ...existingBooks],
        };

        await storageService.updateResearchInProject(project.id, targetSessionId, { researchReport: updatedReport });

        const updatedSessions = (project.researchSessions || []).map(session =>
          session.id === targetSessionId ? { ...session, researchReport: updatedReport } : session
        );

        updatedProject = {
          ...updatedProject,
          researchSessions: updatedSessions,
        };
      }

      try {
        await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
      } catch (e) {
        console.error('Failed to sync book pages into project knowledge base', e);
      }

      if (onProjectUpdate) {
        onProjectUpdate(updatedProject);
      }

      setBookSaveMessage('Book saved to latest research session');
      setBookPrompt('');
    } catch (e: any) {
      console.error('Book generation failed', e);
      setBookError(e?.message || 'Book generation failed');
    } finally {
      setIsGeneratingBook(false);
    }
  };

  const handleDownloadBookPdf = async (asset: AssetItem) => {
    const book = asset.data as BookAsset;
    if (!book) return;

    // Handle Interactive PDF (HTML-based)
    if (book.isInteractive && book.html) {
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(book.html);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
        }, 500);
      }
      return;
    }

    if (!book.pages || !book.pages.length) return;

    setDownloadingBookPdf(asset.id);
    let successCount = 0;
    let failCount = 0;

    try {
      const pdfDoc = await PDFDocument.create();
      const pagesSorted = [...book.pages].sort((a, b) => a.pageNumber - b.pageNumber);

      for (const page of pagesSorted) {
        if (!page.imageUrl) continue;

        try {
          // Attempt to fetch the image data, with retries for expired blobs
          const imageBuffer = await fetchImageWithFallback(page, project.knowledgeBase || []);

          if (imageBuffer) {
            await embedPageToPdf(pdfDoc, imageBuffer.blob, imageBuffer.buffer);
            successCount++;
          } else {
            console.warn(`Could not recover image for page ${page.pageNumber}`);
            failCount++;
          }
        } catch (pageError) {
          console.error(`Failed to embed page ${page.pageNumber} for book ${book.title}`, pageError);
          failCount++;
        }
      }

      if (pdfDoc.getPageCount() === 0) {
        throw new Error('No valid pages could be added to the PDF. The images may have expired and could not be recovered from the project knowledge base.');
      }

      const pdfBytes = await pdfDoc.save();
      // Fix for: Type 'Uint8Array' is not assignable to type 'BlobPart'
      const pdfBlob = new Blob([pdfBytes as unknown as BlobPart], { type: 'application/pdf' });
      const url = URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${book.title.replace(/[^a-z0-9]/gi, '_') || 'book'}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      if (failCount > 0) {
        alert(`PDF downloaded with ${successCount} pages.${failCount} pages could not be recovered(likely expired images).`);
      }

    } catch (e: any) {
      console.error('Failed to download book PDF', e);
      alert(`Failed to generate PDF: ${e?.message || 'Unknown error'} `);
    } finally {
      setDownloadingBookPdf(null);
    }
  };

  const fetchImageWithFallback = async (page: BookPage, knowledgeBase: KnowledgeBaseFile[]): Promise<{ blob: Blob, buffer: ArrayBuffer } | null> => {
    // 1. Try persistent URL from KB if available
    let candidates = [page.imageUrl];

    const kbFile = knowledgeBase.find((f: any) => f.id === page.id || (f.metadata && f.metadata.pageNumber === page.pageNumber));
    if (kbFile && kbFile.url && kbFile.url !== page.imageUrl) {
      // If the page URL is a blob, prefer the KB URL
      if (page.imageUrl.startsWith('blob:')) {
        candidates = [kbFile.url, page.imageUrl];
      } else {
        candidates.push(kbFile.url);
      }
    }

    for (const url of candidates) {
      if (!url) continue;
      try {
        const res = await fetch(url);
        if (res.ok) {
          const blob = await res.blob();
          const buffer = await blob.arrayBuffer();
          // Sanity check: ensure it's actually an image (or ignore type if unknown)
          if (blob.size > 0) {
            return { blob, buffer };
          }
        }
      } catch (e) {
        console.log(`Failed to fetch candidate URL ${url}: `, e);
      }
    }
    return null;
  };

  // Helper to embed image blob into PDF
  const embedPageToPdf = async (pdfDoc: PDFDocument, blob: Blob, arrayBuffer: ArrayBuffer) => {
    // Try PNG first, then JPG regardless of declared content-type to be robust
    try {
      const image = await pdfDoc.embedPng(arrayBuffer);
      const { width, height } = image.scale(1);
      const pdfPage = pdfDoc.addPage([width, height]);
      pdfPage.drawImage(image, { x: 0, y: 0, width, height });
      return;
    } catch (e) {
      // Fallback to JPG
    }

    try {
      const image = await pdfDoc.embedJpg(arrayBuffer);
      const { width, height } = image.scale(1);
      const pdfPage = pdfDoc.addPage([width, height]);
      pdfPage.drawImage(image, { x: 0, y: 0, width, height });
      return;
    } catch (e) {
      throw new Error('Image data is not a valid PNG or JPG');
    }
  };

  const handleGenerateTable = async () => {
    if (!tablePrompt.trim()) return;

    // Credit Check
    const hasCredits = await checkCredits('tableGeneration');
    if (!hasCredits) return;

    const success = await deductCredits('tableGeneration');
    if (!success) {
      setTableError('Failed to deduct credits');
      return;
    }

    setIsGeneratingTable(true);
    setTableError(null);
    setTableSaveMessage(null);
    setGeneratedChartHtml(null);
    setChartError(null);
    try {
      const wizaIntent = await detectWizaTableIntent(tablePrompt);
      let effectiveMode: 'people' | 'company' | 'none' = wizaIntent.mode;
      console.info('[Tables] Generation route:', effectiveMode, wizaIntent);

      const ctx = contextService.buildProjectContext(project);

      const tableSpec = effectiveMode === 'people'
        ? await (async () => {
          const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));
          let listId: number | undefined;

          for (let attempt = 0; attempt < 12; attempt++) {
            const res = await authFetch('/api/wiza-generate-table', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: tablePrompt, size: 10, ...(listId ? { listId } : {}) }),
            });
            const data = await res.json().catch(() => ({}));

            if (!res.ok && res.status !== 202) {
              throw new Error(data?.error || 'Failed to generate Wiza contacts table');
            }

            const nextListId = typeof data?.wiza?.listId === 'number' ? data.wiza.listId : undefined;
            if (nextListId) listId = nextListId;

            if (res.status === 200) {
              if (!data?.tableSpec) throw new Error('Wiza generate table returned no tableSpec');
              return data.tableSpec;
            }

            if (res.status === 202) {
              if (!listId) {
                throw new Error('Wiza list is building but no listId was returned');
              }
              await sleep(1500);
              continue;
            }

            throw new Error('Unexpected response from Wiza generate table');
          }

          throw new Error('Wiza is taking too long to build the list. Please try again.');
        })()
        : effectiveMode === 'company'
          ? await (async () => {
            const res = await authFetch('/api/wiza-company-enrich-table', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: tablePrompt, size: 10 }),
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              const detailsText = typeof data?.details === 'string' ? data.details : '';
              if (detailsText.includes('Insufficient API credits') || detailsText.includes('need 2 credits')) {
                effectiveMode = 'none';
                setTableSaveMessage('Wiza company enrichment credits are insufficient. Generated a table with Gemini instead.');
                return await generateTableFromProjectContext(project, tablePrompt, ctx.fullContext);
              }
              throw new Error(data?.error || 'Failed to enrich companies via Wiza');
            }
            if (!data?.tableSpec) {
              throw new Error('Wiza company enrichment returned no tableSpec');
            }
            return data.tableSpec;
          })()
          : await (async () => {
            const refinedTablePrompt = await refinePromptWithGemini3(tablePrompt, ctx.fullContext, 'text');
            return await generateTableFromProjectContext(project, refinedTablePrompt, ctx.fullContext);
          })();

      const EXTRA_EMPTY_COLUMNS = effectiveMode === 'none' ? 10 : 0;
      const paddedColumns = [...tableSpec.columns];
      for (let i = 0; i < EXTRA_EMPTY_COLUMNS; i++) {
        paddedColumns.push('Label');
      }
      const paddedRows = tableSpec.rows.map(row => {
        const base = [...row];
        for (let i = 0; i < EXTRA_EMPTY_COLUMNS; i++) {
          base.push('');
        }
        return base;
      });

      const tableAsset: TableAsset = {
        id: typeof crypto !== 'undefined' && (crypto as any).randomUUID
          ? (crypto as any).randomUUID()
          : `table - ${Date.now()} `,
        title: tableSpec.title,
        description: tableSpec.description,
        columns: paddedColumns,
        rows: paddedRows,
        createdAt: Date.now(),
      };

      setGeneratedTable(tableAsset);
    } catch (e: any) {
      console.error('Table generation failed', e);
      setTableError(e?.message || 'Table generation failed');
    } finally {
      setIsGeneratingTable(false);
    }
  };

  const handleSaveTable = async () => {
    if (!generatedTable) return;
    await saveTableToProject(generatedTable);
  };

  const saveTableToProject = async (table: TableAsset) => {
    try {
      setTableSaveMessage(null);

      // Save to project-level tables array (no session required)
      const existingTables: TableAsset[] = Array.isArray(project.tables)
        ? project.tables
        : [];
      const updatedTables = [table, ...existingTables.filter(t => String(t?.id || '') !== String(table.id || ''))];

      await storageService.updateResearchProject(project.id, { tables: updatedTables });

      const updatedProject = {
        ...project,
        tables: updatedTables,
        lastModified: Date.now(),
      };

      if (onProjectUpdate) {
        onProjectUpdate(updatedProject);
      }

      setHiddenAssetIds(prev => {
        const next = new Set(prev);
        next.delete(`project-table-${table.id}`);
        return next;
      });

      setTableSaveMessage('Table saved to project');
      setTablePrompt('');
    } catch (e: any) {
      setTableSaveMessage(e?.message || 'Failed to save table');
    }
  };

  const handleOpenSaveTableNameModal = () => {
    if (!generatedTable) return;
    setSaveTableName((generatedTable.title || '').trim() || 'New table');
    setIsSaveTableNameModalOpen(true);
  };

  const handleConfirmSaveTableName = async (titleOverride?: string) => {
    if (!generatedTable) return;
    const title = titleOverride || saveTableName.trim();
    if (!title) return;
    const nextTable: TableAsset = { ...generatedTable, title };
    setGeneratedTable(nextTable);
    setIsSaveTableNameModalOpen(false);
    await saveTableToProject(nextTable);
  };

  const handleAutoSaveTable = async () => {
    if (!generatedTable) return;

    // If table already has a specific title (not default/untitled), just save it
    if (generatedTable.title && generatedTable.title !== 'New table' && !generatedTable.title.startsWith('sheet-table-')) {
      await handleConfirmSaveTableName(generatedTable.title);
      return;
    }

    setTableSaveMessage('Generating title...');
    try {
      const title = await generateTableTitle(
        generatedTable.columns,
        generatedTable.rows.slice(0, 3)
      );
      await handleConfirmSaveTableName(title);
    } catch (error) {
      console.error('Auto-save title generation failed:', error);
      handleOpenSaveTableNameModal(); // Fallback to manual
    }
  };

  // Handle CSV/Excel file upload
  const handleTableFileUpload = async (file: File) => {
    setIsUploadingTable(true);
    setTableUploadError(null);
    setTableError(null);

    const fileName = file.name.toLowerCase();
    const isCSV = fileName.endsWith('.csv');
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

    if (!isCSV && !isExcel) {
      setTableUploadError('Unsupported file type. Please upload a CSV or Excel file (.csv, .xlsx, .xls).');
      setIsUploadingTable(false);
      return;
    }

    try {
      let columns: string[] = [];
      let rows: string[][] = [];

      if (isCSV) {
        // Parse CSV using papaparse
        const text = await file.text();
        const result = Papa.parse<string[]>(text, {
          skipEmptyLines: true,
        });

        if (result.errors.length > 0) {
          console.warn('CSV parsing warnings:', result.errors);
        }

        const data = result.data;
        if (data.length === 0) {
          setTableUploadError('The uploaded file appears to be empty.');
          setIsUploadingTable(false);
          return;
        }

        // First row as headers (columns)
        columns = data[0].map((col, idx) => col?.trim() || `Column ${idx + 1}`);
        // Remaining rows as data
        rows = data.slice(1).map(row =>
          row.map(cell => (cell ?? '').toString())
        );
      } else {
        // Parse Excel using xlsx
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });

        // Use first sheet
        const firstSheetName = workbook.SheetNames[0];
        if (!firstSheetName) {
          setTableUploadError('The Excel file has no sheets.');
          setIsUploadingTable(false);
          return;
        }

        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData: string[][] = XLSX.utils.sheet_to_json(worksheet, {
          header: 1,
          defval: '',
        });

        if (jsonData.length === 0) {
          setTableUploadError('The uploaded file appears to be empty.');
          setIsUploadingTable(false);
          return;
        }

        // First row as headers (columns)
        columns = jsonData[0].map((col, idx) =>
          col?.toString().trim() || `Column ${idx + 1}`
        );
        // Remaining rows as data
        rows = jsonData.slice(1).map(row =>
          row.map(cell => (cell ?? '').toString())
        );
      }

      // Ensure all rows have the same number of columns
      const colCount = columns.length;
      rows = rows.map(row => {
        if (row.length < colCount) {
          return [...row, ...new Array(colCount - row.length).fill('')];
        }
        return row.slice(0, colCount);
      });

      // Extract file name without extension for title
      const baseName = file.name.replace(/\.(csv|xlsx|xls)$/i, '');

      // Set the generated table
      setGeneratedTable({
        id: `uploaded-table-${Date.now()}`,
        title: baseName,
        description: `Uploaded from ${file.name}`,
        columns,
        rows,
        createdAt: Date.now(),
      });

      setTableSaveMessage(`Imported ${rows.length} rows from ${file.name}`);
      setTimeout(() => setTableSaveMessage(null), 3000);
    } catch (error) {
      console.error('Error parsing file:', error);
      setTableUploadError('Failed to parse file. Please ensure it is a valid CSV or Excel file.');
    } finally {
      setIsUploadingTable(false);
      // Reset file input
      if (tableFileInputRef.current) {
        tableFileInputRef.current.value = '';
      }
    }
  };

  const handleEditCell = (row: number, col: number, value: string) => {
    setEditingCell({ row, col });
    setEditValue(value);
  };

  const handleSaveCell = () => {
    if (!generatedTable || !editingCell) return;

    const updatedRows = generatedTable.rows.map((r, rIdx) =>
      rIdx === editingCell.row
        ? r.map((c, cIdx) => (cIdx === editingCell.col ? editValue : c))
        : r
    );

    setGeneratedTable({
      ...generatedTable,
      rows: updatedRows,
    });

    setEditingCell(null);
    setEditValue('');
  };

  const handleCancelEdit = () => {
    setEditingCell(null);
    setEditValue('');
  };

  const handleAddRow = () => {
    if (!generatedTable) return;
    const newRow = new Array(generatedTable.columns.length).fill('');
    setGeneratedTable({
      ...generatedTable,
      rows: [...generatedTable.rows, newRow],
    });
  };

  const handleDeleteRow = (rowIndex: number) => {
    if (!generatedTable) return;
    setGeneratedTable({
      ...generatedTable,
      rows: generatedTable.rows.filter((_, idx) => idx !== rowIndex),
    });
  };

  // SpreadsheetTable handlers
  const handleTableColumnsChange = (newColumns: string[]) => {
    setGeneratedTable(prev => {
      if (!prev) return prev;
      return {
        ...prev,
        columns: newColumns,
      };
    });
  };

  const handleTableRowsChange = (newRows: string[][]) => {
    setGeneratedTable(prev => {
      if (!prev) return prev;
      return {
        ...prev,
        rows: newRows,
      };
    });
  };

  const exportTableAsCSV = () => {
    if (!generatedTable) return;

    const csvContent = [
      generatedTable.columns.join(','),
      ...generatedTable.rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${generatedTable.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const exportTableAsJSON = () => {
    if (!generatedTable) return;

    const jsonContent = JSON.stringify(generatedTable, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${generatedTable.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  useEffect(() => {
    if (activePodcast && audioRef.current) {
      try {
        audioRef.current.currentTime = 0;
        const playPromise = audioRef.current.play();
        if (playPromise && typeof (playPromise as any).then === 'function') {
          (playPromise as Promise<void>).catch(e => {
            console.error('Failed to play podcast audio', e);
          });
        }
      } catch (e) {
        console.error('Error starting podcast playback', e);
      }
    }
  }, [activePodcast]);

  const formatUploadSnippets = (prompt: string, limit = 3) => {
    const relevant = getRelevantUploads(prompt, limit);
    if (!relevant.length) return '';
    return relevant.map(file => {
      const title = file.displayName || file.name || 'Untitled asset';
      const summary = file.summary || 'No summary available.';
      return `${title}: ${summary}`;
    }).join(' | ');
  };

  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        const result = reader.result as string;
        const base64 = result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = error => reject(error);
    });
  };

  const initAnnotateCanvasFromFile = async (file: File) => {
    const canvas = annotateCanvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const base64 = await fileToBase64(file);
    const mimeType = file.type || 'image/png';
    const dataUrl = `data:${mimeType};base64,${base64}`;
    const img = new Image();
    await new Promise<void>((resolve, reject) => {
      img.onload = () => resolve();
      img.onerror = () => reject(new Error('Failed to load reference image'));
      img.src = dataUrl;
    });

    const maxW = 900;
    const maxH = 520;
    const scale = Math.min(1, maxW / img.width, maxH / img.height);
    const w = Math.max(1, Math.round(img.width * scale));
    const h = Math.max(1, Math.round(img.height * scale));

    canvas.width = w;
    canvas.height = h;
    ctx.clearRect(0, 0, w, h);
    ctx.drawImage(img, 0, 0, w, h);

    const snapshot = canvas.toDataURL('image/png');
    setAnnotateHistory({ stack: [snapshot], index: 0 });
  };

  const applyAnnotateSnapshot = async (snapshot: string) => {
    const canvas = annotateCanvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const img = new Image();
    await new Promise<void>((resolve, reject) => {
      img.onload = () => resolve();
      img.onerror = () => reject(new Error('Failed to restore annotation'));
      img.src = snapshot;
    });

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
  };

  const captureAnnotateSnapshot = () => {
    const canvas = annotateCanvasRef.current;
    if (!canvas) return;
    const snapshot = canvas.toDataURL('image/png');
    setAnnotateHistory(prev => {
      const nextStack = prev.stack.slice(0, prev.index + 1);
      nextStack.push(snapshot);
      return { stack: nextStack, index: nextStack.length - 1 };
    });
  };

  const handleAnnotateUndo = async () => {
    if (annotateHistory.index <= 0) return;
    const nextIndex = annotateHistory.index - 1;
    await applyAnnotateSnapshot(annotateHistory.stack[nextIndex]);
    setAnnotateHistory(prev => ({ ...prev, index: Math.max(0, prev.index - 1) }));
  };

  const handleAnnotateRedo = async () => {
    if (annotateHistory.index < 0) return;
    if (annotateHistory.index >= annotateHistory.stack.length - 1) return;
    const nextIndex = annotateHistory.index + 1;
    await applyAnnotateSnapshot(annotateHistory.stack[nextIndex]);
    setAnnotateHistory(prev => ({ ...prev, index: Math.min(prev.stack.length - 1, prev.index + 1) }));
  };

  const getCanvasPoint = (canvas: HTMLCanvasElement, evt: PointerEvent | React.PointerEvent) => {
    const rect = canvas.getBoundingClientRect();
    const x = ('clientX' in evt ? evt.clientX : 0) - rect.left;
    const y = ('clientY' in evt ? evt.clientY : 0) - rect.top;
    const cx = Math.max(0, Math.min(canvas.width, (x / rect.width) * canvas.width));
    const cy = Math.max(0, Math.min(canvas.height, (y / rect.height) * canvas.height));
    return { x: cx, y: cy };
  };

  const drawStroke = (from: { x: number; y: number }, to: { x: number; y: number }) => {
    const canvas = annotateCanvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    ctx.save();
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = referenceAnnotateBrushSize;
    if (referenceAnnotateTool === 'eraser') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.strokeStyle = 'rgba(0,0,0,1)';
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = referenceAnnotateBrushColor;
    }
    ctx.beginPath();
    ctx.moveTo(from.x, from.y);
    ctx.lineTo(to.x, to.y);
    ctx.stroke();
    ctx.restore();
  };

  const handleAnnotatePointerDown = (e: React.PointerEvent) => {
    const canvas = annotateCanvasRef.current;
    if (!canvas) return;

    if (referenceAnnotateTool === 'text') {
      const text = referenceAnnotateText.trim();
      if (!text) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      const pt = getCanvasPoint(canvas, e);
      ctx.save();
      ctx.globalCompositeOperation = 'source-over';
      ctx.font = `${Math.max(8, referenceAnnotateBrushSize)}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`;
      ctx.textBaseline = 'top';
      ctx.fillStyle = referenceAnnotateBrushColor;
      ctx.lineWidth = Math.max(2, Math.round(referenceAnnotateBrushSize / 10));
      ctx.strokeStyle = 'rgba(0,0,0,0.35)';
      ctx.strokeText(text, pt.x, pt.y);
      ctx.fillText(text, pt.x, pt.y);
      ctx.restore();
      captureAnnotateSnapshot();
      return;
    }

    annotateDrawingRef.current = true;
    annotateLastPointRef.current = getCanvasPoint(canvas, e);
    try {
      (e.target as any)?.setPointerCapture?.(e.pointerId);
    } catch {
      // ignore
    }
  };

  const handleAnnotatePointerMove = (e: React.PointerEvent) => {
    if (!annotateDrawingRef.current) return;
    const canvas = annotateCanvasRef.current;
    if (!canvas) return;
    const last = annotateLastPointRef.current;
    const next = getCanvasPoint(canvas, e);
    if (last) {
      drawStroke(last, next);
    }
    annotateLastPointRef.current = next;
  };

  const handleAnnotatePointerUp = () => {
    const wasDrawing = annotateDrawingRef.current;
    annotateDrawingRef.current = false;
    annotateLastPointRef.current = null;
    if (wasDrawing) {
      captureAnnotateSnapshot();
    }
  };

  const blobToBase64 = (blob: Blob): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = () => {
        const result = reader.result as string;
        const base64 = result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = error => reject(error);
    });
  };

  const fetchUploadImageReference = async (file: UploadedFile): Promise<ImageReference | null> => {
    try {
      const url = file.uri || (file as any).url;
      if (!url) return null;
      const response = await fetch(url);
      if (!response.ok) return null;
      const blob = await response.blob();
      if (blob.size === 0) return null;
      const mimeType = blob.type || file.mimeType || 'image/png';
      if (!mimeType.startsWith('image/')) return null;
      const base64 = await blobToBase64(blob);
      return { base64, mimeType };
    } catch (error) {
      console.warn('Failed to fetch upload for reference', error);
      return null;
    }
  };

  const fetchAssetAsFile = async (asset: UploadedFile): Promise<File> => {
    const url = asset.uri || (asset as any).url;
    if (!url) {
      throw new Error('Selected asset has no URL');
    }
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Failed to download selected asset');
    }
    const blob = await response.blob();
    const contentType = blob.type || asset.mimeType || 'image/png';
    const fileNameBase = (asset.displayName || asset.name || 'reference-image').replace(/[\\/:*?"<>|]+/g, '').trim() || 'reference-image';
    const ext = contentType.includes('jpeg') || contentType.includes('jpg')
      ? 'jpg'
      : contentType.includes('webp')
        ? 'webp'
        : 'png';
    return new File([blob], `${fileNameBase}.${ext}`, { type: contentType });
  };

  const fetchUrlAsFile = async (url: string, label?: string): Promise<File> => {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Failed to download selected asset');
    }
    const blob = await response.blob();
    const contentType = blob.type || 'image/png';
    const fileNameBase = (label || 'reference-image').replace(/[\/:*?"<>|]+/g, '').trim() || 'reference-image';
    const ext = contentType.includes('jpeg') || contentType.includes('jpg')
      ? 'jpg'
      : contentType.includes('webp')
        ? 'webp'
        : 'png';
    return new File([blob], `${fileNameBase}.${ext}`, { type: contentType });
  };

  const base64ToBlob = (base64: string, mimeType: string): Blob => {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: mimeType });
  };

  const resizeImageFileForSora = async (
    file: File,
    size: '720x1280' | '1280x720' | '1024x1792' | '1792x1024'
  ): Promise<File> => {
    const [targetWStr, targetHStr] = size.split('x');
    const targetW = Number(targetWStr);
    const targetH = Number(targetHStr);
    if (!targetW || !targetH) return file;

    try {
      const bitmap = await createImageBitmap(file);
      const srcW = bitmap.width;
      const srcH = bitmap.height;
      if (!srcW || !srcH) return file;

      const targetAR = targetW / targetH;
      const srcAR = srcW / srcH;
      let cropW = srcW;
      let cropH = srcH;
      let cropX = 0;
      let cropY = 0;

      // Center crop to match aspect ratio
      if (srcAR > targetAR) {
        cropW = Math.round(srcH * targetAR);
        cropX = Math.round((srcW - cropW) / 2);
      } else if (srcAR < targetAR) {
        cropH = Math.round(srcW / targetAR);
        cropY = Math.round((srcH - cropH) / 2);
      }

      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');
      if (!ctx) return file;

      ctx.drawImage(bitmap, cropX, cropY, cropW, cropH, 0, 0, targetW, targetH);

      const blob: Blob = await new Promise((resolve, reject) => {
        canvas.toBlob(
          (b) => (b ? resolve(b) : reject(new Error('Failed to encode resized reference image'))),
          'image/png'
        );
      });

      return new File([blob], `sora-reference-${Date.now()}.png`, { type: 'image/png' });
    } catch {
      return file;
    }
  };

  // Build a project-aware "magic" prompt that fuses user input with project context
  // NOTE: This legacy function is replaced by refinePromptWithGemini3 in handlers. 
  // Keeping it temporarily commented out or removed.
  // const buildContextPrompt = ... (removed)

  const handleGenerateProjectWebsite = async () => {
    if (!websitePrompt.trim()) return;

    // Check and deduct credits (50 credits for website generation)
    const hasCredits = await checkCredits('websiteGeneration');
    if (!hasCredits) return;

    setIsGeneratingWebsite(true);
    setWebsiteError(null);
    setWebsiteSaveMessage(null);
    setWebsiteLogs([]);
    setWebsiteStreamingCode('');
    setGeneratedWebsiteHtml('');
    setShowWebsiteLogs(true);

    try {
      // Deduct credits before generation
      const deducted = await deductCredits('websiteGeneration');
      if (!deducted) {
        setWebsiteError('Failed to deduct credits. Please try again.');
        setIsGeneratingWebsite(false);
        return;
      }

      const specification = buildWebsiteSpecification(websitePrompt);
      const context = buildWebsiteContext();
      setWebsiteLogs(prev => [...prev, ' Generating high-fidelity website experience...']);

      // Collect website media assets (uploaded files + selected assets)
      const websiteMedia: WebsiteMedia[] = [];

      // 1. Process uploaded files
      if (websiteMediaFiles.length > 0) {
        for (const file of websiteMediaFiles) {
          try {
            const base64 = await fileToBase64(file);
            const isVideo = file.type.startsWith('video/');
            websiteMedia.push({
              url: base64, // Local file doesn't have a URL yet, use base64 for embedding
              base64: base64,
              mimeType: file.type,
              type: isVideo ? 'video' : 'image'
            });
          } catch (e) {
            console.error('Failed to process uploaded file for website:', file.name, e);
          }
        }
      }

      // 2. Process selected existing assets
      if (selectedWebsiteAssetIds.length > 0) {
        for (const assetId of selectedWebsiteAssetIds) {
          const asset = allAssets.find(a => a.id === assetId);
          if (asset) {
            try {
              let assetBase64 = asset.data?.base64;
              const hasUrl = asset.url && (asset.url.startsWith('http://') || asset.url.startsWith('https://'));

              // We always want base64 for vision if possible
              if (!assetBase64 && hasUrl) {
                try {
                  assetBase64 = await fetchImageAsBase64(asset.url!);
                } catch (e) {
                  console.warn('Failed to fetch base64 for vision, will use URL only:', asset.url);
                }
              }

              const isVideo = asset.type === 'video' || (asset.type === 'social' && asset.data?.videoUrl);
              const mimeType = asset.data?.mimeType || (isVideo ? 'video/mp4' : 'image/jpeg');

              websiteMedia.push({
                url: hasUrl ? asset.url! : (assetBase64 || asset.url!), // Prefer real URL for embedding
                base64: assetBase64,
                mimeType,
                type: isVideo ? 'video' : 'image'
              });
            } catch (e) {
              console.error('Failed to process selected asset for website:', asset.title, e);
            }
          }
        }
      }

      const finalHtml = await refineWebsiteCode(
        specification,
        context,
        projectTheme,
        chunk => {
          // Append raw chunks - cleaning happens at render time to avoid corruption from split fences
          setWebsiteStreamingCode(prev => prev + chunk);
        },
        thought => setWebsiteLogs(prev => [...prev, ` ${thought}`]),
        websiteMedia
      );

      // Strip any remaining markdown fences from the final result
      const cleanedHtml = finalHtml
        .replace(/^```(?:html)?\s*\n?/i, '')
        .replace(/\n?```\s*$/i, '')
        .trim();

      setGeneratedWebsiteHtml(cleanedHtml);

      const newWebsiteVersion: SavedWebsiteVersion = {
        id: typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `website-${Date.now()}`,
        timestamp: Date.now(),
        html: cleanedHtml,
        description: websitePrompt.trim().substring(0, 60) || 'Project website experience'
      };

      let saveMessage = 'Website generated locally';
      let targetSession = latestResearchSession;

      // Fallback: Create a research session if none exists to ensure the asset is saved
      if (!targetSession) {
        try {
          const fallbackSession = await storageService.addResearchToProject(project.id, {
            topic: project.name,
            tldr: 'Initial project research session (auto-created)',
            summary: project.description,
            sources: [],
            keyPoints: [],
            marketImplications: '',
            headerImagePrompt: '',
            dynamicSections: []
          });
          targetSession = fallbackSession;
        } catch (sessErr) {
          console.error('Failed to create fallback research session:', sessErr);
        }
      }

      if (targetSession) {
        const updatedVersions = [newWebsiteVersion, ...(targetSession.websiteVersions || [])];
        try {
          await storageService.updateResearchInProject(project.id, targetSession.id, {
            websiteVersions: updatedVersions
          });
          saveMessage = 'Website saved to research session';
        } catch (err: any) {
          console.error('Failed to save website to project session', err);
          saveMessage = err?.message || 'Failed to sync website to Firestore (kept locally)';
        }
      } else {
        saveMessage = 'No research sessions found. Website stored locally only.';
      }

      setWebsiteSaveMessage(saveMessage);

      const newAsset: AssetItem = {
        id: `project-website-${newWebsiteVersion.id}`,
        type: 'website',
        title: newWebsiteVersion.description,
        data: newWebsiteVersion,
        researchId: targetSession?.id || 'project-assets',
        researchTopic: targetSession?.topic || project.name,
        timestamp: newWebsiteVersion.timestamp
      };

      setLocalProjectWebsites(prev => [newAsset, ...prev]);
      setWebsitePrompt('');
    } catch (e: any) {
      console.error('Project-level website generation failed', e);
      setWebsiteError(e?.message || 'Website generation failed');
    } finally {
      setIsGeneratingWebsite(false);
    }
  };

  // Website AI Edit Handlers
  const handleApplyWebsiteEdit = async (targetAsset: AssetItem) => {
    if (!websiteEditPrompt.trim()) return;
    const websiteData = targetAsset.data as SavedWebsiteVersion;
    if (!websiteData?.html) return;

    setIsApplyingEdit(true);
    setWebsiteEditError(null);
    setEditDiffHtml(null);
    setPendingEditHtml(null);
    setEditSummary(null);

    try {
      // Deduct credits
      const creditSuccess = await deductCredits('websiteEdit');
      if (!creditSuccess) {
        setWebsiteEditError('Insufficient credits for website edit');
        setIsApplyingEdit(false);
        return;
      }

      // Collect website media assets (uploaded files + selected assets)
      const websiteMedia: WebsiteMedia[] = [];

      // 1. Process uploaded files
      if (websiteMediaFiles.length > 0) {
        for (const file of websiteMediaFiles) {
          try {
            const base64 = await fileToBase64(file);
            const isVideo = file.type.startsWith('video/');
            websiteMedia.push({
              url: base64, // Local file doesn't have a URL yet, use base64 for embedding
              base64: base64,
              mimeType: file.type,
              type: isVideo ? 'video' : 'image'
            });
          } catch (e) {
            console.error('Failed to process uploaded file for website edit:', file.name, e);
          }
        }
      }

      // 2. Process selected existing assets
      if (selectedWebsiteAssetIds.length > 0) {
        // Using component-level allAssets memo for resolution

        for (const assetId of selectedWebsiteAssetIds) {
          const asset = allAssets.find(a => a.id === assetId);
          if (asset) {
            try {
              let assetBase64 = asset.data?.base64;
              const hasUrl = asset.url && (asset.url.startsWith('http://') || asset.url.startsWith('https://'));

              // We always want base64 for vision if possible
              if (!assetBase64 && hasUrl) {
                try {
                  assetBase64 = await fetchImageAsBase64(asset.url!);
                } catch (e) {
                  console.warn('Failed to fetch base64 for vision, will use URL only:', asset.url);
                }
              }

              const isVideo = asset.type === 'video' || (asset.type === 'social' && asset.data?.videoUrl);
              const mimeType = asset.data?.mimeType || (isVideo ? 'video/mp4' : 'image/jpeg');

              websiteMedia.push({
                url: hasUrl ? asset.url! : (assetBase64 || asset.url!), // Prefer real URL for embedding
                base64: assetBase64,
                mimeType,
                type: isVideo ? 'video' : 'image'
              });
            } catch (e) {
              console.error('Failed to process selected asset for website edit:', asset.title, e);
            }
          }
        }
      }

      // Call Gemini to apply edit
      const result = await editWebsiteWithAI(
        websiteData.html,
        websiteEditPrompt,
        contextService.buildProjectContext(project).fullContext,
        websiteMedia
      );

      // Generate diff using diff library
      const diffPatch = createPatch(
        'website.html',
        websiteData.html,
        result.newHtml,
        'Original',
        'Modified'
      );

      // Convert to HTML using diff2html
      const diffHtmlOutput = diff2html(diffPatch, {
        drawFileList: false,
        outputFormat: 'side-by-side',
        matching: 'lines'
      });

      setEditDiffHtml(diffHtmlOutput);
      setPendingEditHtml(result.newHtml);
      setEditSummary(result.summary);
    } catch (error: any) {
      console.error('Website edit failed:', error);
      setWebsiteEditError(error.message || 'Failed to apply edit');
    } finally {
      setIsApplyingEdit(false);
    }
  };

  const handleAcceptWebsiteEdit = async (targetAsset: AssetItem) => {
    if (!pendingEditHtml) return;
    const websiteData = targetAsset.data as SavedWebsiteVersion;
    if (!websiteData) return;

    const updatedWebsiteData: SavedWebsiteVersion = {
      ...websiteData,
      html: pendingEditHtml,
      timestamp: Date.now(),
    };

    // Find the research session containing this website
    const researchSession = project.researchSessions?.find(s =>
      s.websiteVersions?.some(w => w.id === websiteData.id)
    );

    if (researchSession) {
      const updatedVersions = (researchSession.websiteVersions || []).map(w =>
        w.id === websiteData.id ? updatedWebsiteData : w
      );

      try {
        await storageService.updateResearchInProject(project.id, researchSession.id, {
          websiteVersions: updatedVersions
        });

        // Also update the public website HTML so the public link reflects changes
        if (websiteData.slug) {
          await authFetch('/api/websites?op=update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              slug: websiteData.slug,
              html: pendingEditHtml,
              title: websiteData.description,
            })
          });
          setWebsiteSaveMessage('Changes saved & public link updated!');
          setTimeout(() => setWebsiteSaveMessage(null), 3000);
        }

        // Update local state
        if (onProjectUpdate) {
          const updatedSessions = (project.researchSessions || []).map(s =>
            s.id === researchSession.id
              ? { ...s, websiteVersions: updatedVersions }
              : s
          );
          onProjectUpdate({ ...project, researchSessions: updatedSessions, lastModified: Date.now() });
        }
      } catch (err) {
        console.error('Failed to save edited website:', err);
      }
    }

    // Reset edit state
    setEditDiffHtml(null);
    setPendingEditHtml(null);
    setWebsiteEditPrompt('');
    setIsEditingWebsite(false);
    setEditSummary(null);
    setSelectedWebsite(updatedWebsiteData);
  };

  const handleRejectWebsiteEdit = () => {
    setEditDiffHtml(null);
    setPendingEditHtml(null);
    setEditSummary(null);
  };

  // Lead Form AI Edit Handlers
  const handleApplyLeadFormEdit = async (targetAsset: AssetItem) => {
    if (!formEditPrompt.trim()) return;
    const formData = targetAsset.data as any; // LeadFormAsset structure
    if (!formData?.html) return;

    setIsApplyingEdit(true);
    setFormEditError(null);
    setEditDiffHtml(null);
    setPendingEditHtml(null);
    setEditSummary(null);

    try {
      // Deduct credits (using same cost as website edit)
      const creditSuccess = await deductCredits('websiteEdit');
      if (!creditSuccess) {
        setFormEditError('Insufficient credits for form edit');
        setIsApplyingEdit(false);
        return;
      }

      // Call Gemini to apply edit
      const result = await editWebsiteWithAI(
        formData.html,
        formEditPrompt,
        contextService.buildProjectContext(project).fullContext
      );

      // Generate diff using diff library
      const diffPatch = createPatch(
        'form.html',
        formData.html,
        result.newHtml,
        'Original',
        'Modified'
      );

      // Convert to HTML using diff2html
      const diffHtmlOutput = diff2html(diffPatch, {
        drawFileList: false,
        outputFormat: 'side-by-side',
        matching: 'lines'
      });

      setEditDiffHtml(diffHtmlOutput);
      setPendingEditHtml(result.newHtml);
      setEditSummary(result.summary);
    } catch (error: any) {
      console.error('Form edit failed:', error);
      setFormEditError(error.message || 'Failed to apply edit');
    } finally {
      setIsApplyingEdit(false);
    }
  };

  const handleAcceptLeadFormEdit = async (targetAsset: AssetItem) => {
    if (!pendingEditHtml) return;
    const formData = targetAsset.data as any;
    if (!formData) return;

    const updatedFormData = {
      ...formData,
      html: pendingEditHtml,
    };

    try {
      // Save form to user's Firestore collection
      await authFetch('/api/websites?op=save-form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ form: updatedFormData })
      });

      // Also update the public website HTML so the public link reflects changes
      if (formData.slug) {
        await authFetch('/api/websites?op=update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slug: formData.slug,
            html: pendingEditHtml,
            title: formData.title,
            formId: formData.id,
            type: 'form'
          })
        });
      }

      // Update local state
      setLocalLeadForms(prev => prev.map(f => f.id === formData.id ? updatedFormData : f));

      // Reset edit state
      setEditDiffHtml(null);
      setPendingEditHtml(null);
      setFormEditPrompt('');
      setIsEditingForm(false);
      setEditSummary(null);
      setSelectedForm({ ...targetAsset, data: updatedFormData });

      // Show success message
      setLeadFormSaveMessage('Changes saved & public link updated!');
      setTimeout(() => setLeadFormSaveMessage(null), 3000);
    } catch (err: any) {
      console.error('Failed to save edited form:', err);
      setFormEditError(err.message || 'Failed to save changes');
    }
  };

  const handleRejectLeadFormEdit = () => {
    setEditDiffHtml(null);
    setPendingEditHtml(null);
    setEditSummary(null);
  };

  // Lead Form Handlers
  const handleGenerateLeadForm = async () => {
    if (!leadFormPrompt.trim() || !leadFormTitle.trim()) return;
    if (leadFormFields.length === 0) return;

    // Check and deduct credits (45 credits for form generation)
    const hasCredits = await checkCredits('formGeneration');
    if (!hasCredits) return;

    setIsGeneratingLeadForm(true);
    setLeadFormError(null);
    setLeadFormSaveMessage(null);
    setLeadFormStreamingCode('');
    setGeneratedLeadFormHtml('');

    try {
      // Deduct credits before generation
      const deducted = await deductCredits('formGeneration');
      if (!deducted) {
        setLeadFormError('Failed to deduct credits. Please try again.');
        setIsGeneratingLeadForm(false);
        return;
      }

      const formId = `form-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
      const origin = typeof window !== 'undefined' ? window.location.origin : 'https://freshfront.co';

      // First, create a placeholder slug so we know the URL before generating
      const placeholderRes = await authFetch('/api/websites?op=create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          html: '<html><body>Loading...</body></html>',
          projectId: project.id,
          versionId: formId,
          title: leadFormTitle,
          formId: formId,
          type: 'form'
        })
      });

      if (!placeholderRes.ok) throw new Error('Failed to create hosted link');
      const { slug } = await placeholderRes.json();

      // Process images if any
      const processedImages: string[] = [];
      if (leadFormImages.length > 0) {
        try {
          const promises = leadFormImages.map(file => new Promise<string>((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target?.result as string);
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(file);
          }));
          const results = await Promise.all(promises);
          processedImages.push(...results);
        } catch (err) {
          console.error("Failed to process images", err);
        }
      }

      // Generate the actual form with the known slug
      const finalHtml = await streamLeadFormWebsite(
        leadFormPrompt,
        leadFormFields,
        formId,
        slug,
        project.id,
        leadFormTitle,
        chunk => setLeadFormStreamingCode(prev => prev + chunk),
        // Pass profile logo if enabled
        (leadFormUseProfileLogo && userProfile?.photoURL) ? userProfile.photoURL : undefined,
        // Pass processed images
        processedImages
      );

      setGeneratedLeadFormHtml(finalHtml);

      // Update the public_websites entry with the actual HTML (stored directly in Firestore)
      const updateRes = await authFetch('/api/websites?op=update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          slug: slug,
          html: finalHtml,
          title: leadFormTitle,
          formId: formId,
          type: 'form'
        })
      });

      if (!updateRes.ok) {
        console.error('Failed to update website with final HTML');
      }

      const publicUrl = `${origin}/w/${slug}`;

      const newLeadForm: LeadFormAsset = {
        id: formId,
        title: leadFormTitle,
        prompt: leadFormPrompt,
        fields: leadFormFields,
        html: finalHtml,
        publicUrl,
        slug,
        createdAt: Date.now(),
        projectId: project.id
      };

      // Save form to Firestore (users/{uid}/forms/{formId})
      await authFetch('/api/websites?op=save-form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ form: newLeadForm })
      });

      setLocalLeadForms(prev => [newLeadForm, ...prev]);
      setLeadFormSaveMessage(`Form created! Link: ${publicUrl}`);

      // Copy link to clipboard
      if (navigator.clipboard) {
        try {
          await navigator.clipboard.writeText(publicUrl);
          setLeadFormSaveMessage('Form created & link copied to clipboard!');
        } catch {
          // Fallback - just show the link
        }
      }

      // Reset form
      setLeadFormPrompt('');
      setLeadFormTitle('');
      setLeadFormFields([
        { id: 'name', name: 'name', label: 'Full Name', type: 'text', required: true, placeholder: 'Enter your name' },
        { id: 'email', name: 'email', label: 'Email Address', type: 'email', required: true, placeholder: 'Enter your email' },
      ]);

    } catch (e: any) {
      console.error('Lead form generation failed', e);
      setLeadFormError(e?.message || 'Lead form generation failed');
    } finally {
      setIsGeneratingLeadForm(false);
    }
  };

  const handleAddLeadFormField = (type: LeadFormField['type']) => {
    const id = `field-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
    const labels: Record<string, string> = {
      text: 'Custom Field',
      email: 'Email',
      phone: 'Phone Number',
      textarea: 'Message',
      select: 'Select Option',
      checkbox: 'Agreement'
    };
    const newField: LeadFormField = {
      id,
      name: id,
      label: labels[type] || 'Custom Field',
      type,
      required: false,
      placeholder: ''
    };
    setLeadFormFields(prev => [...prev, newField]);
  };

  const handleRemoveLeadFormField = (fieldId: string) => {
    setLeadFormFields(prev => prev.filter(f => f.id !== fieldId));
  };

  const handleUpdateLeadFormField = (fieldId: string, updates: Partial<LeadFormField>) => {
    setLeadFormFields(prev => prev.map(f => f.id === fieldId ? { ...f, ...updates } : f));
  };

  // Drag and Drop Logic for Lead Form Fields
  const [draggedFieldIndex, setDraggedFieldIndex] = useState<number | null>(null);
  const leadFieldsContainerRef = useRef<HTMLDivElement>(null);

  const moveLeadField = (fromIndex: number, toIndex: number) => {
    if (fromIndex === toIndex) return;
    setLeadFormFields(prev => {
      const next = [...prev];
      const item = next[fromIndex];
      next.splice(fromIndex, 1);
      next.splice(toIndex, 0, item);
      return next;
    });
  };

  const handleFieldDragStart = (index: number) => {
    setDraggedFieldIndex(index);
  };

  const handleFieldDragOver = (e: React.DragEvent, index: number) => {
    e.preventDefault(); // Necessary to allow dropping
    if (draggedFieldIndex === null || draggedFieldIndex === index) return;
    moveLeadField(draggedFieldIndex, index);
    setDraggedFieldIndex(index);
  };

  const handleFieldDragEnd = () => {
    setDraggedFieldIndex(null);
  };

  // Touch support for mobile reordering
  const handleFieldTouchMove = (e: React.TouchEvent) => {
    if (draggedFieldIndex === null) return;

    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    const fieldRow = element?.closest('[data-field-index]');

    if (fieldRow) {
      const targetIndex = parseInt(fieldRow.getAttribute('data-field-index') || '-1');
      if (targetIndex !== -1 && targetIndex !== draggedFieldIndex) {
        moveLeadField(draggedFieldIndex, targetIndex);
        setDraggedFieldIndex(targetIndex);
      }
    }
  };

  const loadLeadForms = async () => {
    try {
      const res = await authFetch(`/api/websites?op=list-forms&projectId=${project.id}`);
      if (!res.ok) throw new Error('Failed to load forms');
      const data = await res.json();
      setLocalLeadForms(data.forms || []);
    } catch (e: any) {
      console.error('Failed to load forms', e);
    }
  };

  const loadCapturedLeads = async (formId?: string) => {
    setLoadingLeads(true);
    setLeadsError(null);
    setSelectedLeadFormId(formId || null);  // Track which form's leads we're viewing
    try {
      const url = formId
        ? `/api/websites?op=list-leads&formId=${formId}`
        : `/api/websites?op=list-leads&projectId=${project.id}`;

      const res = await authFetch(url);
      if (!res.ok) throw new Error('Failed to load leads');
      const data = await res.json();
      setCapturedLeads(data.leads || []);
    } catch (e: any) {
      console.error('Failed to load leads', e);
      setLeadsError(e?.message || 'Failed to load leads');
    } finally {
      setLoadingLeads(false);
    }
  };

  const handleDeleteLeadForm = async (formId: string) => {
    if (!confirm('Are you sure you want to delete this form and all its leads?')) return;
    setLeadFormSaveMessage('Deleting form...');
    try {
      const res = await authFetch('/api/websites?op=delete-form', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ formId })
      });
      if (!res.ok) throw new Error('Failed to delete form');
      setLocalLeadForms(prev => prev.filter(f => f.id !== formId));
      setCapturedLeads(prev => prev.filter(l => l.formId !== formId));
      setLeadFormSaveMessage('Form deleted');
      setTimeout(() => setLeadFormSaveMessage(null), 2000);
    } catch (e: any) {
      console.error('Failed to delete form', e);
      setLeadFormError('Failed to delete form');
    }
  };

  const handleDeleteLead = async (leadId: string) => {
    const lead = capturedLeads.find(l => l.id === leadId);
    if (!lead) return;

    setDeletingLeadId(leadId);
    try {
      const res = await authFetch('/api/websites?op=delete-lead', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ leadId, formId: lead.formId })
      });
      if (!res.ok) throw new Error('Failed to delete lead');
      setCapturedLeads(prev => prev.filter(l => l.id !== leadId));
    } catch (e: any) {
      console.error('Failed to delete lead', e);
    } finally {
      setDeletingLeadId(null);
    }
  };

  const handleExportLeads = () => {
    if (capturedLeads.length === 0) return;

    // Get all unique field keys across all leads
    const allKeys = new Set<string>();
    capturedLeads.forEach(lead => {
      Object.keys(lead.data).forEach(key => allKeys.add(key));
    });
    const headers = ['Form', 'Submitted At', ...Array.from(allKeys)];

    const rows = capturedLeads.map(lead => {
      const date = new Date(lead.submittedAt).toLocaleString();
      const values = Array.from(allKeys).map(key => lead.data[key] || '');
      return [lead.formTitle, date, ...values];
    });

    const csv = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `leads-${project.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // Load forms on mount (for counts)
  useEffect(() => {
    if (project.id) {
      loadLeadForms();
    }
  }, [project.id]);

  // Load leads when switching to leads tab
  useEffect(() => {
    if (filterType === 'forms') {
      loadCapturedLeads();
    }
  }, [filterType, project.id]);

  /* 
   * Updated handleShareWebsite to use "Hosted" sharing.
   * 1. Uploads content to blob (existing logic).
   * 2. Calls /api/websites?op=create to get a slug.
   * 3. Constructs the final hosted URL.
   */
  const handleShareWebsite = async (asset: AssetItem, e?: React.MouseEvent) => {
    e?.stopPropagation();
    if (!asset.data || websiteShareLoading) return;

    const websiteData = asset.data as SavedWebsiteVersion;
    if (!websiteData.html) return;

    // Use current location origin for the link base
    const origin = typeof window !== 'undefined' ? window.location.origin : 'https://freshfront.co';

    // If we already have a slug/publicUrl, just copy it
    if (websiteData.slug) {
      const url = `${origin}/w/${websiteData.slug}`;
      if (navigator.clipboard) {
        await navigator.clipboard.writeText(url);
        setWebsiteSaveMessage('Hosted link copied!');
        setTimeout(() => setWebsiteSaveMessage(null), 3000);
      }
      return;
    }

    setWebsiteShareLoading(asset.id);
    setWebsiteSaveMessage(null);

    try {
      const blob = new Blob([websiteData.html], { type: 'text/html' });
      const file = new File([blob], `website-${websiteData.id}.html`, { type: 'text/html' });

      // 1. Upload to Blob Store
      const targetSessionId = asset.researchId === 'project-assets' ? undefined : asset.researchId;
      const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file, targetSessionId);

      // 2. Create Hosted Slug
      const createRes = await authFetch('/api/websites?op=create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          blobUrl: kbFile.url,
          html: websiteData.html, // Send HTML directly to avoid fetch errors on server
          projectId: project.id,
          versionId: websiteData.id,
          title: asset.title || 'United Website'
        })
      });

      if (!createRes.ok) throw new Error('Failed to create hosted link');
      const { slug } = await createRes.json();

      const publicUrl = `${origin}/w/${slug}`;
      const shareFileId = kbFile.id;

      // Update local data
      const updatedWebsiteData: SavedWebsiteVersion = {
        ...websiteData,
        publicUrl, // Keep for backward compat or just store the full URL
        shareFileId,
        slug
      };

      // Persist update
      let updatedSessions = [...(project.researchSessions || [])];
      let found = false;

      for (let i = 0; i < updatedSessions.length; i++) {
        const session = updatedSessions[i];
        if (session.websiteVersions) {
          const vIndex = session.websiteVersions.findIndex(v => v.id === websiteData.id);
          if (vIndex !== -1) {
            const updatedVersions = [...session.websiteVersions];
            updatedVersions[vIndex] = updatedWebsiteData;
            updatedSessions[i] = { ...session, websiteVersions: updatedVersions };

            await storageService.updateResearchSession(project.id, session.id, {
              websiteVersions: updatedVersions
            });
            found = true;
            break;
          }
        }
      }

      if (!found) console.warn('Could not persist website share info (session not found)');

      if (onProjectUpdate) {
        onProjectUpdate({ ...project, researchSessions: updatedSessions });
      }

      setLocalProjectWebsites(prev => prev.map(a => {
        if (a.id === asset.id) return { ...a, data: updatedWebsiteData };
        return a;
      }));

      // Copy to clipboard
      if (navigator.clipboard) {
        try {
          window.focus(); // Ensure document has focus
          await navigator.clipboard.writeText(publicUrl);
          setWebsiteSaveMessage('Hosted link created & copied!');
          setTimeout(() => setWebsiteSaveMessage(null), 3000);
        } catch (copyErr) {
          console.warn('Clipboard write failed:', copyErr);
          setWebsiteSaveMessage(`Link created: ${publicUrl}`); // Show link so user can manual copy
          // Fallback: Try to show it in a prompt or alert if needed, but toast message with link is better than nothing
        }
      }

    } catch (e: any) {
      console.error('Failed to share website', e);
      setWebsiteError(e.message || 'Share failed');
      setTimeout(() => setWebsiteError(null), 4000);
    } finally {
      setWebsiteShareLoading(null);
    }
  };

  const handleDownloadWebsite = (asset: AssetItem, e?: React.MouseEvent) => {
    e?.stopPropagation();
    const websiteData = asset.data as SavedWebsiteVersion;
    if (!websiteData?.html) return;

    const blob = new Blob([websiteData.html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `website-${websiteData.description.substring(0, 30).replace(/[^a-z0-9]/gi, '-').toLowerCase()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const handleConvertWebsiteToPdf = async (asset: AssetItem, e?: React.MouseEvent) => {
    e?.stopPropagation();
    const websiteData = asset.data as SavedWebsiteVersion;
    if (!websiteData?.html || convertingPdf) return;

    try {
      setConvertingPdf(asset.id);
      setWebsiteSaveMessage('Converting to PDF...');

      const secret = process.env.NEXT_PUBLIC_CONVERTAPI_SECRET;
      if (!secret) {
        throw new Error('ConvertAPI secret not configured');
      }

      // Create form data with HTML content
      const formData = new FormData();
      formData.append('File', new Blob([websiteData.html], { type: 'text/html' }), 'website.html');
      formData.append('PageSize', 'letter');
      formData.append('ViewportWidth', '1920');
      formData.append('ViewportHeight', '1080');
      formData.append('MarginTop', '0');
      formData.append('MarginBottom', '0');
      formData.append('MarginLeft', '0');
      formData.append('MarginRight', '0');
      formData.append('ConversionDelay', '7');
      formData.append('JavaScript', 'true');
      formData.append('LoadLazyContent', 'true');
      formData.append('Background', 'true');
      formData.append('Scale', '100');

      // Call ConvertAPI REST endpoint with download=attachment
      const apiResponse = await fetch(`https://v2.convertapi.com/convert/html/to/pdf?Secret=${secret}&download=attachment`, {
        method: 'POST',
        body: formData
      });

      if (!apiResponse.ok) {
        throw new Error(`ConvertAPI error: ${apiResponse.statusText}`);
      }

      const pdfBlob = await apiResponse.blob();

      // Create download link
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `website-${websiteData.description.substring(0, 30).replace(/[^a-z0-9]/gi, '-').toLowerCase()}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setWebsiteSaveMessage('PDF downloaded successfully!');
      setTimeout(() => setWebsiteSaveMessage(null), 3000);
    } catch (error: any) {
      console.error('PDF conversion failed:', error);
      setWebsiteError(error?.message || 'Failed to convert to PDF');
      setTimeout(() => setWebsiteError(null), 4000);
    } finally {
      setConvertingPdf(null);
    }
  };

  // === Custom Domain Handlers ===
  const handleOpenCustomDomainModal = async (asset: AssetItem) => {
    // Support both website (SavedWebsiteVersion) and leadform (LeadFormAsset) types
    const assetData = asset.data as { slug?: string };
    if (!assetData?.slug) {
      setWebsiteError('Please share this first to get a hosted link');
      setTimeout(() => setWebsiteError(null), 4000);
      return;
    }

    setCustomDomainModalOpen(assetData.slug);
    setCustomDomainInput('');
    setCustomDomainError(null);
    setCustomDomainStatus(null);

    // Check current domain status
    try {
      setCustomDomainLoading(true);
      const res = await authFetch(`/api/websites?op=check-domain&slug=${assetData.slug}`);
      if (res.ok) {
        const data = await res.json();
        setCustomDomainStatus(data);
        if (data.domain) {
          setCustomDomainInput(data.domain);
        }
      }
    } catch (err) {
      console.error('Failed to check domain status', err);
    } finally {
      setCustomDomainLoading(false);
    }
  };

  const handleAddCustomDomain = async () => {
    if (!customDomainModalOpen || !customDomainInput.trim()) return;

    setCustomDomainLoading(true);
    setCustomDomainError(null);

    try {
      const res = await authFetch('/api/websites?op=add-domain', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          domain: customDomainInput.trim().toLowerCase(),
          websiteSlug: customDomainModalOpen
        })
      });

      const data = await res.json();

      if (!res.ok) {
        setCustomDomainError(data.error || 'Failed to add domain');
        return;
      }

      setCustomDomainStatus({
        hasDomain: true,
        domain: data.domain,
        verified: data.verified,
        verification: data.verification
      });
    } catch (err: any) {
      setCustomDomainError(err.message || 'Failed to add domain');
    } finally {
      setCustomDomainLoading(false);
    }
  };

  const handleCheckDomainStatus = async () => {
    if (!customDomainModalOpen || !customDomainStatus?.domain) return;

    setCustomDomainLoading(true);
    setCustomDomainError(null);

    try {
      // Use verify-domain endpoint to trigger explicit verification check with Vercel
      const res = await authFetch('/api/websites?op=verify-domain', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          domain: customDomainStatus.domain,
          websiteSlug: customDomainModalOpen
        })
      });

      if (res.ok) {
        const data = await res.json();
        setCustomDomainStatus({
          hasDomain: true,
          domain: data.domain,
          verified: data.verified,
          verification: data.verification
        });
      } else {
        const data = await res.json();
        setCustomDomainError(data.error || 'Failed to verify domain');
      }
    } catch (err) {
      console.error('Failed to verify domain', err);
      setCustomDomainError('Failed to verify domain');
    } finally {
      setCustomDomainLoading(false);
    }
  };

  const handleRemoveCustomDomain = async () => {
    if (!customDomainModalOpen || !customDomainStatus?.domain) return;

    setCustomDomainLoading(true);
    setCustomDomainError(null);

    try {
      const res = await authFetch('/api/websites?op=remove-domain', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          domain: customDomainStatus.domain,
          websiteSlug: customDomainModalOpen
        })
      });

      if (!res.ok) {
        const data = await res.json();
        setCustomDomainError(data.error || 'Failed to remove domain');
        return;
      }

      setCustomDomainStatus({ hasDomain: false });
      setCustomDomainInput('');
    } catch (err: any) {
      setCustomDomainError(err.message || 'Failed to remove domain');
    } finally {
      setCustomDomainLoading(false);
    }
  };

  const handleEditImage = async (asset: AssetItem) => {
    try {
      if (!asset.url) return;

      // select images tab
      setFilterType('images');

      // scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // Also try to scroll the container view if we are in a scrollable div
      setTimeout(() => {
        topRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);

      // set prompt if available
      if (asset.description) {
        setImagePrompt(asset.description);
      } else if (asset.title && asset.title !== 'Untitled') {
        setImagePrompt(asset.title);
      }

      // Convert URL to File
      // We try to fetch the asset URL and convert it to a File object
      console.log('[ProjectAssets] Fetching image for edit:', asset.url);
      const res = await fetch(asset.url);
      if (!res.ok) throw new Error(`Failed to fetch image: ${res.statusText}`);
      const blob = await res.blob();
      console.log('[ProjectAssets] Image fetched, blob size:', blob.size);
      const filename = asset.title || 'image-reference.png';
      const file = new File([blob], filename, { type: blob.type });

      // Detect image dimensions and set aspect ratio to match
      const imgUrl = URL.createObjectURL(blob);
      const img = new Image();
      await new Promise<void>((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = reject;
        img.src = imgUrl;
      });
      URL.revokeObjectURL(imgUrl);

      const { width, height } = img;
      const ratio = width / height;
      console.log('[ProjectAssets] Image dimensions:', width, 'x', height, 'ratio:', ratio.toFixed(2));

      // Map to closest supported aspect ratio
      const aspectRatios: Array<{ value: '1:1' | '2:3' | '3:2' | '3:4' | '4:3' | '4:5' | '5:4' | '9:16' | '16:9' | '21:9'; ratio: number }> = [
        { value: '1:1', ratio: 1 },
        { value: '2:3', ratio: 2 / 3 },
        { value: '3:2', ratio: 3 / 2 },
        { value: '3:4', ratio: 3 / 4 },
        { value: '4:3', ratio: 4 / 3 },
        { value: '4:5', ratio: 4 / 5 },
        { value: '5:4', ratio: 5 / 4 },
        { value: '9:16', ratio: 9 / 16 },
        { value: '16:9', ratio: 16 / 9 },
        { value: '21:9', ratio: 21 / 9 },
      ];
      const closest = aspectRatios.reduce((prev, curr) =>
        Math.abs(curr.ratio - ratio) < Math.abs(prev.ratio - ratio) ? curr : prev
      );
      console.log('[ProjectAssets] Setting aspect ratio to:', closest.value);
      setImageAspectRatio(closest.value);

      setImageReferenceFiles([file]);
      console.log('[ProjectAssets] Set image reference files');

    } catch (error) {
      console.error('Failed to load image for editing:', error);
      setImageError('Failed to load image for editing.');
    }
  };

  const fetchImageAsBase64 = async (url: string): Promise<string> => {
    try {
      if (url.startsWith('data:image')) {
        return url.split(',')[1];
      }
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const res = reader.result as string;
          resolve(res.split(',')[1]);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (error) {
      console.error('Error fetching image for base64:', error);
      throw error;
    }
  };

  const handleGenerateImage = async () => {
    if (!imagePrompt.trim()) return;

    // Credit check moved to after reference calculation to account for all image sources

    setIsGeneratingImage(true);
    setImageError(null);
    setImageSaveMessage(null);
    setAutoReferenceHints([]);
    try {
      const manualRefs: ImageReference[] = [];

      // Check for reference files FIRST to decide if we need prompt refinement
      if (imageReferenceFiles.length) {
        for (const file of imageReferenceFiles) {
          const base64 = await fileToBase64(file);
          manualRefs.push({ base64, mimeType: file.type || 'image/png' });
        }
      }

      // For edit mode (with references), skip heavy prompt refinement to avoid timeout
      // The image model handles the edit instruction directly
      let magicPrompt: string;
      if (manualRefs.length > 0) {
        // Use raw prompt for editing - the image is the context
        magicPrompt = imagePrompt.trim();
        console.log('[ProjectAssets] Edit mode: using raw prompt (skipping refinement)');
      } else {
        const ctx = contextService.buildProjectContext(project);
        magicPrompt = await refinePromptWithGemini3(imagePrompt, ctx.fullContext, 'image');
      }
      let result: { imageDataUrl: string; parts?: any[] };

      // Add profile picture if selected
      // Automatically detect if profile picture should be used based on prompt
      const profileKeywords = /\b(profile|avatar|me|myself|photo of me|logo|headshot|face)\b/i;
      const shouldIncludeProfile = userProfile?.photoURL && profileKeywords.test(imagePrompt);

      if (shouldIncludeProfile && userProfile?.photoURL) {
        try {
          const base64 = await fetchImageAsBase64(userProfile.photoURL);
          manualRefs.push({ base64, mimeType: 'image/png' }); // Assuming PNG/JPEG, Gemini handles it
        } catch (err) {
          console.error('Failed to load profile picture:', err);
        }
      }



      const uploadRefs: ImageReference[] = [];
      const referencedUploads = getRelevantUploads(imagePrompt, 3).filter(file => {
        const mime = file.mimeType || '';
        const name = file.displayName || file.name || '';
        const isImageMime = mime.startsWith('image/');
        const isImageName = /\.(png|jpe?g|gif|webp|svg)$/i.test(name);
        return isImageMime || isImageName;
      });

      for (const upload of referencedUploads) {
        const ref = await fetchUploadImageReference(upload);
        if (ref) {
          uploadRefs.push(ref);
        }
      }

      const combinedRefs = [...manualRefs, ...uploadRefs];

      if (uploadRefs.length) {
        setAutoReferenceHints(referencedUploads.map(file => file.displayName || file.name));
      }

      const useProModel = imageModel === 'pro';

      // Resolve 'auto' aspect ratio to detected ratio from reference image
      let finalAspectRatio: '1:1' | '2:3' | '3:2' | '3:4' | '4:3' | '4:5' | '5:4' | '9:16' | '16:9' | '21:9' = '1:1';
      if (imageAspectRatio === 'auto') {
        // If auto and we have a reference image, detect it
        if (imageReferenceFiles.length > 0) {
          try {
            finalAspectRatio = await detectImageAspectRatio(imageReferenceFiles[0]);
          } catch (err) {
            console.error('Failed to detect aspect ratio, using 1:1 fallback:', err);
            finalAspectRatio = '1:1';
          }
        } else {
          // No reference image, fallback to 1:1
          finalAspectRatio = '1:1';
        }
      } else {
        // User has selected a specific aspect ratio
        finalAspectRatio = imageAspectRatio;
      }

      const imageOptions = {
        aspectRatio: finalAspectRatio,
        imageSize: useProModel ? imageResolution : undefined,
        useProModel,
      };

      // Check credit cost based on mode
      // If > 1 ref images -> Ingredients Mode (Pro)
      // If 1 ref image -> Edit Mode (Flash)
      // Else -> Standard Generation (Pro or Fast)
      let operation: CreditOperation = 'imageGenerationFast';

      if (combinedRefs.length > 1) {
        operation = 'imageGenerationPro';
      } else if (combinedRefs.length === 1) {
        operation = 'imageGenerationFast';
      } else {
        operation = imageModel === 'pro' ? 'imageGenerationPro' : 'imageGenerationFast';
      }

      const hasCredits = await checkCredits(operation);
      if (!hasCredits) {
        setIsGeneratingImage(false);
        return;
      }

      const success = await deductCredits(operation);
      if (!success) {
        setImageError('Failed to deduct credits');
        setIsGeneratingImage(false);
        return;
      }

      if (combinedRefs.length > 0) {
        // Image Editing Mode (Text + Images -> Image)
        // If 1 image: Edit mode (Flash)
        // If >1 images: Ingredients mode (Pro)
        let blob: Blob;

        if (combinedRefs.length === 1) {
          // Use server-side editImageWithReferences for proper edit mode handling
          console.log('[ProjectAssets] Starting editImageWithReferences with prompt:', magicPrompt.substring(0, 100), '...');
          console.log('[ProjectAssets] Reference image size (base64 chars):', combinedRefs[0].base64.length);
          const editResult = await editImageWithReferences(magicPrompt, combinedRefs, imageOptions);
          console.log('[ProjectAssets] editImageWithReferences returned, converting to blob...');
          // Convert Data URL to Blob for compatibility
          const response = await fetch(editResult.imageDataUrl);
          blob = await response.blob();
          console.log('[ProjectAssets] Blob created, size:', blob.size);
        } else {
          // Ingredients Mode (Gemini 3 Pro)
          blob = await generateImageWithIngredients(combinedRefs, magicPrompt, {
            aspectRatio: imageOptions.aspectRatio,
            imageSize: imageOptions.imageSize
          });
        }

        // Create a local URL for the result
        const url = URL.createObjectURL(blob);

        setGeneratedImage({
          url,
          prompt: magicPrompt,
          parts: []
        });
      } else {
        result = await generateImageWithReferences(magicPrompt, [], imageOptions);
        setGeneratedImage({ url: result.imageDataUrl, prompt: magicPrompt, parts: result.parts });
      }

      if (generatedImage?.url && generatedImage.url.startsWith('blob:')) {
        URL.revokeObjectURL(generatedImage.url);
      }

      setImageEditPrompt('');
    } catch (e: any) {
      console.error('Image generation failed', e);
      setImageError(e?.message || 'Image generation failed');
    } finally {
      setIsGeneratingImage(false);
    }
  };

  const handleEditGeneratedImage = async () => {
    if (!generatedImage?.url || !imageEditPrompt.trim()) return;
    setIsEditingGeneratedImage(true);
    setImageError(null);
    setImageSaveMessage(null);
    try {
      const res = await fetch(generatedImage.url);
      const blob = await res.blob();
      const base64 = await blobToBase64(blob);
      const mimeType = blob.type || 'image/png';
      const ref: ImageReference = { base64, mimeType };

      const useProModel = imageModel === 'pro';
      const result = await editImageWithReferences(imageEditPrompt.trim(), [ref], {
        aspectRatio: imageAspectRatio,
        imageSize: useProModel ? imageResolution : undefined,
        useProModel,
      });

      const editedUrl = result.imageDataUrl;
      const editedParts = result.parts;

      if (generatedImage?.url && generatedImage.url.startsWith('blob:')) {
        URL.revokeObjectURL(generatedImage.url);
      }

      setGeneratedImage({ url: editedUrl, prompt: `${generatedImage.prompt}\n\nEDIT: ${imageEditPrompt.trim()}`, parts: editedParts });
      setImageEditPrompt('');
    } catch (e: any) {
      console.error('Image edit failed', e);
      setImageError(e?.message || 'Image edit failed');
    } finally {
      setIsEditingGeneratedImage(false);
    }
  };

  const handleSaveGeneratedImage = async () => {
    if (!generatedImage) return;
    try {
      setImageSaveMessage(null);
      const res = await fetch(generatedImage.url);
      const blob = await res.blob();
      const fileName = `generated-image-${Date.now()}.png`;
      const file = new File([blob], fileName, { type: blob.type || 'image/png' });
      const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);

      const existingKb = project.knowledgeBase || [];
      const updatedKnowledgeBase = [...existingKb, kbFile];
      try {
        await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
      } catch (err) {
        console.error('Failed to persist generated image into project knowledge base', err);
      }

      onProjectUpdate?.({
        ...project,
        knowledgeBase: updatedKnowledgeBase,
        lastModified: Date.now(),
      });

      setImageSaveMessage('Saved to project knowledge base');
    } catch (e: any) {
      setImageSaveMessage(e?.message || 'Failed to save image to project');
    }
  };

  const handleSaveGeneratedVideo = async () => {
    if (!videoBlob && !videoUrl) return;
    try {
      setVideoSaveMessage(null);
      let blob = videoBlob;
      if (!blob && videoUrl) {
        const res = await fetch(videoUrl);
        blob = await res.blob();
      }
      if (!blob) return;
      const fileName = `generated-video-${Date.now()}.mp4`;
      const file = new File([blob], fileName, { type: 'video/mp4' });
      const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);

      // Check if upload succeeded (has a real URL, not a temporary blob: URL)
      const isPermanent = kbFile.url && !kbFile.url.startsWith('blob:');
      if (!isPermanent) {
        console.warn('[Video Save] Upload returned temporary blob URL - video will not persist after refresh');
      }

      const existingKb = project.knowledgeBase || [];
      const updatedKnowledgeBase = [...existingKb, kbFile];
      try {
        await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
      } catch (err) {
        console.error('Failed to persist generated video into project knowledge base', err);
      }

      onProjectUpdate?.({
        ...project,
        knowledgeBase: updatedKnowledgeBase,
        lastModified: Date.now(),
      });

      if (isPermanent) {
        setVideoSaveMessage('Saved to project knowledge base');
      } else {
        setVideoSaveMessage('Saved locally (cloud upload failed - video may not persist)');
      }
    } catch (e: any) {
      console.error('[Video Save] Error:', e);
      setVideoSaveMessage(e?.message || 'Failed to save video to project');
    }
  };

  const handleGenerateVideo = async () => {
    if (!videoPrompt.trim()) return;

    // Determine operation cost
    const operation: CreditOperation = videoType === 'overview' ? 'videoOverviewGeneration' : 'videoClipGeneration';

    // Credit Check
    const hasCredits = await checkCredits(operation);
    if (!hasCredits) return;

    const success = await deductCredits(operation);
    if (!success) {
      setVideoError('Failed to deduct credits');
      return;
    }

    setIsGeneratingVideo(true);
    setVideoError(null);
    setVideoSaveMessage(null);
    setVideoProgress(null);
    setVideoStatus('queued');
    try {
      const userPrompt = videoPrompt.trim();
      const ctx = contextService.buildProjectContext(project);
      const magicPrompt = await refinePromptWithGemini3(videoPrompt, ctx.fullContext, 'video');

      const titleContext = `Project: ${project.name}
Description: ${project.description}
Video type: clip
User request: ${userPrompt}

PROJECT CONTEXT:
${ctx.fullContext}

Video generation prompt:
${magicPrompt}`;

      const videoContextDescription = `PROJECT CONTEXT:
${ctx.fullContext}

ADDITIONAL NOTES:
${project.notes?.slice(0, 10).map(n => n.content).join('\n') || ''}

KNOWLEDGE BASE:
${project.knowledgeBase?.slice(0, 5).map(f => f.summary).join('\n') || ''}`;



      // If Overview type is selected, use Gemini TTS + Images + Creatomate assembly
      if (videoType === 'overview') {
        try {
          setVideoStatus('queued...');
          setVideoProgress(0);
          const aspectString = videoSize === '1280x720' || videoSize === '1792x1024' ? '1280x720' : '720x1280';
          const result = await createVideoOverview({
            projectId: project.id,
            prompt: magicPrompt, // Use refined prompt for better quality
            aspect: aspectString,
            contextDescription: videoContextDescription,
            slideCount: videoSlides,
            voiceName: 'Kore',
            onStatusUpdate: (status, progress) => {
              let displayStatus = progress || status;
              // Simulate progress for long-running HeyGen step
              if (status === 'generating_avatar' || status === 'processing') {
                if (!videoProgressInterval.current) {
                  setVideoProgress(10);
                  // Increment to ~95% over 15 minutes (900s). Check every 5s => 180 steps.
                  // 85 / 180 ~= 0.47
                  videoProgressInterval.current = setInterval(() => {
                    setVideoProgress(prev => {
                      if (prev === null || prev >= 95) return prev;
                      return Math.round((prev + 0.5) * 10) / 10;
                    });
                  }, 5000);
                }
                displayStatus = 'Generating avatar (Warning: this takes 10-20 mins)...';
              }
              setVideoStatus(displayStatus);
            },
          });

          if (videoUrl) URL.revokeObjectURL(videoUrl);

          // Fetch the video blob for download/save
          const response = await fetch(result.url);
          const blob = await response.blob();
          const localUrl = URL.createObjectURL(blob);

          setVideoUrl(localUrl);
          setVideoBlob(blob);

          if (videoProgressInterval.current) {
            clearInterval(videoProgressInterval.current);
            videoProgressInterval.current = null;
          }
          setVideoProgress(100);
          setVideoStatus('completed');

          try {
            const rawTitle = (await generateVideoTitleFromContext(titleContext)).trim();
            const baseTitle = rawTitle || 'Project Overview';
            const safeTitle = baseTitle.replace(/[\\/:*?"<>|]+/g, '').slice(0, 80).trim() || 'Project Overview';
            const fileName = `${safeTitle}.mp4`;

            // Upload to knowledge base using the same pattern as handleSaveGeneratedVideo
            const file = new File([blob], fileName, { type: 'video/mp4' });
            const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);

            const existingKb = project.knowledgeBase || [];
            const updatedKnowledgeBase = [...existingKb, kbFile];
            await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });

            onProjectUpdate?.({
              ...project,
              knowledgeBase: updatedKnowledgeBase,
              lastModified: Date.now(),
            });

            setVideoSaveMessage('Saved to project!');
          } catch (saveErr) {
            console.warn('Failed to auto-save overview video:', saveErr);
          }
        } catch (err: any) {
          if (videoProgressInterval.current) {
            clearInterval(videoProgressInterval.current);
            videoProgressInterval.current = null;
          }
          console.error('Overview video generation failed:', err);
          setVideoError(err?.message || 'Failed to generate overview video');
          setVideoStatus(null);
        } finally {
          setIsGeneratingVideo(false);
        }
        return;
      }

      // If Veo engine is selected, try Veo first (with optional reference images), then Creatomate.
      if (videoEngine === 'veo') {
        try {
          setVideoStatus('generating');

          // Process reference images (Veo 3.1)
          const referenceImages = [];

          // Add legacy single image if present (compatibility)
          if (videoImageFile) {
            const reader = new FileReader();
            const base64 = await new Promise<string>((resolve, reject) => {
              reader.onload = () => resolve((reader.result as string).split(',')[1]);
              reader.onerror = reject;
              reader.readAsDataURL(videoImageFile);
            });
            referenceImages.push({ base64, mimeType: videoImageFile.type });
          }

          // Add new multi-reference images
          for (const file of videoReferenceFiles) {
            const reader = new FileReader();
            const base64 = await new Promise<string>((resolve, reject) => {
              reader.onload = () => resolve((reader.result as string).split(',')[1]);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            referenceImages.push({ base64, mimeType: file.type });
          }

          const aspectRatio: '16:9' | '9:16' =
            videoSize === '1280x720' || videoSize === '1792x1024' ? '16:9' : '9:16';

          // Map the existing Sora mode toggle into Veo's speed/quality behavior.
          const veoQualityMode: 'speed' | 'quality' =
            videoModel === 'sora-2-pro' ? 'quality' : 'speed';

          const veoBlob = await generateVeoVideo(
            magicPrompt,
            aspectRatio,
            veoQualityMode,
            referenceImages
          );
          if (videoUrl) URL.revokeObjectURL(videoUrl);
          const veoUrl = URL.createObjectURL(veoBlob);
          setVideoUrl(veoUrl);
          setVideoBlob(veoBlob);
          setVideoStatus('completed');

          try {
            const rawTitle = (await generateVideoTitleFromContext(titleContext)).trim();
            const baseTitle = rawTitle || 'Project explainer';
            const safeTitle = baseTitle.replace(/[\\/:*?"<>|]+/g, '').slice(0, 80).trim() || 'Project explainer';
            const fileName = `${safeTitle}.mp4`;
            const veoFile = new File([veoBlob], fileName, { type: 'video/mp4' });
            const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, veoFile);

            // Check if upload succeeded with a permanent URL
            const isPermanent = kbFile.url && !kbFile.url.startsWith('blob:');
            if (!isPermanent) {
              console.warn('[Video Auto-Save] Veo upload returned temporary blob URL');
            }

            const existingKb = project.knowledgeBase || [];
            const updatedKnowledgeBase = [...existingKb, kbFile];
            await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
            onProjectUpdate?.({
              ...project,
              knowledgeBase: updatedKnowledgeBase,
              lastModified: Date.now(),
            });
            setVideoSaveMessage(isPermanent ? 'Saved to project assets' : 'Saved locally (cloud upload failed)');
          } catch (veoPersistError) {
            console.error('Failed to persist Veo-generated video to project knowledge base', veoPersistError);
          }
          return;
        } catch (veoError: any) {
          console.error('Veo video generation failed, falling back to Creatomate voiceover video...', veoError);
        }

        // Creatomate fallback for Veo
        try {
          setVideoStatus('rendering');
          const fallback = await createVoiceoverVideoWithCreatomate({
            prompt: magicPrompt,
            voiceoverPrompt: userPrompt || project.description || project.name,
            aspect: videoSize,
            durationSeconds: Number(videoSeconds),
            contextDescription: videoContextDescription,
          });

          const res = await fetch(fallback.url);
          const blob = await res.blob();
          if (videoUrl) URL.revokeObjectURL(videoUrl);
          const url = URL.createObjectURL(blob);
          setVideoUrl(url);
          setVideoBlob(blob);
          setVideoStatus('completed');

          try {
            const rawTitle = (await generateVideoTitleFromContext(titleContext)).trim();
            const baseTitle = rawTitle || 'Project explainer';
            const safeTitle = baseTitle.replace(/[\\/:*?"<>|]+/g, '').slice(0, 80).trim() || 'Project explainer';
            const fileName = `${safeTitle}.mp4`;
            const file = new File([blob], fileName, { type: 'video/mp4' });
            const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);
            const existingKb = project.knowledgeBase || [];
            const updatedKnowledgeBase = [...existingKb, kbFile];
            await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
            onProjectUpdate?.({
              ...project,
              knowledgeBase: updatedKnowledgeBase,
              lastModified: Date.now(),
            });
            setVideoSaveMessage('Saved to project assets');
          } catch (persistError) {
            console.error('Failed to persist Creatomate-generated video to project knowledge base', persistError);
          }

          return;
        } catch (fallbackError: any) {
          console.error('Creatomate fallback video generation failed after Veo engine selection', fallbackError);
          throw fallbackError;
        }
      }

      // Default engine: Sora (existing path)
      try {
        // Primary path: Sora prototype API
        let job;
        if (videoImageFile) {
          const resized = await resizeImageFileForSora(videoImageFile, videoSize);
          job = await createVideoFromImage({
            model: videoModel,
            prompt: magicPrompt,
            seconds: videoSeconds,
            size: videoSize,
          }, resized);
        } else {
          job = await createVideoFromText({
            model: videoModel,
            prompt: magicPrompt,
            seconds: videoSeconds,
            size: videoSize,
          });
        }

        const finalJob = await pollVideoUntilComplete(job.id, (j) => {
          setVideoStatus(j.status);
          if (typeof j.progress === 'number') setVideoProgress(j.progress);
        }, 5000);

        if (finalJob.status !== 'completed') {
          throw new Error(finalJob.error?.message || `Video job ended with status: ${finalJob.status}`);
        }

        const blob = await downloadVideoBlob(finalJob.id, 'video');
        if (videoUrl) URL.revokeObjectURL(videoUrl);
        const url = URL.createObjectURL(blob);
        setVideoUrl(url);
        setVideoBlob(blob);

        // Auto-persist Sora-generated video into project knowledge base so it appears under Project Assets > videos.
        try {
          const rawTitle = (await generateVideoTitleFromContext(titleContext)).trim();
          const baseTitle = rawTitle || 'Project explainer';
          const safeTitle = baseTitle.replace(/[\\/:*?"<>|]+/g, '').slice(0, 80).trim() || 'Project explainer';
          const fileName = `${safeTitle}.mp4`;
          const file = new File([blob], fileName, { type: 'video/mp4' });
          const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);

          // Check if upload succeeded with a permanent URL
          const isPermanent = kbFile.url && !kbFile.url.startsWith('blob:');
          if (!isPermanent) {
            console.warn('[Video Auto-Save] Upload returned temporary blob URL');
          }

          const existingKb = project.knowledgeBase || [];
          const updatedKnowledgeBase = [...existingKb, kbFile];
          await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
          onProjectUpdate?.({
            ...project,
            knowledgeBase: updatedKnowledgeBase,
            lastModified: Date.now(),
          });
          setVideoSaveMessage(isPermanent ? 'Saved to project assets' : 'Saved locally (cloud upload failed)');
        } catch (persistError) {
          console.error('Failed to persist Sora-generated video to project knowledge base', persistError);
        }
        return;
      } catch (soraError: any) {
        console.error('Sora video generation failed, falling back to Creatomate voiceover video...', soraError);
      }

      // Fallback path: Creatomate RenderScript video with Pexels assets + voiceover
      try {
        setVideoStatus('rendering');
        const fallback = await createVoiceoverVideoWithCreatomate({
          prompt: magicPrompt, // rich visual context
          voiceoverPrompt: userPrompt || project.description || project.name,
          aspect: videoSize,
          durationSeconds: Number(videoSeconds),
          contextDescription: videoContextDescription,
        });

        const res = await fetch(fallback.url);
        const blob = await res.blob();
        if (videoUrl) URL.revokeObjectURL(videoUrl);
        const url = URL.createObjectURL(blob);
        setVideoUrl(url);
        setVideoBlob(blob);
        setVideoStatus('completed');

        // Auto-persist Creatomate fallback video into project knowledge base.
        try {
          const rawTitle = (await generateVideoTitleFromContext(titleContext)).trim();
          const baseTitle = rawTitle || 'Project explainer';
          const safeTitle = baseTitle.replace(/[\\/:*?"<>|]+/g, '').slice(0, 80).trim() || 'Project explainer';
          const fileName = `${safeTitle}.mp4`;
          const file = new File([blob], fileName, { type: 'video/mp4' });
          const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);

          // Check if upload succeeded with a permanent URL
          const isPermanent = kbFile.url && !kbFile.url.startsWith('blob:');
          if (!isPermanent) {
            console.warn('[Video Auto-Save] Creatomate upload returned temporary blob URL');
          }

          const existingKb = project.knowledgeBase || [];
          const updatedKnowledgeBase = [...existingKb, kbFile];
          await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
          onProjectUpdate?.({
            ...project,
            knowledgeBase: updatedKnowledgeBase,
            lastModified: Date.now(),
          });
          setVideoSaveMessage(isPermanent ? 'Saved to project assets' : 'Saved locally (cloud upload failed)');
        } catch (persistError) {
          console.error('Failed to persist Creatomate-generated video to project knowledge base', persistError);
        }
      } catch (fallbackError: any) {
        console.error('Creatomate fallback video generation failed', fallbackError);
        throw fallbackError;
      }
    } catch (e: any) {
      console.error('Video generation failed', e);
      setVideoError(e?.message || 'Video generation failed');
      setVideoStatus('failed');
    } finally {
      setIsGeneratingVideo(false);
    }
  };

  const handleGenerateVideoFromImage = async (asset: AssetItem) => {
    if (!asset.url) return;
    setVideoSaveMessage(null);
    setVideoError(null);
    setVideoStatus(null);

    // We need to fetch the file first
    let file: File;
    try {
      file = await fetchUrlAsFile(asset.url, asset.title);
    } catch (e) {
      console.error('Failed to fetch image for video generation', e);
      setVideoError('Failed to load image reference.');
      return;
    }

    // Set as reference image and clear others for a fresh start
    setVideoImageFile(file);
    setVideoReferenceFiles([]);

    const magicPrompt = `Animate this image of ${asset.title || 'a scene'}`;
    setVideoPrompt(magicPrompt);

    // Switch to videos tab which reveals the generator UI
    setFilterType('videos');

    // Optional: scroll to top if needed, but usually tab switch is enough context
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleEditImageNano = async () => {
    if (!selectedImage || !selectedImage.url || !nanoBananaEditPrompt.trim()) return;

    setIsNanoBananaEditing(true);
    setNanoBananaError(null);

    try {
      // 1. Fetch current image as File
      const file = await fetchUrlAsFile(selectedImage.url, selectedImage.title);
      // 2. Convert to Base64
      const base64 = await fileToBase64(file);
      const mimeType = file.type || 'image/png';

      // 3. Call Gemini Nano Editor
      const blob = await editImageWithGeminiNano(base64, mimeType, nanoBananaEditPrompt);

      // 4. Save to Project Assets
      const safeTitle = `${selectedImage.title} (edited)`.replace(/[\\/:*?"<>|]+/g, '').slice(0, 80).trim();
      const editedFile = new File([blob], `${safeTitle}.png`, { type: 'image/png' });
      const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, editedFile);

      const updatedKb = [...(project.knowledgeBase || []), kbFile];
      await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKb });

      onProjectUpdate?.({
        ...project,
        knowledgeBase: updatedKb,
        lastModified: Date.now(),
      });

      // Clear prompt
      setNanoBananaEditPrompt('');

      // If we were editing a local reference from the image generator, update that reference file
      let nextId = kbFile.id;
      if (selectedImage.id && selectedImage.id.startsWith('temp-ref-')) {
        const refIndex = parseInt(selectedImage.id.replace('temp-ref-', ''), 10);
        if (!isNaN(refIndex) && refIndex >= 0) {
          setImageReferenceFiles(prev => {
            const next = [...prev];
            if (next[refIndex]) {
              next[refIndex] = editedFile;
            }
            return next;
          });
          // Keep the ID as temp-ref so subsequent edits update the same slot
          nextId = selectedImage.id;
        }
      }

      // Update the selected image to the newly created asset so the preview stays open
      // We try to match the existing asset type if possible, or default to slide/image
      const newAsset: AssetItem = {
        id: nextId,
        type: selectedImage.type,
        url: kbFile.url,
        title: kbFile.name,
        description: nanoBananaEditPrompt,
        researchId: selectedImage.researchId || project.id,
        researchTopic: selectedImage.researchTopic || project.name,
        timestamp: Date.now(),
        data: { imageUrl: kbFile.url }
      };

      setSelectedImage(newAsset);
      setImageSaveMessage('Image edited and saved to assets');
    } catch (e: any) {
      console.error('Nano Banana Edit failed:', e);
      setNanoBananaError(e.message || 'Failed to edit image');
    } finally {
      setIsNanoBananaEditing(false);
    }
  };

  const suggestionsTriggerRef = useRef({
    projectId: project.id,
    researchCount: project.researchSessions?.length || 0,
    noteCount: (project.notes || []).length,
    fileCount: (project.uploadedFiles || []).length || 0,
  });
  const dataReferenceCacheRef = useRef<Map<string, ImageReference>>(new Map());

  const latestResearchSession = project.researchSessions?.[project.researchSessions.length - 1];
  const projectTheme: DualTheme | undefined = project.researchSessions?.[0]?.researchReport?.theme;

  const buildWebsiteSpecification = (prompt: string): string => {
    const recentResearch = (project.researchSessions || []).slice(-3).map(session => {
      const summary = session.researchReport?.summary || '';
      const keyPoints = (session.researchReport?.keyPoints || []).slice(0, 3).map(kp => ` ${kp.title}: ${kp.details}`).join('\n');
      return `Session: ${session.topic}\nSummary: ${summary}\n${keyPoints}`;
    }).join('\n\n');

    const uploads = (project.uploadedFiles || []).slice(-4).map(file => ` ${file.displayName || file.name}`).join('\n');
    const notes = (project.notes || []).slice(0, 4).map(note => ` ${note.title}`).join('\n');
    const tasks = (project.tasks || []).filter(t => t.status !== 'done').slice(0, 4).map(task => ` ${task.title}`).join('\n');

    return `PROJECT WEBSITE BRIEF
Project: ${project.name}
Mission: ${project.description}
User Goal: ${prompt.trim()}

Research Signals:
${recentResearch || 'No research sessions yet.'}

Active Tasks:
${tasks || 'No open tasks logged.'}

Pinned Notes:
${notes || 'No pinned notes available.'}

Uploaded Files of Interest:
${uploads || 'No uploaded files referenced.'}

Requirements:
- Modern, responsive layout with bold storytelling.
- Highlight key research insights and calls-to-action derived from context above.
- Include sections for hero, highlights, proof, and actionable next steps.`;
  };

  const buildWebsiteContext = () => {
    const ctx = contextService.buildProjectContext(project);
    return ctx.fullContext;
  };

  const handleGenerateBlog = async () => {
    if (!blogPrompt.trim()) return;

    // Credit Check
    const hasCredits = await checkCredits('blogGeneration');
    if (!hasCredits) return;

    const success = await deductCredits('blogGeneration');
    if (!success) {
      setBlogError('Failed to deduct credits');
      return;
    }

    setIsGeneratingBlog(true);
    setBlogError(null);
    setGeneratedBlog(null);
    try {
      const sessions = project.researchSessions || [];
      const latest = sessions[sessions.length - 1];
      const latestReport = latest?.researchReport;

      const topic = latestReport?.topic || project.name;
      const summarySource = latestReport?.summary || blogPrompt;
      const ctx = contextService.buildProjectContext(project);
      const magicSummary = await refinePromptWithGemini3(summarySource, ctx.fullContext, 'text');
      const keyPoints = latestReport?.keyPoints || [];

      const blog = await generateStructuredBlogPost(topic, magicSummary, keyPoints, ctx.fullContext);
      setGeneratedBlog(blog);

      // Immediately stop loading after AI generation completes
      setIsGeneratingBlog(false);

      if (blog) {
        let currentSession = latestResearchSession;

        // Fallback: Create a research session if none exists to ensure the asset is saved
        if (!currentSession) {
          try {
            const fallbackSession = await storageService.addResearchToProject(project.id, {
              topic: project.name,
              tldr: 'Initial project research session (auto-created)',
              summary: project.description,
              sources: [],
              keyPoints: [],
              marketImplications: '',
              headerImagePrompt: '',
              dynamicSections: []
            });
            currentSession = fallbackSession;
          } catch (sessErr) {
            console.error('Failed to create fallback research session for blog:', sessErr);
          }
        }

        // Persist into the research session
        if (currentSession) {
          try {
            const currentReport = currentSession.researchReport || {
              topic: project.name,
              tldr: '',
              summary: '',
              sources: [],
              keyPoints: [],
              marketImplications: '',
              headerImagePrompt: '',
              dynamicSections: []
            };
            await storageService.updateResearchInProject(project.id, currentSession.id, {
              researchReport: {
                ...currentReport,
                blogPost: blog,
              },
            });
            setBlogSaveMessage('Saved blog into research session');
          } catch (e) {
            console.error('Failed to save generated blog into research session:', e);
            setBlogSaveMessage('Failed to save to Firestore (kept locally)');
          }
        }

        // Track locally so it appears immediately in the Assets list
        setLocalGeneratedBlogs(prev => [
          {
            id: `local-blog-${Date.now()}`,
            type: 'blog',
            title: blog.title,
            description: blog.subtitle,
            data: blog,
            researchId: currentSession?.id || 'project-generated-blogs',
            researchTopic: currentSession?.topic || project.name,
            timestamp: Date.now(),
          },
          ...prev,
        ]);
      }
    } catch (e: any) {
      console.error('Blog generation failed', e);
      setBlogError(e?.message || 'Blog generation failed');
      setIsGeneratingBlog(false);
    }
  };

  const handleEditBlog = (asset: AssetItem) => {
    if (asset.type !== 'blog') return;
    const content = asset.data?.content || '';
    setFilterType('docs');
    setGoogleDocsText(content);
    setGoogleDocsLastLoadedText(content);
    setGoogleDocsSelected({
      documentId: asset.id,
      title: asset.title
    });
    setGoogleDocsMessage(null);
    setGoogleDocsLastSavedAt(null);
    // Ensure we are in edit mode, not preview
    setGoogleDocsPreviewMode(false);
  };

  const handleGeneratePodcast = async () => {
    if (!podcastPrompt.trim()) return;

    // Credit Check
    const operation: CreditOperation = podcastDuration === 'long' ? 'podcastLong' : podcastDuration === 'medium' ? 'podcastMedium' : 'podcastShort';
    const hasCredits = await checkCredits(operation);
    if (!hasCredits) return;

    const success = await deductCredits(operation);
    if (!success) {
      setPodcastError('Failed to deduct credits');
      return;
    }

    setIsGeneratingPodcast(true);
    setPodcastError(null);
    setPodcastSaveMessage(null);
    try {
      const sessions = project.researchSessions || [];
      const researchSummaries = sessions.map(session => ({
        topic: session.topic,
        summary: session.researchReport?.summary || session.researchReport?.tldr || '',
        keyPoints: session.researchReport?.keyPoints?.map(kp => kp.title) || [],
      }));

      const uploadedFiles = (project.uploadedFiles || []).map(f => ({
        displayName: f.displayName,
        name: f.name,
        mimeType: f.mimeType,
        summary: f.summary,
      }));

      const notes = project.notes || [];
      const noteSnippets = notes
        .slice(0, 10)
        .map(note => {
          const title = note.title || 'Untitled note';
          const body = (note.content || '').trim();
          const snippet = body.length > 200 ? `${body.slice(0, 200)}` : body;
          return `${title}: ${snippet || 'No content'}`;
        })
        .join('\n');

      const descriptionWithNotes = noteSnippets
        ? `${project.description}\n\nKey project notes:\n${noteSnippets}`
        : project.description;



      const ctx = contextService.buildProjectContext(project);

      // Integrate the user prompt into the description/context for the script writer
      const refinedPodcastPrompt = await refinePromptWithGemini3(podcastPrompt, ctx.fullContext, 'text');
      const enhancedDescription = `${descriptionWithNotes}\n\nUSER REQUEST FOR EPISODE:\n${refinedPodcastPrompt}`;

      const script = await generatePodcastScript(
        project.name,
        enhancedDescription,
        researchSummaries,
        podcastStyle,
        podcastDuration,
        uploadedFiles,
        ctx.fullContext
      );

      const audio = await generatePodcastAudio(script);

      const mimeType = audio.mimeType || 'audio/wav';
      const audioBlob = base64ToBlob(audio.audioData, mimeType);
      const safeTitle = script.title || 'podcast';
      const fileName = `${safeTitle.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.wav`;
      const file = new File([audioBlob], fileName, { type: mimeType });

      try {
        const kbFile = await storageService.uploadKnowledgeBaseFile(project.id, file);
        const existingKb = project.knowledgeBase || [];
        const updatedKnowledgeBase = [...existingKb, kbFile];
        await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
        onProjectUpdate?.({
          ...project,
          knowledgeBase: updatedKnowledgeBase,
          lastModified: Date.now(),
        });
        setPodcastSaveMessage('Saved to project assets');
      } catch (e: any) {
        console.error('Failed to save podcast audio to project knowledge base', e);
        setPodcastSaveMessage(e?.message || 'Failed to save podcast to project');
      }

      setPodcastPrompt('');
    } catch (e: any) {
      console.error('Podcast generation failed', e);
      setPodcastError(e?.message || 'Podcast generation failed');
    } finally {
      setIsGeneratingPodcast(false);
    }
  };

  const assetsBySession = useMemo(() => {
    const sessions = project.researchSessions || [];

    // Track which knowledge base files correspond to book page images so we can
    // avoid surfacing them twice (once as pages on sessions, once as generic
    // project-level images).
    const bookPageFileIds = new Set<string>();
    sessions.forEach(session => {
      const report = session.researchReport;
      if (!report || !report.books) return;
      report.books.forEach(book => {
        (book.pages || []).forEach(page => {
          if (page.id) {
            bookPageFileIds.add(page.id);
          }
        });
      });
    });

    const items = sessions.map(session => {
      const assets: AssetItem[] = [];
      const report = session.researchReport;

      if (!report) {
        return { session, assets };
      }

      if (report.headerImageUrl && !report.headerImageUrl.includes('placehold.co')) {
        assets.push({
          id: `header-${session.id}`,
          type: 'header',
          url: report.headerImageUrl,
          title: 'Hero Image',
          description: report.headerImagePrompt,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: session.timestamp
        });
      }

      if (report.slides) {
        report.slides.forEach((slide, idx) => {
          if (slide.imageUrl && !slide.imageUrl.includes('placehold.co')) {
            assets.push({
              id: `slide-${session.id}-${idx}`,
              type: 'slide',
              url: slide.imageUrl,
              title: slide.title || `Slide ${idx + 1}`,
              description: slide.imagePrompt,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: session.timestamp
            });
          }
          if (slide.imageUrls) {
            slide.imageUrls.forEach((url, imgIdx) => {
              if (url && !url.includes('placehold.co')) {
                assets.push({
                  id: `slide-${session.id}-${idx}-${imgIdx}`,
                  type: 'slide',
                  url: url,
                  title: `${slide.title || `Slide ${idx + 1}`} - Image ${imgIdx + 1}`,
                  researchId: session.id,
                  researchTopic: session.topic,
                  timestamp: session.timestamp
                });
              }
            });
          }
        });
      }

      if (session.noteMapState) {
        session.noteMapState.forEach((node, idx) => {
          if (node.imageUrl && !node.imageUrl.includes('placehold.co')) {
            assets.push({
              id: `notemap-${session.id}-${node.id}`,
              type: 'notemap',
              url: node.imageUrl,
              title: node.title || `Note ${idx + 1}`,
              description: node.content,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: session.timestamp
            });
          }
        });
      }

      if (report.blogPost && report.blogPost.content) {
        assets.push({
          id: `blog-${session.id}`,
          type: 'blog',
          url: report.blogPost.imageUrl,
          title: report.blogPost.title,
          description: report.blogPost.subtitle,
          data: report.blogPost,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: session.timestamp
        });
      }

      if (report.socialCampaign?.posts) {
        report.socialCampaign.posts.forEach((post, idx) => {
          if (post.imageUrl && !post.imageUrl.includes('placehold.co')) {
            assets.push({
              id: `social-${session.id}-${idx}`,
              type: 'social',
              url: post.imageUrl,
              title: `${post.platform} Post`,
              description: post.caption,
              data: post,
              researchId: session.id,
              researchTopic: session.topic,
              timestamp: session.timestamp
            });
          }
        });
      }

      if (report.videoPost && report.videoPost.videoUrl) {
        assets.push({
          id: `video-${session.id}`,
          type: 'video',
          url: report.videoPost.videoUrl,
          title: report.videoPost.caption || 'Social video',
          description: report.videoPost.hashtags,
          data: report.videoPost,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: session.timestamp,
        });
      }

      const websites = session.websiteVersions || [];
      websites.forEach((version, idx) => {
        assets.push({
          id: `website-${session.id}-${version.id}`,
          type: 'website',
          title: version.description || `Website v${websites.length - idx}`,
          data: version,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: version.timestamp
        });
      });

      const books = report.books || [];
      books.forEach(book => {
        // High-level book asset (for Books filter and PDF download)
        assets.push({
          id: `book-${session.id}-${book.id}`,
          type: 'book',
          title: book.title,
          description: book.description,
          data: book,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: book.createdAt || session.timestamp,
        });

        // Also surface each page image as an image asset so it appears under
        // the Images and All filters.
        (book.pages || []).forEach(page => {
          if (!page.imageUrl) return;
          assets.push({
            id: `book-page-${session.id}-${book.id}-${page.pageNumber}`,
            type: 'social',
            url: page.imageUrl,
            title: `${book.title}  Page ${page.pageNumber}`,
            description: page.text || book.description,
            researchId: session.id,
            researchTopic: session.topic,
            timestamp: book.createdAt || session.timestamp,
          });
        });
      });

      const tables = report.tables || [];
      tables.forEach(table => {
        assets.push({
          id: `table-${session.id}-${table.id}`,
          type: 'table',
          title: table.title,
          description: table.description,
          data: table,
          researchId: session.id,
          researchTopic: session.topic,
          timestamp: table.createdAt || session.timestamp,
        });
      });

      return {
        session,
        assets
      };
    }).filter(item => item.assets.length > 0);

    // Aggregate project-level assets (videos, podcasts, blogs, local generated blogs) into a single virtual "Project assets" session
    const knowledgeBase = project.knowledgeBase || [];
    const kbVideos = knowledgeBase.filter(file => file.type.startsWith('video/') || file.name.toLowerCase().endsWith('.mp4'));
    const kbPodcasts = knowledgeBase.filter(file => file.type.startsWith('audio/'));
    const kbBlogs = knowledgeBase.filter(file =>
      file.type.startsWith('text/') && file.name.endsWith('.md')
    );
    const kbImages = knowledgeBase.filter(file => file.type.startsWith('image/') && !bookPageFileIds.has(file.id));

    const knowledgeBaseIds = new Set(knowledgeBase.map(file => file.id));

    const projectAssets: AssetItem[] = [];

    // 1) Project-level videos stored in the knowledge base
    kbVideos.forEach(file => {
      projectAssets.push({
        id: `video-${file.id}`,
        type: 'video',
        url: file.url,
        title: file.name,
        description: file.summary,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: file.uploadedAt,
      });
    });

    // 2) Project-level podcasts stored in the knowledge base (audio files)
    kbPodcasts.forEach(file => {
      projectAssets.push({
        id: `podcast-${file.id}`,
        type: 'podcast',
        url: file.url,
        title: file.name,
        description: file.summary,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: file.uploadedAt,
      });
    });

    // 3) Blog markdown files stored in the knowledge base (legacy path)
    kbBlogs.forEach(file => {
      projectAssets.push({
        id: `kb-blog-${file.id}`,
        type: 'blog',
        title: file.name,
        description: file.summary,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: file.uploadedAt,
      });
    });

    // 4) Project-level images stored in the knowledge base
    // These include images generated via project chat, Assets tab generators,
    // and campaign/blog cover images that were uploaded as KnowledgeBaseFile
    // entries. We surface them as generic image assets (using the 'social'
    // type so they appear under the Images filter).
    kbImages.forEach(file => {
      projectAssets.push({
        id: `kb-image-${file.id}`,
        type: 'social',
        url: file.url,
        title: file.name,
        description: file.summary,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: file.uploadedAt,
      });
    });



    // 5) Uploaded Files (Data Tab)
    // Map these to the appropriate asset type so they appear in the correct filter tabs.
    if (project.uploadedFiles && project.uploadedFiles.length > 0) {
      project.uploadedFiles.forEach(file => {
        const mime = (file.mimeType || '').toLowerCase();
        let type: AssetItem['type'] = 'doc'; // Default to doc

        if (mime.startsWith('image/')) type = 'social';
        else if (mime.startsWith('video/')) type = 'video';
        else if (mime.startsWith('audio/')) type = 'podcast';
        else if (mime === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) type = 'book';
        else if (mime === 'text/csv' || mime.includes('excel') || mime.includes('spreadsheet') || file.name.toLowerCase().endsWith('.csv') || file.name.toLowerCase().endsWith('.xlsx')) type = 'table';

        projectAssets.push({
          id: `upload-${file.name}`,
          type,
          title: file.displayName || file.name,
          description: file.summary || 'Uploaded file',
          url: file.url || file.uri, // Prefer URL for direct access
          data: file,
          researchId: 'project-assets',
          researchTopic: 'Uploads',
          timestamp: file.uploadedAt || Date.now(),
        });
      });
    }

    // 6) Also include any blogs generated in this UI session (not yet reloaded from Firestore)
    // Filter out blogs already synced to sessions (deduplication by title)
    const knownBlogTitles = new Set<string>();
    (project.researchSessions || []).forEach(s => {
      const blogPost = s.researchReport?.blogPost;
      if (blogPost?.title) {
        knownBlogTitles.add(blogPost.title);
      }
    });

    const pendingBlogs = localGeneratedBlogs.filter(asset => {
      const blog = asset.data as BlogPost;
      return blog && !knownBlogTitles.has(blog.title);
    });

    projectAssets.push(...pendingBlogs.map(asset => ({
      ...asset,
      researchId: 'project-assets',
      researchTopic: project.name,
    })));

    // 7) Include any websites generated in this UI session
    // Filter out any that are already in the research sessions (deduplication)
    const knownWebsiteVersionIds = new Set<string>();
    (project.researchSessions || []).forEach(s => {
      (s.websiteVersions || []).forEach(v => knownWebsiteVersionIds.add(v.id));
    });

    const pendingWebsites = localProjectWebsites.filter(asset => {
      const version = asset.data as SavedWebsiteVersion;
      return version && !knownWebsiteVersionIds.has(version.id);
    });

    projectAssets.push(...pendingWebsites.map(asset => ({
      ...asset,
      researchId: 'project-assets',
      researchTopic: project.name,
    })));

    // 8) Include any locally tracked podcasts that haven't synced yet
    if (localProjectPodcasts.length) {
      const pendingPodcasts = localProjectPodcasts.filter(file => !knowledgeBaseIds.has(file.id));
      projectAssets.push(...pendingPodcasts.map<AssetItem>(file => ({
        id: `local-podcast-${file.id}`,
        type: 'podcast',
        url: file.url,
        title: file.name,
        description: file.summary,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: file.uploadedAt,
      })));
    }

    // 9) Include project-level tables (session-independent)
    if (project.tables && project.tables.length > 0) {
      projectAssets.push(...project.tables.map<AssetItem>(table => ({
        id: `project-table-${table.id}`,
        type: 'table',
        title: table.title,
        description: table.description,
        data: table,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: table.createdAt || Date.now(),
      })));
    }

    // 10) Include project-level charts (session-independent)
    if (project.charts && project.charts.length > 0) {
      projectAssets.push(...project.charts.map<AssetItem>(chart => ({
        id: `project-chart-${chart.id}`,
        type: 'table',
        title: chart.title,
        description: chart.description,
        data: chart,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: chart.createdAt || Date.now(),
      })));
    }

    // 11) Include Stripe products for the filtered view
    if (stripeProducts.length > 0) {
      projectAssets.push(...stripeProducts.map<AssetItem>(product => ({
        id: `product-${product.id}`,
        type: 'product',
        title: product.name,
        description: product.description || `Price: ${(product.unitAmount / 100).toFixed(2)} ${product.currency.toUpperCase()}`,
        data: product,
        researchId: 'project-assets',
        researchTopic: project.name,
        timestamp: (product.createdAt || Date.now() / 1000) * 1000,
      })));
    }

    if (projectAssets.length > 0) {
      const firstTs = projectAssets[0].timestamp || Date.now();
      items.push({
        session: {
          id: 'project-assets',
          topic: 'Project assets',
          timestamp: firstTs,
          lastModified: firstTs,
          researchReport: project.researchSessions[0]?.researchReport || {
            topic: project.name,
            tldr: '',
            summary: '',
            headerImagePrompt: '',
            dynamicSections: [],
            keyPoints: [],
            marketImplications: '',
            sources: [],
          },
          websiteVersions: [],
        } as any,
        assets: projectAssets,
      });
    }

    return items;
  }, [
    project.researchSessions,
    project.knowledgeBase,
    project.uploadedFiles, // Added dependency
    project.name,
    localGeneratedBlogs,
    localProjectWebsites,
    localProjectPodcasts,
    stripeProducts
  ]);

  const docsInlineImageCandidates = useMemo(() => {
    const isPublicHttpUrl = (url: string) => {
      const u = (url || '').toString();
      return /^https?:\/\//i.test(u) && !u.startsWith('blob:') && !u.startsWith('data:');
    };

    const assetImages = assetsBySession
      .flatMap(item => item.assets)
      .filter(asset => {
        if (!asset?.url) return false;
        if (!['header', 'slide', 'notemap', 'social'].includes(asset.type)) return false;
        if (!isPublicHttpUrl(String(asset.url))) return false;
        return true;
      })
      .map(asset => ({
        key: `asset-${asset.id}`,
        label: asset.title || 'Image asset',
        url: String(asset.url),
      }));

    const uploadImages = uploadedFiles
      .filter(isImageLikeFile)
      .filter(file => {
        const url = (file.uri || (file as any).url || '').toString();
        return isPublicHttpUrl(url);
      })
      .map(file => {
        const url = (file.uri || (file as any).url || '').toString();
        return {
          key: `upload-${getFileKey(file)}`,
          label: getFileLabel(file),
          url,
        };
      });

    const combined = [...assetImages, ...uploadImages];
    const dedupedByUrl = new Map<string, { key: string; label: string; url: string }>();
    combined.forEach(entry => {
      if (!dedupedByUrl.has(entry.url)) {
        dedupedByUrl.set(entry.url, entry);
      }
    });

    return Array.from(dedupedByUrl.values());
  }, [assetsBySession, uploadedFiles]);

  const videoReferenceAssetCandidates = useMemo((): ImageReferenceCandidate[] => {
    const tokens = buildSearchTokens(videoAssetSearch);

    const assetImageCandidates: ImageReferenceCandidate[] = assetsBySession
      .flatMap(item => item.assets)
      .filter(asset => {
        if (!asset.url) return false;
        return ['header', 'slide', 'notemap', 'social'].includes(asset.type);
      })
      .map(asset => {
        const label = asset.title || 'Image asset';
        const haystack = `${label} ${asset.description || ''} ${asset.type} ${asset.researchTopic || ''}`;
        const score = tokens.length ? scoreByQueryTokens(haystack, tokens) : 1;
        return {
          key: `asset-${asset.id}`,
          label,
          url: asset.url || '',
          score,
        };
      })
      .filter(entry => entry.score > 0);

    const uploadedImageCandidates: ImageReferenceCandidate[] = uploadedFiles
      .filter(file => {
        const url = file.uri || (file as any).url;
        if (!url) return false;
        return isImageLikeFile(file);
      })
      .map(file => {
        const url = (file.uri || (file as any).url) as string;
        const label = getFileLabel(file);
        const haystack = `${label} ${(file.summary || '')}`;
        const score = tokens.length ? scoreByQueryTokens(haystack, tokens) : 1;
        return {
          key: `upload-${getFileKey(file)}`,
          label,
          url,
          score,
          file,
        };
      })
      .filter(entry => entry.score > 0);

    const combined = [...assetImageCandidates, ...uploadedImageCandidates];
    const dedupedByUrl = new Map<string, ImageReferenceCandidate>();
    combined.forEach(entry => {
      const existing = dedupedByUrl.get(entry.url);
      if (!existing || entry.score > existing.score) {
        dedupedByUrl.set(entry.url, entry);
      }
    });

    return Array.from(dedupedByUrl.values()).sort((a, b) => b.score - a.score);
  }, [assetsBySession, uploadedFiles, videoAssetSearch]);

  useEffect(() => {
    if (!isAnnotatingReference) return;
    const file = imageReferenceFiles.length === 1 ? imageReferenceFiles[0] : null;
    if (!file) return;
    setReferenceAnnotateError(null);
    initAnnotateCanvasFromFile(file).catch((e: any) => {
      setReferenceAnnotateError(e?.message || 'Failed to load reference image');
    });
  }, [isAnnotatingReference, imageReferenceFiles]);

  useEffect(() => {
    if (!isAnnotatingReference) return;

    const onKeyDown = (e: KeyboardEvent) => {
      const isCmd = e.metaKey || e.ctrlKey;
      if (!isCmd) return;
      const key = (e.key || '').toLowerCase();
      if (key === 'z') {
        e.preventDefault();
        if (e.shiftKey) {
          handleAnnotateRedo().catch(() => { });
        } else {
          handleAnnotateUndo().catch(() => { });
        }
      }
      if (key === 'y') {
        e.preventDefault();
        handleAnnotateRedo().catch(() => { });
      }
    };

    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [isAnnotatingReference, annotateHistory.index, annotateHistory.stack.length, referenceAnnotateTool, referenceAnnotateText, referenceAnnotateBrushSize, referenceAnnotateBrushColor]);

  const filteredAssetsBySession = useMemo(() => {
    const search = assetSearch.trim().toLowerCase();

    return assetsBySession
      .map(item => ({
        ...item,
        assets: item.assets.filter(asset => {
          if (hiddenAssetIds.has(asset.id)) return false;
          if (filterType === 'images' && !['header', 'slide', 'notemap', 'social'].includes(asset.type)) return false;
          if (filterType === 'videos' && asset.type !== 'video') return false;
          if (filterType === 'blogs' && asset.type !== 'blog') return false;
          if (filterType === 'websites' && asset.type !== 'website') return false;
          if (filterType === 'podcasts' && asset.type !== 'podcast') return false;
          if (filterType === 'books' && asset.type !== 'book') return false;
          if (filterType === 'tables' && asset.type !== 'table') return false;
          if (filterType === 'docs' && asset.type !== 'blog') return false;
          if (filterType === 'products' && asset.type !== 'product') return false;

          if (!search) return true;

          const haystack = [
            asset.title,
            asset.description,
            asset.researchTopic,
            (item.session as any)?.topic,
            asset.type,
          ]
            .filter(Boolean)
            .join(' ')
            .toLowerCase();

          return haystack.includes(search);
        }),
      }))
      .filter(item => item.assets.length > 0);
  }, [assetsBySession, filterType, assetSearch, hiddenAssetIds]);

  // Flat list of all assets (no session grouping) for type-based tabs
  const flatFilteredAssets = useMemo(() => {
    const search = assetSearch.trim().toLowerCase();

    // Flatten all assets from all sessions
    const allAssets: AssetItem[] = [];
    const seenIds = new Set<string>();

    assetsBySession.forEach(item => {
      item.assets.forEach(asset => {
        // Robust deduplication: Use data.id if available, or fallback to a content-based key
        let dedupKey = asset.id;
        if (asset.data?.id) {
          dedupKey = `${asset.type}-${asset.data.id}`;
        } else if (asset.type === 'blog' || asset.type === 'doc') {
          // For blogs/docs without IDs, use title + subtitle/description as a proxy
          dedupKey = `${asset.type}-${asset.title}-${asset.description || ''}`;
        } else if (asset.type === 'video' && asset.url) {
          dedupKey = `${asset.type}-${asset.url}`;
        }

        if (!seenIds.has(dedupKey)) {
          seenIds.add(dedupKey);
          allAssets.push(asset);
        }
      });
    });

    // Filter by type, hidden status, and search
    return allAssets.filter(asset => {
      if (hiddenAssetIds.has(asset.id)) return false;

      // Type filtering
      if (filterType === 'images' && !['header', 'slide', 'notemap', 'social'].includes(asset.type)) return false;
      if (filterType === 'videos' && asset.type !== 'video') return false;
      if (filterType === 'websites' && asset.type !== 'website') return false;
      if (filterType === 'podcasts' && asset.type !== 'podcast') return false;
      if (filterType === 'docs' && asset.type !== 'blog' && asset.type !== 'table' && asset.type !== 'doc') return false;
      if (filterType === 'blogs' && asset.type !== 'blog') return false;
      if (filterType === 'tables' && asset.type !== 'table') return false;
      if (filterType === 'products' && asset.type !== 'product') return false;
      if (filterType === 'books' && asset.type !== 'book') return false;

      // Search filtering
      if (!search) return true;
      const haystack = [asset.title, asset.description, asset.researchTopic, asset.type]
        .filter(Boolean)
        .join(' ')
        .toLowerCase();
      return haystack.includes(search);
    }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Most recent first
  }, [assetsBySession, filterType, assetSearch, hiddenAssetIds]);

  // Group all assets by type for the "All" tab
  const assetsByType = useMemo(() => {
    const search = assetSearch.trim().toLowerCase();

    // Flatten all assets from all sessions
    const allAssets: AssetItem[] = [];
    const seenIds = new Set<string>();
    assetsBySession.forEach(item => {
      item.assets.forEach(asset => {
        // Robust deduplication: Use data.id if available, or fallback to a content-based key
        let dedupKey = asset.id;
        if (asset.data?.id) {
          dedupKey = `${asset.type}-${asset.data.id}`;
        } else if (asset.type === 'blog' || asset.type === 'doc') {
          dedupKey = `${asset.type}-${asset.title}-${asset.description || ''}`;
        }

        if (!hiddenAssetIds.has(asset.id) && !seenIds.has(dedupKey)) {
          // Search filtering
          if (search) {
            const haystack = [asset.title, asset.description, asset.researchTopic, asset.type]
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            if (!haystack.includes(search)) return;
          }
          seenIds.add(dedupKey);
          allAssets.push(asset);
        }
      });
    });



    // Add Forms to allAssets
    if (localLeadForms?.length > 0) {
      localLeadForms.forEach((form: any) => {
        if (!hiddenAssetIds.has(form.id) && !seenIds.has(form.id)) {
          const formAsset = {
            id: form.id,
            type: 'form',
            title: form.name || 'Untitled Form',
            timestamp: form.createdAt || Date.now(),
            description: `${form.leads?.length || 0} leads`,
            url: '',
            data: form,
            researchId: project.id,
            researchTopic: 'Forms'
          } as unknown as AssetItem;

          // Search filtering
          if (search) {
            const haystack = [formAsset.title, formAsset.description, 'form']
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            if (!haystack.includes(search)) return;
          }
          seenIds.add(formAsset.id);
          allAssets.push(formAsset);
        }
      });
    }

    // Add Products to allAssets
    if (stripeProducts?.length > 0) {
      stripeProducts.forEach((product: any) => {
        if (product.active && !seenIds.has(product.id)) { // Only show active products? Or all? Assuming all for now or active.
          const productAsset = {
            id: product.id,
            type: 'product',
            title: product.name,
            timestamp: product.createdAt || Date.now(),
            description: product.description || undefined,
            url: '',
            data: product,
            researchId: project.id,
            researchTopic: 'Products'
          } as unknown as AssetItem;

          // Search filtering
          if (search) {
            const haystack = [productAsset.title, productAsset.description, 'product']
              .filter(Boolean)
              .join(' ')
              .toLowerCase();
            if (!haystack.includes(search)) return;
          }
          seenIds.add(productAsset.id);
          allAssets.push(productAsset);
        }
      });
    }

    // Define type groups with display names and icons
    const typeGroups: { key: string; label: string; types: string[]; icon: string }[] = [
      { key: 'images', label: 'Images', types: ['header', 'slide', 'notemap', 'social'], icon: '' },
      { key: 'videos', label: 'Videos', types: ['video'], icon: '' },
      { key: 'blogs', label: 'Blogs', types: ['blog'], icon: '' },
      { key: 'websites', label: 'Websites', types: ['website'], icon: '' },
      { key: 'podcasts', label: 'Podcasts', types: ['podcast'], icon: '' },
      { key: 'books', label: 'PDFs', types: ['book'], icon: '' },
      { key: 'tables', label: 'Tables', types: ['table'], icon: '' },
      { key: 'docs', label: 'Docs', types: ['blog', 'table'], icon: '' }, // Combined for legacy support or specific view if needed
      { key: 'forms', label: 'Forms', types: ['form'], icon: '' },
      { key: 'products', label: 'Products', types: ['product'], icon: '' },
    ];

    // Group assets by type
    // Note: We filter duplicates if an asset matches multiple groups (e.g. docs vs blogs/tables)
    // But currently types are disjoint enough except for docs which overlaps.
    // Given the request was for specific groups, I'll stick to the requested list.
    // The user requested: Images, Videos, Blogs, Websites, Podcasts, Books, Tables, Docs, Forms, Products
    // Wait, 'Docs' usually combines blogs/tables, but the user listed them separately AND Docs?
    // User request: "Images, Videos, Blogs, Websites, Podcasts, Books, Tables, Docs, Forms, Products"
    // Does 'Docs' mean something else? Or just redundant?
    // I'll assume 'Docs' covers generic documents if any, but currently 'blog' and 'table' cover text assets.
    // I'll remove 'docs' from the config if it's redundant with 'blogs' & 'tables', OR keep it if I want to show a combined view.
    // The previous prompt said: "Type Mapping: Blogs and Tables should be combined under a new 'Docs' tab."
    // But this new prompt lists "Blogs... Tables... Docs...".
    // I will include ALL of them as separate groups for now, but ensure 'Docs' doesn't double count if I define it as (blog|table).
    // Actually, looking at my type filtered list:
    // keys: images, videos, blogs, websites, podcasts, books, tables, products.
    // I will add 'forms'.
    // I will REMOVE 'docs' from this specific "All" tab view to avoid duplication if I have 'blogs' and 'tables' separately.
    // Wait, let's look at the user request again: "...grouped by types/formats Images, Videos, Blogs, Websites, Podcasts, Books, Tables, Docs, Forms, Products"
    // It LISTS "Blogs, ... Tables, Docs ...". This implies 3 separate categories?
    // Maybe 'Docs' are other files?
    // I'll stick to 'Blogs' and 'Tables' as I have them, and maybe 'Docs' as a catch-all or just omit if empty. 
    // I'll add 'forms'.

    // Let's refine the list based strictly on the user request string:
    // Images, Videos, Blogs, Websites, Podcasts, Books, Tables, Docs, Forms, Products.

    const groups: { key: string; label: string; types: string[]; icon: string }[] = [
      { key: 'images', label: 'Images', types: ['header', 'slide', 'notemap', 'social'], icon: '' },
      { key: 'videos', label: 'Videos', types: ['video'], icon: '' },
      { key: 'blogs', label: 'Blogs', types: ['blog'], icon: '' },
      { key: 'websites', label: 'Websites', types: ['website'], icon: '' },
      { key: 'podcasts', label: 'Podcasts', types: ['podcast'], icon: '' },
      { key: 'books', label: 'Books', types: ['book'], icon: '' },
      { key: 'tables', label: 'Tables', types: ['table'], icon: '' },
      { key: 'docs', label: 'Docs', types: ['doc'], icon: '' }, // Assuming 'doc' type exists or is different?
      { key: 'forms', label: 'Forms', types: ['form'], icon: '' },
      { key: 'products', label: 'Products', types: ['product'], icon: '' },
    ];

    // If 'doc' type doesn't exist, this group will just be empty.
    // I'll check if I should map 'blog'/'table' to 'docs'. 
    // If I map them to 'docs' AND 'blogs'/'tables', they will appear twice.
    // I'll assume 'Docs' is for future use or distinct 'doc' type assets.

    // Build type-based groups
    const typeBasedGroups = groups.map(group => ({
      ...group,
      assets: allAssets
        .filter(asset => group.types.includes(asset.type))
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
    })).filter(group => group.assets.length > 0);

    // Build Pinned group from pinnedAssetIds
    const pinnedIds = project.pinnedAssetIds || [];
    const pinnedAssets = allAssets
      .filter(asset => pinnedIds.includes(asset.id))
      .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    // Prepend Pinned group if there are pinned assets
    if (pinnedAssets.length > 0) {
      return [
        { key: 'pinned', label: 'Pinned', types: [], icon: '', assets: pinnedAssets },
        ...typeBasedGroups,
      ];
    }

    return typeBasedGroups;
  }, [assetsBySession, assetSearch, hiddenAssetIds, localLeadForms, stripeProducts, uploadedFiles, project.pinnedAssetIds]);

  // Toggle pin status for an asset
  const handleTogglePin = async (assetId: string, e?: React.MouseEvent) => {
    e?.stopPropagation();
    const currentPinned = project.pinnedAssetIds || [];
    const isPinned = currentPinned.includes(assetId);
    const nextPinned = isPinned
      ? currentPinned.filter(id => id !== assetId)
      : [...currentPinned, assetId];

    const updatedProject = {
      ...project,
      pinnedAssetIds: nextPinned,
      lastModified: Date.now(),
    };

    // Update local state immediately
    onProjectUpdate?.(updatedProject);

    // Persist to Firestore
    try {
      await storageService.updateResearchProject(project.id, {
        pinnedAssetIds: nextPinned,
        lastModified: updatedProject.lastModified,
      });
    } catch (err) {
      console.error('Failed to save pin state:', err);
    }
  };

  const handleDeleteAsset = async (assetId: string) => {
    if (!confirm('Delete this asset from the Assets view?')) return;

    const addHidden = () =>
      setHiddenAssetIds(prev => {
        const next = new Set(prev);
        next.add(assetId);
        return next;
      });

    const removeHidden = () =>
      setHiddenAssetIds(prev => {
        const next = new Set(prev);
        next.delete(assetId);
        return next;
      });

    addHidden();

    const commitProjectUpdate = (nextProject: ResearchProject) => {
      onProjectUpdate?.(nextProject);
    };

    try {
      let id = assetId;
      if (id.startsWith('upload-')) {
        // Deletion for uploaded files
        const fileName = id.slice('upload-'.length);

        // 1. Delete from Cloud
        await deleteUploadedFile(fileName).catch(err => console.warn('Cloud delete failed, removing local ref anyway:', err));

        // 2. Update Project State
        const nextUploadedFiles = (project.uploadedFiles || []).filter(f => f.name !== fileName);

        const updatedProject = {
          ...project,
          uploadedFiles: nextUploadedFiles,
          lastModified: Date.now()
        };

        // 3. Persist
        await storageService.updateResearchProject(project.id, {
          uploadedFiles: nextUploadedFiles,
          lastModified: updatedProject.lastModified
        });

        commitProjectUpdate(updatedProject);
        return;
      }

      if (id.startsWith('project-')) {
        id = id.slice('project-'.length);
      }

      const sessions = project.researchSessions || [];

      const matchSessionRemainder = (rest: string): { sessionId: string; remainder: string } | null => {
        const candidates = sessions
          .map(s => String(s.id || ''))
          .filter(Boolean)
          .sort((a, b) => b.length - a.length);

        for (const sid of candidates) {
          const prefix = `${sid}-`;
          if (rest === sid) return { sessionId: sid, remainder: '' };
          if (rest.startsWith(prefix)) {
            return { sessionId: sid, remainder: rest.slice(prefix.length) };
          }
        }
        return null;
      };

      const removeKnowledgeBaseFileById = async (fileId: string) => {
        const existingKb = project.knowledgeBase || [];
        const file = existingKb.find(f => f.id === fileId) || null;
        const updatedKnowledgeBase = existingKb.filter(f => f.id !== fileId);

        if (file) {
          await storageService.deleteKnowledgeBaseFile(project.id, file);
        }

        await storageService.updateResearchProject(project.id, { knowledgeBase: updatedKnowledgeBase });
        commitProjectUpdate({ ...project, knowledgeBase: updatedKnowledgeBase, lastModified: Date.now() });
      };

      const updateSession = async (sessionId: string, updates: Partial<SavedResearch>) => {
        await storageService.updateResearchInProject(project.id, sessionId, updates);
        const nextSessions = (project.researchSessions || []).map(s =>
          s.id === sessionId ? ({ ...s, ...updates, lastModified: Date.now() } as any) : s
        );
        commitProjectUpdate({ ...project, researchSessions: nextSessions, lastModified: Date.now() });
      };

      const updateSessionReport = async (sessionId: string, updater: (report: any) => any) => {
        const session = sessions.find(s => s.id === sessionId);
        if (!session || !session.researchReport) return;
        const nextReport = updater(session.researchReport);
        await updateSession(sessionId, { researchReport: nextReport } as any);
      };

      if (id.startsWith('product-')) {
        const productId = id.slice('product-'.length);
        const nextProducts = (project.stripeProducts || []).filter(p => p.id !== productId);

        // Update project
        await storageService.updateResearchProject(project.id, { stripeProducts: nextProducts });
        commitProjectUpdate({ ...project, stripeProducts: nextProducts });

        // Update local state
        setStripeProducts(prev => prev.filter(p => p.id !== productId));
        return;
      }

      if (id.startsWith('kb-image-')) {
        const fileId = id.slice('kb-image-'.length);
        await removeKnowledgeBaseFileById(fileId);
        return;
      }

      if (id.startsWith('kb-blog-')) {
        const fileId = id.slice('kb-blog-'.length);
        await removeKnowledgeBaseFileById(fileId);
        return;
      }

      if (id.startsWith('podcast-')) {
        const fileId = id.slice('podcast-'.length);
        await removeKnowledgeBaseFileById(fileId);
        return;
      }

      if (id.startsWith('video-')) {
        const token = id.slice('video-'.length);
        if (token.startsWith('file_')) {
          await removeKnowledgeBaseFileById(token);
          return;
        }
        const sessionMatch = sessions.find(s => s.id === token);
        if (sessionMatch?.researchReport?.videoPost) {
          await updateSessionReport(token, (report: any) => ({ ...report, videoPost: undefined }));
          return;
        }
        await removeKnowledgeBaseFileById(token);
        return;
      }

      if (id.startsWith('session-blog-')) {
        const sessionId = id.slice('session-blog-'.length);
        await updateSessionReport(sessionId, (report: any) => ({ ...report, blogPost: undefined }));
        return;
      }

      if (id.startsWith('session-video-')) {
        const sessionId = id.slice('session-video-'.length);
        await updateSessionReport(sessionId, (report: any) => ({ ...report, videoPost: undefined }));
        return;
      }

      if (id.startsWith('blog-')) {
        const sessionId = id.slice('blog-'.length);
        await updateSessionReport(sessionId, (report: any) => ({ ...report, blogPost: undefined }));
        return;
      }

      if (id.startsWith('header-')) {
        const sessionId = id.slice('header-'.length);
        await updateSessionReport(sessionId, (report: any) => ({
          ...report,
          headerImageUrl: undefined,
        }));
        return;
      }

      if (id.startsWith('slide-')) {
        const rest = id.slice('slide-'.length);
        const match = matchSessionRemainder(rest);
        if (!match) return;
        const sessionId = match.sessionId;
        const idxParts = match.remainder.split('-').filter(Boolean);
        if (!idxParts.length) return;
        const last = Number(idxParts[idxParts.length - 1]);
        const secondLast = idxParts.length >= 2 ? Number(idxParts[idxParts.length - 2]) : NaN;
        const hasTwoNums = Number.isFinite(last) && Number.isFinite(secondLast);
        const slideIdx = hasTwoNums ? secondLast : last;
        const imageIdx = hasTwoNums ? last : null;
        if (!Number.isFinite(slideIdx)) return;

        await updateSessionReport(sessionId, (report: any) => {
          const slides: any[] = Array.isArray(report.slides) ? report.slides : [];
          const nextSlides = slides.map((s, idx) => {
            if (idx !== slideIdx) return s;
            if (imageIdx !== null && Array.isArray(s?.imageUrls)) {
              const nextUrls = s.imageUrls.filter((_: any, i: number) => i !== imageIdx);
              return { ...s, imageUrls: nextUrls };
            }
            return { ...s, imageUrl: undefined };
          });
          return { ...report, slides: nextSlides };
        });
        return;
      }

      if (id.startsWith('notemap-')) {
        const rest = id.slice('notemap-'.length);
        const match = matchSessionRemainder(rest);
        if (!match || !match.remainder) return;
        const sessionId = match.sessionId;
        const nodeId = match.remainder;
        const session = sessions.find(s => s.id === sessionId);
        const state: any[] = Array.isArray((session as any)?.noteMapState) ? (session as any).noteMapState : [];
        const nextState = state.map((n: any) => (n?.id === nodeId ? { ...n, imageUrl: undefined } : n));
        await updateSession(sessionId, { noteMapState: nextState } as any);
        return;
      }

      if (id.startsWith('social-')) {
        const rest = id.slice('social-'.length);
        const match = matchSessionRemainder(rest);
        if (!match) return;
        const sessionId = match.sessionId;
        const postIdx = Number(match.remainder);
        if (!Number.isFinite(postIdx)) return;
        await updateSessionReport(sessionId, (report: any) => {
          const campaign = report.socialCampaign;
          const posts: any[] = Array.isArray(campaign?.posts) ? campaign.posts : [];
          const nextPosts = posts.map((p, idx) => (idx === postIdx ? { ...p, imageUrl: undefined } : p));
          return { ...report, socialCampaign: campaign ? { ...campaign, posts: nextPosts } : campaign };
        });
        return;
      }

      if (id.startsWith('website-')) {
        const rest = id.slice('website-'.length);
        const match = matchSessionRemainder(rest);
        let sessionId: string | undefined;
        let versionId: string | undefined;

        if (match) {
          sessionId = match.sessionId;
          versionId = match.remainder;
        } else {
          // If matchSessionRemainder fails, search all sessions for this website version ID
          const searchId = rest;
          for (const s of sessions) {
            if (s.websiteVersions?.some(v => v.id === searchId)) {
              sessionId = s.id;
              versionId = searchId;
              break;
            }
          }
        }

        if (sessionId && versionId) {
          const session = sessions.find(s => s.id === sessionId);
          const versions: any[] = Array.isArray((session as any)?.websiteVersions) ? (session as any).websiteVersions : [];
          const nextVersions = versions.filter((v: any) => String(v?.id || '') !== versionId);
          await updateSession(sessionId, { websiteVersions: nextVersions } as any);

          // Also clean up local state if it was a pending project website
          setLocalProjectWebsites(prev => prev.filter(a => (a.data as SavedWebsiteVersion)?.id !== versionId));
        }
        return;
      }

      if (id.startsWith('session-website-')) {
        const rest = id.slice('session-website-'.length);
        const match = matchSessionRemainder(rest);
        if (!match || !match.remainder) return;
        const sessionId = match.sessionId;
        const versionId = match.remainder;
        const session = sessions.find(s => s.id === sessionId);
        const versions: any[] = Array.isArray((session as any)?.websiteVersions) ? (session as any).websiteVersions : [];
        const nextVersions = versions.filter((v: any) => String(v?.id || '') !== versionId);
        await updateSession(sessionId, { websiteVersions: nextVersions } as any);
        return;
      }

      if (id.startsWith('book-')) {
        const rest = id.slice('book-'.length);
        const match = matchSessionRemainder(rest);
        if (!match || !match.remainder) return;
        const sessionId = match.sessionId;
        const bookId = match.remainder;
        await updateSessionReport(sessionId, (report: any) => {
          const books: any[] = Array.isArray(report.books) ? report.books : [];
          const nextBooks = books.filter((b: any) => String(b?.id || '') !== bookId);
          return { ...report, books: nextBooks };
        });
        return;
      }

      if (id.startsWith('table-')) {
        const rest = id.slice('table-'.length);
        const match = matchSessionRemainder(rest);
        if (!match || !match.remainder) return;
        const sessionId = match.sessionId;
        const tableId = match.remainder;
        await updateSessionReport(sessionId, (report: any) => {
          const tables: any[] = Array.isArray(report.tables) ? report.tables : [];
          const nextTables = tables.filter((t: any) => String(t?.id || '') !== tableId);
          return { ...report, tables: nextTables };
        });
        return;
      }

      return;
    } catch (e) {
      console.error('Failed to delete asset', e);
      removeHidden();
      alert('Failed to delete asset. Please try again.');
    }
  };

  const totalImages = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => ['header', 'slide', 'notemap', 'social'].includes(a.type)).length, 0
  );
  const totalVideos = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => a.type === 'video').length, 0
  );
  const totalBlogs = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => a.type === 'blog').length, 0
  );
  const totalWebsites = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => a.type === 'website').length, 0
  );
  const totalPodcasts = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => a.type === 'podcast').length, 0
  );
  const totalBooks = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => a.type === 'book').length, 0
  );
  const totalTables = assetsBySession.reduce((acc, item) =>
    acc + item.assets.filter(a => a.type === 'table').length, 0
  );
  const totalForms = localLeadForms?.length || 0;
  const totalProducts = stripeProducts?.length || project.stripeProducts?.length || 0;

  const totalAssets = totalImages + totalVideos + totalBlogs + totalWebsites + totalPodcasts + totalBooks + totalTables + totalForms + totalProducts;

  // Notify parent of total asset count
  useEffect(() => {
    onAssetCountChange?.(totalAssets);
  }, [totalAssets, onAssetCountChange]);

  const toggleSession = (sessionId: string) => {
    setExpandedSessions(prev => {
      const next = new Set(prev);
      if (next.has(sessionId)) {
        next.delete(sessionId);
      } else {
        next.add(sessionId);
      }
      return next;
    });
  };

  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };

  const getTypeIcon = (type: AssetItem['type']) => {
    switch (type) {
      case 'header':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        );
      case 'slide':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
          </svg>
        );
      case 'notemap':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
        );
      case 'blog':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
          </svg>
        );
      case 'website':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
          </svg>
        );
      case 'social':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
        );
      case 'video':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m0-4v4m0-4L9 6m6 4L9 18m0-12L4.447 8.276A1 1 0 004 9.17v5.66a1 1 0 00.553.894L9 18" />
          </svg>
        );
      case 'podcast':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6a2 2 0 012-2h2a2 2 0 012 2v13m-8 0h8M5 10h.01M5 14h.01M19 10h.01M19 14h.01" />
          </svg>
        );
      case 'book':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a2 2 0 012-2h11a1 1 0 011 1v14a1 1 0 01-1.447.894L15 18.118l-2.553.776A2 2 0 0110 19H6a2 2 0 01-2-2V5z" />
          </svg>
        );
      case 'table':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        );
      case 'doc':
        return (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        );
      default:
        return null;
    }
  };

  const getTypeColor = (type: AssetItem['type']) => {
    switch (type) {
      case 'header': return 'bg-[#5e5ce6]/20 text-[#5e5ce6]';
      case 'slide': return 'bg-[#0071e3]/20 text-[#0071e3]';
      case 'notemap': return 'bg-[#30d158]/20 text-[#30d158]';
      case 'blog': return 'bg-[#ff9f0a]/20 text-[#ff9f0a]';
      case 'website': return 'bg-[#bf5af2]/20 text-[#bf5af2]';
      case 'social': return 'bg-[#ff375f]/20 text-[#ff375f]';
      case 'video': return 'bg-[#0a84ff]/20 text-[#0a84ff]';
      case 'podcast': return 'bg-[#34c759]/20 text-[#34c759]';
      case 'book': return 'bg-[#f97316]/20 text-[#f97316]';
      case 'table': return 'bg-[#06b6d4]/20 text-[#06b6d4]';
      case 'doc': return 'bg-[#0071e3]/20 text-[#0071e3]';
      default: return 'bg-[#86868b]/20 text-[#86868b]';
    }
  };

  const filterOptions = [
    { key: 'all' as const, label: 'All' },
    { key: 'images' as const, label: 'Images' },
    { key: 'videos' as const, label: 'Videos' },
    { key: 'blogs' as const, label: 'Blogs' },
    { key: 'websites' as const, label: 'Websites' },
    { key: 'podcasts' as const, label: 'Podcasts' },
    { key: 'books' as const, label: 'PDFs' },
    { key: 'docs' as const, label: 'Docs' },
    { key: 'forms' as const, label: 'Forms' },
    { key: 'tables' as const, label: 'Tables' },
    { key: 'products' as const, label: 'Products' },
  ];

  const handleAssetClick = (asset: AssetItem) => {
    if (asset.type === 'table') {
      const tableData = asset.data as TableAsset;
      // Case 1: Already parsed table (standard project table)
      if (tableData && Array.isArray(tableData.rows)) {
        setFilterType('tables');
        setGeneratedTable(tableData);
        setTableError(null);
        setTableSaveMessage(null);
        return;
      }

      // Case 2: Raw uploaded file (CSV/Excel) that needs parsing
      if (asset.url) {
        setFilterType('tables');
        setTableError(null);
        setTableSaveMessage(null);
        // Use uploading state to show loading indicator
        setIsUploadingTable(true);

        // Fetch and parse the file
        (async () => {
          try {
            const response = await fetch(asset.url!);
            if (!response.ok) throw new Error('Failed to fetch file');

            const blob = await response.blob();
            const file = new File([blob], asset.title || 'table.csv', { type: asset.data?.mimeType || 'text/csv' });

            // Re-use logic similar to handleTableFileUpload but without the file input check
            let columns: string[] = [];
            let rows: string[][] = [];
            const fileName = file.name.toLowerCase();
            const isCSV = fileName.endsWith('.csv') || file.type === 'text/csv';

            if (isCSV) {
              const text = await file.text();
              const result = Papa.parse<string[]>(text, { skipEmptyLines: true });
              if (result.errors.length > 0) console.warn('CSV parsing warnings:', result.errors);
              const data = result.data;
              if (!data || data.length === 0) throw new Error('Empty file');
              columns = data[0].map((col, idx) => col?.trim() || `Column ${idx + 1}`);
              rows = data.slice(1).map(row => row.map(cell => (cell ?? '').toString()));
            } else {
              // Assume Excel
              const arrayBuffer = await file.arrayBuffer();
              const workbook = XLSX.read(arrayBuffer, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              if (!firstSheetName) throw new Error('No sheets found');
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData: string[][] = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
              if (jsonData.length === 0) throw new Error('Empty file');
              columns = jsonData[0].map((col, idx) => col?.toString().trim() || `Column ${idx + 1}`);
              rows = jsonData.slice(1).map(row => row.map(cell => (cell ?? '').toString()));
            }

            // Normalize row lengths
            const colCount = columns.length;
            rows = rows.map(row => {
              if (row.length < colCount) return [...row, ...new Array(colCount - row.length).fill('')];
              return row.slice(0, colCount);
            });

            setGeneratedTable({
              id: asset.id, // Keep original asset ID if possible, or new one
              title: asset.title,
              description: asset.description,
              columns,
              rows,
              createdAt: asset.timestamp,
              // Link to original file so we can sync back if needed?
              // For now just allow viewing/editing
            });

          } catch (error) {
            console.error('Failed to parse table asset:', error);
            setTableError('Failed to load table file. It may be corrupted or in an unsupported format.');
          } finally {
            setIsUploadingTable(false);
          }
        })();

        return;
      }
    }

    if (asset.type === 'website' && asset.data) {
      setSelectedWebsite(asset.data as SavedWebsiteVersion);
      return;
    }

    if (asset.type === 'leadform' && asset.data) {
      setSelectedForm(asset);
      return;
    }
    if (asset.type === 'website' && asset.url) {
      window.open(asset.url, '_blank');
      return;
    }

    if (asset.type === 'video' || asset.type.startsWith('video/')) {
      setSelectedVideo(asset);
      return;
    }

    if (asset.type === 'blog' || asset.type === 'doc') {
      // Open blog in docs editor
      const blogId = asset.id.startsWith('blog-') ? asset.id : `blog-${asset.id}`;

      // Priority 1: content is already loaded/generated (e.g. valid blog content)
      // Note: We check specifically for content, not description, to avoid showing summary for Docs
      if (asset.data?.content) {
        setGoogleDocsSelected({
          documentId: blogId,
          title: asset.title || 'Blog Post'
        });
        setGoogleDocsText(asset.data.content);
        setGoogleDocsLastLoadedText(asset.data.content);
        setFilterType('docs');
        return;
      }

      // Priority 2: Uploaded file (URL) - Fetch and parse
      if (asset.url) {
        setGoogleDocsSelected({
          documentId: blogId,
          title: asset.title || 'Document'
        });
        setFilterType('docs');
        setGoogleDocsText('Loading document...'); // Show loading state in editor

        (async () => {
          try {
            const response = await fetch(asset.url!);
            if (!response.ok) throw new Error('Failed to fetch file');
            const blob = await response.blob();

            const isDocx = asset.title.toLowerCase().endsWith('.docx') || blob.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
            const isDoc = asset.title.toLowerCase().endsWith('.doc') || blob.type === 'application/msword';

            let textContent = '';

            if (isDocx) {
              const arrayBuffer = await blob.arrayBuffer();
              const result = await mammoth.convertToHtml({ arrayBuffer });
              textContent = result.value; // The generated HTML
              if (result.messages.length > 0) console.warn('Mammoth warnings:', result.messages);
            } else if (isDoc) {
              textContent = '<p><strong>Preview not supported for .doc files.</strong><br/>Please convert to .docx or .pdf, or download the file to view.</p>';
            } else {
              // Assume generic text/md
              textContent = await blob.text();
            }

            setGoogleDocsText(textContent);
            setGoogleDocsLastLoadedText(textContent);

          } catch (e: any) {
            console.error('Failed to load doc content:', e);
            setGoogleDocsText(`Failed to load document: ${e.message}`);
          }
        })();
        return;
      }

      // Priority 3: Fallback to description (e.g. for simple notes/blogs without full content yet)
      if (asset.description) {
        setGoogleDocsSelected({
          documentId: blogId,
          title: asset.title || 'Blog Post'
        });
        setGoogleDocsText(asset.description);
        setGoogleDocsLastLoadedText(asset.description);
        setFilterType('docs');
        return;
      }

    }

    if (['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) {
      setSelectedImage(asset);
      return;
    }

    if (asset.type === 'book') {
      setSelectedImage(asset);
      setCurrentBookPage(0);
      return;
    }

    if (asset.type === 'product') {
      const productData = asset.data as StripeProduct;
      let link = productData?.paymentLinkUrl;

      // If no payment link exists, create one
      if (!link && productData?.priceId && userProfile?.stripeConnect?.accountId) {
        setCreatingPaymentLink(productData.id);
        authFetch('/api/stripe?op=create-payment-link', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accountId: userProfile.stripeConnect.accountId,
            priceId: productData.priceId,
            customFields: productData.customFields || [],
            quantityOptions: productData.quantityOptions,
          }),
        })
          .then(res => res.json())
          .then(data => {
            if (data.url) {
              link = data.url;
              // Update product with payment link
              const updatedProducts = (project.stripeProducts || []).map(p =>
                p.id === productData.id ? { ...p, paymentLinkUrl: link } : p
              );
              storageService.updateResearchProject(project.id, { stripeProducts: updatedProducts });
              onProjectUpdate?.({ ...project, stripeProducts: updatedProducts });
              setStripeProducts(prev => prev.map(p => p.id === productData.id ? { ...p, paymentLinkUrl: link } : p));

              // Open and copy
              window.open(link, '_blank');
              navigator.clipboard.writeText(link!);
              alert('Payment link opened in new tab and copied to clipboard!');
            }
          })
          .catch(err => {
            console.error('Failed to create payment link:', err);
            alert('Failed to create payment link');
          })
          .finally(() => {
            setCreatingPaymentLink(null);
          });
        return;
      }

      if (link) {
        window.open(link, '_blank');
        navigator.clipboard.writeText(link);
        alert('Payment link opened in new tab and copied to clipboard!');
      } else {
        alert('No payment link available for this product');
      }
      return;
    }

    if (asset.type === 'podcast') {
      if (onPlayPodcast) {
        onPlayPodcast({
          id: asset.id,
          title: asset.title || 'Podcast',
          url: asset.url,
          researchTopic: asset.researchTopic || project.name,
        });
      } else {
        setActivePodcast(asset);
      }
    }
  };

  // -- Navigation Helpers --

  const getNavigableAssets = useCallback(() => {
    // assetsByType contains groups (Pinned, Images, Videos...)
    // Flatten it to get all currently visible assets in visual order
    let assets = assetsByType.flatMap(group => group.assets);

    // Apply View Filter if not 'all'
    if (filterType !== 'all') {
      switch (filterType) {
        case 'images':
          assets = assets.filter(a => ['header', 'slide', 'notemap', 'social'].includes(a.type) || (a.type.startsWith('image/') && !a.type.startsWith('video')));
          break;
        case 'videos':
          assets = assets.filter(a => a.type === 'video' || a.type.startsWith('video/'));
          break;
        case 'blogs':
          assets = assets.filter(a => a.type === 'blog');
          break;
        case 'websites':
          assets = assets.filter(a => a.type === 'website');
          break;
        case 'podcasts':
          assets = assets.filter(a => a.type === 'podcast');
          break;
        case 'books':
          assets = assets.filter(a => a.type === 'book');
          break;
        case 'tables':
          assets = assets.filter(a => a.type === 'table');
          break;
        case 'forms':
          // Check for both 'form' (legacy/manual) and 'leadform' (type definition)
          assets = assets.filter(a => a.type === 'leadform' || (a.type as string) === 'form');
          break;
        case 'products':
          assets = assets.filter(a => a.type === 'product');
          break;
        case 'docs':
          // Docs usually combines blogs and tables in this app context, or generic docs
          assets = assets.filter(a => ['blog', 'table', 'doc'].includes(a.type));
          break;
      }
    }

    // Deduplicate assets by ID while preserving visual order (first occurrence wins)
    // This allows Pinned assets (at the top) to take precedence in navigation flow
    const seen = new Set<string>();
    const uniqueAssets: AssetItem[] = [];

    for (const asset of assets) {
      if (!seen.has(asset.id)) {
        seen.add(asset.id);
        uniqueAssets.push(asset);
      }
    }

    return uniqueAssets;
  }, [assetsByType, filterType]);

  const handleNextAsset = useCallback((e?: React.MouseEvent | KeyboardEvent) => {
    e?.stopPropagation();
    const currentAsset = selectedImage || selectedVideo;
    if (!currentAsset) return;

    const assets = getNavigableAssets();
    const currentIndex = assets.findIndex(a => a.id === currentAsset.id);
    if (currentIndex === -1) return;

    const nextIndex = (currentIndex + 1) % assets.length;
    const nextAsset = assets[nextIndex];
    handleAssetClick(nextAsset);
  }, [selectedImage, selectedVideo, getNavigableAssets]);

  const handlePrevAsset = useCallback((e?: React.MouseEvent | KeyboardEvent) => {
    e?.stopPropagation();
    const currentAsset = selectedImage || selectedVideo;
    if (!currentAsset) return;

    const assets = getNavigableAssets();
    const currentIndex = assets.findIndex(a => a.id === currentAsset.id);
    if (currentIndex === -1) return;

    const prevIndex = (currentIndex - 1 + assets.length) % assets.length;
    const prevAsset = assets[prevIndex];
    handleAssetClick(prevAsset);
  }, [selectedImage, selectedVideo, getNavigableAssets]);

  // Keyboard listeners for navigation
  useEffect(() => {
    if (!selectedImage && !selectedVideo) return;
    // Disable global nav for books as they have their own page nav
    if (selectedImage?.type === 'book') return;

    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight') handleNextAsset(e);
      if (e.key === 'ArrowLeft') handlePrevAsset(e);
    };

    window.addEventListener('keydown', onKeyDown);
    return () => window.removeEventListener('keydown', onKeyDown);
  }, [selectedImage, selectedVideo, handleNextAsset, handlePrevAsset]);

  return (
    <>
      <div ref={topRef} className="space-y-5">
        <div className="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
          {/* Subtabs row */}
          {/* Search bar */}
          <div className="w-full lg:w-auto lg:min-w-[200px] lg:max-w-[280px] flex-shrink-0">
            <input
              type="text"
              value={assetSearch}
              onChange={e => setAssetSearch(e.target.value)}
              placeholder="Search assets..."
              className={`w-full rounded-full px-4 py-2 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] focus:border-transparent ${isDarkMode
                ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]'
                : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'
                }`}
            />
          </div>
          <div className="flex items-center gap-2 text-xs overflow-x-auto pb-1 lg:pb-0 min-w-0 lg:flex-1">
            {filterOptions.map(option => {
              let count: number | null = null;
              switch (option.key) {
                case 'all': count = totalAssets; break;
                case 'images': count = totalImages; break;
                case 'videos': count = totalVideos; break;
                case 'blogs': count = totalBlogs; break;
                case 'websites': count = totalWebsites; break;
                case 'podcasts': count = totalPodcasts; break;
                case 'books': count = totalBooks; break;
                case 'tables': count = totalTables; break;
                case 'forms': count = totalForms; break;
                case 'products': count = totalProducts; break;
              }

              const getTabIcon = (key: string) => {
                switch (key) {
                  case 'all': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                  );
                  case 'images': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  );
                  case 'videos': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m0-4v4m0-4L9 6m6 4L9 18m0-12L4.447 8.276A1 1 0 004 9.17v5.66a1 1 0 00.553.894L9 18" />
                    </svg>
                  );
                  case 'blogs': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                    </svg>
                  );
                  case 'websites': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                  );
                  case 'podcasts': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6a2 2 0 012-2h2a2 2 0 012 2v13m-8 0h8M5 10h.01M5 14h.01M19 10h.01M19 14h.01" />
                    </svg>
                  );
                  case 'books': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                  );
                  case 'tables': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                  );
                  case 'forms': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                  );
                  case 'products': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                  );
                  case 'docs': return (
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                  );
                  default: return null;
                }
              };

              return (
                <button
                  key={option.key}
                  type="button"
                  onClick={() => setFilterType(option.key)}
                  className={`px-3 py-1.5 rounded-full border transition-all flex items-center gap-2 whitespace-nowrap ${filterType === option.key
                    ? isDarkMode
                      ? 'bg-white text-black border-transparent shadow'
                      : 'bg-gray-900 text-white border-gray-900 shadow'
                    : isDarkMode
                      ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:bg-[#2c2c2e]'
                      : 'border-gray-200 text-gray-600 hover:border-gray-400 hover:bg-gray-50'
                    }`}
                >
                  <span className="lg:hidden">{getTabIcon(option.key)}</span>
                  <span>{option.label}</span>
                  {count !== null && (
                    <span className={`hidden sm:inline-flex items-center justify-center h-4 min-w-[16px] px-1 text-[10px] rounded-full ${filterType === option.key
                      ? isDarkMode ? 'bg-black/10 text-black' : 'bg-white/20 text-white'
                      : isDarkMode ? 'bg-[#3d3d3f] text-[#86868b]' : 'bg-gray-200 text-gray-600'
                      }`}>
                      {count}
                    </span>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {
          (filterType === 'images' || filterType === 'videos' || filterType === 'websites' || filterType === 'books') && (
            <div className="mt-4 flex flex-col lg:flex-row gap-4">
              {filterType === 'websites' && (
                <div className={`flex-1 rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                  <h3 className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Generate Website</h3>

                  <p className={`text-xs mb-3 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                    {selectedEcommerceProductIds.length > 0
                      ? 'Create an e-commerce store with Stripe payment integration using your selected products.'
                      : 'Create a website with AI. Optionally attach products from Products tab to generate an e-commerce store.'}
                  </p>

                  <div className="space-y-3">
                    <div>
                      <label className={`block text-xs font-medium mb-1.5 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-700'}`}>
                        {selectedEcommerceProductIds.length > 0 ? 'Store Design Concept' : 'Website Concept'}
                      </label>
                      <textarea
                        value={websitePrompt}
                        onChange={e => setWebsitePrompt(e.target.value)}
                        rows={2}
                        className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                        placeholder={selectedEcommerceProductIds.length > 0
                          ? "Describe your store's style and layout (e.g. minimalist dark mode tech store, vibrant fashion boutique)"
                          : "Describe your website (e.g. professional landing page, portfolio site, documentation hub)"}
                      />
                      {/* Suggestion buttons */}
                      <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                        {[
                          { label: 'Landing page', value: 'Build a landing page based on the project' },
                          { label: 'Interactive quiz', value: 'Create an interactive quiz based on the project' },
                          { label: '3D simulation', value: 'Generate a 3D simulation based on the project' },
                          { label: 'Game', value: 'Create a game based on the project' },
                          { label: 'Ecommerce store', value: 'Build an ecommerce store' },
                        ].map((suggestion) => (
                          <button
                            key={suggestion.value}
                            type="button"
                            onClick={() => setWebsitePrompt(suggestion.value)}
                            className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                              ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                              : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                              }`}
                          >
                            {suggestion.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Media Upload and Asset Selection */}
                    <div className="mt-3 flex flex-wrap items-center gap-2 text-xs">
                      <label
                        className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full cursor-pointer border transition-colors ${isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:bg-[#2c2c2e]'
                          : 'border-gray-300 text-gray-700 hover:border-gray-500 hover:bg-gray-50'
                          }`}
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span>Upload Media</span>
                        <input
                          type="file"
                          accept="image/*,video/*"
                          multiple
                          className="hidden"
                          onChange={(e) => {
                            const files = Array.from(e.target.files || []);
                            setWebsiteMediaFiles(prev => [...prev, ...files]);
                            if (e.target) e.target.value = '';
                          }}
                        />
                      </label>

                      <button
                        type="button"
                        onClick={() => {
                          setIsWebsiteAssetPickerOpen(true);
                        }}
                        className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs border transition-colors ${isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:bg-[#2c2c2e]'
                          : 'border-gray-300 text-gray-700 hover:border-gray-500 hover:bg-gray-50'
                          }`}
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>Select Assets</span>
                      </button>

                      <button
                        type="button"
                        onClick={() => setIsEcommerceProductPickerOpen(true)}
                        className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs border transition-colors ${selectedEcommerceProductIds.length > 0
                          ? isDarkMode
                            ? 'border-[#0071e3] text-[#0071e3] bg-[#0071e3]/10'
                            : 'border-[#0071e3] text-[#0071e3] bg-[#0071e3]/10'
                          : isDarkMode
                            ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:bg-[#2c2c2e]'
                            : 'border-gray-300 text-gray-700 hover:border-gray-500 hover:bg-gray-50'
                          }`}
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        <span>{selectedEcommerceProductIds.length > 0 ? `Products (${selectedEcommerceProductIds.length})` : 'Attach Products'}</span>
                      </button>

                      {(websiteMediaFiles.length > 0 || selectedWebsiteAssetIds.length > 0) && (
                        <div className="flex items-center gap-2 pl-2 border-l border-gray-200 dark:border-gray-700">
                          <div className="flex -space-x-2 overflow-hidden py-0.5 pl-0.5">
                            {/* Combined Preview List (Max 4 items) */}
                            {(() => {
                              const MAX_PREVIEWS = 4;
                              const totalCount = websiteMediaFiles.length + selectedWebsiteAssetIds.length;
                              const showOverflow = totalCount > MAX_PREVIEWS;

                              // Create a unified list of items to render
                              const fileItems = websiteMediaFiles.map(f => ({ type: 'file', data: f }));
                              const assetItems = selectedWebsiteAssetIds.map(id => ({ type: 'asset', data: id }));
                              const distinctItems = [...fileItems, ...assetItems].slice(0, MAX_PREVIEWS);

                              return (
                                <>
                                  {distinctItems.map((item, i) => {
                                    if (item.type === 'file') {
                                      const file = item.data as File;
                                      return (
                                        <div key={`file-${i}`} className="relative w-10 h-10 rounded-full ring-2 ring-white dark:ring-[#1c1c1e] bg-gray-100 dark:bg-gray-800 overflow-hidden shrink-0">
                                          {file.type.startsWith('image/') ? (
                                            <img src={URL.createObjectURL(file)} className="w-full h-full object-cover" alt="upload" />
                                          ) : (
                                            <div className="w-full h-full flex items-center justify-center text-xs"></div>
                                          )}
                                        </div>
                                      );
                                    } else {
                                      const id = item.data as string;
                                      const asset = allAssets.find(a => a.id === id);

                                      // Improved preview logic:
                                      // 1. Determine if it's a video
                                      const isVideo = asset?.type === 'video' || (asset?.type === 'social' && asset?.data?.videoUrl);

                                      // 2. Resolve image URL:
                                      //    - If video: only use data.imageUrl or data.thumbnail (never use main url as it's likely mp4)
                                      //    - If image: use url or data.imageUrl
                                      let displayUrl = '';
                                      if (isVideo) {
                                        displayUrl = asset?.data?.imageUrl || asset?.data?.thumbnail;
                                      } else {
                                        displayUrl = asset?.url || asset?.data?.imageUrl;
                                      }

                                      return (
                                        <div key={`asset-${i}`} className="relative w-10 h-10 rounded-full ring-2 ring-white dark:ring-[#1c1c1e] bg-gray-100 dark:bg-gray-800 overflow-hidden shrink-0 flex items-center justify-center">
                                          {displayUrl ? (
                                            <img src={displayUrl} className="w-full h-full object-cover" alt="asset" onError={(e) => {
                                              // Fallback on error (e.g. if url was actually a video despite checks)
                                              e.currentTarget.style.display = 'none';
                                              e.currentTarget.parentElement?.querySelector('.fallback-icon')?.classList.remove('hidden');
                                            }} />
                                          ) : null}
                                          {/* Fallback icon container */}
                                          <div className={`fallback-icon ${displayUrl ? 'hidden' : 'flex'} absolute inset-0 items-center justify-center text-xs`}>
                                            {isVideo ? '' : ''}
                                          </div>
                                        </div>
                                      );
                                    }
                                  })}

                                  {showOverflow && (
                                    <div className="relative w-10 h-10 rounded-full ring-2 ring-white dark:ring-[#1c1c1e] bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-[10px] font-medium shrink-0">
                                      +{totalCount - MAX_PREVIEWS}
                                    </div>
                                  )}
                                </>
                              );
                            })()}
                          </div>

                          <button
                            type="button"
                            onClick={() => {
                              setWebsiteMediaFiles([]);
                              setSelectedWebsiteAssetIds([]);
                            }}
                            className={`p-1 rounded-full ${isDarkMode ? 'hover:bg-[#3d3d3f] text-[#86868b]' : 'hover:bg-gray-100 text-gray-400'}`}
                            title="Clear all attached media"
                          >
                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      )}
                    </div>

                    {(websiteError || ecommerceError) && (
                      <p className="text-xs text-red-500">{websiteError || ecommerceError}</p>
                    )}
                    {(websiteSaveMessage || ecommerceSaveMessage) && (
                      <p className="text-xs text-green-500">{websiteSaveMessage || ecommerceSaveMessage}</p>
                    )}

                    <div className="flex items-center justify-between pt-1">
                      <div className="flex items-center gap-2">
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={async () => {
                            if (selectedEcommerceProductIds.length > 0) {
                              // E-commerce mode
                              setEcommercePrompt(websitePrompt);
                              await handleGenerateEcommerceWebsite(websitePrompt);
                            } else {
                              // Regular website mode
                              await handleGenerateProjectWebsite();
                            }
                          }}
                          disabled={(isGeneratingEcommerce || isGeneratingWebsite) || !websitePrompt.trim()}
                          className={`px-4 py-1.5 rounded-full text-xs font-medium flex items-center gap-1.5 ${(isGeneratingEcommerce || isGeneratingWebsite) || !websitePrompt.trim()
                            ? 'bg-[#0071e3]/50 text-white/50 cursor-not-allowed'
                            : 'bg-[#0071e3] text-white hover:bg-[#0077ED] shadow-lg shadow-[#0071e3]/20'
                            }`}
                        >
                          {(isGeneratingEcommerce || isGeneratingWebsite) ? (
                            <>
                              <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <circle cx="12" cy="12" r="10" className="opacity-25" />
                                <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                              </svg>
                              Generating...
                            </>
                          ) : (
                            selectedEcommerceProductIds.length > 0 ? 'Generate Store' : 'Generate Website'
                          )}
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Streaming Preview */}
                  {(websiteStreamingCode || ecommerceStreamingHtml || generatedWebsiteHtml) && (
                    <div className="mt-4">
                      <div className="flex items-center justify-between mb-2">
                        <h4 className={`text-xs font-medium ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>
                          {(isGeneratingWebsite || isGeneratingEcommerce) ? 'Generating Preview...' : 'Preview'}
                        </h4>
                        {(isGeneratingWebsite || isGeneratingEcommerce) && (
                          <div className="flex items-center gap-2">
                            <svg className="w-3 h-3 animate-spin text-[#0071e3]" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <circle cx="12" cy="12" r="10" className="opacity-25" />
                              <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                            </svg>
                            <span className={`text-[10px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>Streaming...</span>
                          </div>
                        )}
                      </div>
                      <div className={`w-full h-[400px] rounded-xl overflow-hidden border ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                        <iframe
                          srcDoc={generatedWebsiteHtml || ecommerceStreamingHtml || cleanStreamingCode(websiteStreamingCode)}
                          className="w-full h-full bg-white"
                          title="Website Preview"
                          sandbox="allow-scripts"
                        />
                      </div>
                    </div>
                  )}
                </div>
              )}


              {filterType === 'images' && (
                <div className={`flex-1 rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                  <h3 className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Generate Image</h3>
                  <p className={`text-xs mb-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Prototype-only Gemini image generation. Generated images are not yet saved into the project.</p>
                  <textarea
                    value={imagePrompt}
                    onChange={e => setImagePrompt(e.target.value)}
                    rows={2}
                    className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                    placeholder="Describe the asset you want to generate (e.g. hero image, product shot, background graphic)"
                  />
                  {/* Suggestion buttons */}
                  <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                    {[
                      { label: 'Infographic', value: 'Create an infographic based on the project' },
                      { label: 'Social media post', value: 'Create a social media post based on the project' },
                      { label: 'Illustration', value: 'Turn this into an illustration' },
                      { label: 'Combine photos', value: 'Combine these photos' },
                      { label: 'Remove background', value: 'Remove the background' },
                    ].map((suggestion) => (
                      <button
                        key={suggestion.value}
                        type="button"
                        onClick={() => setImagePrompt(suggestion.value)}
                        className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                          : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                          }`}
                      >
                        {suggestion.label}
                      </button>
                    ))}
                  </div>
                  <div className="mt-2 flex flex-wrap items-center gap-3 text-xs">
                    <div className="flex items-center gap-2">
                      <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Model:</span>
                      <div className={`flex items-center gap-1 p-0.5 rounded-full ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-200'}`}>
                        <button
                          type="button"
                          onClick={() => setImageModel('fast')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${imageModel === 'fast'
                            ? 'bg-[#0071e3] text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                          title="Gemini 2.5 Flash Image"
                        >
                          Fast
                        </button>
                        <button
                          type="button"
                          onClick={() => setImageModel('pro')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${imageModel === 'pro'
                            ? 'bg-[#0071e3] text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                          title="Gemini 3 Pro Image Preview"
                        >
                          Pro
                        </button>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Aspect:</span>
                      <select
                        value={imageAspectRatio}
                        onChange={(e) => {
                          const newValue = e.target.value as typeof imageAspectRatio;
                          setImageAspectRatio(newValue);
                          setHasUserSetAspectRatio(true); // User manually changed it
                        }}
                        className={`rounded-full px-3 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white' : 'bg-white border border-gray-300 text-gray-900'}`}
                      >
                        <option value="auto">Auto (from reference)</option>
                        {['1:1', '2:3', '3:2', '3:4', '4:3', '4:5', '5:4', '9:16', '16:9', '21:9'].map(r => (
                          <option key={r} value={r}>{r}</option>
                        ))}
                      </select>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Resolution:</span>
                      <select
                        value={imageResolution}
                        onChange={(e) => setImageResolution(e.target.value as any)}
                        disabled={imageModel !== 'pro'}
                        className={`rounded-full px-3 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white' : 'bg-white border border-gray-300 text-gray-900'} ${imageModel !== 'pro' ? 'opacity-50 cursor-not-allowed' : ''}`}
                        title="Only used when Pro image model is enabled"
                      >
                        {['1K', '2K', '4K'].map(r => (
                          <option key={r} value={r}>{r}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <div className="mt-2 flex flex-wrap items-center gap-2 text-xs">
                    <label
                      className={`inline-flex items-center gap-1 px-2 py-1 rounded-full cursor-pointer border transition-colors ${isDarkMode
                        ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                        : 'border-gray-300 text-gray-700 hover:border-gray-500'
                        }`}
                    >
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14M4 6h16" />
                      </svg>
                      <span>{imageReferenceFiles.length ? 'Add reference images' : 'Upload reference image'}</span>
                      <input
                        type="file"
                        accept="image/*"
                        multiple
                        className="hidden"
                        onChange={async (e) => {
                          const files = Array.from(e.target.files || []);
                          const currentCount = imageReferenceFiles.length;
                          const room = MAX_DATA_REFERENCES - currentCount;
                          if (room <= 0) return;
                          const toAdd = files.slice(0, room);
                          setImageReferenceFiles(prev => [...prev, ...toAdd]);

                          // Auto-detect aspect ratio from first image if user hasn't manually set it
                          if (toAdd.length > 0 && !hasUserSetAspectRatio && imageAspectRatio === 'auto') {
                            try {
                              const detectedRatio = await detectImageAspectRatio(toAdd[0]);
                              setImageAspectRatio(detectedRatio);
                            } catch (err) {
                              console.error('Failed to detect aspect ratio:', err);
                            }
                          }

                          if (e.target) e.target.value = '';
                        }}
                      />
                    </label>
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        // Sync ref immediately for first-click reliability
                        assetPickerTargetRef.current = 'image';
                        setAssetPickerTarget('image');
                        // Clear all selection tracking to avoid cross-tab pollution
                        setSelectedImageAssetIds([]);
                        setSelectedVeoAssetIds([]);
                        setIsImageAssetPickerOpen(true);
                      }}
                      disabled={imageReferenceFiles.length >= MAX_DATA_REFERENCES}
                      className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] border transition-colors ${imageReferenceFiles.length >= MAX_DATA_REFERENCES
                        ? isDarkMode
                          ? 'border-[#3d3d3f]/30 text-[#636366]/50 cursor-not-allowed'
                          : 'border-gray-200 text-gray-400 cursor-not-allowed'
                        : isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                          : 'border-gray-300 text-gray-700 hover:border-gray-500'
                        }`}
                    >
                      Select from assets
                    </button>
                    {/* Profile picture usage is now automatic based on prompt context */}
                    {imageReferenceFiles.length > 0 && (
                      <span className={`max-w-[160px] truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {imageReferenceFiles.length === 1
                          ? imageReferenceFiles[0].name
                          : `${imageReferenceFiles.length} reference images`}
                      </span>
                    )}
                    {imageReferenceFiles.length === 1 && (
                      <button
                        type="button"
                        onClick={() => {
                          setReferenceAnnotateError(null);
                          setIsAnnotatingReference(true);
                        }}
                        className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] border transition-colors ${isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                          : 'border-gray-300 text-gray-700 hover:border-gray-500'
                          }`}
                      >
                        Annotate
                      </button>
                    )}
                    {imageReferenceFiles.length > 0 && (
                      <button
                        type="button"
                        onClick={() => setImageReferenceFiles([])}
                        className={isDarkMode ? 'text-[#86868b] hover:text-white' : 'text-gray-500 hover:text-gray-800'}
                      >
                        Clear
                      </button>
                    )}
                    {autoReferenceHints.length > 0 && (
                      <div
                        className={
                          "flex flex-col gap-1.5 px-3 py-2 rounded-xl border " +
                          (isDarkMode ? 'border-[#3d3d3f] bg-[#1d1d1f]' : 'border-gray-200 bg-gray-50')
                        }
                      >
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>
                          Using Data tab reference{autoReferenceHints.length === 1 ? '' : 's'}:
                        </span>
                        <div className="flex flex-nowrap gap-1 overflow-x-auto pb-1 custom-scrollbar">
                          {autoReferenceHints.map(name => (
                            <span
                              key={name}
                              className={
                                "px-2 py-1 rounded-full whitespace-nowrap " +
                                (isDarkMode ? 'bg-[#2d2d2f] text-white/80' : 'bg-white text-gray-700 border border-gray-200')
                              }
                            >
                              {name}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  {imageReferencePreviewUrls.length > 0 && (
                    <div
                      className={`mt-3 overflow-x-auto pb-1 custom-scrollbar rounded-2xl border p-3 ${isDarkMode ? 'border-[#3d3d3f]/70 bg-black/20' : 'border-gray-200 bg-gray-50'}`}
                    >
                      <div className="flex flex-nowrap gap-3 min-w-min">
                        {imageReferenceFiles.map((file, idx) => (
                          <div key={idx} className="relative group flex-shrink-0 cursor-pointer" onClick={() => {
                            setSelectedImage({
                              id: `temp-ref-${idx}`,
                              type: 'slide',
                              url: imageReferencePreviewUrls[idx],
                              title: file.name,
                              description: 'Reference Image',
                              researchId: project.id,
                              researchTopic: project.name,
                              timestamp: Date.now(),
                              data: { imageUrl: imageReferencePreviewUrls[idx] }
                            });
                          }}>
                            <img
                              src={imageReferencePreviewUrls[idx]}
                              alt="Reference"
                              className="h-32 sm:h-48 md:h-64 w-auto rounded-xl border border-black/10 bg-black/5 object-contain hover:opacity-90 transition-opacity"
                            />
                            <button
                              type="button"
                              onClick={(e) => {
                                e.stopPropagation();
                                setImageReferenceFiles(prev => prev.filter((_, i) => i !== idx));
                              }}
                              className="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] shadow-sm opacity-0 group-hover:opacity-100 transition-opacity"
                            >
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                            <div className="mt-1 text-[9px] max-w-[64px] truncate text-center opacity-70">
                              {file.name}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  <div className="mt-2 flex items-center justify-end gap-2">
                    <button
                      type="button"
                      onClick={handleGenerateImage}
                      disabled={isGeneratingImage || !imagePrompt.trim()}
                      className={`px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 ${isGeneratingImage
                        ? 'bg-gray-500/60 text-white cursor-wait'
                        : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                        }`}
                    >
                      {isGeneratingImage && (
                        <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" className="opacity-25" />
                          <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                        </svg>
                      )}
                      <span>{isGeneratingImage ? (imageReferenceFiles.length > 0 ? 'Editing...' : 'Generating...') : (imageReferenceFiles.length > 0 ? 'Edit' : 'Generate')}</span>
                    </button>
                  </div>
                  {imageError && (
                    <p className="mt-2 text-xs text-red-400">{imageError}</p>
                  )}
                  {generatedImage && (
                    <div className="mt-3 flex flex-col sm:flex-row items-center sm:items-start gap-3">
                      <div
                        className="relative group cursor-pointer flex-shrink-0"
                        title="View full screen"
                        onClick={(e) => {
                          e.stopPropagation(); // Ensure no bubble up issues
                          setSelectedImage({
                            id: `generated-image-${Date.now()}`,
                            // Use 'slide' as it is a supported type in ProjectAssets for image viewing, 
                            // or fallback to default viewer logic which handles 'slide' correctly.
                            type: 'slide' as const,
                            url: generatedImage.url,
                            title: generatedImage.prompt || 'Generated Image',
                            description: generatedImage.prompt,
                            researchId: project.id,
                            researchTopic: project.name,
                            timestamp: Date.now(),
                            data: { imageUrl: generatedImage.url }
                          });
                        }}
                      >
                        <img
                          src={generatedImage.url}
                          alt={generatedImage.prompt}
                          className="max-w-[240px] sm:max-w-xs max-h-64 sm:max-h-48 rounded-lg object-contain border border-black/10 hover:opacity-90 transition-opacity bg-black/5"
                        />
                        <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                          <div className="bg-black/40 text-white p-1.5 rounded-full backdrop-blur-sm">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                            </svg>
                          </div>
                        </div>
                      </div>
                      <div className="w-full sm:flex-1 space-y-2">
                        <p className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>{generatedImage.prompt}</p>
                        <div className={`flex flex-col gap-2 rounded-xl p-3 border ${isDarkMode ? 'border-[#3d3d3f] bg-[#111111]' : 'border-gray-200 bg-gray-50'}`}>
                          <div className={`text-[11px] font-medium ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>Edit image (post prompt)</div>
                          <div className="flex items-center gap-2">
                            <input
                              type="text"
                              value={imageEditPrompt}
                              onChange={(e) => setImageEditPrompt(e.target.value)}
                              placeholder="e.g. Make the lighting warmer, add subtle grain"
                              className={`flex-1 rounded-lg px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                            />
                            <button
                              type="button"
                              onClick={handleEditGeneratedImage}
                              disabled={isEditingGeneratedImage || !imageEditPrompt.trim()}
                              className={`px-3 py-2 rounded-lg text-xs font-medium ${isEditingGeneratedImage ? 'bg-gray-500/60 text-white cursor-wait' : 'bg-white/10 text-white hover:bg-white/15'} ${!isDarkMode ? 'bg-white text-gray-900 border border-gray-300 hover:bg-gray-50' : ''}`}
                            >
                              {isEditingGeneratedImage ? 'Editing' : 'Edit'}
                            </button>
                          </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2 text-xs">
                          <a
                            href={generatedImage.url}
                            download="generated-image.png"
                            className="px-2.5 py-1 rounded-full border border-gray-300 bg-white text-gray-800 hover:bg-gray-50"
                          >
                            Download PNG
                          </a>
                          <button
                            type="button"
                            onClick={handleSaveGeneratedImage}
                            className="px-2.5 py-1 rounded-full border border-[#0071e3]/40 bg-[#0071e3]/10 text-[#0071e3] hover:bg-[#0071e3]/15"
                          >
                            Save to Project
                          </button>
                          <button
                            type="button"
                            onClick={async () => {
                              // Generate Video from Image: Switch to videos tab and pre-load image
                              try {
                                const res = await fetch(generatedImage.url);
                                const blob = await res.blob();
                                const ext = (blob.type || '').includes('jpeg') ? 'jpg' : 'png';
                                const fileName = `generated-image-${Date.now()}.${ext}`;
                                const file = new File([blob], fileName, { type: blob.type || 'image/png' });

                                // Set video image file
                                setVideoImageFile(file);
                                // Clear any existing reference files to ensure a clean slate
                                setVideoReferenceFiles([]);
                                // Pre-populate video prompt with context from image prompt
                                setVideoPrompt(generatedImage.prompt ? `Create a video based on this image: ${generatedImage.prompt}` : '');
                                // Switch to videos tab
                                setFilterType('videos');
                                // Scroll to top
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                              } catch (error) {
                                console.error('Failed to load image for video generation:', error);
                                setVideoError('Failed to load image. Please try again.');
                              }
                            }}
                            className="px-2.5 py-1 rounded-full border border-purple-500/40 bg-purple-500/10 text-purple-600 hover:bg-purple-500/15"
                            title="Generate video from this image"
                          >
                            Generate Video
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              // Share to Social: Use onShareToX callback with image asset
                              if (onShareToX) {
                                const assetItem = {
                                  id: `generated-image-${Date.now()}`,
                                  type: 'slide' as const,
                                  url: generatedImage.url,
                                  title: generatedImage.prompt || 'Generated Image',
                                  description: generatedImage.prompt,
                                  data: { imageUrl: generatedImage.url },
                                  researchId: project.id,
                                  researchTopic: project.name,
                                  timestamp: Date.now(),
                                };
                                onShareToX(assetItem);
                              }
                            }}
                            className="px-2.5 py-1 rounded-full border border-green-500/40 bg-green-500/10 text-green-600 hover:bg-green-500/15"
                            title="Share to social media"
                          >
                            Share
                          </button>
                          {imageSaveMessage && (
                            <span className={`text-[11px] ${imageSaveMessage.startsWith('Saved') ? 'text-green-400' : 'text-red-400'}`}>
                              {imageSaveMessage}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {filterType === 'videos' && (
                <div className={`flex-1 rounded-2xl p-4 sm:p-5 min-w-0 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                  <h3 className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Generate Video</h3>

                  {/* Video Overview Job Queue Display */}
                  {allVideoOverviewJobs.length > 0 && (
                    <div className={`mb-4 p-3 rounded-xl ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/40' : 'bg-gray-50 border border-gray-200'}`}>
                      <div className="flex items-center justify-between mb-2">
                        <h4 className={`text-xs font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                          Active Jobs ({allVideoOverviewJobs.length})
                        </h4>
                        <span className={`text-[10px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                          Refreshes every 5s
                        </span>
                      </div>
                      <div className="space-y-2">
                        {allVideoOverviewJobs.map((job) => {
                          const jobAge = Date.now() - job.createdAt;
                          const minutes = Math.floor(jobAge / 60000);
                          const seconds = Math.floor((jobAge % 60000) / 1000);
                          const ageText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;

                          const statusColors: Record<string, { bg: string; text: string; border: string }> = {
                            queued: { bg: isDarkMode ? 'bg-blue-500/10' : 'bg-blue-50', text: isDarkMode ? 'text-blue-400' : 'text-blue-600', border: isDarkMode ? 'border-blue-500/20' : 'border-blue-200' },
                            processing: { bg: isDarkMode ? 'bg-yellow-500/10' : 'bg-yellow-50', text: isDarkMode ? 'text-yellow-400' : 'text-yellow-600', border: isDarkMode ? 'border-yellow-500/20' : 'border-yellow-200' },
                            generating_script: { bg: isDarkMode ? 'bg-purple-500/10' : 'bg-purple-50', text: isDarkMode ? 'text-purple-400' : 'text-purple-600', border: isDarkMode ? 'border-purple-500/20' : 'border-purple-200' },
                            generating_audio: { bg: isDarkMode ? 'bg-indigo-500/10' : 'bg-indigo-50', text: isDarkMode ? 'text-indigo-400' : 'text-indigo-600', border: isDarkMode ? 'border-indigo-500/20' : 'border-indigo-200' },
                            generating_images: { bg: isDarkMode ? 'bg-pink-500/10' : 'bg-pink-50', text: isDarkMode ? 'text-pink-400' : 'text-pink-600', border: isDarkMode ? 'border-pink-500/20' : 'border-pink-200' },
                            assembling: { bg: isDarkMode ? 'bg-orange-500/10' : 'bg-orange-50', text: isDarkMode ? 'text-orange-400' : 'text-orange-600', border: isDarkMode ? 'border-orange-500/20' : 'border-orange-200' },
                            generating_avatar: { bg: isDarkMode ? 'bg-green-500/10' : 'bg-green-50', text: isDarkMode ? 'text-green-400' : 'text-green-600', border: isDarkMode ? 'border-green-500/20' : 'border-green-200' },
                            completed: { bg: isDarkMode ? 'bg-green-500/10' : 'bg-green-50', text: isDarkMode ? 'text-green-400' : 'text-green-600', border: isDarkMode ? 'border-green-500/20' : 'border-green-200' },
                            failed: { bg: isDarkMode ? 'bg-red-500/10' : 'bg-red-50', text: isDarkMode ? 'text-red-400' : 'text-red-600', border: isDarkMode ? 'border-red-500/20' : 'border-red-200' },
                          };

                          const colors = statusColors[job.status] || statusColors.processing;
                          const isActiveJob = activeVideoOverviewJob?.jobId === job.jobId;

                          return (
                            <div
                              key={job.jobId}
                              className={`flex items-center justify-between gap-2 p-2 rounded-lg border ${colors.border} ${colors.bg} ${isActiveJob ? 'ring-1 ring-[#0071e3]' : ''}`}
                            >
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2">
                                  <span className={`text-[10px] font-medium px-1.5 py-0.5 rounded ${colors.text}`}>
                                    {job.status.replace(/_/g, ' ').toUpperCase()}
                                  </span>
                                  {isActiveJob && (
                                    <span className="text-[10px] px-1.5 py-0.5 rounded bg-[#0071e3]/20 text-[#0071e3]">
                                      RESUMING
                                    </span>
                                  )}
                                  <span className={`text-[10px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                    {ageText} ago
                                  </span>
                                </div>
                                {job.progress && (
                                  <p className={`text-[10px] mt-0.5 truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                                    {job.progress}
                                  </p>
                                )}
                                <p className={`text-[9px] mt-0.5 font-mono truncate ${isDarkMode ? 'text-[#636366]' : 'text-gray-400'}`}>
                                  {job.jobId}
                                </p>
                              </div>
                              <button
                                type="button"
                                onClick={async () => {
                                  if (confirm('Cancel this video overview job?')) {
                                    // For now, just remove from UI - you could add API call to cancel in backend
                                    setAllVideoOverviewJobs(prev => prev.filter(j => j.jobId !== job.jobId));
                                    if (activeVideoOverviewJob?.jobId === job.jobId) {
                                      setActiveVideoOverviewJob(null);
                                      setIsGeneratingVideo(false);
                                    }
                                  }
                                }}
                                className={`px-2 py-1 text-[10px] font-medium rounded transition-colors ${isDarkMode
                                  ? 'bg-red-500/10 text-red-400 hover:bg-red-500/20'
                                  : 'bg-red-50 text-red-600 hover:bg-red-100'
                                  }`}
                              >
                                Cancel
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {(videoType === 'clip' || videoType === 'overview') && (
                    <>
                      <p className={`text-xs mb-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        Prototype text-to-video or image-to-video generation using Sora 2 or Veo 3.1. Result is preview-only.
                      </p>
                      <textarea
                        value={videoPrompt}
                        onChange={e => setVideoPrompt(e.target.value)}
                        rows={2}
                        className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                        placeholder="Describe the video you want (shot, subject, motion, lighting, style)"
                      />
                      {/* Suggestion buttons */}
                      <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                        {[
                          { label: 'Ad', value: 'Create an ad based on the project' },
                          { label: 'Explainer video', value: 'Create an explainer video based on the project' },
                          { label: 'Influencer vlog', value: 'Create an influencer vlog based on the project' },
                          { label: 'Animate image', value: 'Animate this image' },
                          { label: 'Merge images', value: 'Merge these images' },
                        ].map((suggestion) => (
                          <button
                            key={suggestion.value}
                            type="button"
                            onClick={() => setVideoPrompt(suggestion.value)}
                            className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                              ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                              : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                              }`}
                          >
                            {suggestion.label}
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                  <div className="mt-2 flex flex-wrap items-center gap-3 text-xs">
                    {videoType === 'clip' && (
                      <div className="flex flex-wrap items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}> </span>
                        {videoEngine === 'veo' ? (
                          <>
                            <label
                              className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] border transition-colors ${videoReferenceFiles.length >= 3
                                ? isDarkMode
                                  ? 'border-[#3d3d3f]/30 text-[#636366]/50 cursor-not-allowed'
                                  : 'border-gray-200 text-gray-400 cursor-not-allowed'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] cursor-pointer'
                                  : 'border-gray-300 text-gray-700 hover:border-gray-500 cursor-pointer'
                                }`}
                              title={videoReferenceFiles.length >= 3 ? 'Maximum 3 reference images allowed' : 'Upload reference images from device'}
                            >
                              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14M4 6h16" />
                              </svg>
                              <span>Upload from device</span>
                              <input
                                type="file"
                                accept="image/*"
                                multiple
                                disabled={videoReferenceFiles.length >= 3}
                                className="hidden"
                                onChange={e => {
                                  const files = Array.from(e.target.files || []);
                                  const remaining = 3 - videoReferenceFiles.length;
                                  if (remaining > 0) {
                                    const filesToAdd = files.slice(0, remaining);
                                    setVideoReferenceFiles(prev => [...prev, ...filesToAdd]);
                                  }
                                  if (e.target) e.target.value = ''; // Reset input to allow picking same file again
                                }}
                              />
                            </label>
                            <button
                              type="button"
                              onClick={(e) => {
                                e.stopPropagation();
                                // Sync ref immediately for first-click reliability
                                assetPickerTargetRef.current = 'veo';
                                setAssetPickerTarget('veo');
                                // Clear all selection tracking to avoid cross-tab pollution
                                setSelectedImageAssetIds([]);
                                setSelectedVeoAssetIds([]);
                                setIsImageAssetPickerOpen(true);
                              }}
                              disabled={videoReferenceFiles.length >= 3}
                              className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] border transition-colors ${videoReferenceFiles.length >= 3
                                ? isDarkMode
                                  ? 'border-[#3d3d3f]/30 text-[#636366]/50 cursor-not-allowed'
                                  : 'border-gray-200 text-gray-400 cursor-not-allowed'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                                  : 'border-gray-300 text-gray-700 hover:border-gray-500'
                                }`}
                              title={videoReferenceFiles.length >= 3 ? 'Maximum 3 reference images allowed' : 'Select reference images from your project assets'}
                            >
                              Select from assets
                            </button>
                            <span className={`text-[10px] ${videoReferenceFiles.length >= 3 ? 'text-amber-500' : isDarkMode ? 'text-[#636366]' : 'text-gray-500'}`}>
                              {videoReferenceFiles.length}/3
                            </span>
                          </>
                        ) : (
                          <>
                            <label
                              className={`inline-flex items-center gap-1 px-2 py-1 rounded-full cursor-pointer text-[11px] border transition-colors ${isDarkMode
                                ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                                : 'border-gray-300 text-gray-700 hover:border-gray-500'
                                }`}
                            >
                              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14M4 6h16" />
                              </svg>
                              <span>{videoImageFile ? 'Change image' : 'Upload image'}</span>
                              <input
                                type="file"
                                accept="image/*"
                                className="hidden"
                                onChange={e => {
                                  const file = e.target.files?.[0] || null;
                                  setVideoImageFile(file);
                                }}
                              />
                            </label>
                            <button
                              type="button"
                              onClick={(e) => {
                                e.stopPropagation();
                                // Sync ref immediately for first-click reliability
                                assetPickerTargetRef.current = 'sora';
                                setAssetPickerTarget('sora');
                                // Clear all selection tracking to avoid cross-tab pollution
                                setSelectedImageAssetIds([]);
                                setSelectedVeoAssetIds([]);
                                setIsImageAssetPickerOpen(true);
                              }}
                              className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] border transition-colors ${isDarkMode
                                ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                                : 'border-gray-300 text-gray-700 hover:border-gray-500'
                                }`}
                            >
                              Select from assets
                            </button>
                          </>
                        )}
                        {videoImageFile && (
                          <div className="flex items-center gap-2">
                            {videoImagePreviewUrl ? (
                              <div className={`w-8 h-8 rounded-lg overflow-hidden border ${isDarkMode ? 'border-[#3d3d3f]/70 bg-black/30' : 'border-gray-200 bg-gray-100'}`}>
                                <img src={videoImagePreviewUrl} alt={videoImageFile.name} className="w-full h-full object-cover" />
                              </div>
                            ) : (
                              <div className={`w-8 h-8 rounded-lg border ${isDarkMode ? 'border-[#3d3d3f]/70 bg-black/30' : 'border-gray-200 bg-gray-100'}`} />
                            )}
                            <span className={`max-w-[160px] truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>{videoImageFile.name}</span>
                            <button
                              type="button"
                              onClick={() => setVideoImageFile(null)}
                              className={`${isDarkMode ? 'text-[#86868b] hover:text-white' : 'text-gray-500 hover:text-gray-800'} text-[11px]`}
                            >
                              Remove
                            </button>
                          </div>
                        )}

                        {/* Display additional reference files for Veo with improved previews */}
                        {videoReferenceFiles.length > 0 && (
                          <div className="mt-2 space-y-2">
                            <p className={`text-[11px] font-medium ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>
                              Reference Images ({videoReferenceFiles.length}/3)
                            </p>
                            <div className="flex flex-wrap gap-2">
                              {videoReferenceFiles.map((file, idx) => {
                                const previewUrl = videoReferencePreviewUrls[idx];
                                if (!previewUrl) return null;

                                return (
                                  <div key={`${file.name}-${idx}`} className={`group relative rounded-lg overflow-hidden border ${isDarkMode ? 'border-[#3d3d3f]/70' : 'border-gray-200'}`}>
                                    <img
                                      src={previewUrl}
                                      alt={file.name}
                                      className="w-20 h-20 object-cover"
                                    />
                                    <div className={`absolute inset-0 bg-gradient-to-t ${isDarkMode ? 'from-black/80 via-transparent' : 'from-gray-900/80 via-transparent'} opacity-0 group-hover:opacity-100 transition-opacity`}>
                                      <button
                                        type="button"
                                        onClick={() => {
                                          const next = [...videoReferenceFiles];
                                          next.splice(idx, 1);
                                          setVideoReferenceFiles(next);
                                        }}
                                        className="absolute bottom-1 right-1 p-1 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors"
                                        title="Remove image"
                                      >
                                        <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                      </button>
                                    </div>
                                    <div className={`absolute top-0 left-0 px-1.5 py-0.5 text-[9px] font-medium rounded-br-md ${isDarkMode ? 'bg-black/60 text-white' : 'bg-gray-900/60 text-white'}`}>
                                      {idx + 1}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}  </div>
                    )}
                    <div className="flex items-center gap-2">
                      <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Type:</span>
                      <div className={`flex items-center gap-1 p-0.5 rounded-full ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-200'}`}>
                        <button
                          type="button"
                          onClick={() => setVideoType('clip')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoType === 'clip'
                            ? 'bg-[#0071e3] text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                        >
                          Clip
                        </button>
                        <button
                          type="button"
                          onClick={() => setVideoType('overview')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoType === 'overview'
                            ? 'bg-[#0071e3] text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                        >
                          Overview
                        </button>
                        <button
                          type="button"
                          onClick={() => setVideoType('slideshow')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoType === 'slideshow'
                            ? 'bg-[#0071e3] text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                        >
                          Slideshow
                        </button>
                        <button
                          type="button"
                          onClick={() => setVideoType('live')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors flex items-center gap-1.5 ${videoType === 'live'
                            ? 'bg-red-600 text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                        >
                          {videoType === 'live' && <span className="animate-pulse w-1.5 h-1.5 rounded-full bg-white" />}
                          Live
                        </button>
                        <button
                          type="button"
                          onClick={() => setVideoType('edit')}
                          className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoType === 'edit'
                            ? 'bg-[#0071e3] text-white'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-white'
                              : 'text-gray-700 hover:text-gray-900'
                            }`}
                        >
                          Edit
                        </button>
                      </div>
                    </div>
                    {videoType === 'clip' && (
                      <div className="flex items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Engine:</span>
                        <div className={`flex items-center gap-1 p-0.5 rounded-full ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-200'}`}>
                          <button
                            type="button"
                            onClick={() => {
                              setVideoEngine('sora');
                              setVideoModel('sora-2');
                            }}
                            className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoEngine === 'sora'
                              ? 'bg-[#0071e3] text-white'
                              : isDarkMode
                                ? 'text-[#86868b] hover:text-white'
                                : 'text-gray-700 hover:text-gray-900'
                              }`}
                          >
                            Sora 2
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              setVideoEngine('veo');
                              setVideoModel('veo-3.1');
                            }}
                            className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoEngine === 'veo'
                              ? 'bg-[#0071e3] text-white'
                              : isDarkMode
                                ? 'text-[#86868b] hover:text-white'
                                : 'text-gray-700 hover:text-gray-900'
                              }`}
                          >
                            Veo 3.1
                          </button>
                        </div>
                      </div>
                    )}
                    {videoType === 'live' && (
                      <div className="col-span-full mt-4 w-full h-[500px] rounded-xl overflow-hidden border border-gray-200 dark:border-gray-800 shadow-sm relative">
                        <LiveVideoEditor
                          className="w-full h-full"
                          isDarkMode={isDarkMode}
                          imageReference={liveVideoImageFile}
                          imagePreviewUrl={liveVideoImagePreviewUrl}
                          onSelectImage={() => {
                            setAssetPickerTarget('live-video-image');
                            setIsImageAssetPickerOpen(true);
                          }}
                          onRemoveImage={() => {
                            setLiveVideoImageFile(null);
                            setLiveVideoImagePreviewUrl(null);
                          }}
                        />
                      </div>
                    )}
                    {videoType === 'edit' && (
                      <div className="w-full mt-6 space-y-6">
                        <div className="flex items-center justify-between">
                          <h3 className={`text-sm font-medium ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Modify with Luma Dream Machine</h3>
                          <span className={`text-xs px-2 py-0.5 rounded-full ${isDarkMode ? 'bg-[#0071e3]/20 text-[#0a84ff]' : 'bg-[#0071e3]/10 text-[#0071e3]'}`}>
                            Beta
                          </span>
                        </div>

                        {/* Video Uploader */}
                        <div className="group relative">
                          {!lumaVideoFile && !lumaVideoPreviewUrl ? (
                            <div className="flex gap-4">
                              <label className={`relative flex-1 flex flex-col items-center justify-center h-48 rounded-xl border-2 border-dashed transition-all cursor-pointer ${isDarkMode
                                ? 'border-[#3d3d3f] hover:border-[#636366] hover:bg-[#1c1c1e]'
                                : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                }`}>
                                <div className="flex flex-col items-center justify-center text-center">
                                  <div className={`w-12 h-12 mb-3 rounded-full flex items-center justify-center ${isDarkMode ? 'bg-[#2c2c2e]' : 'bg-gray-100'}`}>
                                    <svg className={`w-6 h-6 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                  </div>
                                  <p className={`text-sm font-medium mb-1 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Upload Source Video
                                  </p>
                                  <p className={`text-xs ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                    MP4 or MOV up to 100MB
                                  </p>
                                </div>
                                <input
                                  type="file"
                                  className="hidden"
                                  accept="video/*"
                                  onChange={(e) => {
                                    const file = e.target.files?.[0];
                                    if (file) {
                                      setLumaVideoFile(file);
                                      setLumaVideoAssetId(null);
                                      setLumaVideoTitle(file.name);
                                      setLumaVideoPreviewUrl(URL.createObjectURL(file));
                                    }
                                  }}
                                />
                              </label>

                              <button
                                type="button"
                                onClick={(e) => {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  console.log('Luma Source Video Picker Clicked (New Flow)');
                                  setIsLumaVideoPickerOpen(true);
                                }}
                                className={`flex-1 flex flex-col items-center justify-center h-48 rounded-xl border-2 border-dashed transition-all ${isDarkMode
                                  ? 'border-[#3d3d3f] hover:border-[#636366] hover:bg-[#1c1c1e]'
                                  : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                  }`}
                              >
                                <div className={`w-12 h-12 mb-3 rounded-full flex items-center justify-center ${isDarkMode ? 'bg-[#2c2c2e]' : 'bg-gray-100'}`}>
                                  <svg className={`w-6 h-6 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                  </svg>
                                </div>
                                <p className={`text-sm font-medium mb-1 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                  Select from Assets
                                </p>
                                <p className={`text-xs ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                  Use video from library
                                </p>
                              </button>
                            </div>
                          ) : (
                            <div className="relative rounded-xl overflow-hidden bg-black aspect-video group shadow-lg ring-1 ring-black/5 dark:ring-white/10">
                              {lumaVideoPreviewUrl && (
                                <video src={lumaVideoPreviewUrl} className="w-full h-full object-contain" controls />
                              )}
                              <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                <button
                                  onClick={() => { setLumaVideoFile(null); setLumaVideoPreviewUrl(null); setLumaVideoTitle(null); setLumaJob(null); }}
                                  className="p-2 bg-black/50 hover:bg-black/70 text-white rounded-full backdrop-blur-sm transition-colors"
                                  title="Clear Video"
                                >
                                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </div>

                              {lumaJob?.status === 'completed' && lumaVideoPreviewUrl ? (
                                <div className="absolute bottom-3 right-3 flex flex-wrap justify-end gap-2 z-10 px-3">
                                  <a
                                    href={lumaVideoPreviewUrl}
                                    download={`luma-video-${lumaJob.id}.mp4`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-3 py-1.5 bg-[#0071e3] text-white text-xs font-medium rounded-full hover:bg-[#0077ED] transition-colors shadow-lg flex items-center gap-1.5"
                                  >
                                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Download
                                  </a>
                                  <div className="px-3 py-1.5 bg-green-500/90 text-white text-xs font-medium rounded-full shadow-lg backdrop-blur-md flex items-center gap-1.5">
                                    <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Saved
                                  </div>
                                </div>
                              ) : lumaVideoTitle && (
                                <div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent">
                                  <p className="text-white text-xs font-medium truncate">{lumaVideoTitle}</p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>



                        {/* First Frame Reference */}
                        <div className="group relative">
                          <label className={`block text-xs font-medium mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            First Frame Reference (Optional)
                          </label>
                          {!lumaFirstFrameFile ? (
                            <div className="flex gap-2">
                              <label className={`relative flex-1 flex flex-col items-center justify-center h-32 rounded-xl border-2 border-dashed transition-all cursor-pointer ${isDarkMode
                                ? 'border-[#3d3d3f] hover:border-[#636366] hover:bg-[#1c1c1e]'
                                : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                }`}>
                                <div className="flex flex-col items-center justify-center text-center">
                                  <svg className={`w-5 h-5 mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                  </svg>
                                  <p className={`text-xs ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>Upload Image</p>
                                </div>
                                <input
                                  type="file"
                                  className="hidden"
                                  accept="image/*"
                                  onChange={(e) => {
                                    const file = e.target.files?.[0];
                                    if (file) {
                                      setLumaFirstFrameFile(file);
                                      setLumaFirstFrameAssetId(null);
                                      setLumaFirstFramePreviewUrl(URL.createObjectURL(file));
                                    }
                                  }}
                                />
                              </label>

                              <button
                                onClick={() => {
                                  setAssetPickerTarget('luma-first-frame');
                                  setIsVideoAssetPickerOpen(false);
                                  setIsImageAssetPickerOpen(true);
                                }}
                                className={`flex-1 flex flex-col items-center justify-center h-32 rounded-xl border-2 border-dashed transition-all ${isDarkMode
                                  ? 'border-[#3d3d3f] hover:border-[#636366] hover:bg-[#1c1c1e]'
                                  : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                  }`}
                              >
                                <svg className={`w-5 h-5 mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                                <p className={`text-xs ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>Select from Assets</p>
                              </button>

                              {(lumaVideoFile || lumaVideoPreviewUrl) && (
                                <button
                                  onClick={handleExtractFirstFrame}
                                  disabled={isExtractingFrame}
                                  className={`relative flex-0.5 min-w-[80px] flex flex-col items-center justify-center h-32 rounded-xl border-dashed border-2 ml-2 transition-all ${isDarkMode
                                    ? 'border-[#3d3d3f] hover:border-[#636366] hover:bg-[#1c1c1e]'
                                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                    }`}
                                >
                                  {isExtractingFrame ? (
                                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-[#0071e3]"></div>
                                  ) : (
                                    <svg className={`w-5 h-5 mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                  )}
                                  <p className={`text-[10px] text-center px-1 ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                    {isExtractingFrame ? 'Extracting...' : 'Use Frame'}
                                  </p>
                                </button>
                              )}
                            </div>
                          ) : (
                            <div className="relative h-32 w-full rounded-xl overflow-hidden bg-black group shadow-lg ring-1 ring-black/5 dark:ring-white/10">
                              {lumaFirstFramePreviewUrl && (
                                <img src={lumaFirstFramePreviewUrl} className="w-full h-full object-cover" alt="First frame reference" />
                              )}

                              {isEditingFrame ? (
                                <div className="absolute inset-0 bg-black/90 z-20 flex flex-col p-3 transition-opacity">
                                  <textarea
                                    className={`flex-1 w-full text-xs resize-none border rounded p-2 mb-2 focus:ring-1 focus:ring-[#0071e3] focus:outline-none ${isDarkMode ? 'bg-[#1c1c1e] text-white border-gray-700' : 'bg-white text-black border-gray-300'}`}
                                    placeholder="Describe edits (e.g. 'remove text', 'make sky orange')..."
                                    value={frameEditPrompt}
                                    onChange={e => setFrameEditPrompt(e.target.value)}
                                    autoFocus
                                  />
                                  <div className="flex justify-end gap-2 text-[10px]">
                                    <button
                                      onClick={() => setIsEditingFrame(false)}
                                      className="text-gray-400 hover:text-white px-2 py-1"
                                    >
                                      Cancel
                                    </button>
                                    <button
                                      onClick={handleEditFrameWithGemini}
                                      disabled={!frameEditPrompt.trim()}
                                      className="bg-[#0071e3] text-white px-3 py-1 rounded-full hover:bg-[#0077ED] disabled:opacity-50"
                                    >
                                      Generate
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <>
                                  <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity z-10 flex gap-2">
                                    <button
                                      onClick={() => setIsEditingFrame(true)}
                                      className="px-2 py-1.5 bg-black/50 hover:bg-black/70 text-white text-[10px] font-medium rounded-full backdrop-blur-sm transition-colors flex items-center gap-1"
                                    >
                                      <svg className="w-3 h-3 text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                      </svg>
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => { setLumaFirstFrameFile(null); setLumaFirstFramePreviewUrl(null); setLumaFirstFrameAssetId(null); }}
                                      className="p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-full backdrop-blur-sm transition-colors"
                                    >
                                      <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                      </svg>
                                    </button>
                                  </div>
                                  {lumaFirstFrameAssetId && (
                                    <div className="absolute bottom-2 left-2 px-2 py-0.5 rounded-full bg-black/60 backdrop-blur-sm">
                                      <span className="text-[10px] text-white font-medium">Asset Linked</span>
                                    </div>
                                  )}
                                </>
                              )}
                            </div>
                          )}
                        </div>

                        {/* Controls Container */}
                        <div className={`p-5 rounded-2xl ${isDarkMode ? 'bg-[#1c1c1e] ring-1 ring-[#3d3d3f]' : 'bg-white ring-1 ring-gray-200'} shadow-sm`}>
                          {/* Prompt */}
                          <div className="mb-6">
                            <label className={`block text-xs font-medium mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Modifications
                            </label>
                            <textarea
                              value={lumaPrompt}
                              onChange={(e) => setLumaPrompt(e.target.value)}
                              placeholder="Describe how you want to change the video (e.g. 'Turn the car into a spaceship', 'Add cinematic lighting', 'Make it look like a sketch')"
                              className={`w-full p-3 rounded-xl text-sm transition-shadow focus:ring-2 focus:ring-[#0071e3] focus:outline-none resize-none ${isDarkMode
                                ? 'bg-[#111111] text-white placeholder-gray-600'
                                : 'bg-gray-50 text-gray-900 placeholder-gray-400'
                                }`}
                              rows={3}
                            />
                          </div>

                          {/* Style Strength Selector */}
                          <div className="mb-6">
                            <label className={`block text-xs font-medium mb-3 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Style Strength
                            </label>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                              {[
                                { id: 'adhere_1', label: 'Consistent', desc: 'Keeps structure' },
                                { id: 'flex_1', label: 'Balanced', desc: 'Mix of both' },
                                { id: 'reimagine_1', label: 'Creative', desc: 'Heavy changes' }
                              ].map((m) => {
                                const isSelected = lumaMode.startsWith(m.id.split('_')[0]);
                                return (
                                  <button
                                    key={m.id}
                                    onClick={() => setLumaMode(m.id as any)}
                                    className={`relative flex flex-col items-start p-3 rounded-xl border text-left transition-all ${isSelected
                                      ? 'border-[#0071e3] bg-[#0071e3]/5 ring-1 ring-[#0071e3]'
                                      : isDarkMode
                                        ? 'border-[#3d3d3f] hover:border-[#636366] hover:bg-[#2c2c2e]'
                                        : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                                      }`}
                                  >
                                    <span className={`text-xs font-semibold mb-0.5 ${isSelected ? 'text-[#0071e3]' : isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                      {m.label}
                                    </span>
                                    <span className={`text-[10px] ${isSelected ? 'text-[#0071e3]/80' : 'text-gray-500'}`}>
                                      {m.desc}
                                    </span>
                                    {isSelected && (
                                      <div className="absolute top-2 right-2 w-2 h-2 rounded-full bg-[#0071e3]" />
                                    )}
                                  </button>
                                );
                              })}
                            </div>
                          </div>

                          {/* Action Button */}
                          <button
                            onClick={async () => {
                              if (!lumaVideoFile || !lumaPrompt) return;
                              setIsModifyingLuma(true);
                              setLumaError(null);
                              try {
                                // Resolve URLs from Assets (Luma requires public URLs)
                                // If selected from assets, previewUrl is the public URL.
                                // If uploaded locally, previewUrl is a blob: URL (which won't work).

                                const videoUrl = lumaVideoAssetId ? lumaVideoPreviewUrl : null;
                                const firstFrameUrl = lumaFirstFrameAssetId ? lumaFirstFramePreviewUrl : null;

                                if (!videoUrl && lumaVideoFile) {
                                  throw new Error("Local file upload is not yet supported for Luma. Please use 'Select from Assets' to choose a video from your library.");
                                }

                                if (!videoUrl) throw new Error("No video selected.");

                                // Call Luma API
                                const response = await lumaService.modifyVideo({
                                  media: { url: videoUrl },
                                  first_frame: firstFrameUrl ? { url: firstFrameUrl } : undefined,
                                  model: 'ray-2',
                                  mode: lumaMode,
                                  prompt: lumaPrompt,
                                });

                                // Success
                                setLumaResult(response.id);
                                setLumaJob({ id: response.id, status: 'queued' });

                              } catch (e: any) {
                                setLumaError(e.message);
                              } finally {
                                setIsModifyingLuma(false);
                              }
                            }}
                            disabled={isModifyingLuma || !lumaVideoFile || !lumaPrompt || (lumaJob && lumaJob.status !== 'completed' && lumaJob.status !== 'failed')}
                            className={`w-full py-3 rounded-xl font-medium text-sm text-white shadow-sm transition-all ${isModifyingLuma || !lumaVideoFile || !lumaPrompt || (lumaJob && lumaJob.status !== 'completed' && lumaJob.status !== 'failed')
                              ? 'bg-gray-300 dark:bg-gray-700 cursor-not-allowed'
                              : 'bg-[#0071e3] hover:bg-[#0077ED] hover:shadow-md'
                              }`}
                          >
                            {isModifyingLuma ? (
                              <div className="flex items-center justify-center gap-2">
                                <svg className="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span>Generating Preview...</span>
                              </div>
                            ) : lumaJob && (lumaJob.status !== 'completed' && lumaJob.status !== 'failed') ? (
                              `Job Active: ${lumaJob.status}...`
                            ) : (
                              'Generate Modification'
                            )}
                          </button>

                          {lumaJob && (lumaJob.status !== 'completed' && lumaJob.status !== 'failed') && (
                            <div className="mt-3 p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 flex items-center gap-3">
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-[#0071e3]"></div>
                              <div className="flex-1">
                                <p className="text-xs font-medium text-blue-800 dark:text-blue-300">
                                  Dreaming... ({lumaJob.status})
                                </p>
                                <p className="text-[10px] text-blue-600 dark:text-blue-400 mt-0.5">
                                  This may take a minute. You can continue working.
                                </p>
                              </div>
                            </div>
                          )}

                          {lumaError && (
                            <div className="mt-4 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800">
                              <p className="text-xs text-red-600 dark:text-red-400 text-center font-medium">{lumaError}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    {videoType === 'clip' && (
                      <div className="flex items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Mode:</span>
                        <div className={`flex items-center gap-1 p-0.5 rounded-full ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-200'}`}>
                          {videoEngine === 'sora' ? (
                            <>
                              <button
                                type="button"
                                onClick={() => setVideoModel('sora-2')}
                                className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoModel === 'sora-2'
                                  ? 'bg-[#0071e3] text-white'
                                  : isDarkMode
                                    ? 'text-[#86868b] hover:text-white'
                                    : 'text-gray-700 hover:text-gray-900'
                                  }`}
                              >
                                Speed
                              </button>
                              <button
                                type="button"
                                onClick={() => setVideoModel('sora-2-pro')}
                                className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoModel === 'sora-2-pro'
                                  ? 'bg-[#0071e3] text-white'
                                  : isDarkMode
                                    ? 'text-[#86868b] hover:text-white'
                                    : 'text-gray-700 hover:text-gray-900'
                                  }`}
                              >
                                Quality
                              </button>
                            </>
                          ) : (
                            <button
                              type="button"
                              onClick={() => setVideoModel('veo-3.1')}
                              className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoModel === 'veo-3.1'
                                ? 'bg-[#0071e3] text-white'
                                : isDarkMode
                                  ? 'text-[#86868b] hover:text-white'
                                  : 'text-gray-700 hover:text-gray-900'
                                }`}
                            >
                              3.1
                            </button>
                          )}
                        </div>
                      </div>
                    )}

                    {videoType === 'clip' && (
                      <div className="flex items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Aspect:</span>
                        <div className="flex items-center gap-1">
                          {[
                            { id: '720x1280', label: '9:16', shape: 'h-7 w-3' },
                            { id: '1280x720', label: '16:9', shape: 'h-3 w-7' },
                          ].map(option => (
                            <button
                              key={option.id}
                              type="button"
                              onClick={() => setVideoSize(option.id as any)}
                              className={`flex flex-col items-center gap-0.5 px-1.5 py-1 rounded-lg text-[10px] border transition-colors ${videoSize === option.id
                                ? 'border-[#0071e3] bg-[#0071e3]/10 text-[#0071e3]'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                                  : 'border-gray-300 text-gray-600 hover:border-gray-500'
                                }`}
                            >
                              <div className={`rounded-[4px] bg-current/40 ${option.shape}`} />
                              <span>{option.label}</span>
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                    {videoType === 'clip' && (
                      <div className="flex items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Seconds:</span>
                        <div className={`flex items-center gap-1 p-0.5 rounded-full ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-200'}`}>
                          {(videoEngine === 'veo' ? (['8'] as const) : (['4', '8', '12'] as const)).map(s => (
                            <button
                              key={s}
                              type="button"
                              onClick={() => setVideoSeconds(s)}
                              className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoSeconds === s
                                ? 'bg-[#0071e3] text-white'
                                : isDarkMode
                                  ? 'text-[#86868b] hover:text-white'
                                  : 'text-gray-700 hover:text-gray-900'
                                }`}
                            >
                              {s}s
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                    {videoType === 'overview' && (
                      <div className="flex items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Slides:</span>
                        <div className={`flex items-center gap-1 p-0.5 rounded-full ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-200'}`}>
                          {[8, 12, 16].map(s => (
                            <button
                              key={s}
                              type="button"
                              onClick={() => setVideoSlides(s)}
                              className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${videoSlides === s
                                ? 'bg-[#0071e3] text-white'
                                : isDarkMode
                                  ? 'text-[#86868b] hover:text-white'
                                  : 'text-gray-700 hover:text-gray-900'
                                }`}
                            >
                              {s}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Slideshow Mode UI */}
                    {videoType === 'slideshow' && (
                      <div className="col-span-full mt-4 space-y-4 min-w-0 w-full max-w-full">
                        <p className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          Select images and videos from your assets. Click to toggle selection, set duration for each clip.
                        </p>

                        {/* Image Assets Row */}
                        <div>
                          <h4 className={`text-xs font-medium mb-2 ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>Images</h4>
                          <div className="flex gap-2 overflow-x-auto pb-2 max-w-full">
                            {assetsBySession.flatMap(s => s.assets).filter(a => a.type === 'header' || a.type === 'slide' || a.type === 'notemap' || a.type === 'social').map(asset => {
                              const selected = slideshowAssets.find(s => s.assetId === asset.id);
                              return (
                                <div
                                  key={asset.id}
                                  className={`relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden cursor-pointer border-2 transition-all ${selected
                                    ? 'border-[#0071e3] ring-2 ring-[#0071e3]/30'
                                    : isDarkMode ? 'border-[#3d3d3f] hover:border-[#636366]' : 'border-gray-200 hover:border-gray-400'
                                    }`}
                                  onClick={() => {
                                    if (selected) {
                                      setSlideshowAssets(prev => prev.filter(s => s.assetId !== asset.id).map((s, i) => ({ ...s, order: i + 1 })));
                                    } else {
                                      setSlideshowAssets(prev => [...prev, {
                                        assetId: asset.id,
                                        url: asset.url || '',
                                        type: 'image',
                                        duration: 4,
                                        order: prev.length + 1,
                                        title: asset.title,
                                      }]);
                                    }
                                  }}
                                >
                                  {asset.url && <img src={asset.url} alt={asset.title} className="w-full h-full object-cover" />}
                                  {selected && (
                                    <>
                                      <div className="absolute top-1 left-1 w-5 h-5 rounded-full bg-[#0071e3] text-white text-[10px] font-bold flex items-center justify-center">
                                        {selected.order}
                                      </div>
                                      <select
                                        value={selected.duration}
                                        onClick={e => e.stopPropagation()}
                                        onChange={e => {
                                          const newDuration = parseInt(e.target.value) as 4 | 6 | 8;
                                          setSlideshowAssets(prev => prev.map(s => s.assetId === asset.id ? { ...s, duration: newDuration } : s));
                                        }}
                                        className="absolute bottom-1 right-1 w-12 text-[10px] rounded bg-black/70 text-white border-none px-1 py-0.5"
                                      >
                                        <option value={4}>4s</option>
                                        <option value={6}>6s</option>
                                        <option value={8}>8s</option>
                                      </select>
                                    </>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>

                        {/* Video Assets Row */}
                        <div>
                          <h4 className={`text-xs font-medium mb-2 ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>Videos</h4>
                          <div className="flex gap-2 overflow-x-auto pb-2 max-w-full">
                            {assetsBySession.flatMap(s => s.assets).filter(a => a.type === 'video').map(asset => {
                              const selected = slideshowAssets.find(s => s.assetId === asset.id);
                              return (
                                <div
                                  key={asset.id}
                                  className={`relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden cursor-pointer border-2 transition-all ${selected
                                    ? 'border-[#0071e3] ring-2 ring-[#0071e3]/30'
                                    : isDarkMode ? 'border-[#3d3d3f] hover:border-[#636366]' : 'border-gray-200 hover:border-gray-400'
                                    }`}
                                  onClick={() => {
                                    if (selected) {
                                      setSlideshowAssets(prev => prev.filter(s => s.assetId !== asset.id).map((s, i) => ({ ...s, order: i + 1 })));
                                    } else {
                                      setSlideshowAssets(prev => [...prev, {
                                        assetId: asset.id,
                                        url: asset.url || '',
                                        type: 'video',
                                        duration: 6,
                                        order: prev.length + 1,
                                        title: asset.title,
                                      } as any]);
                                    }
                                  }}
                                >
                                  <div className={`w-full h-full flex items-center justify-center ${isDarkMode ? 'bg-black/50' : 'bg-gray-100'}`}>
                                    {asset.url ? (
                                      <video
                                        src={asset.url}
                                        className="w-full h-full object-cover pointer-events-none"
                                        muted
                                        preload="metadata"
                                      />
                                    ) : (
                                      <svg className={`w-8 h-8 ${isDarkMode ? 'text-white/50' : 'text-gray-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                      </svg>
                                    )}
                                  </div>
                                  {selected && (
                                    <>
                                      <div className="absolute top-1 left-1 w-5 h-5 rounded-full bg-[#0071e3] text-white text-[10px] font-bold flex items-center justify-center">
                                        {selected.order}
                                      </div>
                                      <select
                                        value={selected.duration}
                                        onClick={e => e.stopPropagation()}
                                        onChange={e => {
                                          const newDuration = parseInt(e.target.value) as 4 | 6 | 8;
                                          setSlideshowAssets(prev => prev.map(s => s.assetId === asset.id ? { ...s, duration: newDuration } : s));
                                        }}
                                        className="absolute bottom-1 right-1 w-12 text-[10px] rounded bg-black/70 text-white border-none px-1 py-0.5"
                                      >
                                        <option value={4}>4s</option>
                                        <option value={6}>6s</option>
                                        <option value={8}>8s</option>
                                      </select>
                                    </>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>

                        {/* Selected Assets Preview */}
                        {slideshowAssets.length > 0 && (
                          <div className={`p-3 rounded-xl ${isDarkMode ? 'bg-[#111111]' : 'bg-gray-100'}`}>
                            <div className="flex items-center justify-between mb-2">
                              <span className={`text-xs font-medium ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>
                                Sequence ({slideshowAssets.length} clips, {slideshowAssets.reduce((acc, s) => acc + (s.duration === 'full' ? 0 : s.duration), 0)}s + full videos)
                              </span>
                              <button
                                onClick={() => setSlideshowAssets([])}
                                className={`text-[10px] ${isDarkMode ? 'text-red-400 hover:text-red-300' : 'text-red-600 hover:text-red-700'}`}
                              >
                                Clear All
                              </button>
                            </div>
                            <div className="flex gap-1 overflow-x-auto max-w-full">
                              {slideshowAssets.sort((a, b) => a.order - b.order).map(s => (
                                <div key={s.assetId} className={`flex-shrink-0 px-2 py-1 rounded text-[10px] ${isDarkMode ? 'bg-[#0071e3]/20 text-[#0071e3]' : 'bg-[#0071e3]/10 text-[#0071e3]'}`}>
                                  {s.order}. {s.title?.slice(0, 12) || s.type} ({s.duration}s)
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    <div className="flex items-center gap-2 ml-auto">
                      {/* Emergency clear button for stuck jobs */}
                      {activeVideoOverviewJob && (
                        <button
                          type="button"
                          onClick={() => {
                            console.log('[ProjectAssets] User manually clearing stuck job:', activeVideoOverviewJob.jobId);
                            setActiveVideoOverviewJob(null);
                            setIsGeneratingVideo(false);
                            setVideoStatus(null);
                            setVideoError('Cleared stuck job. You can start a new video.');
                            setVideoProgress(null);
                          }}
                          className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors ${isDarkMode
                            ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30'
                            : 'bg-red-50 text-red-600 hover:bg-red-100'
                            }`}
                          title="Clear stuck job and allow new generation"
                        >
                          Clear Stuck Job
                        </button>
                      )}
                      {videoType !== 'live' && videoType !== 'edit' && (
                        <button
                          type="button"
                          onClick={videoType === 'slideshow' ? async () => {
                            if (slideshowAssets.length === 0) return;
                            setIsGeneratingVideo(true);
                            setVideoError(null);
                            setVideoStatus('Assembling slideshow...');
                            try {
                              const result = await createSlideshowVideoWithCreatomate({
                                elements: slideshowAssets.sort((a, b) => a.order - b.order).map(s => ({
                                  url: s.url,
                                  type: s.type,
                                  duration: s.duration,
                                })),
                                width: 1920,
                                height: 1080,
                                transition: 'fade',
                                projectId: project.id,
                              });
                              // Open the generated video in the preview modal
                              setSelectedVideo({
                                id: 'slideshow-' + Date.now(),
                                title: 'Slideshow Video',
                                type: 'video',
                                url: result.url,
                                researchTopic: project.name || 'Slideshow',
                                researchId: project.id,
                                timestamp: Date.now(),
                              });
                              setVideoStatus(null);
                              setSlideshowAssets([]);
                            } catch (err) {
                              setVideoError(err instanceof Error ? err.message : 'Failed to create slideshow');
                              setVideoStatus(null);
                            } finally {
                              setIsGeneratingVideo(false);
                            }
                          } : handleGenerateVideo}
                          disabled={isGeneratingVideo || (videoType === 'slideshow' ? slideshowAssets.length === 0 : !videoPrompt.trim())}
                          className={`px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 ${isGeneratingVideo
                            ? 'bg-gray-500/60 text-white cursor-wait'
                            : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                            }`}
                        >
                          {isGeneratingVideo && (
                            <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <circle cx="12" cy="12" r="10" className="opacity-25" />
                              <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                            </svg>
                          )}
                          <span>{isGeneratingVideo ? 'Generating' : 'Generate'}</span>
                        </button>
                      )}
                    </div>
                  </div>
                  {videoStatus && (
                    <div className="mt-3 w-full">
                      <div className="flex items-center justify-between mb-1">
                        <p className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          {videoStatus}
                        </p>
                        {typeof videoProgress === 'number' && (
                          <span className={`text-[10px] font-medium ${isDarkMode ? 'text-white/60' : 'text-gray-500'}`}>
                            {Math.round(videoProgress)}%
                          </span>
                        )}
                      </div>
                      {typeof videoProgress === 'number' && (
                        <div className={`h-1.5 w-full rounded-full overflow-hidden ${isDarkMode ? 'bg-[#3d3d3f]' : 'bg-gray-200'}`}>
                          <div
                            className="h-full bg-[#0071e3] transition-all duration-300 ease-out rounded-full"
                            style={{ width: `${Math.min(100, Math.max(0, videoProgress))}%` }}
                          />
                        </div>
                      )}
                    </div>
                  )}
                  {videoError && (
                    <p className="mt-1 text-xs text-red-400">{videoError}</p>
                  )}
                  {videoUrl && (
                    <div className="mt-3 space-y-2">
                      <video
                        src={videoUrl}
                        controls
                        className="w-full md:max-w-2xl mx-auto block rounded-xl border border-black/20 bg-black"
                      />
                      <div className="flex flex-wrap items-center gap-2 text-xs">
                        <a
                          href={videoUrl}
                          download="generated-video.mp4"
                          className="px-2.5 py-1 rounded-full border border-gray-300 bg-white text-gray-800 hover:bg-gray-50 transition-colors"
                        >
                          Download MP4
                        </a>
                        <button
                          type="button"
                          onClick={handleSaveGeneratedVideo}
                          className="px-2.5 py-1 rounded-full border border-[#0071e3]/40 bg-[#0071e3]/10 text-[#0071e3] hover:bg-[#0071e3]/15 transition-colors"
                        >
                          Save to Project
                        </button>
                        {onShareToX && (
                          <button
                            type="button"
                            onClick={() => {
                              onShareToX({
                                id: `temp-video-${Date.now()}`,
                                type: 'video',
                                url: videoUrl,
                                title: `Generated Video - ${project.name}`,
                                description: videoPrompt,
                                researchTopic: project.name,
                                timestamp: Date.now(),
                              } as AssetItem);
                            }}
                            className="px-2.5 py-1 rounded-full bg-[#0071e3] text-white hover:bg-[#0077ed] transition-colors"
                          >
                            Share to Social
                          </button>
                        )}
                        {videoSaveMessage && (
                          <span className={`text-[11px] ${videoSaveMessage.startsWith('Saved') ? 'text-green-400' : 'text-red-400'}`}>
                            {videoSaveMessage}
                          </span>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div >
          )
        }

        {/* Leads Tab */}
        {
          filterType === 'forms' && (
            <div className="mt-4 space-y-6">
              {/* Lead Form Generator */}
              <div className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <h3 className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Create Lead Form</h3>
                <p className={`text-xs mb-3 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                  Generate a beautiful lead capture form website. Forms are instantly published with a unique shareable link.
                </p>

                {/* Form Title */}
                <div className="mb-3">
                  <label className={`block text-xs font-medium mb-1 ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>Form Title</label>
                  <input
                    type="text"
                    value={leadFormTitle}
                    onChange={e => setLeadFormTitle(e.target.value)}
                    placeholder="e.g., Contact Us, Get a Quote, Newsletter Signup"
                    className={`w-full text-sm rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                  />
                </div>

                {/* Design Prompt */}
                <div className="mb-3">
                  <label className={`block text-xs font-medium mb-1 ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>Design Prompt</label>
                  <textarea
                    value={leadFormPrompt}
                    onChange={e => setLeadFormPrompt(e.target.value)}
                    rows={2}
                    className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                    placeholder="Describe the style (e.g., Modern SaaS landing page with blue gradient, Minimalist B2B form with trust badges)"
                  />
                  {/* Suggestion buttons */}
                  <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                    {[
                      { label: 'Contact form', value: 'Create a contact form based on the project' },
                      { label: 'Newsletter signup', value: 'Create a newsletter signup based on the project' },
                      { label: 'Booking form', value: 'Create a booking form based on the project' },
                      { label: 'Feedback survey', value: 'Create a feedback survey based on the project' },
                      { label: 'Registration form', value: 'Create a registration form based on the project' },
                    ].map((suggestion) => (
                      <button
                        key={suggestion.value}
                        type="button"
                        onClick={() => setLeadFormPrompt(suggestion.value)}
                        className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                          : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                          }`}
                      >
                        {suggestion.label}
                      </button>
                    ))}
                  </div>

                  {/* Profile Logo Option */}
                  {userProfile?.photoURL && (
                    <div className="mt-2 flex items-center">
                      <label className="flex items-center gap-2 cursor-pointer group">
                        <div className="relative flex items-center">
                          <input
                            type="checkbox"
                            checked={leadFormUseProfileLogo}
                            onChange={(e) => setLeadFormUseProfileLogo(e.target.checked)}
                            className="peer h-4 w-4 rounded border-gray-300 text-[#0071e3] focus:ring-[#0071e3] transition-all"
                          />
                        </div>
                        <span className={`text-xs ${isDarkMode ? 'text-gray-400 group-hover:text-white' : 'text-gray-600 group-hover:text-gray-900'} transition-colors`}>
                          Use profile logo
                        </span>
                        <img
                          src={userProfile.photoURL}
                          alt="Logo preview"
                          className="ml-1 w-5 h-5 rounded-full object-cover border border-gray-200"
                        />
                      </label>
                    </div>
                  )}
                </div>

                {/* Image Upload Option */}
                <div className="mt-3">
                  <label className={`block text-xs font-medium mb-1 ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>
                    Images (for context or placement)
                  </label>

                  <div className="flex flex-wrap gap-2 items-center">
                    <label className={`cursor-pointer inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${isDarkMode
                      ? 'bg-[#111111] border-[#3d3d3f]/60 text-gray-300 hover:text-white hover:border-[#636366]'
                      : 'bg-white border-gray-300 text-gray-600 hover:text-gray-900 hover:border-gray-400'
                      }`}>
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      Add Images
                      <input
                        type="file"
                        multiple
                        accept="image/*"
                        className="hidden"
                        onChange={(e) => {
                          if (e.target.files && e.target.files.length > 0) {
                            setLeadFormImages(prev => [...prev, ...Array.from(e.target.files || [])]);
                          }
                        }}
                      />
                    </label>

                    <button
                      type="button"
                      onClick={() => {
                        setSelectedFormAssetIds([]);
                        setIsFormAssetPickerOpen(true);
                      }}
                      className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${isDarkMode
                        ? 'bg-[#111111] border-[#3d3d3f]/60 text-gray-300 hover:text-white hover:border-[#636366]'
                        : 'bg-white border-gray-300 text-gray-600 hover:text-gray-900 hover:border-gray-400'
                        }`}
                    >
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14M4 6h16" />
                      </svg>
                      Select from assets
                    </button>

                    {leadFormImages.map((file, idx) => (
                      <div key={idx} className="relative group">
                        <div className={`flex items-center gap-1 pl-1 pr-2 py-1 rounded-lg text-xs border ${isDarkMode ? 'bg-[#1d1d1f] border-[#3d3d3f] text-gray-300' : 'bg-gray-50 border-gray-200 text-gray-700'
                          }`}>
                          <span className="truncate max-w-[80px]">{file.name}</span>
                          <button
                            type="button"
                            onClick={() => setLeadFormImages(prev => prev.filter((_, i) => i !== idx))}
                            className="ml-1 p-0.5 rounded-full hover:bg-black/10 dark:hover:bg-white/10 text-gray-400 hover:text-red-500"
                          >
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                  <p className={`text-[10px] mt-1 ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                    Gemini will analyze these images (products, backgrounds, etc.) and place them intelligently in the form.
                  </p>
                </div>

                {/* Form Fields Builder */}
                <div className="mb-4">
                  <div className="flex items-center justify-between mb-2">
                    <label className={`text-xs font-medium ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>Form Fields</label>
                    <div className="flex items-center gap-1">
                      {(['text', 'phone', 'textarea', 'select', 'checkbox'] as const).map(type => (
                        <button
                          key={type}
                          type="button"
                          onClick={() => handleAddLeadFormField(type)}
                          className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                            ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:text-white'
                            : 'border-gray-300 text-gray-600 hover:border-gray-400 hover:text-gray-900'
                            }`}
                        >
                          + {type.charAt(0).toUpperCase() + type.slice(1)}
                        </button>
                      ))}
                    </div>
                  </div>
                  <div className="space-y-2" ref={leadFieldsContainerRef}>
                    {leadFormFields.map((field, idx) => (
                      <div
                        key={field.id}
                        draggable={true}
                        onDragStart={() => handleFieldDragStart(idx)}
                        onDragOver={(e) => handleFieldDragOver(e, idx)}
                        onDragEnd={handleFieldDragEnd}
                        data-field-index={idx}
                        className={`flex items-center gap-2 p-2 rounded-xl transition-all ${draggedFieldIndex === idx
                          ? (isDarkMode ? 'bg-[#1d1d1f] border-dashed border-[#0071e3] opacity-50' : 'bg-gray-100 border-dashed border-blue-400 opacity-50')
                          : (isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/40' : 'bg-gray-50 border border-gray-200')
                          }`}
                      >
                        <div
                          className={`cursor-move p-1 rounded touch-none ${isDarkMode ? 'text-[#636366] hover:bg-white/10' : 'text-gray-400 hover:bg-gray-200'}`}
                          onTouchStart={(e) => { e.stopPropagation(); setDraggedFieldIndex(idx); }}
                          onTouchMove={handleFieldTouchMove}
                          onTouchEnd={handleFieldDragEnd}
                          title="Drag to reorder"
                        >
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" />
                          </svg>
                        </div>
                        <input
                          type="text"
                          value={field.label}
                          onChange={e => handleUpdateLeadFormField(field.id, { label: e.target.value, name: e.target.value.toLowerCase().replace(/\s+/g, '_') })}
                          placeholder="Field label"
                          className={`flex-1 text-xs rounded-lg px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white' : 'bg-white border border-gray-300 text-gray-900'}`}
                        />
                        <select
                          value={field.type}
                          onChange={e => handleUpdateLeadFormField(field.id, { type: e.target.value as any })}
                          className={`text-[10px] rounded-lg px-2 py-1.5 focus:outline-none ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white' : 'bg-white border border-gray-300 text-gray-900'}`}
                        >
                          <option value="text">Text</option>
                          <option value="email">Email</option>
                          <option value="phone">Phone</option>
                          <option value="textarea">Textarea</option>
                          <option value="select">Select</option>
                          <option value="checkbox">Checkbox</option>
                        </select>
                        <label className={`flex items-center gap-1 text-[10px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          <input
                            type="checkbox"
                            checked={field.required}
                            onChange={e => handleUpdateLeadFormField(field.id, { required: e.target.checked })}
                            className="w-3 h-3"
                          />
                          Req
                        </label>
                        <button
                          type="button"
                          onClick={() => handleRemoveLeadFormField(field.id)}
                          disabled={['name', 'email'].includes(field.id)}
                          className={`p-1 rounded-full transition-colors ${['name', 'email'].includes(field.id)
                            ? 'opacity-30 cursor-not-allowed'
                            : isDarkMode
                              ? 'text-[#86868b] hover:text-red-400 hover:bg-red-500/10'
                              : 'text-gray-400 hover:text-red-500 hover:bg-red-50'
                            }`}
                          title={['name', 'email'].includes(field.id) ? 'Required field' : 'Remove field'}
                        >
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Generate Button */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2 text-xs">
                    {leadFormError && <span className="text-red-400">{leadFormError}</span>}
                    {leadFormSaveMessage && <span className="text-green-400">{leadFormSaveMessage}</span>}
                  </div>
                  <button
                    type="button"
                    onClick={handleGenerateLeadForm}
                    disabled={isGeneratingLeadForm || !leadFormPrompt.trim() || !leadFormTitle.trim()}
                    className={`px-4 py-2 rounded-full text-xs font-medium flex items-center gap-2 ${isGeneratingLeadForm
                      ? 'bg-gray-500/60 text-white cursor-wait'
                      : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                      }`}
                  >
                    {isGeneratingLeadForm && (
                      <svg className="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10" className="opacity-25" />
                        <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                      </svg>
                    )}
                    <span>{isGeneratingLeadForm ? 'Generating...' : 'Generate Lead Form'}</span>
                  </button>
                </div>

                {/* Streaming Preview */}
                {(leadFormStreamingCode || generatedLeadFormHtml) && (
                  <div className="mt-4">
                    <h4 className={`text-xs font-medium mb-2 ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>Preview</h4>
                    <div className={`w-full h-96 rounded-xl overflow-hidden border ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                      <iframe
                        srcDoc={generatedLeadFormHtml || leadFormStreamingCode}
                        className="w-full h-full bg-white"
                        title="Lead Form Preview"
                        sandbox="allow-scripts"
                      />
                    </div>
                  </div>
                )}
              </div>

              {/* Created Forms */}
              {localLeadForms.length > 0 && (
                <div className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                  <h3 className={`text-sm font-semibold mb-3 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Your Lead Forms</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    {localLeadForms.map(form => (
                      <div
                        key={form.id}
                        onClick={() => setSelectedForm({
                          id: form.id,
                          type: 'leadform',
                          title: form.title,
                          data: form,
                          researchId: 'lead-forms',
                          researchTopic: 'Lead Forms',
                          timestamp: form.createdAt
                        })}
                        className={`p-3 rounded-xl border cursor-pointer transition-all hover:shadow-lg ${isDarkMode ? 'border-[#3d3d3f]/60 bg-[#111111] hover:border-[#0071e3]/50' : 'border-gray-200 bg-gray-50 hover:border-blue-300'}`}
                      >
                        <h4 className={`text-sm font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{form.title}</h4>
                        <p className={`text-[10px] mt-1 truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          {form.fields.length} fields  {form.leadCount || 0} leads
                        </p>
                        <div className="mt-3 flex flex-wrap items-center gap-2">
                          <button
                            type="button"
                            onClick={(e) => {
                              e.stopPropagation();
                              loadCapturedLeads(form.id);
                              const el = document.getElementById('captured-leads-section');
                              if (el) el.scrollIntoView({ behavior: 'smooth' });
                            }}
                            className={`px-2 py-1 rounded-full text-[10px] font-medium border transition-colors ${isDarkMode
                              ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366]'
                              : 'border-gray-200 text-gray-600 hover:text-gray-900 hover:border-gray-300'
                              }`}
                          >
                            View Leads
                          </button>
                          <button
                            type="button"
                            onClick={(e) => {
                              e.stopPropagation();
                              handleOpenCustomDomainModal({
                                id: form.id,
                                type: 'leadform',
                                title: form.title,
                                data: form,
                                researchId: 'lead-forms',
                                researchTopic: 'Lead Forms',
                                timestamp: form.createdAt
                              } as AssetItem);
                            }}
                            className={`px-2 py-1 rounded-full text-[10px] font-medium border transition-colors ${isDarkMode
                              ? 'border-purple-500/50 text-purple-400 hover:bg-purple-500/10'
                              : 'border-purple-200 text-purple-600 hover:bg-purple-50'
                              }`}
                          >
                            Custom Domain
                          </button>
                          <button
                            type="button"
                            onClick={async (e) => {
                              e.stopPropagation();
                              if (navigator.clipboard) {
                                await navigator.clipboard.writeText(form.publicUrl);
                                setLeadFormSaveMessage('Link copied!');
                                setTimeout(() => setLeadFormSaveMessage(null), 2000);
                              }
                            }}
                            className={`px-2 py-1 rounded-full text-[10px] font-medium ${isDarkMode
                              ? 'bg-[#0071e3]/20 text-[#0071e3] hover:bg-[#0071e3]/30'
                              : 'bg-blue-50 text-blue-600 hover:bg-blue-100'
                              }`}
                          >
                            Copy Link
                          </button>
                          <a
                            href={form.publicUrl}
                            onClick={(e) => e.stopPropagation()}
                            target="_blank"
                            rel="noopener noreferrer"
                            className={`px-2 py-1 rounded-full text-[10px] font-medium ${isDarkMode
                              ? 'bg-white/10 text-white/80 hover:bg-white/15'
                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                              }`}
                          >
                            Visit
                          </a>
                          <button
                            type="button"
                            onClick={(e) => {
                              e.stopPropagation();
                              handleDeleteLeadForm(form.id);
                            }}
                            className={`px-2 py-1 rounded-full text-[10px] font-medium ${isDarkMode
                              ? 'bg-red-500/10 text-red-400 hover:bg-red-500/20'
                              : 'bg-red-50 text-red-600 hover:bg-red-100'
                              }`}
                            title="Delete Form"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Captured Leads */}
              <div id="captured-leads-section" className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-2">
                    <h3 className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      Captured Leads
                      {selectedLeadFormId && (() => {
                        const form = localLeadForms.find(f => f.id === selectedLeadFormId);
                        return form ? <span className={`font-normal ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>  {form.title}</span> : null;
                      })()}
                    </h3>
                    {selectedLeadFormId && (
                      <button
                        type="button"
                        onClick={() => loadCapturedLeads()}
                        className={`text-[9px] px-1.5 py-0.5 rounded ${isDarkMode ? 'text-[#86868b] hover:text-white' : 'text-gray-500 hover:text-gray-700'}`}
                      >
                        Show All
                      </button>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      onClick={() => loadCapturedLeads(selectedLeadFormId || undefined)}
                      disabled={loadingLeads}
                      className={`px-2 py-1 rounded-full text-[10px] border ${isDarkMode
                        ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                        : 'border-gray-300 text-gray-600 hover:border-gray-400'
                        }`}
                    >
                      {loadingLeads ? 'Loading...' : 'Refresh'}
                    </button>
                    {capturedLeads.length > 0 && (
                      <button
                        type="button"
                        onClick={handleExportLeads}
                        className={`px-2 py-1 rounded-full text-[10px] font-medium ${isDarkMode
                          ? 'bg-green-500/20 text-green-400 hover:bg-green-500/30'
                          : 'bg-green-50 text-green-600 hover:bg-green-100'
                          }`}
                      >
                        Export CSV
                      </button>
                    )}
                    {capturedLeads.length > 0 && (
                      <button
                        type="button"
                        onClick={handleEmailAllLeads}
                        className={`px-2 py-1 rounded-sm text-[10px] font-medium ${isDarkMode
                          ? 'bg-[#0071e3]/20 text-[#0071e3] hover:bg-[#0071e3]/30'
                          : 'bg-blue-50 text-blue-600 hover:bg-blue-100'
                          }`}
                      >
                        Email All Leads
                      </button>
                    )}
                  </div>
                </div>

                {leadsError && (
                  <p className="text-xs text-red-400 mb-3">{leadsError}</p>
                )}

                {loadingLeads ? (
                  <div className="flex items-center justify-center py-8">
                    <svg className="w-6 h-6 animate-spin text-[#0071e3]" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10" className="opacity-25" />
                      <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                    </svg>
                  </div>
                ) : capturedLeads.length === 0 ? (
                  <div className={`text-center py-8 ${isDarkMode ? 'text-[#636366]' : 'text-gray-400'}`}>
                    <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <p className="text-sm">No leads captured yet</p>
                    <p className="text-xs mt-1">Create a lead form and share it to start collecting leads</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {capturedLeads.map(lead => {
                      const isExpanded = expandedLeadId === lead.id;
                      return (
                        <div
                          key={lead.id}
                          className={`rounded-xl border overflow-hidden ${isDarkMode ? 'border-[#3d3d3f]/60 bg-[#111111]' : 'border-gray-200 bg-gray-50'}`}
                        >
                          <div
                            className={`flex items-center justify-between p-3 cursor-pointer ${isDarkMode ? 'hover:bg-white/5' : 'hover:bg-gray-100'}`}
                            onClick={() => setExpandedLeadId(isExpanded ? null : lead.id)}
                          >
                            <div className="flex items-center gap-3 min-w-0">
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium ${isDarkMode ? 'bg-[#0071e3]/20 text-[#0071e3]' : 'bg-blue-100 text-blue-600'}`}>
                                {(lead.data.name || lead.data.email || '?').charAt(0).toUpperCase()}
                              </div>
                              <div className="min-w-0">
                                <p className={`text-sm font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                  {(() => {
                                    const data = lead.data || {};
                                    // Try to find a field that looks like a name
                                    const nameField = Object.keys(data).find(k => k.toLowerCase().includes('name')) ||
                                      Object.keys(data).find(k => k.toLowerCase().includes('first')) ||
                                      'name';
                                    // Try to find a field that looks like an email/contact
                                    const contactField = Object.keys(data).find(k => k.toLowerCase().includes('email')) || 'email';

                                    return data[nameField] || data[contactField] || Object.values(data)[0] || 'Unknown';
                                  })()}
                                </p>
                                <p className={`text-[10px] truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                                  {lead.formTitle}  {new Date(lead.submittedAt).toLocaleDateString()}
                                </p>
                              </div>
                            </div>
                            <div className="flex items-center gap-2">
                              {/* Email button - only show if lead has email */}
                              {/* Email button - only show if lead has email */}
                              {(() => {
                                const data = lead.data || {};
                                const hasEmail = data.email || data.Email || Object.keys(data).some(k => k.toLowerCase().includes('email') && data[k]);

                                if (!hasEmail) return null;

                                return (
                                  <button
                                    type="button"
                                    onClick={e => {
                                      e.stopPropagation();
                                      handleEmailLead(lead);
                                    }}
                                    className={`p-1.5 rounded-full transition-colors ${sentEmailLeads.has(lead.id)
                                      ? 'text-[#0071e3] bg-[#0071e3]/10'
                                      : isDarkMode
                                        ? 'text-[#86868b] hover:text-[#0071e3] hover:bg-[#0071e3]/10'
                                        : 'text-gray-400 hover:text-blue-500 hover:bg-blue-50'
                                      }`}
                                    title={sentEmailLeads.has(lead.id) ? "Email sent" : "Send email to this lead"}
                                  >
                                    {sentEmailLeads.has(lead.id) ? (
                                      <svg className="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z" />
                                        <path d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z" />
                                      </svg>
                                    ) : (
                                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                      </svg>
                                    )}
                                  </button>
                                );
                              })()}
                              <button
                                type="button"
                                onClick={e => {
                                  e.stopPropagation();
                                  handleDeleteLead(lead.id);
                                }}
                                disabled={deletingLeadId === lead.id}
                                className={`p-1.5 rounded-full transition-colors ${deletingLeadId === lead.id
                                  ? 'opacity-50 cursor-wait'
                                  : isDarkMode
                                    ? 'text-[#86868b] hover:text-red-400 hover:bg-red-500/10'
                                    : 'text-gray-400 hover:text-red-500 hover:bg-red-50'
                                  }`}
                              >
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                              <svg className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''} ${isDarkMode ? 'text-[#636366]' : 'text-gray-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                              </svg>
                            </div>
                          </div>
                          {isExpanded && (
                            <div className={`px-3 pb-3 pt-1 border-t ${isDarkMode ? 'border-[#3d3d3f]/40' : 'border-gray-200'}`}>
                              <div className="grid grid-cols-2 gap-2 text-xs">
                                {Object.entries(lead.data).map(([key, value]) => (
                                  <div key={key}>
                                    <span className={`font-medium ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>{key}:</span>
                                    <span className={`ml-1 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{value}</span>
                                  </div>
                                ))}
                              </div>
                              <p className={`text-[10px] mt-2 ${isDarkMode ? 'text-[#636366]' : 'text-gray-400'}`}>
                                Submitted: {new Date(lead.submittedAt).toLocaleString()}
                              </p>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
          )
        }

        {
          isAnnotatingReference && (
            <div
              className="fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"
              onClick={() => setIsAnnotatingReference(false)}
            >
              <div
                className={`w-full max-w-4xl rounded-2xl border shadow-xl overflow-hidden ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}
                onClick={e => e.stopPropagation()}
              >
                <div className={`p-4 border-b ${isDarkMode ? 'border-[#3d3d3f]/70' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <div className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Annotate reference image</div>
                      <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Draw over the image to guide visual edits before generating.</div>
                    </div>
                    <button
                      type="button"
                      onClick={() => setIsAnnotatingReference(false)}
                      className={`px-3 py-1.5 rounded-full text-xs border ${isDarkMode ? 'border-[#3d3d3f] text-white/80 hover:bg-white/10' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}`}
                    >
                      Close
                    </button>
                  </div>
                </div>

                <div className="p-4 space-y-3">
                  <div className="flex flex-wrap items-center gap-3">
                    <label className={`text-xs flex items-center gap-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                      <span>Color</span>
                      <input
                        type="color"
                        value={referenceAnnotateBrushColor}
                        onChange={(e) => setReferenceAnnotateBrushColor(e.target.value)}
                        disabled={referenceAnnotateTool === 'eraser'}
                        className="h-7 w-10 p-0 border-0 bg-transparent"
                      />
                    </label>

                    <label className={`text-xs flex items-center gap-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                      <span>Size</span>
                      <input
                        type="range"
                        min={2}
                        max={120}
                        value={referenceAnnotateBrushSize}
                        onChange={(e) => setReferenceAnnotateBrushSize(Number(e.target.value))}
                      />
                      <span className={`${isDarkMode ? 'text-white/80' : 'text-gray-800'} text-[11px] w-6 text-right`}>{referenceAnnotateBrushSize}</span>
                    </label>

                    <button
                      type="button"
                      onClick={() => setReferenceAnnotateTool('brush')}
                      className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${referenceAnnotateTool === 'brush'
                        ? 'bg-[#0071e3] text-white'
                        : isDarkMode
                          ? 'text-[#86868b] hover:text-white border border-[#3d3d3f]'
                          : 'text-gray-700 hover:text-gray-900 border border-gray-300'}`}
                    >
                      Brush
                    </button>
                    <button
                      type="button"
                      onClick={() => setReferenceAnnotateTool('eraser')}
                      className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${referenceAnnotateTool === 'eraser'
                        ? 'bg-[#0071e3] text-white'
                        : isDarkMode
                          ? 'text-[#86868b] hover:text-white border border-[#3d3d3f]'
                          : 'text-gray-700 hover:text-gray-900 border border-gray-300'}`}
                    >
                      Eraser
                    </button>

                    <button
                      type="button"
                      onClick={() => setReferenceAnnotateTool('text')}
                      className={`px-2 py-1 rounded-full text-[11px] font-medium transition-colors ${referenceAnnotateTool === 'text'
                        ? 'bg-[#0071e3] text-white'
                        : isDarkMode
                          ? 'text-[#86868b] hover:text-white border border-[#3d3d3f]'
                          : 'text-gray-700 hover:text-gray-900 border border-gray-300'}`}
                    >
                      Text
                    </button>

                    {referenceAnnotateTool === 'text' && (
                      <input
                        value={referenceAnnotateText}
                        onChange={(e) => setReferenceAnnotateText(e.target.value)}
                        placeholder="Type text then click to place"
                        className={`flex-1 min-w-[220px] rounded-xl px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                      />
                    )}

                    <button
                      type="button"
                      onClick={() => handleAnnotateUndo().catch(() => { })}
                      disabled={annotateHistory.index <= 0}
                      className={`px-2 py-1 rounded-full text-[11px] font-medium border transition-colors ${annotateHistory.index <= 0
                        ? isDarkMode
                          ? 'border-[#3d3d3f]/60 text-[#636366] cursor-not-allowed'
                          : 'border-gray-200 text-gray-400 cursor-not-allowed'
                        : isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:text-white'
                          : 'border-gray-300 text-gray-700 hover:border-gray-500'}`}
                    >
                      Undo
                    </button>

                    <button
                      type="button"
                      onClick={() => handleAnnotateRedo().catch(() => { })}
                      disabled={annotateHistory.index < 0 || annotateHistory.index >= annotateHistory.stack.length - 1}
                      className={`px-2 py-1 rounded-full text-[11px] font-medium border transition-colors ${annotateHistory.index < 0 || annotateHistory.index >= annotateHistory.stack.length - 1
                        ? isDarkMode
                          ? 'border-[#3d3d3f]/60 text-[#636366] cursor-not-allowed'
                          : 'border-gray-200 text-gray-400 cursor-not-allowed'
                        : isDarkMode
                          ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:text-white'
                          : 'border-gray-300 text-gray-700 hover:border-gray-500'}`}
                    >
                      Redo
                    </button>

                    <button
                      type="button"
                      onClick={() => {
                        const canvas = annotateCanvasRef.current;
                        if (!canvas) return;
                        const ctx = canvas.getContext('2d');
                        if (!ctx) return;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        const file = imageReferenceFiles.length === 1 ? imageReferenceFiles[0] : null;
                        if (file) {
                          initAnnotateCanvasFromFile(file).catch(() => { });
                        }
                      }}
                      className={`px-2 py-1 rounded-full text-[11px] font-medium border transition-colors ${isDarkMode ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]' : 'border-gray-300 text-gray-700 hover:border-gray-500'}`}
                    >
                      Reset
                    </button>

                    <div className="ml-auto flex items-center gap-2">
                      <button
                        type="button"
                        onClick={async () => {
                          try {
                            const canvas = annotateCanvasRef.current;
                            if (!canvas) return;
                            const blob: Blob = await new Promise((resolve, reject) => {
                              canvas.toBlob((b) => (b ? resolve(b) : reject(new Error('Failed to export annotation'))), 'image/png');
                            });
                            const baseName = imageReferenceFiles[0]?.name?.replace(/\.[^.]+$/, '') || 'reference-annotated';
                            const next = new File([blob], `${baseName}-annotated.png`, { type: 'image/png' });
                            setImageReferenceFiles([next]);
                            setIsAnnotatingReference(false);
                          } catch (e: any) {
                            setReferenceAnnotateError(e?.message || 'Failed to save annotation');
                          }
                        }}
                        className="px-3 py-1.5 rounded-full text-xs font-medium bg-[#0071e3] hover:bg-[#0077ed] text-white"
                      >
                        Save annotation
                      </button>
                    </div>
                  </div>

                  {referenceAnnotateError && (
                    <p className="text-xs text-red-400">{referenceAnnotateError}</p>
                  )}

                  <div className={`rounded-2xl border overflow-hidden ${isDarkMode ? 'border-[#3d3d3f]/70 bg-black/20' : 'border-gray-200 bg-gray-50'}`}>
                    <div className="w-full overflow-auto">
                      <canvas
                        ref={annotateCanvasRef}
                        onPointerDown={handleAnnotatePointerDown}
                        onPointerMove={handleAnnotatePointerMove}
                        onPointerUp={handleAnnotatePointerUp}
                        onPointerCancel={handleAnnotatePointerUp}
                        className="block max-w-full"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )
        }

        {
          isVideoAssetPickerOpen && (
            <div
              className="fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"
              onClick={() => {
                if (isLoadingVideoAsset) return;
                setIsVideoAssetPickerOpen(false);
              }}
            >
              <div
                className={`w-full max-w-3xl rounded-2xl border shadow-xl overflow-hidden ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}
                onClick={e => e.stopPropagation()}
              >
                <div className={`p-4 border-b ${isDarkMode ? 'border-[#3d3d3f]/70' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <div className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Choose image reference</div>
                      <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Select an existing image asset to use as the reference frame.</div>
                    </div>
                    <button
                      type="button"
                      onClick={() => setIsVideoAssetPickerOpen(false)}
                      disabled={isLoadingVideoAsset}
                      className={`px-3 py-1.5 rounded-full text-xs border ${isDarkMode ? 'border-[#3d3d3f] text-white/80 hover:bg-white/10' : 'border-gray-300 text-gray-700 hover:bg-gray-50'} ${isLoadingVideoAsset ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                      Close
                    </button>
                  </div>
                  <div className="mt-3 flex items-center gap-2">
                    <input
                      value={videoAssetSearch}
                      onChange={e => setVideoAssetSearch(e.target.value)}
                      placeholder="Search your images"
                      className={`flex-1 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                    />
                    {isLoadingVideoAsset && (
                      <span className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Loading</span>
                    )}
                  </div>
                </div>

                <div className="p-4 max-h-[60vh] overflow-y-auto">
                  {videoReferenceAssetCandidates.length === 0 ? (
                    <div className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>No image assets found.</div>
                  ) : (
                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                      {videoReferenceAssetCandidates.map(entry => (
                        <button
                          key={entry.key}
                          type="button"
                          disabled={isLoadingVideoAsset}
                          onClick={async () => {
                            try {
                              setIsLoadingVideoAsset(true);
                              const file = 'file' in entry
                                ? await fetchAssetAsFile(entry.file)
                                : await fetchUrlAsFile(entry.url, entry.label);
                              setVideoImageFile(file);
                              setIsVideoAssetPickerOpen(false);
                            } catch (err: any) {
                              console.error('Failed to load asset as file', err);
                              setVideoError(err?.message || 'Failed to load selected image');
                            } finally {
                              setIsLoadingVideoAsset(false);
                            }
                          }}
                          className={`group rounded-xl overflow-hidden border text-left ${isDarkMode ? 'border-[#3d3d3f]/70 hover:border-[#636366]' : 'border-gray-200 hover:border-gray-300'} ${isLoadingVideoAsset ? 'opacity-60 cursor-not-allowed' : ''}`}
                          title={entry.label}
                        >
                          <div className={`w-full aspect-square ${isDarkMode ? 'bg-black/40' : 'bg-gray-100'}`}>
                            <img src={entry.url} alt={entry.label} className="w-full h-full object-cover" />
                          </div>
                          <div className={`p-2 text-[11px] truncate ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>{entry.label}</div>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )
        }

        {
          filterType === 'docs' && (
            <div className="mt-4">
              <div className={`rounded-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <div className={`p-4 sm:p-5 border-b ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                  <div className="flex flex-col gap-2">
                    <div className="flex flex-col sm:flex-row sm:items-center gap-2">
                      <div className="flex items-center gap-2 flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          {googleDocsSelected?.documentId.includes('blog') ? (
                            <svg className="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                            </svg>
                          ) : (
                            <img
                              src="https://I8OXklu4Tq3i4aWc.public.blob.vercel-storage.com/Docs_2020.webp"
                              alt="Docs"
                              className="w-5 h-5 object-contain"
                            />
                          )}
                          <h3 className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                            {googleDocsSelected?.documentId.includes('blog') ? 'Edit Blog' : 'Docs'}
                          </h3>
                        </div>
                        {googleDocsSelected && (
                          <span className={`text-xs truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>{googleDocsSelected.title}</span>
                        )}
                        {/* Dynamic sync status indicator */}
                        {googleDocsSelected && !googleDocsSelected.documentId.includes('blog') && (
                          <>
                            {googleDocsSyncStatus === 'syncing' || googleDocsAutoSaving ? (
                              <span className={`flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full ${isDarkMode ? 'bg-[#0071e3]/20 text-[#0a84ff]' : 'bg-blue-100 text-blue-700'}`}>
                                <svg className="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <circle cx="12" cy="12" r="10" strokeWidth="2" className="opacity-25" />
                                  <path strokeWidth="2" d="M4 12a8 8 0 018-8" className="opacity-75" />
                                </svg>
                                Syncing...
                              </span>
                            ) : googleDocsSyncStatus === 'error' ? (
                              <span className={`text-[10px] px-2 py-0.5 rounded-full ${isDarkMode ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-700'}`}>
                                Sync error
                              </span>
                            ) : googleDocsIsDirty ? (
                              <span className={`text-[10px] px-2 py-0.5 rounded-full ${isDarkMode ? 'bg-[#ff9f0a]/20 text-[#ff9f0a]' : 'bg-amber-100 text-amber-800'}`}>
                                Editing...
                              </span>
                            ) : googleDocsLastSavedAt ? (
                              <span className={`flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full ${isDarkMode ? 'bg-[#34c759]/20 text-[#34c759]' : 'bg-green-100 text-green-700'}`}>
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Synced
                              </span>
                            ) : null}
                          </>
                        )}
                        {/* Blog-specific status (not auto-synced) */}
                        {googleDocsSelected?.documentId.includes('blog') && (
                          <>
                            {googleDocsIsDirty && (
                              <span className={`text-[10px] px-2 py-0.5 rounded-full ${isDarkMode ? 'bg-[#ff9f0a]/20 text-[#ff9f0a]' : 'bg-amber-100 text-amber-800'}`}>
                                Unsaved
                              </span>
                            )}
                            {googleDocsLastSavedAt && !googleDocsIsDirty && (
                              <span className={`text-[10px] ${isDarkMode ? 'text-[#636366]' : 'text-gray-500'}`}>
                                Saved {formatDate(googleDocsLastSavedAt)}
                              </span>
                            )}
                          </>
                        )}
                      </div>

                      <div className="flex items-center gap-2 flex-shrink-0">
                        {!googleDriveConnected ? (
                          <button
                            type="button"
                            onClick={handleConnectGoogle}
                            disabled={googleDriveStatusLoading}
                            className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                          >
                            {googleDriveStatusLoading ? 'Checking' : (
                              <div className="flex items-center gap-2">
                                <img src={PLATFORM_LOGOS.googledrive} alt="" className="w-4 h-4 object-contain" />
                                <span>Connect Google</span>
                              </div>
                            )}
                          </button>
                        ) : (
                          <>
                            <button
                              type="button"
                              onClick={() => {
                                const next = !googleDocsPickerOpen;
                                setGoogleDocsPickerOpen(next);
                                if (next && googleDocsFiles.length === 0) {
                                  loadGoogleDocsFiles({ reset: true });
                                }
                              }}
                              className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                            >
                              {googleDocsPickerOpen ? 'Hide library' : 'Browse docs'}
                            </button>
                            <button
                              type="button"
                              onClick={handleConnectGoogle}
                              className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white hover:bg-black/30' : 'bg-white border border-gray-200 text-gray-900 hover:bg-gray-50'}`}
                            >
                              <div className="flex items-center gap-2">
                                <img src={PLATFORM_LOGOS.googledrive} alt="" className="w-3.5 h-3.5 object-contain" />
                                <span>Reconnect</span>
                              </div>
                            </button>
                          </>
                        )}

                        {googleDocsSelected && (
                          <button
                            type="button"
                            onClick={handleSaveDoc}
                            disabled={googleDocsSaveLoading}
                            className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${googleDocsSaveLoading ? (isDarkMode ? 'bg-[#2d2d2f]/60 text-[#86868b]' : 'bg-gray-200 text-gray-500') : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'}`}
                            title="Save (Ctrl/Cmd+S)"
                          >
                            {googleDocsSaveLoading ? 'Saving' : 'Save'}
                          </button>
                        )}

                        {googleDocsSelected && !googleDocsSelected.documentId.includes('blog') && (
                          <a
                            href={`https://docs.google.com/document/d/${encodeURIComponent(googleDocsSelected.documentId)}/edit`}
                            target="_blank"
                            rel="noreferrer"
                            className={`${isDarkMode ? 'text-[#0a84ff]' : 'text-[#0071e3]'} text-xs hover:underline`}
                          >
                            Open
                          </a>
                        )}
                      </div>
                    </div>

                    {googleDocsMessage && (
                      <p className={`text-xs ${googleDocsMessage.toLowerCase().includes('failed') ? 'text-red-400' : isDarkMode ? 'text-[#0a84ff]' : 'text-[#0071e3]'}`}>
                        {googleDocsMessage}
                      </p>
                    )}
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-12">
                  <div className={`lg:col-span-4 border-b lg:border-b-0 lg:border-r ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                    {googleDocsPickerOpen && googleDriveConnected ? (
                      <div className="p-4 space-y-3">
                        <div className="flex items-center gap-2">
                          <input
                            value={googleDocsQuery}
                            onChange={(e) => setGoogleDocsQuery(e.target.value)}
                            placeholder="Search your Google Docs"
                            className={`flex-1 px-3 py-2 rounded-xl text-xs border focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-black/30 border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                          />
                          <button
                            type="button"
                            onClick={() => loadGoogleDocsFiles({ reset: true })}
                            disabled={googleDocsListLoading}
                            className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-white text-gray-900 hover:bg-gray-100 border border-gray-200'}`}
                          >
                            {googleDocsListLoading ? 'Loading' : 'Search'}
                          </button>
                        </div>

                        <div className="max-h-[50vh] lg:max-h-[60vh] overflow-y-auto space-y-2 pr-1">
                          {googleDocsFiles.length === 0 && !googleDocsListLoading ? (
                            <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>No docs found.</div>
                          ) : (
                            googleDocsFiles.map(file => (
                              <button
                                key={file.id}
                                type="button"
                                onClick={() => handleLoadDoc(file.id, file.name)}
                                disabled={googleDocsLoadLoading}
                                className={`w-full text-left px-3 py-2 rounded-xl border transition-colors ${googleDocsSelected?.documentId === file.id ? (isDarkMode ? 'border-[#0071e3] bg-[#0071e3]/10 text-white' : 'border-[#0071e3] bg-[#0071e3]/5 text-gray-900') : (isDarkMode ? 'border-[#3d3d3f]/60 bg-black/20 hover:bg-black/30 text-white' : 'border-gray-200 bg-white hover:bg-gray-50 text-gray-900')}`}
                              >
                                <div className="text-xs font-semibold truncate">{file.name}</div>
                                <div className={`text-[11px] mt-0.5 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>{file.id}</div>
                              </button>
                            ))
                          )}
                        </div>

                        {googleDocsNextPageToken && (
                          <div className="flex justify-center">
                            <button
                              type="button"
                              onClick={() => loadGoogleDocsFiles({ reset: false })}
                              disabled={googleDocsListLoading}
                              className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-white text-gray-900 hover:bg-gray-100 border border-gray-200'}`}
                            >
                              {googleDocsListLoading ? 'Loading' : 'Load more'}
                            </button>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="p-4">
                        <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          {googleDriveConnected ? 'Browse docs to load one into the editor.' : 'Connect Google to browse your Docs.'}
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="lg:col-span-8 p-4">
                    <div className={`rounded-2xl border overflow-hidden ${isDarkMode ? 'border-[#3d3d3f]/60 bg-[#111111]' : 'border-gray-200 bg-white'}`}>
                      <div className={`px-3 py-2 border-b flex items-center justify-between gap-2 ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                        <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          {googleDocsSelected
                            ? (googleDocsSelected.documentId.includes('blog')
                              ? 'Editing Blog Content'
                              : 'Editing plain text (formatting not preserved yet)')
                            : 'No document loaded'}
                        </div>
                        <div className="flex items-center gap-2">
                          {googleDocsSelected && (
                            <button
                              type="button"
                              onClick={() => setGoogleDocsPreviewMode(prev => !prev)}
                              disabled={googleDocsLoadLoading}
                              className={`px-2.5 py-1 rounded-full text-[11px] font-semibold transition-colors ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white hover:bg-black/30' : 'bg-white border border-gray-200 text-gray-900 hover:bg-gray-50'}`}
                              title={googleDocsPreviewMode ? 'Switch to edit mode' : 'Preview inline images'}
                            >
                              {googleDocsPreviewMode ? 'Edit' : 'Preview'}
                            </button>
                          )}
                          {googleDocsSelected && (
                            <div ref={googleDocsInsertImageMenuRef} className="relative">
                              <button
                                type="button"
                                onClick={() => setGoogleDocsInsertImageMenuOpen(prev => !prev)}
                                disabled={!googleDriveConnected || googleDocsLoadLoading}
                                className={`px-2.5 py-1 rounded-full text-[11px] font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                                title="Insert inline image"
                              >
                                Insert image
                              </button>

                              <input
                                ref={googleDocsUploadImageInputRef}
                                type="file"
                                accept="image/*"
                                className="hidden"
                                onChange={async (e) => {
                                  const file = e.target.files?.[0];
                                  if (!file) return;
                                  try {
                                    setGoogleDocsInsertImageMenuOpen(false);
                                    await handleDocsInlineImageUpload(file);
                                  } finally {
                                    if (googleDocsUploadImageInputRef.current) {
                                      googleDocsUploadImageInputRef.current.value = '';
                                    }
                                  }
                                }}
                              />

                              {googleDocsInsertImageMenuOpen && (
                                <div className={`absolute right-0 mt-2 w-44 rounded-xl border shadow-xl overflow-hidden z-20 ${isDarkMode ? 'bg-[#1d1d1f] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setGoogleDocsInsertImageMenuOpen(false);
                                      setGoogleDocsGenerateImageOpen(true);
                                    }}
                                    className={`w-full text-left px-3 py-2 text-xs font-semibold transition-colors ${isDarkMode ? 'text-white hover:bg-black/30' : 'text-gray-900 hover:bg-gray-50'}`}
                                  >
                                    Generate
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setGoogleDocsInsertImageMenuOpen(false);
                                      googleDocsUploadImageInputRef.current?.click();
                                    }}
                                    className={`w-full text-left px-3 py-2 text-xs font-semibold transition-colors ${isDarkMode ? 'text-white hover:bg-black/30' : 'text-gray-900 hover:bg-gray-50'}`}
                                  >
                                    Upload
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setGoogleDocsInsertImageMenuOpen(false);
                                      setGoogleDocsImagePickerOpen(true);
                                    }}
                                    className={`w-full text-left px-3 py-2 text-xs font-semibold transition-colors ${isDarkMode ? 'text-white hover:bg-black/30' : 'text-gray-900 hover:bg-gray-50'}`}
                                  >
                                    Select
                                  </button>
                                </div>
                              )}
                            </div>
                          )}
                          <div className={`text-[11px] ${isDarkMode ? 'text-[#636366]' : 'text-gray-500'}`}>
                            {googleDocsSelected ? `${googleDocsText.trim().length ? googleDocsText.trim().split(/\s+/).length : 0} words` : ''}
                          </div>
                        </div>
                      </div>
                      {googleDocsPreviewMode && googleDocsSelected ? (
                        <div className={`w-full px-3 py-3 text-sm ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                          <div className={`${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'} text-[11px] mb-2`}>
                            Preview mode (inline images are rendered; click Edit to modify text)
                          </div>
                          <div className="space-y-2">
                            {googleDocsPreviewParts.length === 0 ? (
                              <div className={`${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'} text-sm`}>
                                Nothing to preview.
                              </div>
                            ) : (
                              googleDocsPreviewParts.map((part, idx) => {
                                if (part.type === 'image') {
                                  const style: React.CSSProperties = {
                                    maxWidth: '100%',
                                    width: typeof part.widthPx === 'number' ? `${part.widthPx}px` : undefined,
                                    height: typeof part.heightPx === 'number' ? `${part.heightPx}px` : undefined,
                                  };

                                  return (
                                    <div key={`${part.url}-${idx}`} className="my-2">
                                      <img
                                        src={part.url}
                                        alt="Inline"
                                        style={style}
                                        className="rounded-lg border border-black/10 dark:border-white/10"
                                        loading="lazy"
                                      />
                                    </div>
                                  );
                                }

                                return (
                                  <div key={`text-${idx}`} className={isDarkMode ? 'prose prose-invert max-w-none text-white' : 'prose max-w-none text-gray-900'}>
                                    <ReactMarkdown>
                                      {part.value}
                                    </ReactMarkdown>
                                  </div>
                                );
                              })
                            )}
                          </div>
                        </div>
                      ) : (
                        <textarea
                          ref={googleDocsTextareaRef}
                          value={googleDocsText}
                          onChange={(e) => setGoogleDocsText(e.target.value)}
                          rows={18}
                          disabled={!googleDocsSelected || googleDocsLoadLoading}
                          className={`w-full text-sm px-3 py-3 resize-y focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] text-white placeholder:text-[#636366]' : 'bg-white text-gray-900 placeholder:text-gray-500'} ${!googleDocsSelected ? 'opacity-60' : ''}`}
                          placeholder={googleDocsSelected ? 'Start typing' : 'Select a Doc from the library to begin.'}
                        />
                      )}
                    </div>

                    {googleDocsImagePickerOpen && (
                      <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                        <div
                          className="absolute inset-0 bg-black/60"
                          onClick={() => setGoogleDocsImagePickerOpen(false)}
                        />
                        <div className={`relative w-full max-w-3xl rounded-2xl border shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}>
                          <div className={`px-4 py-3 border-b flex items-center justify-between ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                            <div>
                              <div className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Insert inline image</div>
                              <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                Images must be publicly reachable via URL (no blob/data URLs).
                              </div>
                            </div>
                            <button
                              type="button"
                              onClick={() => setGoogleDocsImagePickerOpen(false)}
                              className={`px-3 py-1.5 rounded-xl text-xs font-semibold ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                            >
                              Close
                            </button>
                          </div>

                          <div className="p-4">
                            <div className="flex flex-wrap gap-3 items-end">
                              <div>
                                <div className={`text-[11px] mb-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Width (px)</div>
                                <input
                                  value={googleDocsImageWidthPx}
                                  onChange={(e) => setGoogleDocsImageWidthPx(e.target.value)}
                                  placeholder="480"
                                  className={`w-24 px-3 py-2 rounded-xl text-xs border focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-black/30 border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                                />
                              </div>
                              <div>
                                <div className={`text-[11px] mb-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Height (px, optional)</div>
                                <input
                                  value={googleDocsImageHeightPx}
                                  onChange={(e) => setGoogleDocsImageHeightPx(e.target.value)}
                                  placeholder=""
                                  className={`w-28 px-3 py-2 rounded-xl text-xs border focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-black/30 border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                                />
                              </div>
                            </div>

                            <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-[55vh] overflow-y-auto pr-1">
                              {docsInlineImageCandidates.length === 0 ? (
                                <div className={`col-span-full text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                                  No eligible images found in project assets.
                                </div>
                              ) : (
                                docsInlineImageCandidates.map((file) => {
                                  const url = (file.url || '').toString();
                                  const label = file.label || 'Untitled image';
                                  return (
                                    <button
                                      key={file.key}
                                      type="button"
                                      onClick={() => {
                                        insertGoogleDocsInlineImageToken(url);
                                        setGoogleDocsImagePickerOpen(false);
                                      }}
                                      className={`group rounded-xl border overflow-hidden text-left transition-colors ${isDarkMode ? 'border-[#3d3d3f]/60 bg-black/20 hover:bg-black/30' : 'border-gray-200 bg-white hover:bg-gray-50'}`}
                                      title={label}
                                    >
                                      <div className="aspect-video bg-black/10 overflow-hidden">
                                        <img
                                          src={url}
                                          alt={label}
                                          className="w-full h-full object-cover group-hover:scale-[1.02] transition-transform"
                                          loading="lazy"
                                        />
                                      </div>
                                      <div className={`p-2 text-[11px] truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{label}</div>
                                    </button>
                                  );
                                })
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {googleDocsGenerateImageOpen && (
                      <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                        <div
                          className="absolute inset-0 bg-black/60"
                          onClick={() => {
                            if (googleDocsGenerateImageLoading) return;
                            setGoogleDocsGenerateImageOpen(false);
                          }}
                        />
                        <div className={`relative w-full max-w-xl rounded-2xl border shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}>
                          <div className={`px-4 py-3 border-b flex items-center justify-between ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                            <div>
                              <div className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Generate inline image</div>
                              <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>Generates with Gemini, uploads to your project, then inserts into the doc.</div>
                            </div>
                            <button
                              type="button"
                              onClick={() => setGoogleDocsGenerateImageOpen(false)}
                              disabled={googleDocsGenerateImageLoading}
                              className={`px-3 py-1.5 rounded-xl text-xs font-semibold ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'} ${googleDocsGenerateImageLoading ? 'opacity-60 cursor-wait' : ''}`}
                            >
                              Close
                            </button>
                          </div>

                          <div className="p-4">
                            <div className={`text-[11px] mb-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Prompt</div>
                            <textarea
                              value={googleDocsGenerateImagePrompt}
                              onChange={(e) => setGoogleDocsGenerateImagePrompt(e.target.value)}
                              rows={3}
                              placeholder="e.g. a clean diagram explaining our funnel stages"
                              className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-black/30 border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                            />

                            <div className="mt-3 flex items-center justify-end gap-2">
                              <button
                                type="button"
                                onClick={handleDocsInlineImageGenerate}
                                disabled={googleDocsGenerateImageLoading || !googleDocsGenerateImagePrompt.trim()}
                                className={`px-3 py-2 rounded-xl text-xs font-semibold transition-colors ${googleDocsGenerateImageLoading
                                  ? 'bg-gray-500/60 text-white cursor-wait'
                                  : (isDarkMode ? 'bg-[#0071e3] text-white hover:bg-[#0a84ff]' : 'bg-[#0071e3] text-white hover:bg-[#0a84ff]')
                                  }`}
                              >
                                {googleDocsGenerateImageLoading ? 'Generating' : 'Generate & Insert'}
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )
        }

        {
          filterType === 'blogs' && (
            <div className="mt-4 flex flex-col lg:flex-row gap-4">
              {/* Blog generation (project-context-aware) */}
              <div className={`flex-1 rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <h3 className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Generate Blog Post</h3>
                <p className={`text-xs mb-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                  Use your project&apos;s research, notes, tasks, and assets to draft a new blog article. Your prompt guides the angle; context is added automatically.
                </p>
                <textarea
                  value={blogPrompt}
                  onChange={e => setBlogPrompt(e.target.value)}
                  rows={2}
                  className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                  placeholder="Describe the blog you want (angle, audience, style). Project context will be used automatically."
                />
                {/* Suggestion buttons */}
                <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                  {[
                    { label: 'Thought leadership', value: 'Write a thought leadership article based on the project' },
                    { label: 'How-to guide', value: 'Create a how-to guide based on the project' },
                    { label: 'Case study', value: 'Write a case study based on the project' },
                    { label: 'Listicle', value: 'Create a listicle based on the project' },
                    { label: 'Trend analysis', value: 'Write an industry trend analysis based on the project' },
                  ].map((suggestion) => (
                    <button
                      key={suggestion.value}
                      type="button"
                      onClick={() => setBlogPrompt(suggestion.value)}
                      className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                        ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                        : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                        }`}
                    >
                      {suggestion.label}
                    </button>
                  ))}
                </div>
                <div className="mt-2 flex items-center justify-end gap-2">
                  <button
                    type="button"
                    onClick={handleGenerateBlog}
                    disabled={isGeneratingBlog || !blogPrompt.trim()}
                    className={`px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 ${isGeneratingBlog
                      ? 'bg-gray-500/60 text-white cursor-wait'
                      : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                      }`}
                  >
                    {isGeneratingBlog && (
                      <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10" className="opacity-25" />
                        <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                      </svg>
                    )}
                    <span>{isGeneratingBlog ? 'Generating' : 'Generate blog'}</span>
                  </button>
                </div>
                {blogError && (
                  <p className="mt-2 text-xs text-red-400">{blogError}</p>
                )}
                {generatedBlog && (
                  <div className="mt-4">
                    <h4 className={`text-base font-semibold mb-1 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{generatedBlog.title}</h4>
                    {generatedBlog.subtitle && (
                      <p className={`text-xs mb-3 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>{generatedBlog.subtitle}</p>
                    )}
                    <div className={isDarkMode ? 'prose prose-invert max-w-none' : 'prose max-w-none'}>
                      <ReactMarkdown>
                        {generatedBlog.content || ''}
                      </ReactMarkdown>
                    </div>
                    <div className="mt-4 flex items-center gap-2">
                      {onShareToX && (
                        <button
                          type="button"
                          onClick={() => {
                            onShareToX({
                              id: `temp-blog-${Date.now()}`,
                              type: 'blog',
                              title: generatedBlog.title,
                              description: generatedBlog.subtitle,
                              data: generatedBlog,
                              researchTopic: project.name,
                              timestamp: Date.now(),
                            } as AssetItem);
                          }}
                          className="px-4 py-1.5 rounded-full bg-[#0071e3] text-white text-xs font-semibold hover:bg-[#0077ed] transition-colors flex items-center gap-2"
                        >
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                          </svg>
                          Share to Social
                        </button>
                      )}
                      {blogSaveMessage && (
                        <span className={`text-[11px] ${blogSaveMessage.toLowerCase().includes('saved') ? 'text-green-400' : 'text-red-400'}`}>
                          {blogSaveMessage}
                        </span>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )
        }

        {
          filterType === 'podcasts' && (
            <div className="mt-4">
              <div className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <h3 className={`text-sm font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Generate Podcast Episode</h3>
                <p className={`text-xs mb-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                  Turn your project research and notes into an audio episode. Choose a style and length, then we&apos;ll save the audio into project assets.
                </p>
                <textarea
                  value={podcastPrompt}
                  onChange={e => setPodcastPrompt(e.target.value)}
                  rows={2}
                  className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                  placeholder="Describe the topic, audience, or angle for this episode"
                />
                {/* Suggestion buttons */}
                <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                  {[
                    { label: 'Deep dive', value: 'Create a deep dive episode based on the project' },
                    { label: 'News roundup', value: 'Create a news roundup based on the project' },
                    { label: 'Expert interview', value: 'Create an expert interview based on the project' },
                    { label: 'Q&A session', value: 'Create a Q&A session based on the project' },
                    { label: 'Storytelling', value: 'Create a storytelling episode based on the project' },
                  ].map((suggestion) => (
                    <button
                      key={suggestion.value}
                      type="button"
                      onClick={() => setPodcastPrompt(suggestion.value)}
                      className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                        ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                        : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                        }`}
                    >
                      {suggestion.label}
                    </button>
                  ))}
                </div>
                <div className="mt-2 flex flex-wrap items-center gap-3 text-xs">
                  <div className="flex items-center gap-1">
                    <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Style:</span>
                    <div className="flex items-center gap-1">
                      {[
                        { value: 'conversational', label: 'Conversational' },
                        { value: 'educational', label: 'Educational' },
                        { value: 'debate', label: 'Debate' },
                        { value: 'interview', label: 'Interview' },
                      ].map(option => (
                        <button
                          key={option.value}
                          type="button"
                          onClick={() => setPodcastStyle(option.value as any)}
                          className={`px-2 py-1 rounded-full border text-[11px] ${podcastStyle === option.value
                            ? isDarkMode
                              ? 'bg-white text-black border-transparent'
                              : 'bg-gray-900 text-white border-gray-900'
                            : isDarkMode
                              ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                              : 'border-gray-300 text-gray-600 hover:border-gray-400'
                            }`}
                        >
                          {option.label}
                        </button>
                      ))}
                    </div>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Length:</span>
                    <div className="flex items-center gap-1">
                      {[
                        { value: 'short', label: 'Short' },
                        { value: 'medium', label: 'Medium' },
                        { value: 'long', label: 'Long' },
                      ].map(option => (
                        <button
                          key={option.value}
                          type="button"
                          onClick={() => setPodcastDuration(option.value as any)}
                          className={`px-2 py-1 rounded-full border text-[11px] ${podcastDuration === option.value
                            ? isDarkMode
                              ? 'bg-white text-black border-transparent'
                              : 'bg-gray-900 text-white border-gray-900'
                            : isDarkMode
                              ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366]'
                              : 'border-gray-300 text-gray-600 hover:border-gray-400'
                            }`}
                        >
                          {option.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
                <div className="mt-3 flex items-center justify-end gap-2">
                  <button
                    type="button"
                    onClick={handleGeneratePodcast}
                    disabled={isGeneratingPodcast || !podcastPrompt.trim()}
                    className={`px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 ${isGeneratingPodcast
                      ? 'bg-gray-500/60 text-white cursor-wait'
                      : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                      }`}
                  >
                    {isGeneratingPodcast && (
                      <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10" className="opacity-25" />
                        <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                      </svg>
                    )}
                    <span>{isGeneratingPodcast ? 'Generating' : 'Generate podcast'}</span>
                  </button>
                  {podcastSaveMessage && (
                    <span className={`text-[11px] ${podcastSaveMessage.startsWith('Saved') ? 'text-green-400' : 'text-red-400'}`}>
                      {podcastSaveMessage}
                    </span>
                  )}
                </div>
                {podcastError && (
                  <p className="mt-2 text-xs text-red-400">{podcastError}</p>
                )}
              </div>
            </div>
          )
        }

        {
          filterType === 'books' && (
            <div className="mt-4">
              <div className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                    Generate PDF
                  </h3>

                  {/* Unified Interactive Toggle */}
                  <div className={`flex items-center gap-3 p-1.5 rounded-xl border ${isDarkMode ? 'bg-[#2c2c2e] border-[#3d3d3f]' : 'bg-blue-50 border-blue-100'}`}>
                    <div className="flex items-center gap-2 pl-1">
                      <label className={`text-[10px] font-bold uppercase tracking-wider cursor-pointer ${isDarkMode ? 'text-[#86868b]' : 'text-[#0071e3]'}`} onClick={() => setIsPdfMode(!isPdfMode)}>
                        Interactive Mode
                      </label>
                      <span className="text-[9px] px-1.5 py-0.5 rounded-full bg-[#0071e3] text-white font-bold">
                        AI
                      </span>
                    </div>
                    <button
                      type="button"
                      onClick={() => setIsPdfMode(!isPdfMode)}
                      className={`relative inline-flex h-5 w-10 items-center rounded-full transition-colors ${isPdfMode
                        ? 'bg-[#0071e3]'
                        : isDarkMode ? 'bg-[#3d3d3f]' : 'bg-gray-300'
                        }`}
                    >
                      <span
                        className={`inline-block h-3.5 w-3.5 transform rounded-full bg-white transition-transform ${isPdfMode ? 'translate-x-5' : 'translate-x-1'
                          }`}
                      />
                    </button>
                  </div>
                </div>

                <p className={`text-xs mb-3 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                  {isPdfMode
                    ? 'Create a professional single-page document or presentation optimized for high-quality PDF extraction.'
                    : 'Create a multi-page PDF document based on your project. Choose a style by describing what you want.'}
                </p>

                <textarea
                  value={bookPrompt}
                  onChange={e => setBookPrompt(e.target.value)}
                  rows={3}
                  className={`w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                  placeholder={isPdfMode ? "Describe the PDF concept (e.g. business proposal, research findings)" : "Describe the multi-page document (e.g. a story, market guide)"}
                />

                {/* Combined Suggestion buttons */}
                <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                  {[
                    ...(isPdfMode ? [
                      { label: 'Research Report', value: 'Create a detailed research report based on the project' },
                      { label: 'Business Proposal', value: 'Create a professional business proposal' },
                      { label: 'Pitch Deck', value: 'Generate a pitch deck as a document' },
                    ] : [
                      { label: 'Market overview', value: 'Create a market overview based on the project' },
                      { label: 'Illustrated book', value: 'Create an illustrated book based on the project' },
                      { label: 'Report', value: 'Create a report based on the project' },
                    ]),
                    { label: 'Case Study', value: 'Create a compelling case study' },
                  ].map((suggestion) => (
                    <button
                      key={suggestion.value}
                      type="button"
                      onClick={() => setBookPrompt(suggestion.value)}
                      className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                        ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                        : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                        }`}
                    >
                      {suggestion.label}
                    </button>
                  ))}
                </div>

                {isPdfMode && (
                  <div className="mt-3 pt-3 border-t border-dashed border-gray-200 dark:border-[#3d3d3f]">
                    <div className="flex items-center justify-between mb-2">
                      <label className={`text-xs font-medium ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Visual References (AI will analyze & use these)
                      </label>
                      <span className="text-[10px] text-gray-400">{websiteMediaFiles.length + selectedWebsiteAssetIds.length} selected</span>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {/* File Input */}
                      <label className={`cursor-pointer inline-flex items-center justify-center w-12 h-12 rounded-xl text-xs font-medium border border-dashed transition-all ${isDarkMode ? 'border-[#3d3d3f] hover:border-[#0071e3] hover:bg-[#0071e3]/10 text-gray-400' : 'border-gray-300 hover:border-[#0071e3] hover:bg-[#0071e3]/5 text-gray-600'}`} title="Upload new images">
                        <input
                          type="file"
                          multiple
                          accept="image/*"
                          className="hidden"
                          onChange={(e) => {
                            if (e.target.files) {
                              setWebsiteMediaFiles(prev => [...prev, ...Array.from(e.target.files || [])]);
                            }
                          }}
                        />
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                      </label>

                      {/* Select From Assets Button */}
                      <button
                        type="button"
                        onClick={() => setIsWebsiteAssetPickerOpen(true)}
                        className={`inline-flex items-center justify-center w-12 h-12 rounded-xl text-xs font-medium border border-dashed transition-all ${isDarkMode ? 'border-[#3d3d3f] hover:border-[#0071e3] hover:bg-[#0071e3]/10 text-gray-400' : 'border-gray-300 hover:border-[#0071e3] hover:bg-[#0071e3]/5 text-gray-600'}`}
                        title="Select from project assets"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </button>

                      {/* Preview List (Selected Assets) */}
                      {selectedWebsiteAssetIds.length > 0 && (
                        <div className="flex items-center justify-center w-12 h-12 rounded-xl border border-[#3d3d3f] bg-black/20 text-xs font-medium text-white" title={`${selectedWebsiteAssetIds.length} assets selected`}>
                          +{selectedWebsiteAssetIds.length}
                        </div>
                      )}

                      {/* Preview List */}
                      {websiteMediaFiles.map((file, idx) => (
                        <div key={idx} className={`relative group w-12 h-12 rounded-xl overflow-hidden border ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                          <img src={URL.createObjectURL(file)} className="w-full h-full object-cover" alt="preview" />
                          <button
                            onClick={() => setWebsiteMediaFiles(prev => prev.filter((_, i) => i !== idx))}
                            className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white transition-opacity"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div className="mt-3 flex items-center justify-between gap-3">
                  <div className="flex items-center gap-3">
                    {!isPdfMode && (
                      <div className="flex items-center gap-2">
                        <span className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600 text-[11px]'}>Pages:</span>
                        <input
                          type="number"
                          min={4}
                          max={32}
                          value={bookPageCount}
                          onChange={e => {
                            const val = parseInt(e.target.value, 10);
                            if (Number.isNaN(val)) return;
                            setBookPageCount(Math.max(4, Math.min(32, val)));
                          }}
                          className={`w-12 rounded-lg px-2 py-1 border text-xs ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/60 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                        />
                      </div>
                    )}

                    {isPdfMode && generatedWebsiteHtml && (
                      <button
                        onClick={() => {
                          const printWindow = window.open('', '_blank');
                          if (printWindow) {
                            printWindow.document.write(generatedWebsiteHtml);
                            printWindow.document.close();
                            printWindow.focus();
                            setTimeout(() => {
                              printWindow.print();
                            }, 500);
                          }
                        }}
                        className={`px-3 py-1.5 rounded-full text-[10px] font-bold border transition-colors ${isDarkMode
                          ? 'bg-green-500/20 border-green-500/40 text-green-400 hover:bg-green-500/30'
                          : 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100'
                          } flex items-center gap-1.5`}
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download PDF
                      </button>
                    )}
                  </div>

                  <button
                    type="button"
                    onClick={async () => {
                      if (isPdfMode) {
                        await handleGeneratePdfWebsite(bookPrompt);
                      } else {
                        await handleGenerateBook();
                      }
                    }}
                    disabled={isGeneratingBook || isGeneratingWebsite || !bookPrompt.trim()}
                    className={`px-4 py-1.5 rounded-full text-xs font-medium flex items-center gap-1.5 ${isGeneratingBook || isGeneratingWebsite
                      ? 'bg-gray-500/60 text-white cursor-wait'
                      : 'bg-[#0071e3] hover:bg-[#0077ed] text-white shadow-lg shadow-[#0071e3]/20'
                      }`}
                  >
                    {(isGeneratingBook || isGeneratingWebsite) && (
                      <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10" className="opacity-25" />
                        <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                      </svg>
                    )}
                    <span>{isGeneratingBook || isGeneratingWebsite ? 'Generating' : 'Generate PDF'}</span>
                  </button>
                </div>

                {(bookError || websiteError) && (
                  <p className="mt-2 text-xs text-red-400">{bookError || websiteError}</p>
                )}
                {(bookSaveMessage || websiteSaveMessage) && (
                  <p className={`mt-2 text-[10px] font-medium ${(bookSaveMessage?.includes('Saved') || websiteSaveMessage?.includes('Saved')) ? 'text-green-400' : 'text-[#0071e3]'}`}>
                    {bookSaveMessage || websiteSaveMessage}
                  </p>
                )}
              </div>

              {/* Streaming Preview (Interactive) */}
              {isPdfMode && (websiteStreamingCode || generatedWebsiteHtml) && (
                <div className="mt-4">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className={`text-xs font-medium ${isDarkMode ? 'text-white/70' : 'text-gray-700'}`}>
                      {isGeneratingWebsite ? 'Generating Asset...' : 'Asset Preview'}
                    </h4>
                    {isGeneratingWebsite && (
                      <div className="flex items-center gap-2">
                        <svg className="w-3.5 h-3.5 animate-spin text-[#0071e3]" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" className="opacity-25" />
                          <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                        </svg>
                        <span className={`text-[10px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>Streaming...</span>
                      </div>
                    )}
                  </div>
                  <div className={`w-full h-[400px] rounded-2xl overflow-hidden border ${isDarkMode ? 'border-[#3d3d3f]/60 bg-[#111111]' : 'border-gray-200 bg-white shadow-inner'}`}>
                    <iframe
                      srcDoc={generatedWebsiteHtml || cleanStreamingCode(websiteStreamingCode)}
                      className="w-full h-full bg-white"
                      title="PDF Preview"
                      sandbox="allow-scripts"
                    />
                  </div>
                </div>
              )}
              {generatedBookPages.length > 0 && (
                <div className="mt-4">
                  <h4 className={`text-xs font-semibold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                    Generated pages (click to view or download)
                  </h4>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    {generatedBookPages
                      .slice()
                      .sort((a, b) => a.pageNumber - b.pageNumber)
                      .map(page => (
                        <div
                          key={page.id}
                          className={
                            isDarkMode
                              ? 'rounded-xl border border-[#3d3d3f]/70 bg-black/30 p-2 flex flex-col gap-1'
                              : 'rounded-xl border border-gray-200 bg-gray-50 p-2 flex flex-col gap-1'
                          }
                        >
                          <div className="relative w-full pb-[141.4%] overflow-hidden rounded-lg border border-black/10 bg-black/5">
                            <img
                              src={page.imageUrl}
                              alt={page.prompt || `${project.name}  page ${page.pageNumber}`}
                              className="absolute inset-0 w-full h-full object-cover"
                            />
                          </div>
                          <div className="flex items-center justify-between gap-2 mt-1">
                            <span
                              className={
                                isDarkMode
                                  ? 'text-[11px] text-[#e5e5ea]'
                                  : 'text-[11px] text-gray-800'
                              }
                            >
                              Page {page.pageNumber}
                            </span>
                            <a
                              href={page.imageUrl}
                              download={`book-page-${page.pageNumber}.png`}
                              className={
                                isDarkMode
                                  ? 'text-[10px] text-[#0a84ff] hover:underline'
                                  : 'text-[10px] text-[#0071e3] hover:underline'
                              }
                            >
                              Download PNG
                            </a>
                          </div>
                        </div>
                      ))}
                  </div>
                </div>
              )}

              {isSaveTableNameModalOpen && (
                <div
                  className="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"
                  onClick={() => setIsSaveTableNameModalOpen(false)}
                >
                  <div
                    className={`w-full max-w-lg rounded-2xl border shadow-xl overflow-hidden ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}
                    onClick={e => e.stopPropagation()}
                  >
                    <div className={`p-4 border-b ${isDarkMode ? 'border-[#3d3d3f]/70' : 'border-gray-200'}`}>
                      <div className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Name this table
                      </div>
                      <div className={`mt-1 text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        This name will be used when saving to the latest research session.
                      </div>
                    </div>

                    <div className="p-4">
                      <input
                        value={saveTableName}
                        onChange={(e) => setSaveTableName(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            e.preventDefault();
                            handleConfirmSaveTableName().catch(() => { });
                          }
                          if (e.key === 'Escape') {
                            e.preventDefault();
                            setIsSaveTableNameModalOpen(false);
                          }
                        }}
                        autoFocus
                        placeholder="Table name"
                        className={`w-full rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                      />

                      <div className="mt-4 flex items-center justify-end gap-2">
                        <button
                          type="button"
                          onClick={() => setIsSaveTableNameModalOpen(false)}
                          className={`px-3 py-2 rounded-xl text-sm font-semibold border ${isDarkMode ? 'border-[#3d3d3f] text-white/80 hover:bg-white/10' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}`}
                        >
                          Cancel
                        </button>
                        <button
                          type="button"
                          onClick={() => handleConfirmSaveTableName().catch(() => { })}
                          disabled={!saveTableName.trim()}
                          className={`px-3 py-2 rounded-xl text-sm font-semibold ${!saveTableName.trim()
                            ? isDarkMode
                              ? 'bg-[#2d2d2f]/60 text-[#86868b]'
                              : 'bg-gray-200 text-gray-500'
                            : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                            }`}
                        >
                          Save
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )
        }

        {
          filterType === 'tables' && (
            <div className="mt-4">
              <div className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <h3 className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      Generate Data Table
                    </h3>
                    <p className={`mt-1 text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                      Create a structured table from your project's research, tasks, and notes.
                    </p>
                  </div>
                </div>

                <textarea
                  value={tablePrompt}
                  onChange={e => setTablePrompt(e.target.value)}
                  rows={2}
                  className={`mt-3 w-full text-sm rounded-xl px-3 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                  placeholder="Describe the table you want (e.g., 'comparison of research findings', 'task timeline', 'feature matrix')"
                />
                {/* Suggestion buttons */}
                <div className="mt-2 hidden sm:flex flex-wrap gap-1.5">
                  {[
                    { label: 'Comparison table', value: 'Create a comparison table based on the project' },
                    { label: 'Feature matrix', value: 'Create a feature matrix based on the project' },
                    { label: 'Timeline', value: 'Create a timeline based on the project' },
                    { label: 'Pricing table', value: 'Create a pricing table based on the project' },
                    { label: 'Analytics summary', value: 'Create an analytics summary based on the project' },
                  ].map((suggestion) => (
                    <button
                      key={suggestion.value}
                      type="button"
                      onClick={() => setTablePrompt(suggestion.value)}
                      className={`px-2 py-1 rounded-full text-[10px] border transition-colors ${isDarkMode
                        ? 'border-[#3d3d3f] text-[#86868b] hover:text-white hover:border-[#636366] hover:bg-[#2d2d2f]'
                        : 'border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                        }`}
                    >
                      {suggestion.label}
                    </button>
                  ))}
                </div>

                <div className="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                  <div className="flex flex-wrap items-center gap-2">
                    {!googleDriveConnected ? (
                      <button
                        type="button"
                        onClick={handleConnectGoogle}
                        disabled={googleDriveStatusLoading}
                        className={`px-2.5 py-1.5 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                      >
                        {googleDriveStatusLoading ? 'Checking' : (
                          <div className="flex items-center gap-2">
                            <img src={PLATFORM_LOGOS.googledrive} alt="" className="w-4 h-4 object-contain" />
                            <span>Connect Google</span>
                          </div>
                        )}
                      </button>
                    ) : (
                      <>
                        <button
                          type="button"
                          onClick={() => {
                            setGoogleSheetsPickerOpen(true);
                            if (googleSheetsFiles.length === 0) {
                              loadGoogleSheetsFiles({ reset: true });
                            }
                          }}
                          disabled={googleSheetsLoadLoading}
                          className={`px-2.5 py-1.5 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                        >
                          {googleSheetsLoadLoading ? 'Importing' : (
                            <div className="flex items-center gap-2">
                              <img src={PLATFORM_LOGOS.googlesheets} alt="" className="w-3.5 h-3.5 object-contain" />
                              <span>Import Sheet</span>
                            </div>
                          )}
                        </button>

                        {googleSheetsTabs.length > 0 && googleSheetsSelectedSpreadsheet && (
                          <select
                            value={googleSheetsSelectedTab}
                            onChange={(e) => handleReloadSelectedTab(e.target.value)}
                            className={`px-2.5 py-1.5 rounded-xl text-xs border ${isDarkMode ? 'bg-[#0b0b0c] border-[#3d3d3f]/60 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                            title={googleSheetsSelectedSpreadsheet.title}
                          >
                            {googleSheetsTabs.map(tab => (
                              <option key={tab.sheetId} value={tab.title}>
                                {tab.title}
                              </option>
                            ))}
                          </select>
                        )}

                        <button
                          type="button"
                          onClick={handleSaveBackToSheet}
                          disabled={googleSheetsSaveLoading || !generatedTable?.googleSpreadsheetId}
                          className={`px-2.5 py-1.5 rounded-xl text-xs font-semibold ${googleSheetsSaveLoading || !generatedTable?.googleSpreadsheetId
                            ? isDarkMode
                              ? 'bg-[#2d2d2f]/60 text-[#86868b]'
                              : 'bg-gray-200 text-gray-500'
                            : 'bg-[#34c759] hover:bg-[#30d158] text-black'
                            }`}
                        >
                          {googleSheetsSaveLoading ? 'Saving' : 'Save to Sheet'}
                        </button>
                        <button
                          type="button"
                          onClick={handleExportToNewSheet}
                          disabled={googleSheetsSaveLoading || !googleDriveConnected || !generatedTable}
                          className={`px-2.5 py-1.5 rounded-xl text-xs font-semibold ${googleSheetsSaveLoading || !googleDriveConnected || !generatedTable
                            ? isDarkMode
                              ? 'bg-[#2d2d2f]/60 text-[#86868b]'
                              : 'bg-gray-200 text-gray-500'
                            : 'bg-[#0a84ff] hover:bg-[#0077ed] text-white'
                            }`}
                        >
                          Export new
                        </button>
                        <button
                          type="button"
                          onClick={handleConnectGoogle}
                          className={`px-2.5 py-1.5 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white hover:bg-black/30' : 'bg-white border border-gray-200 text-gray-900 hover:bg-gray-50'}`}
                        >
                          <div className="flex items-center gap-2">
                            <img src={PLATFORM_LOGOS.googledrive} alt="" className="w-3.5 h-3.5 object-contain" />
                            <span>Reconnect</span>
                          </div>
                        </button>

                        {/* Google Sheets Sync Status Indicator */}
                        {generatedTable?.googleSpreadsheetId && (
                          <>
                            {googleSheetsSyncStatus === 'syncing' || googleSheetsAutoSaving ? (
                              <span className={`flex items-center gap-1 text-[10px] px-2 py-1 rounded-full ${isDarkMode ? 'bg-[#0071e3]/20 text-[#0a84ff]' : 'bg-blue-100 text-blue-700'}`}>
                                <svg className="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <circle cx="12" cy="12" r="10" strokeWidth="2" className="opacity-25" />
                                  <path strokeWidth="2" d="M4 12a8 8 0 018-8" className="opacity-75" />
                                </svg>
                                Syncing...
                              </span>
                            ) : googleSheetsSyncStatus === 'error' ? (
                              <span className={`text-[10px] px-2 py-1 rounded-full ${isDarkMode ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-700'}`}>
                                Sync error
                              </span>
                            ) : googleSheetsLastSyncedData && JSON.stringify({ columns: generatedTable.columns, rows: generatedTable.rows }) !== JSON.stringify(googleSheetsLastSyncedData) ? (
                              <span className={`text-[10px] px-2 py-1 rounded-full ${isDarkMode ? 'bg-[#ff9f0a]/20 text-[#ff9f0a]' : 'bg-amber-100 text-amber-800'}`}>
                                Editing...
                              </span>
                            ) : googleSheetsSyncStatus === 'synced' ? (
                              <span className={`flex items-center gap-1 text-[10px] px-2 py-1 rounded-full ${isDarkMode ? 'bg-[#34c759]/20 text-[#34c759]' : 'bg-green-100 text-green-700'}`}>
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Synced
                              </span>
                            ) : null}
                          </>
                        )}
                      </>
                    )}

                    {/* Upload File Button - Always visible */}
                    <button
                      type="button"
                      onClick={() => tableFileInputRef.current?.click()}
                      disabled={isUploadingTable}
                      className={`px-2.5 py-1.5 rounded-xl text-xs font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'}`}
                    >
                      {isUploadingTable ? 'Uploading' : (
                        <div className="flex items-center gap-2">
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                          </svg>
                          <span>Upload File</span>
                        </div>
                      )}
                    </button>
                    <input
                      ref={tableFileInputRef}
                      type="file"
                      accept=".csv,.xlsx,.xls"
                      className="hidden"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) handleTableFileUpload(file);
                      }}
                    />
                  </div>

                  <div className="flex justify-end">
                    <button
                      type="button"
                      onClick={handleGenerateTable}
                      disabled={isGeneratingTable || !tablePrompt.trim()}
                      className={`px-3 py-1.5 rounded-xl text-xs font-semibold flex items-center gap-1 ${isGeneratingTable
                        ? 'bg-gray-500/60 text-white cursor-wait'
                        : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                        }`}
                    >
                      {isGeneratingTable && (
                        <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" className="opacity-25" />
                          <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                        </svg>
                      )}
                      <span>{isGeneratingTable ? 'Generating' : 'Generate'}</span>
                    </button>
                  </div>
                </div>

                {(tableError || tableSaveMessage || tableUploadError) && (
                  <div className="mt-3 space-y-2">
                    {tableError && <p className="text-xs text-red-400">{tableError}</p>}
                    {tableUploadError && <p className="text-xs text-red-400">{tableUploadError}</p>}
                    {tableSaveMessage && (
                      <p className={`text-xs ${tableSaveMessage.includes('Failed') ? 'text-red-400' : 'text-green-400'}`}>{tableSaveMessage}</p>
                    )}
                  </div>
                )}

                {!generatedTable && (
                  <>
                    {flatFilteredAssets.length > 0 && (
                      <div className="mt-6">
                        <h3 className={`text-xs font-semibold mb-3 tracking-wide uppercase ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          Existing Tables
                        </h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                          {flatFilteredAssets.map(asset => (
                            <button
                              key={asset.id}
                              type="button"
                              onClick={() => handleAssetClick(asset)}
                              className={`group relative flex flex-col items-start text-left p-3 rounded-xl border transition-all ${isDarkMode
                                ? 'bg-[#1d1d1f] border-[#3d3d3f]/60 hover:border-[#636366] hover:bg-[#2c2c2e]'
                                : 'bg-white border-gray-200 hover:border-gray-300 hover:bg-gray-50 shadow-sm'
                                }`}
                            >
                              <div className="flex items-center gap-2 mb-2 w-full">
                                <div className={`p-1.5 rounded-lg ${isDarkMode ? 'bg-[#06b6d4]/20 text-[#06b6d4]' : 'bg-cyan-100 text-cyan-700'}`}>
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                  </svg>
                                </div>
                                <p className={`text-sm font-medium truncate flex-1 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                  {asset.title}
                                </p>
                              </div>
                              <p className={`text-xs line-clamp-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                {asset.description || 'No description'}
                              </p>
                              <p className={`text-[10px] mt-2 ${isDarkMode ? 'text-[#636366]' : 'text-gray-400'}`}>
                                {formatDate(asset.timestamp)}
                              </p>
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    <div
                      className={`mt-4 rounded-2xl border p-4 ${isDarkMode ? 'border-[#3d3d3f]/60 bg-[#111111]' : 'border-gray-200 bg-gray-50'}`}
                    >
                      <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        Generate a table to start editing, or upload a CSV/Excel file. You can then export, chart, save to the project, or sync to Google Sheets.
                      </div>
                    </div>
                  </>
                )}

                {generatedTable && (
                  <div className="mt-4">
                    <SpreadsheetTable
                      columns={generatedTable.columns}
                      rows={generatedTable.rows}
                      onColumnsChange={handleTableColumnsChange}
                      onRowsChange={handleTableRowsChange}
                      isDarkMode={isDarkMode}
                      title={generatedTable.title}
                      description={generatedTable.description}
                    />

                    <div className="mt-3 flex flex-wrap items-center justify-end gap-2">
                      <button
                        type="button"
                        onClick={() => setIsVisualizeOpen(v => !v)}
                        className={`px-3 py-1.5 rounded-xl text-xs font-semibold flex items-center gap-1.5 ${isVisualizeOpen
                          ? isDarkMode
                            ? 'bg-white/10 text-white border border-[#3d3d3f] hover:bg-white/15'
                            : 'bg-gray-100 text-gray-900 border border-gray-300 hover:bg-gray-200'
                          : 'bg-[#0071e3] hover:bg-[#0077ed] text-white'
                          }`}
                      >
                        {isGeneratingChart && isVisualizeOpen && (
                          <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <circle cx="12" cy="12" r="10" className="opacity-25" />
                            <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                          </svg>
                        )}
                        <span>{isVisualizeOpen ? 'Hide' : 'Visualize'}</span>
                      </button>
                      <button
                        type="button"
                        onClick={exportTableAsCSV}
                        className={`px-2.5 py-1.5 rounded-xl border text-xs font-semibold flex items-center gap-1.5 ${isDarkMode ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:text-white' : 'border-gray-300 text-gray-700 hover:border-gray-400 hover:text-gray-900'}`}
                        title="Export as CSV"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        CSV
                      </button>
                      <button
                        type="button"
                        onClick={exportTableAsJSON}
                        className={`px-2.5 py-1.5 rounded-xl border text-xs font-semibold ${isDarkMode ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:text-white' : 'border-gray-300 text-gray-700 hover:border-gray-400 hover:text-gray-900'}`}
                        title="Export as JSON"
                      >
                        JSON
                      </button>
                      <button
                        type="button"
                        onClick={handleAutoSaveTable}
                        className="px-3 py-1.5 rounded-xl bg-[#0071e3] hover:bg-[#0077ed] text-white text-xs font-semibold"
                      >
                        Save to Project
                      </button>
                    </div>

                    {isVisualizeOpen && (
                      <div className="mt-3">
                        <div className={`text-xs font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Chart type</div>
                        <div className="mt-2 flex flex-wrap lg:flex-nowrap items-center gap-1.5">
                          {[
                            { key: 'bar', label: 'Bar' },
                            { key: 'bar_horizontal', label: 'Bar H' },
                            { key: 'line', label: 'Line' },
                            { key: 'area', label: 'Area' },
                            { key: 'pie', label: 'Pie' },
                            { key: 'donut', label: 'Donut' },
                            { key: 'table', label: 'Table' },
                          ].map(option => (
                            <button
                              key={option.key}
                              type="button"
                              onClick={() => setChartType(option.key as any)}
                              className={`px-2 py-1 rounded-lg text-[11px] font-semibold border transition-colors whitespace-nowrap ${chartType === option.key
                                ? isDarkMode
                                  ? 'bg-white text-black border-transparent'
                                  : 'bg-gray-900 text-white border-gray-900'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] text-[#86868b] hover:border-[#636366] hover:text-white'
                                  : 'border-gray-300 text-gray-700 hover:border-gray-400 hover:text-gray-900'
                                }`}
                            >
                              {option.label}
                            </button>
                          ))}
                        </div>

                        {chartError && <p className="mt-3 text-xs text-red-400">{chartError}</p>}

                        {generatedChartHtml && (
                          <div
                            className={
                              'mt-4 rounded-2xl overflow-hidden border ' +
                              (isDarkMode ? 'border-[#3d3d3f]/60 bg-[#111111]' : 'border-gray-200 bg-white') +
                              ' h-[520px] sm:h-[580px] lg:h-[680px]'
                            }
                          >
                            <iframe srcDoc={generatedChartHtml} className="w-full h-full border-0" title="Generated chart" />
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {googleSheetsMessage && (
                  <div
                    className={`mt-4 rounded-2xl border px-3 py-2 text-xs ${googleSheetsMessage.toLowerCase().includes('failed')
                      ? isDarkMode
                        ? 'border-rose-400/30 bg-rose-400/10 text-rose-300'
                        : 'border-rose-600/30 bg-rose-600/10 text-rose-700'
                      : isDarkMode
                        ? 'border-emerald-400/30 bg-emerald-400/10 text-emerald-300'
                        : 'border-emerald-600/30 bg-emerald-600/10 text-emerald-700'
                      }`}
                  >
                    {googleSheetsMessage}
                  </div>
                )}
              </div>

              {googleSheetsPickerOpen && googleDriveConnected && (
                <div
                  className="fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4"
                  onClick={() => setGoogleSheetsPickerOpen(false)}
                >
                  <div
                    className={`w-full max-w-3xl rounded-2xl border shadow-xl overflow-hidden ${isDarkMode ? 'bg-[#111111] border-[#3d3d3f]/70' : 'bg-white border-gray-200'}`}
                    onClick={e => e.stopPropagation()}
                  >
                    <div className={`p-4 border-b ${isDarkMode ? 'border-[#3d3d3f]/70' : 'border-gray-200'}`}>
                      <div className="flex items-center justify-between gap-3">
                        <div>
                          <div className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Import from Google Sheets</div>
                          <div className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Pick a spreadsheet to import into the current table.</div>
                        </div>
                        <button
                          type="button"
                          onClick={() => setGoogleSheetsPickerOpen(false)}
                          className={`px-3 py-1.5 rounded-full text-xs border ${isDarkMode ? 'border-[#3d3d3f] text-white/80 hover:bg-white/10' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}`}
                        >
                          Close
                        </button>
                      </div>
                      <div className="mt-3 flex flex-col sm:flex-row sm:items-center gap-2">
                        <input
                          value={googleSheetsQuery}
                          onChange={(e) => setGoogleSheetsQuery(e.target.value)}
                          placeholder="Search Google Sheets"
                          className={`flex-1 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#0b0b0c] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'}`}
                        />
                        <button
                          type="button"
                          onClick={() => loadGoogleSheetsFiles({ reset: true })}
                          disabled={googleSheetsListLoading}
                          className={`px-3 py-2 rounded-xl text-sm font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'} ${googleSheetsListLoading ? 'opacity-60 cursor-not-allowed' : ''}`}
                        >
                          {googleSheetsListLoading ? 'Loading' : 'Search'}
                        </button>
                      </div>
                    </div>

                    <div className="p-4">
                      {googleSheetsFiles.length === 0 ? (
                        <div className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          {googleSheetsListLoading ? 'Loading sheets' : 'No sheets found.'}
                        </div>
                      ) : (
                        <div className="max-h-[60vh] overflow-y-auto space-y-2">
                          {googleSheetsFiles.map(file => (
                            <button
                              key={file.id}
                              type="button"
                              onClick={() => handlePrepareSpreadsheetImport(file.id, file.name)}
                              disabled={googleSheetsLoadLoading}
                              className={`w-full text-left px-3 py-2 rounded-xl border transition-colors ${isDarkMode ? 'border-[#3d3d3f]/60 bg-black/20 hover:bg-black/30 text-white' : 'border-gray-200 bg-white hover:bg-gray-50 text-gray-900'} ${googleSheetsLoadLoading ? 'opacity-60 cursor-not-allowed' : ''}`}
                            >
                              <div className="text-sm font-semibold truncate">{file.name}</div>
                              <div className={`text-[11px] mt-0.5 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>{file.id}</div>
                            </button>
                          ))}
                        </div>
                      )}

                      {googleSheetsSelectedSpreadsheet && googleSheetsTabs.length > 0 && (
                        <div className={`mt-4 rounded-2xl border p-3 ${isDarkMode ? 'border-[#3d3d3f]/60 bg-black/20' : 'border-gray-200 bg-gray-50'}`}>
                          <div className="flex flex-col sm:flex-row sm:items-center gap-2">
                            <div className="min-w-0 flex-1">
                              <div className={`text-[11px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>Selected spreadsheet</div>
                              <div className={`text-sm font-semibold truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                {googleSheetsSelectedSpreadsheet.title}
                              </div>
                            </div>
                            <select
                              value={googleSheetsSelectedTab}
                              onChange={(e) => setGoogleSheetsSelectedTab(e.target.value)}
                              className={`px-3 py-2 rounded-xl text-sm border ${isDarkMode ? 'bg-[#0b0b0c] border-[#3d3d3f]/60 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                            >
                              {googleSheetsTabs.map(tab => (
                                <option key={tab.sheetId} value={tab.title}>
                                  {tab.title}
                                </option>
                              ))}
                            </select>
                            <button
                              type="button"
                              onClick={() => handleReloadSelectedTab(googleSheetsSelectedTab)}
                              disabled={googleSheetsLoadLoading}
                              className={`px-3 py-2 rounded-xl text-sm font-semibold ${googleSheetsLoadLoading
                                ? isDarkMode
                                  ? 'bg-[#2d2d2f]/60 text-[#86868b]'
                                  : 'bg-gray-200 text-gray-500'
                                : 'bg-[#0a84ff] hover:bg-[#0077ed] text-white'
                                }`}
                            >
                              Import tab
                            </button>
                          </div>
                        </div>
                      )}

                      {googleSheetsNextPageToken && (
                        <div className="mt-3 flex justify-center">
                          <button
                            type="button"
                            onClick={() => loadGoogleSheetsFiles({ reset: false })}
                            disabled={googleSheetsListLoading}
                            className={`px-3 py-2 rounded-xl text-sm font-semibold transition-colors ${isDarkMode ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]' : 'bg-gray-100 text-gray-900 hover:bg-gray-200'} ${googleSheetsListLoading ? 'opacity-60 cursor-not-allowed' : ''}`}
                          >
                            {googleSheetsListLoading ? 'Loading' : 'Load more'}
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          )
        }


        {/* Products Tab - Stripe Connect */}
        {
          filterType === 'products' && (
            <div className="mt-4 space-y-6">
              <div className={`rounded-2xl p-4 sm:p-5 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60' : 'bg-white border border-gray-200'}`}>
                <div className="flex items-center gap-2 mb-2">
                  <h3 className={`text-sm font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Stripe Connect</h3>
                  {stripeConnectStatus?.chargesEnabled && (
                    <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-green-500/10 text-green-500 border border-green-500/20">
                      Account Status: Active
                      <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                      </svg>
                    </span>
                  )}
                </div>

                <p className={`text-xs mb-4 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                  Connect your Stripe account to sell products directly from your projects. Your Stripe account is shared across all projects.
                </p>

                {/* Account Status or Connect Button */}
                {stripeConnectStatus ? (
                  <div className="space-y-4">
                    {/* Account Status Card - Only show if NOT fully active (e.g. pending details) */}
                    {(!stripeConnectStatus.chargesEnabled || !stripeConnectStatus.payoutsEnabled || !stripeConnectStatus.detailsSubmitted) && (
                      <div className={`rounded-xl p-4 ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60' : 'bg-gray-50 border border-gray-200'}`}>
                        <div className="flex items-center justify-between mb-3">
                          <span className={`text-xs font-medium ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>Account Status</span>
                          <span className={`text-xs px-2 py-0.5 rounded-full ${stripeConnectStatus.chargesEnabled ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-500'}`}>
                            {stripeConnectStatus.chargesEnabled ? 'Active' : 'Pending'}
                          </span>
                        </div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          <div className="flex items-center gap-2">
                            <span className={stripeConnectStatus.chargesEnabled ? 'text-green-500' : 'text-red-500'}>
                              {stripeConnectStatus.chargesEnabled ? 'Yes' : 'No'}
                            </span>
                            <span className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>Charges enabled</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={stripeConnectStatus.payoutsEnabled ? 'text-green-500' : 'text-red-500'}>
                              {stripeConnectStatus.payoutsEnabled ? 'Yes' : 'No'}
                            </span>
                            <span className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>Payouts enabled</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={stripeConnectStatus.detailsSubmitted ? 'text-green-500' : 'text-yellow-500'}>
                              {stripeConnectStatus.detailsSubmitted ? '' : ''}
                            </span>
                            <span className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>Details submitted</span>
                          </div>
                        </div>

                        {/* Complete Onboarding Button if needed */}
                        {!stripeConnectStatus.detailsSubmitted && (
                          <button
                            onClick={async () => {
                              try {
                                const res = await authFetch('/api/stripe?op=create-account-link', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({
                                    accountId: stripeConnectStatus?.accountId,
                                    returnUrl: window.location.href,
                                    refreshUrl: window.location.href,
                                  }),
                                });
                                const data = await res.json();
                                if (data.url) {
                                  window.location.href = data.url;
                                }
                              } catch (e) {
                                console.error('Failed to create account link:', e);
                              }
                            }}
                            className="mt-3 w-full py-2 px-4 rounded-xl text-sm font-medium bg-[#0071e3] text-white hover:bg-[#0077ED] transition-colors"
                          >
                            Complete Onboarding
                          </button>
                        )}
                      </div>
                    )}

                    {/* Product Creation Section - Only if charges enabled */}
                    {stripeConnectStatus.chargesEnabled && (
                      <div className={`rounded-xl p-4 ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60' : 'bg-gray-50 border border-gray-200'}`}>
                        <h4 className={`text-xs font-semibold mb-3 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Create Product</h4>
                        <p className={`text-xs mb-3 ${isDarkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                          Products created here will be linked to this project.
                        </p>

                        {productError && (
                          <div className="mb-3 p-2 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-xs">
                            {productError}
                          </div>
                        )}

                        {productSaveMessage && (
                          <div className="mb-3 p-2 rounded-lg bg-green-500/10 border border-green-500/30 text-green-400 text-xs">
                            {productSaveMessage}
                          </div>
                        )}

                        <div className="space-y-3">
                          <input
                            type="text"
                            placeholder="Product name"
                            value={productName}
                            onChange={(e) => setProductName(e.target.value)}
                            disabled={isCreatingProduct}
                            className={`w-full text-sm rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'} disabled:opacity-50`}
                          />

                          {/* Description with Generate Button */}
                          <div className="relative">
                            <textarea
                              placeholder="Description (optional)"
                              value={productDescription}
                              onChange={(e) => setProductDescription(e.target.value)}
                              disabled={isCreatingProduct || isGeneratingDescription}
                              rows={3}
                              className={`w-full text-sm rounded-xl px-3 py-2 pr-24 resize-none focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'} disabled:opacity-50`}
                            />
                            <button
                              type="button"
                              onClick={async () => {
                                if (!productName.trim() && !productDescription.trim() && productImages.length === 0 && selectedProductAssetIds.length === 0) {
                                  setProductError('Add a product name, description, or images to generate');
                                  return;
                                }

                                setIsGeneratingDescription(true);
                                setProductError(null);

                                try {
                                  // Build context for AI
                                  const context: string[] = [];
                                  if (productName.trim()) context.push(`Product name: ${productName.trim()}`);
                                  if (productDescription.trim()) context.push(`Current description: ${productDescription.trim()}`);

                                  // Get image URLs from assets
                                  const assetImageUrls = allAssets
                                    .filter(a => selectedProductAssetIds.includes(a.id))
                                    .map(a => a.url)
                                    .filter(Boolean);

                                  // Call Gemini to generate description
                                  const prompt = `Generate a compelling product description for an e-commerce listing.
${context.length > 0 ? '\nContext:\n' + context.join('\n') : ''}
${assetImageUrls.length > 0 ? `\n${assetImageUrls.length} product image(s) are provided.` : ''}
${productImages.length > 0 ? `\n${productImages.length} uploaded image(s) provided.` : ''}

Write a concise, persuasive description (2-3 sentences) that highlights key features and benefits. Be professional and engaging.`;

                                  const res = await authFetch('/api/gemini?op=chat', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                      messages: [{ role: 'user', content: prompt }],
                                      model: 'gemini-2.0-flash',
                                    }),
                                  });

                                  const data = await res.json();
                                  if (data.response) {
                                    setProductDescription(data.response.trim());
                                  }
                                } catch (e: any) {
                                  console.error('Failed to generate description:', e);
                                  setProductError('Failed to generate description');
                                } finally {
                                  setIsGeneratingDescription(false);
                                }
                              }}
                              disabled={isCreatingProduct || isGeneratingDescription}
                              className={`absolute right-2 top-2 px-2 py-1 rounded-lg text-xs font-medium transition-colors ${isDarkMode
                                ? 'bg-[#635BFF]/20 text-[#635BFF] hover:bg-[#635BFF]/30'
                                : 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                                } disabled:opacity-50`}
                            >
                              {isGeneratingDescription ? '...' : ' Generate'}
                            </button>
                          </div>

                          {/* Product Images */}
                          <div>
                            <label className={`block text-xs font-medium mb-1.5 ${isDarkMode ? 'text-white/80' : 'text-gray-700'}`}>
                              Product Images (optional)
                            </label>
                            <div className="flex flex-wrap gap-2 items-center">
                              <label className={`cursor-pointer inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${isDarkMode
                                ? 'bg-[#111111] border-[#3d3d3f]/60 text-gray-300 hover:text-white hover:border-[#636366]'
                                : 'bg-white border-gray-300 text-gray-600 hover:text-gray-900 hover:border-gray-400'
                                }`}>
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Upload Cover Image
                                <input
                                  type="file"
                                  accept="image/*"
                                  className="hidden"
                                  onChange={(e) => {
                                    if (e.target.files && e.target.files.length > 0) {
                                      // Only allow single image for product cover
                                      setProductImages([e.target.files[0]]);
                                    }
                                  }}
                                />
                              </label>

                              <button
                                type="button"
                                onClick={() => {
                                  setSelectedProductAssetIds([]);
                                  setIsProductAssetPickerOpen(true);
                                }}
                                className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${isDarkMode
                                  ? 'bg-[#111111] border-[#3d3d3f]/60 text-gray-300 hover:text-white hover:border-[#636366]'
                                  : 'bg-white border-gray-300 text-gray-600 hover:text-gray-900 hover:border-gray-400'
                                  }`}
                              >
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14M4 6h16" />
                                </svg>
                                From Assets
                              </button>

                              {/* Uploaded files preview */}
                              {productImages.map((file, idx) => (
                                <div key={`file-${idx}`} className="relative group">
                                  <div className={`flex items-center gap-1 pl-1 pr-2 py-1 rounded-lg text-xs border ${isDarkMode ? 'bg-[#1d1d1f] border-[#3d3d3f] text-gray-300' : 'bg-gray-50 border-gray-200 text-gray-700'}`}>
                                    <span className="truncate max-w-[80px]">{file.name}</span>
                                    <button
                                      type="button"
                                      onClick={() => setProductImages(prev => prev.filter((_, i) => i !== idx))}
                                      className="ml-1 p-0.5 rounded-full hover:bg-black/10 dark:hover:bg-white/10 text-gray-400 hover:text-red-500"
                                    >
                                      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                      </svg>
                                    </button>
                                  </div>
                                </div>
                              ))}

                              {/* Selected assets preview */}
                              {selectedProductAssetIds.length > 0 && (
                                <span className={`text-xs ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                  +{selectedProductAssetIds.length} from assets
                                </span>
                              )}
                            </div>
                          </div>

                          {/* Price and Currency */}
                          <div className="flex gap-2">
                            <input
                              type="number"
                              placeholder="Price"
                              step="0.01"
                              min="0"
                              value={productPrice}
                              onChange={(e) => setProductPrice(e.target.value)}
                              disabled={isCreatingProduct}
                              className={`flex-1 text-sm rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-white border border-gray-300 text-gray-900 placeholder:text-gray-500'} disabled:opacity-50`}
                            />
                            <select
                              value={productCurrency}
                              onChange={(e) => setProductCurrency(e.target.value)}
                              disabled={isCreatingProduct}
                              className={`text-sm rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60 text-white' : 'bg-white border-gray-300 text-gray-900'} disabled:opacity-50`}
                            >
                              <option value="usd">USD</option>
                              <option value="eur">EUR</option>
                              <option value="gbp">GBP</option>
                              <option value="cad">CAD</option>
                            </select>
                          </div>

                          {/* Payment Link Options Toggle */}
                          <button
                            type="button"
                            onClick={() => setShowPaymentOptions(!showPaymentOptions)}
                            className={`w-full flex items-center justify-between py-2 px-3 rounded-lg text-xs font-medium transition-colors ${isDarkMode
                              ? 'bg-[#1d1d1f] text-gray-300 hover:text-white'
                              : 'bg-gray-100 text-gray-600 hover:text-gray-900'
                              }`}
                          >
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" />
                            </svg>
                            <span> Payment Link Options</span>
                            <svg className={`w-4 h-4 transition-transform ${showPaymentOptions ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                          </button>

                          {/* Payment Options Panel */}
                          {showPaymentOptions && (
                            <div className={`p-3 rounded-lg space-y-4 ${isDarkMode ? 'bg-[#1d1d1f]' : 'bg-gray-50'}`}>
                              {/* Custom Fields Section */}
                              <div>
                                <div className="flex items-center justify-between mb-2">
                                  <label className={`text-xs font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Custom Fields
                                  </label>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const newField = {
                                        id: `field-${Date.now()}`,
                                        key: `custom_${customFields.length + 1}`,
                                        label: '',
                                        type: 'text' as const
                                      };
                                      setCustomFields([...customFields, newField]);
                                    }}
                                    className="text-xs px-2 py-1 rounded bg-[#0071e3] text-white hover:bg-[#0077ED] transition-colors"
                                  >
                                    + Add Field
                                  </button>
                                </div>

                                {customFields.length === 0 ? (
                                  <p className={`text-xs ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                    No custom fields added
                                  </p>
                                ) : (
                                  <div className="space-y-2">
                                    {customFields.map((field, index) => (
                                      <div key={field.id} className={`p-2 rounded border ${isDarkMode ? 'border-[#3d3d3f] bg-[#111111]' : 'border-gray-200 bg-white'}`}>
                                        <div className="flex items-start gap-2 mb-2">
                                          <div className="flex-1">
                                            <input
                                              type="text"
                                              placeholder="Field Key (e.g., size, color)"
                                              value={field.key}
                                              onChange={(e) => {
                                                const updated = [...customFields];
                                                updated[index].key = e.target.value;
                                                setCustomFields(updated);
                                              }}
                                              className={`w-full text-xs px-2 py-1 rounded mb-1 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f] text-white' : 'bg-white border border-gray-300 text-gray-900'}`}
                                            />
                                            <input
                                              type="text"
                                              placeholder="Field Label (shown to customer)"
                                              value={field.label}
                                              onChange={(e) => {
                                                const updated = [...customFields];
                                                updated[index].label = e.target.value;
                                                setCustomFields(updated);
                                              }}
                                              className={`w-full text-xs px-2 py-1 rounded ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f] text-white' : 'bg-white border border-gray-300 text-gray-900'}`}
                                            />
                                          </div>
                                          <select
                                            value={field.type}
                                            onChange={(e) => {
                                              const updated = [...customFields];
                                              updated[index].type = e.target.value as 'text' | 'numeric';
                                              setCustomFields(updated);
                                            }}
                                            className={`text-xs px-2 py-1 rounded ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f] text-white' : 'bg-white border border-gray-300 text-gray-900'}`}
                                          >
                                            <option value="text">Text</option>
                                            <option value="numeric">Numeric</option>
                                          </select>
                                          <button
                                            type="button"
                                            onClick={() => {
                                              setCustomFields(customFields.filter(f => f.id !== field.id));
                                            }}
                                            className="text-red-500 hover:text-red-600 text-xs p-1"
                                          >
                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                          </button>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>

                              {/* Quantity Settings Section */}
                              <div className={`pt-3 border-t ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                                <div className="flex items-center justify-between mb-2">
                                  <label className={`text-xs font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                    Allow Quantity Adjustment
                                  </label>
                                  <button
                                    type="button"
                                    onClick={() => setQuantityEnabled(!quantityEnabled)}
                                    className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${quantityEnabled ? 'bg-[#0071e3]' : isDarkMode ? 'bg-[#3d3d3f]' : 'bg-gray-300'
                                      }`}
                                  >
                                    <span
                                      className={`inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${quantityEnabled ? 'translate-x-5' : 'translate-x-1'
                                        }`}
                                    />
                                  </button>
                                </div>

                                {quantityEnabled && (
                                  <div className="grid grid-cols-2 gap-2 mt-2">
                                    <div>
                                      <label className={`block text-xs mb-1 ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                        Minimum
                                      </label>
                                      <input
                                        type="number"
                                        min="1"
                                        value={quantityMin}
                                        onChange={(e) => setQuantityMin(e.target.value)}
                                        className={`w-full text-xs px-2 py-1 rounded ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f] text-white' : 'bg-white border border-gray-200 text-gray-900'}`}
                                      />
                                    </div>
                                    <div>
                                      <label className={`block text-xs mb-1 ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                        Maximum
                                      </label>
                                      <input
                                        type="number"
                                        min="1"
                                        value={quantityMax}
                                        onChange={(e) => setQuantityMax(e.target.value)}
                                        className={`w-full text-xs px-2 py-1 rounded ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f] text-white' : 'bg-white border border-gray-200 text-gray-900'}`}
                                      />
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          <button
                            onClick={async () => {
                              if (!productName.trim() || !productPrice || parseFloat(productPrice) <= 0) {
                                setProductError('Please enter a valid product name and price');
                                return;
                              }

                              setIsCreatingProduct(true);
                              setProductError(null);
                              setProductSaveMessage(null);

                              try {
                                let imageUrl: string | undefined;

                                // Upload product image if one is selected
                                if (productImages.length > 0) {
                                  try {
                                    const { upload } = await import('@vercel/blob/client');
                                    const imageFile = productImages[0];
                                    const imagePath = `products/${userProfile.stripeConnect?.accountId}/${Date.now()}_${imageFile.name}`;

                                    const blob = await upload(imagePath, imageFile, {
                                      access: 'public',
                                      handleUploadUrl: '/api/media?op=upload-token'
                                    });

                                    imageUrl = blob.url;
                                  } catch (uploadError) {
                                    console.error('Failed to upload product image:', uploadError);
                                    setProductError('Failed to upload product image. Product will be created without an image.');
                                    // Continue creating product even if image upload fails
                                  }
                                }

                                const res = await authFetch('/api/stripe?op=create-product', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({
                                    accountId: userProfile.stripeConnect?.accountId,
                                    name: productName.trim(),
                                    description: productDescription.trim() || undefined,
                                    price: parseFloat(productPrice),
                                    currency: productCurrency,
                                    images: imageUrl ? [imageUrl] : undefined,
                                  }),
                                });

                                const data = await res.json();

                                if (data.error) {
                                  throw new Error(data.error);
                                }

                                // Save product to project
                                const newProduct: StripeProduct = {
                                  id: data.id,
                                  name: data.name,
                                  description: data.description || undefined,
                                  priceId: data.priceId,
                                  active: true,
                                  unitAmount: data.unitAmount,
                                  currency: data.currency,
                                  createdAt: Date.now(),
                                  images: (data.images && data.images.length > 0) ? data.images : (imageUrl ? [imageUrl] : []),
                                  paymentLinkUrl: undefined,
                                  customFields: customFields.map(f => ({ key: f.key, label: f.label, type: f.type })),
                                  quantityOptions: quantityEnabled ? {
                                    enabled: true,
                                    minimum: parseInt(quantityMin) || 1,
                                    maximum: parseInt(quantityMax) || 10,
                                  } : undefined,
                                };

                                const updatedProducts = [...(project.stripeProducts || []), newProduct];
                                const updatedProject = { ...project, stripeProducts: updatedProducts };

                                await storageService.updateResearchProject(project.id, { stripeProducts: updatedProducts });
                                onProjectUpdate?.(updatedProject);
                                setStripeProducts(prev => [...prev, newProduct]);

                                // Clear form
                                setProductName('');
                                setProductDescription('');
                                setProductPrice('');
                                setProductImages([]);
                                setSelectedProductAssetIds([]);
                                setProductSaveMessage('Product created successfully!');

                                setTimeout(() => setProductSaveMessage(null), 3000);
                              } catch (e: any) {
                                console.error('Failed to create product:', e);
                                setProductError(e?.message || 'Failed to create product');
                              } finally {
                                setIsCreatingProduct(false);
                              }
                            }}
                            disabled={isCreatingProduct || !productName.trim() || !productPrice}
                            className="w-full py-2 px-4 rounded-xl text-sm font-medium bg-[#0071e3] text-white hover:bg-[#0077ED] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                          >
                            {isCreatingProduct ? (
                              <>
                                <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <circle cx="12" cy="12" r="10" className="opacity-25" />
                                  <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                </svg>
                                Creating...
                              </>
                            ) : (
                              'Create Product'
                            )}
                          </button>
                        </div>
                      </div>
                    )}


                  </div>
                ) : (
                  /* Connect Account Button */
                  <div className="space-y-3">
                    <div className="space-y-1">
                      <label className={`text-xs font-medium ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Country
                      </label>
                      <select
                        value={selectedStripeCountry}
                        onChange={(e) => setSelectedStripeCountry(e.target.value)}
                        className={`w-full p-2 rounded-lg text-sm border ${isDarkMode
                          ? 'bg-[#1c1c1e] border-[#3d3d3f] text-white'
                          : 'bg-white border-gray-200 text-gray-900'
                          } focus:outline-none focus:ring-2 focus:ring-[#635BFF]/50`}
                      >
                        {STRIPE_COUNTRIES.map((country) => (
                          <option key={country.code} value={country.code}>
                            {country.name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <button
                      onClick={async () => {
                        try {
                          // Create a new Stripe Connect account
                          const res = await authFetch('/api/stripe?op=create-account', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                              email: userProfile?.email || '',
                              country: selectedStripeCountry,
                            }),
                          });
                          const data = await res.json();

                          if (data.accountId) {
                            // Save to user profile
                            await storageService.updateUserProfile({
                              stripeConnect: {
                                accountId: data.accountId,
                                chargesEnabled: data.chargesEnabled || false,
                                payoutsEnabled: data.payoutsEnabled || false,
                                detailsSubmitted: data.detailsSubmitted || false,
                                createdAt: Date.now(),
                              },
                            });

                            // Create onboarding link and redirect
                            const linkRes = await authFetch('/api/stripe?op=create-account-link', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                accountId: data.accountId,
                                returnUrl: window.location.href,
                                refreshUrl: window.location.href,
                              }),
                            });
                            const linkData = await linkRes.json();

                            if (linkData.url) {
                              window.location.href = linkData.url;
                            }
                          }
                        } catch (e) {
                          console.error('Failed to create Stripe account:', e);
                        }
                      }}
                      className="w-full py-3 px-4 rounded-xl text-sm font-medium bg-[#635BFF] text-white hover:bg-[#5851db] transition-colors flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.165 0 9.667 0 7.589.654 6.104 1.872 4.56 3.147 3.757 4.992 3.757 7.218c0 4.039 2.467 5.76 6.476 7.219 2.585.92 3.445 1.574 3.445 2.583 0 .98-.84 1.545-2.354 1.545-1.875 0-4.965-.921-6.99-2.109l-.9 5.555C5.175 22.99 8.385 24 11.714 24c2.641 0 4.843-.624 6.328-1.813 1.664-1.305 2.525-3.236 2.525-5.732 0-4.128-2.524-5.851-6.591-7.305z" />
                      </svg>
                      Connect with Stripe
                    </button>
                  </div>
                )}
              </div>
            </div >
          )
        }

        {/* Type-grouped Asset Grid - For "All" tab */}
        {
          filterType === 'all' &&
          assetsByType.length > 0 && (
            <div className="mt-4 space-y-4">
              {assetsByType.map(({ key, label, icon, assets }, groupIndex) => {
                const isExpanded = expandedSessions.has(key);
                const visibleAssets = isExpanded ? assets : [];

                // Get group color from palette
                const fallbackColor = getSessionColor(groupIndex);
                const isGridView = true; // All tab always uses grid view

                // Helper to check if asset has visual preview
                const hasVisualPreview = (asset: AssetItem) => {
                  if (asset.type === 'book') return true; // PDFs always have a visual preview area
                  if (!asset.url && asset.type !== 'product') return false;
                  const visualTypes = ['header', 'slide', 'notemap', 'social'];
                  if (visualTypes.includes(asset.type)) return true;
                  if (asset.type === 'video') return true;
                  if (asset.type === 'product' && (asset.data as StripeProduct)?.images?.[0]) return true;
                  return false;
                };

                // Get preview URL for asset
                const getPreviewUrl = (asset: AssetItem): string | null => {
                  if (asset.type === 'book') {
                    const book = asset.data as BookAsset;
                    if (book?.pages?.[0]?.imageUrl) return book.pages[0].imageUrl;
                    return null; // Interactive PDFs will fall back to iframe or icon
                  }
                  if (asset.type === 'product' && (asset.data as StripeProduct)?.images?.[0]) {
                    return (asset.data as StripeProduct).images[0];
                  }
                  return asset.url || null;
                };

                return (
                  <div
                    key={key}
                    className={`rounded-2xl border-l-4 ${fallbackColor.border} ${isDarkMode
                      ? `border border-l-4 border-[#3d3d3f]/60 ${fallbackColor.bgDark} p-3 sm:p-4`
                      : `border border-l-4 border-gray-200 ${fallbackColor.bg} p-3 sm:p-4`
                      }`}
                  >

                    <button
                      type="button"
                      onClick={() => toggleSession(key)}
                      className={
                        isDarkMode
                          ? 'w-full flex items-center justify-between gap-2 mb-3 px-2 py-1.5 rounded-xl hover:bg-white/5 transition-colors'
                          : 'w-full flex items-center justify-between gap-2 mb-3 px-2 py-1.5 rounded-xl hover:bg-white/50 transition-colors'
                      }
                    >
                      <div className="flex items-center gap-2 min-w-0 text-left">
                        <span className={
                          isDarkMode
                            ? 'text-sm font-semibold text-white truncate'
                            : 'text-sm font-semibold text-gray-900 truncate'
                        }>
                          {icon} {label}
                        </span>
                        <span className={`px-2 py-0.5 rounded-full text-[10px] font-medium ${isDarkMode ? 'bg-white/10 text-white/70' : 'bg-black/5 text-gray-600'
                          }`}>
                          {assets.length}
                        </span>

                      </div>
                      <div className="flex items-center gap-1 flex-shrink-0 text-[11px]">
                        <span className={
                          isDarkMode ? 'text-[#0a84ff]' : 'text-[#0a84ff]'
                        }>
                          {isExpanded ? 'Collapse' : 'Expand'}
                        </span>
                        <svg
                          className={
                            isExpanded
                              ? 'w-4 h-4 text-[#0a84ff] transform rotate-90 transition-transform'
                              : 'w-4 h-4 text-[#0a84ff] transform transition-transform'
                          }
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fillRule="evenodd"
                            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                            clipRule="evenodd"
                          />
                        </svg>
                      </div>
                    </button>

                    {/* Grid layout for 'all' filter, horizontal scroll for others */}
                    {isGridView ? (
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
                        {visibleAssets.map(asset => (
                          <div
                            key={asset.id}
                            role="button"
                            tabIndex={0}
                            onClick={() => handleAssetClick(asset)}
                            className={`group rounded-xl overflow-hidden cursor-pointer transition-all hover:scale-[1.02] ${isDarkMode
                              ? 'bg-black/20 border border-[#3d3d3f]/70 hover:border-[#636366]'
                              : 'bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md'
                              }`}
                          >
                            {/* Thumbnail / Icon Area */}
                            <div className={`aspect-square relative overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f]' : 'bg-gray-100'
                              }`}>
                              {hasVisualPreview(asset) ? (
                                <>
                                  {asset.type === 'video' ? (
                                    <>
                                      <video
                                        src={asset.url || ''}
                                        className="w-full h-full object-cover"
                                        preload="metadata"
                                        muted
                                        playsInline
                                        onLoadedMetadata={(e) => {
                                          // Seek to 0.1s to get a good thumbnail frame
                                          (e.target as HTMLVideoElement).currentTime = 0.1;
                                        }}
                                      />
                                      <div className="absolute inset-0 flex items-center justify-center bg-black/40">
                                        <div className="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                          <svg className="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M8 5v14l11-7z" />
                                          </svg>
                                        </div>
                                      </div>
                                    </>
                                  ) : asset.type === 'book' && (asset.data as BookAsset)?.isInteractive && !((asset.data as BookAsset)?.pages?.[0]?.imageUrl) ? (
                                    /* Interactive PDF Placeholder Thumbnail */
                                    <div className={`w-full h-full flex flex-col items-center justify-center p-4 text-center ${isDarkMode ? 'bg-gradient-to-br from-indigo-500/20 to-purple-500/20' : 'bg-gradient-to-br from-indigo-50 to-purple-50'}`}>
                                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-2 ${isDarkMode ? 'bg-indigo-500/40 text-white' : 'bg-indigo-600 text-white'}`}>
                                        <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                      </div>
                                      <span className={`text-[10px] font-bold uppercase tracking-widest ${isDarkMode ? 'text-indigo-400' : 'text-indigo-700'}`}>Interactive PDF</span>
                                    </div>
                                  ) : (
                                    <img
                                      src={getPreviewUrl(asset) || ''}
                                      alt={asset.title || 'Asset preview'}
                                      className="w-full h-full object-cover"
                                    />
                                  )}
                                </>
                              ) : (
                                <div className={`w-full h-full flex flex-col items-center justify-center ${getTypeColor(asset.type)}`}>
                                  <div className="w-16 h-16 rounded-2xl flex items-center justify-center bg-current/20">
                                    <span className="scale-150">{getTypeIcon(asset.type)}</span>
                                  </div>
                                  <span className="mt-2 text-[10px] font-medium uppercase tracking-wide opacity-70">
                                    {asset.type}
                                  </span>
                                </div>
                              )}
                              {/* Removed old absolute website buttons */}
                              {/* Mobile Action Toggle */}
                              <button
                                type="button"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setMobileMenuAssetId(mobileMenuAssetId === asset.id ? null : asset.id);
                                }}
                                className="sm:hidden absolute bottom-2 right-2 p-3 rounded-full bg-black/50 text-white z-20"
                              >
                                <svg className={`w-6 h-6 transition-transform ${mobileMenuAssetId === asset.id ? 'rotate-45' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                              </button>

                              {/* Desktop Hover / Mobile Menu Overlay Buttons */}
                              <div className={`absolute top-2 right-2 flex flex-row-reverse items-center gap-1.5 transition-opacity ${mobileMenuAssetId === asset.id ? '!opacity-100 z-10' : 'opacity-0 group-hover:opacity-100'}`}>
                                {/* Delete button */}
                                <button
                                  type="button"
                                  onClick={e => {
                                    e.stopPropagation();
                                    handleDeleteAsset(asset.id);
                                  }}
                                  className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-red-500/80 transition-colors"
                                  aria-label="Delete asset"
                                >
                                  <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>

                                {/* Edit Image button overlay (for images only) */}
                                {(['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) && !asset.type.startsWith('video') && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleEditImage(asset);
                                    }}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-emerald-500/80 transition-colors"
                                    title="Edit Image (Use as Reference)"
                                  >
                                    <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                  </button>
                                )}

                                {/* Share button */}
                                {onShareToX && (
                                  ['video', 'header', 'slide', 'notemap', 'social'].includes(asset.type) ||
                                  asset.type.startsWith('video/') ||
                                  asset.type.startsWith('image/')
                                ) && (
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        onShareToX(asset);
                                      }}
                                      className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors"
                                      title="Share to Social"
                                    >
                                      <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                      </svg>
                                    </button>
                                  )}

                                {/* Generate Video button overlay (for images only) */}
                                {((['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) && !asset.type.startsWith('video')) && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleGenerateVideoFromImage(asset);
                                    }}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-purple-500/80 transition-colors"
                                    title="Generate Video (Sora/Veo)"
                                  >
                                    <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                  </button>
                                )}

                                {/* Download PDF Button */}
                                {asset.type === 'book' && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleDownloadBookPdf(asset);
                                    }}
                                    disabled={downloadingBookPdf === asset.id}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors disabled:opacity-50 disabled:cursor-wait"
                                    title="Download PDF"
                                  >
                                    {downloadingBookPdf === asset.id ? (
                                      <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <circle cx="12" cy="12" r="10" strokeWidth="4" className="opacity-25" />
                                        <path d="M4 12a8 8 0 018-8" strokeWidth="4" className="opacity-75" />
                                      </svg>
                                    ) : (
                                      <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                      </svg>
                                    )}
                                  </button>
                                )}

                                {/* Pin button (Swapped position) */}
                                <button
                                  type="button"
                                  onClick={e => handleTogglePin(asset.id, e)}
                                  className={`p-2 sm:p-1.5 rounded-full transition-colors ${(project.pinnedAssetIds || []).includes(asset.id)
                                    ? 'bg-amber-500/80 text-white hover:bg-amber-600/80'
                                    : 'bg-black/60 text-white/70 hover:text-white hover:bg-amber-500/80'
                                    }`}
                                  aria-label={(project.pinnedAssetIds || []).includes(asset.id) ? 'Unpin asset' : 'Pin asset'}
                                  title={(project.pinnedAssetIds || []).includes(asset.id) ? 'Unpin' : 'Pin to top'}
                                >
                                  <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill={(project.pinnedAssetIds || []).includes(asset.id) ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                                  </svg>
                                </button>

                                {/* Edit Blog button overlay */}
                                {asset.type === 'blog' && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleEditBlog(asset);
                                    }}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors"
                                    title="Edit Blog"
                                  >
                                    <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                  </button>
                                )}

                                {asset.type === 'blog' && onShareToX && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      onShareToX(asset);
                                    }}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-green-500/80 transition-colors"
                                    title="Share Blog"
                                  >
                                    <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                    </svg>
                                  </button>
                                )}


                                {/* Custom Domain button for websites and leadforms */}
                                {(asset.type === 'website' || asset.type === 'leadform') && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleOpenCustomDomainModal(asset);
                                    }}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-purple-500/80 transition-colors"
                                    title="Custom Domain"
                                  >
                                    <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                                    </svg>
                                  </button>
                                )}

                                {/* Website/Form Link Button */}
                                {(asset.type === 'website' || asset.type === 'leadform') && (
                                  <button
                                    type="button"
                                    onClick={e => {
                                      if (asset.type === 'website') handleShareWebsite(asset, e);
                                      // Leads forms are auto-shared on creation, but we can copy the link
                                      if (asset.type === 'leadform') {
                                        e.stopPropagation();
                                        const data = asset.data as any;
                                        if (data?.publicUrl) {
                                          navigator.clipboard.writeText(data.publicUrl);
                                          // Could add toast here
                                        }
                                      }
                                    }}
                                    disabled={websiteShareLoading === asset.id}
                                    className={`p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors ${websiteShareLoading === asset.id ? 'opacity-100 cursor-wait' : ''}`}
                                    aria-label="Copy Link"
                                    title="Copy Link"
                                  >
                                    {websiteShareLoading === asset.id ? (
                                      <svg className="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <circle cx="12" cy="12" r="10" className="opacity-25" />
                                        <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                      </svg>
                                    ) : (
                                      <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                      </svg>
                                    )}
                                  </button>
                                )}

                                {/* Website Download Button */}
                                {asset.type === 'website' && (
                                  <button
                                    type="button"
                                    onClick={e => handleDownloadWebsite(asset, e)}
                                    className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-green-500/80 transition-colors"
                                    aria-label="Download website"
                                    title="Download HTML"
                                  >
                                    <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                  </button>
                                )}

                                {/* Product buttons: Copy Payment Link and View Orders */}
                                {asset.type === 'product' && (
                                  <>
                                    <button
                                      type="button"
                                      onClick={async (e) => {
                                        e.stopPropagation();
                                        const productData = asset.data as StripeProduct;
                                        if (!productData?.priceId) return;

                                        setCreatingPaymentLink(productData.id);
                                        try {
                                          const res = await authFetch('/api/stripe?op=create-payment-link', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                              accountId: userProfile?.stripeConnect?.accountId,
                                              priceId: productData.priceId,
                                              customFields: productData.customFields || [],
                                              quantityOptions: productData.quantityOptions,
                                            }),
                                          });
                                          const data = await res.json();
                                          if (data.url) {
                                            navigator.clipboard.writeText(data.url);
                                            alert('Payment link copied to clipboard!');

                                            // Persist payment link
                                            try {
                                              const updatedProducts = (project.stripeProducts || []).map(p =>
                                                p.id === productData.id ? { ...p, paymentLinkUrl: data.url } : p
                                              );
                                              await storageService.updateResearchProject(project.id, { stripeProducts: updatedProducts });
                                              onProjectUpdate?.({ ...project, stripeProducts: updatedProducts });
                                            } catch (persistError) {
                                              console.error('Failed to persist payment link:', persistError);
                                            }
                                          }
                                        } catch (err) {
                                          console.error('Failed to create payment link:', err);
                                          alert('Failed to create payment link');
                                        } finally {
                                          setCreatingPaymentLink(null);
                                        }
                                      }}
                                      disabled={creatingPaymentLink === (asset.data as StripeProduct)?.id}
                                      className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-green-500/80 transition-colors disabled:opacity-50"
                                      title="Copy Payment Link"
                                    >
                                      <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                      </svg>
                                    </button>
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        const productData = asset.data as StripeProduct;
                                        if (!productData?.priceId) return;

                                        if (expandedProductOrders === productData.id) {
                                          setExpandedProductOrders(null);
                                        } else {
                                          setExpandedProductOrders(productData.id);
                                          fetchOrders(productData.id, productData.priceId);
                                        }
                                      }}
                                      className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors"
                                      title="View Orders"
                                    >
                                      <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                      </svg>
                                    </button>
                                  </>
                                )}
                              </div>
                            </div>
                            {/* Title Area */}
                            <div className="p-2 sm:p-2.5">
                              <div className="flex items-start justify-between gap-1">
                                <p className={`text-xs font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'
                                  }`}>
                                  {asset.title}
                                </p>
                              </div>
                              <p className={`text-[10px] truncate mt-0.5 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                {formatDate(asset.timestamp)}
                              </p>

                              {/* View Orders button for products */}
                              {asset.type === 'product' && (
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const productData = asset.data as StripeProduct;
                                    if (!productData?.priceId) return;

                                    if (expandedProductOrders === productData.id) {
                                      setExpandedProductOrders(null);
                                    } else {
                                      setExpandedProductOrders(productData.id);
                                      fetchOrders(productData.id, productData.priceId);
                                    }
                                  }}
                                  className={`w-full mt-2 px-2 py-1 rounded text-xs font-medium transition-colors ${isDarkMode
                                    ? 'bg-[#0071e3] hover:bg-[#0077ED] text-white'
                                    : 'bg-[#0071e3] hover:bg-[#0077ED] text-white'
                                    }`}
                                >
                                   View Orders
                                </button>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      /* Original horizontal scroll layout for filtered views */
                      <div className="overflow-x-auto">
                        <div className="flex items-stretch gap-2.5 min-w-0">
                          {visibleAssets.map(asset => (
                            <div
                              key={asset.id}
                              role="button"
                              tabIndex={0}
                              onClick={() => handleAssetClick(asset)}
                              className={
                                isDarkMode
                                  ? 'flex items-start gap-2.5 p-2.5 rounded-xl border border-[#3d3d3f]/70 hover:border-[#636366] hover:bg-black/20 transition-colors flex-shrink-0 min-w-[220px] max-w-[260px]'
                                  : 'flex items-start gap-2.5 p-2.5 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors flex-shrink-0 min-w-[220px] max-w-[260px]'
                              }
                            >
                              {(
                                (asset.type === 'header' ||
                                  asset.type === 'slide' ||
                                  asset.type === 'notemap' ||
                                  asset.type === 'social') &&
                                asset.url
                              ) ? (
                                <div
                                  className={
                                    isDarkMode
                                      ? 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-white/10 bg-black/40'
                                      : 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-black/10 bg-gray-100'
                                  }
                                >
                                  <img
                                    src={asset.url}
                                    alt={asset.title || asset.researchTopic || 'Asset image'}
                                    className="w-full h-full object-cover"
                                  />
                                </div>
                              ) : (asset.type === 'video' || asset.type.startsWith('video/')) && asset.url ? (
                                <div
                                  className={
                                    isDarkMode
                                      ? 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-white/10 bg-black/40'
                                      : 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-black/10 bg-gray-100'
                                  }
                                >
                                  <video
                                    src={asset.url}
                                    className="w-full h-full object-cover pointer-events-none"
                                    muted
                                    playsInline
                                  />
                                </div>
                              ) : asset.type === 'product' && ((asset.data as StripeProduct)?.images?.[0] || asset.url) ? (
                                <div
                                  className={
                                    isDarkMode
                                      ? 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-white/10 bg-black/40'
                                      : 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-black/10 bg-gray-100'
                                  }
                                >
                                  <img
                                    src={(asset.data as StripeProduct).images?.[0] || asset.url}
                                    alt={asset.title || 'Product image'}
                                    className="w-full h-full object-cover"
                                  />
                                </div>
                              ) : asset.type === 'book' ? (
                                <div
                                  className={
                                    isDarkMode
                                      ? 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-white/10 bg-black/40 flex items-center justify-center'
                                      : 'flex-shrink-0 w-10 h-10 rounded-lg overflow-hidden border border-black/10 bg-gray-100 flex items-center justify-center'
                                  }
                                >
                                  {(asset.data as BookAsset)?.pages?.[0]?.imageUrl ? (
                                    <img
                                      src={(asset.data as BookAsset).pages[0].imageUrl}
                                      alt={asset.title}
                                      className="w-full h-full object-cover"
                                    />
                                  ) : (
                                    <svg className={`w-5 h-5 ${isDarkMode ? 'text-indigo-400' : 'text-indigo-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                  )}
                                </div>
                              ) : (
                                <span
                                  className={`flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center ${getTypeColor(
                                    asset.type,
                                  )}`}
                                >
                                  {getTypeIcon(asset.type)}
                                </span>
                              )}
                              <div className="flex-1 min-w-0 text-left">
                                <div className="flex items-center justify-between gap-1">
                                  <p
                                    className={
                                      isDarkMode
                                        ? 'text-xs font-medium text-white truncate'
                                        : 'text-xs font-medium text-gray-900 truncate'
                                    }
                                  >
                                    {asset.title}
                                  </p>
                                  <span
                                    className={
                                      isDarkMode
                                        ? 'text-[10px] text-[#636366] flex-shrink-0'
                                        : 'text-[10px] text-gray-500 flex-shrink-0'
                                    }
                                  >
                                    {formatDate(asset.timestamp)}
                                  </span>
                                  {asset.type === 'website' && (
                                    <>
                                      <button
                                        type="button"
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleOpenCustomDomainModal(asset);
                                        }}
                                        className={
                                          isDarkMode
                                            ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                            : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                        }
                                        title="Custom Domain"
                                      >
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                                        </svg>
                                      </button>
                                      <button
                                        type="button"
                                        onClick={e => handleShareWebsite(asset, e)}
                                        disabled={websiteShareLoading === asset.id}
                                        className={
                                          isDarkMode
                                            ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                            : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                        }
                                        title="Copy Link"
                                      >
                                        {websiteShareLoading === asset.id ? (
                                          <svg className="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <circle cx="12" cy="12" r="10" className="opacity-25" />
                                            <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                          </svg>
                                        ) : (
                                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                          </svg>
                                        )}
                                      </button>
                                      <button
                                        type="button"
                                        onClick={e => handleDownloadWebsite(asset, e)}
                                        className={
                                          isDarkMode
                                            ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                            : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                        }
                                        title="Download HTML"
                                      >
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                      </button>
                                    </>
                                  )}
                                  {onShareToX && (
                                    ['blog', 'video', 'header', 'slide', 'notemap', 'social'].includes(asset.type) ||
                                    asset.type.startsWith('video/') ||
                                    asset.type.startsWith('image/')
                                  ) && (
                                      <button
                                        type="button"
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          onShareToX(asset);
                                        }}
                                        className={
                                          isDarkMode
                                            ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                            : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                        }
                                        title="Share to Social"
                                      >
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                        </svg>
                                      </button>
                                    )}
                                  {((['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) && !asset.type.startsWith('video')) && (
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleEditImage(asset);
                                      }}
                                      className={
                                        isDarkMode
                                          ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                          : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                      }
                                      title="Edit Image (Use as Reference)"
                                    >
                                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                      </svg>
                                    </button>
                                  )}
                                  {asset.type === 'blog' && (
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleEditBlog(asset);
                                      }}
                                      className={
                                        isDarkMode
                                          ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                          : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                      }
                                      title="Edit Blog"
                                    >
                                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                      </svg>
                                    </button>
                                  )}

                                  {((['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) && !asset.type.startsWith('video')) && (
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleGenerateVideoFromImage(asset);
                                      }}
                                      className={
                                        isDarkMode
                                          ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-white hover:bg-white/10'
                                          : 'ml-1 p-1 rounded-full text-gray-400 hover:text-gray-900 hover:bg-gray-100'
                                      }
                                      title="Generate Video (Sora/Veo)"
                                    >
                                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                      </svg>
                                    </button>
                                  )}

                                  <button
                                    type="button"
                                    onClick={e => {
                                      e.stopPropagation();
                                      handleDeleteAsset(asset.id);
                                    }}
                                    className={
                                      isDarkMode
                                        ? 'ml-1 p-1 rounded-full text-[#636366] hover:text-red-400 hover:bg-red-500/10'
                                        : 'ml-1 p-1 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50'
                                    }
                                    aria-label="Delete asset"
                                  >
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path
                                        strokeLinecap="round"
                                        strokeLinejoin="round"
                                        strokeWidth={2}
                                        d="M6 7h12M10 11v6m4-6v6M9 7l1-2h4l1 2m-1 13H9a2 2 0 01-2-2V7h10v11a2 2 0 01-2 2z"
                                      />
                                    </svg>
                                  </button>
                                </div>
                                {asset.type === 'product' ? (
                                  <div className="space-y-1">
                                    <p className={`text-xs font-semibold ${isDarkMode ? 'text-[#0071e3]' : 'text-[#0071e3]'}`}>
                                      ${((asset.data as StripeProduct)?.unitAmount / 100).toFixed(2)} {((asset.data as StripeProduct)?.currency || 'USD').toUpperCase()}
                                    </p>

                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        const productData = asset.data as StripeProduct;
                                        if (!productData?.priceId) return;

                                        if (expandedProductOrders === productData.id) {
                                          setExpandedProductOrders(null);
                                        } else {
                                          setExpandedProductOrders(productData.id);
                                          fetchOrders(productData.id, productData.priceId);
                                        }
                                      }}
                                      className={`text-[10px] font-medium px-2 py-1 rounded ${isDarkMode
                                        ? 'bg-[#0071e3] hover:bg-[#0077ED] text-white'
                                        : 'bg-[#0071e3] hover:bg-[#0077ED] text-white'
                                        }`}
                                    >
                                       View Orders
                                    </button>
                                  </div>
                                ) : (
                                  <p
                                    className={
                                      isDarkMode
                                        ? 'text-[11px] text-[#86868b] truncate'
                                        : 'text-[11px] text-gray-600 truncate'
                                    }
                                  >
                                    {asset.researchTopic}
                                  </p>
                                )}
                                {asset.description && (
                                  <p
                                    className={
                                      isDarkMode
                                        ? 'mt-0.5 text-[11px] text-[#86868b] line-clamp-4'
                                        : 'mt-0.5 text-[11px] text-gray-600 line-clamp-4'
                                    }
                                  >
                                    {asset.description}
                                  </p>
                                )}
                                {asset.type === 'book' && ((asset.data as BookAsset)?.pages?.length || (asset.data as BookAsset)?.isInteractive) && (
                                  <div className="mt-1">
                                    <button
                                      type="button"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleDownloadBookPdf(asset);
                                      }}
                                      disabled={downloadingBookPdf === asset.id}
                                      className={
                                        isDarkMode
                                          ? 'text-[11px] text-[#0a84ff] hover:underline disabled:opacity-50 inline-flex items-center gap-1'
                                          : 'text-[11px] text-[#0071e3] hover:underline disabled:opacity-50 inline-flex items-center gap-1'
                                      }
                                    >
                                      {downloadingBookPdf === asset.id ? (
                                        <>
                                          <svg className="w-3 h-3 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <circle cx="12" cy="12" r="10" className="opacity-25" />
                                            <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                          </svg>
                                          <span>Generating...</span>
                                        </>
                                      ) : (
                                        'Download PDF'
                                      )}
                                    </button>
                                  </div>
                                )}


                                {/* Product Orders List */}
                                {asset.type === 'product' && expandedProductOrders === asset.id && (
                                  <div className={`mt-3 pt-3 border-t ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                                    {(!productOrders[asset.id] || productOrders[asset.id].length === 0) ? (
                                      <p className={`text-xs ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                        {loadingOrders ? 'Loading orders...' : 'No orders found yet.'}
                                      </p>
                                    ) : (
                                      <>
                                        <div className="flex items-center justify-between mb-2">
                                          <p className={`text-xs font-medium ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                            {productOrders[asset.id].length} {productOrders[asset.id].length === 1 ? 'Order' : 'Orders'}
                                          </p>
                                          <button
                                            type="button"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleEmailAllCustomers();
                                            }}
                                            className={`px-2.5 py-1 rounded-lg text-[11px] font-semibold flex items-center gap-1.5 transition-colors ${isDarkMode
                                              ? 'bg-[#0071e3]/10 text-[#0071e3] hover:bg-[#0071e3]/20'
                                              : 'bg-blue-50 text-blue-600 hover:bg-blue-100'
                                              }`}
                                          >
                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            Email All Customers
                                          </button>
                                        </div>
                                        <div className="space-y-2">
                                          {productOrders[asset.id].map(order => (
                                            <div key={order.id} className={`flex items-center justify-between p-2 rounded-lg ${isDarkMode ? 'bg-[#1d1d1f]' : 'bg-gray-50'}`}>
                                              <div className="min-w-0 flex-1 mr-2">
                                                <p className={`text-xs font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                                  {order.customerName || 'Customer'}
                                                </p>
                                                <p className={`text-[10px] truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                                  {order.customerEmail}
                                                </p>
                                              </div>
                                              <div className="flex items-center gap-2">
                                                <span className={`text-[10px] font-medium px-1.5 py-0.5 rounded ${isDarkMode ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700'}`}>
                                                  Paid
                                                </span>
                                                <button
                                                  onClick={async (e) => {
                                                    e.stopPropagation();
                                                    const isConnected = emailProvider === 'gmail' ? gmailConnected : outlookConnected;
                                                    if (!isConnected) {
                                                      alert(`Please connect your ${emailProvider === 'gmail' ? 'Gmail' : 'Outlook'} account first.`);
                                                      return;
                                                    }
                                                    if (!confirm(`Send email to ${order.customerEmail}?`)) return;

                                                    try {
                                                      await authFetch(`/api/email?op=send&provider=${emailProvider}`, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({
                                                          to: order.customerEmail,
                                                          subject: `Order Update #${order.id.slice(-6)}`,
                                                          html: `<p>Hi ${order.customerName || 'there'},</p><p>Here is an update regarding your order.</p>`
                                                        })
                                                      });
                                                      setSentEmailCustomers(prev => new Set(prev).add(order.customerEmail));
                                                      alert('Email sent!');
                                                    } catch (err) {
                                                      alert('Failed to send email');
                                                    }
                                                  }}
                                                  className={`p-1.5 rounded-full transition-colors ${sentEmailCustomers.has(order.customerEmail)
                                                    ? 'text-[#0071e3] bg-[#0071e3]/10'
                                                    : isDarkMode
                                                      ? 'text-[#86868b] hover:text-[#0071e3] hover:bg-[#0071e3]/10'
                                                      : 'text-gray-400 hover:text-blue-500 hover:bg-blue-50'
                                                    }`}
                                                  title={sentEmailCustomers.has(order.customerEmail) ? "Email sent" : "Email customer"}
                                                >
                                                  {sentEmailCustomers.has(order.customerEmail) ? (
                                                    <svg className="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                                                      <path d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z" />
                                                      <path d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z" />
                                                    </svg>
                                                  ) : (
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                    </svg>
                                                  )}
                                                </button>
                                                {/* Fulfillment Button Reuse */}
                                                <button
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    setSelectedOrder(order);
                                                    setIsFulfillmentModalOpen(true);
                                                  }}
                                                  className={`p-1.5 rounded-full transition-colors ${isDarkMode
                                                    ? 'text-[#86868b] hover:text-[#0071e3] hover:bg-[#0071e3]/10'
                                                    : 'text-gray-400 hover:text-blue-500 hover:bg-blue-50'}`}
                                                  title="Fulfill Order"
                                                >
                                                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                  </svg>
                                                </button>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )
        }

        {/* Flat Grid View - For type-specific tabs (not 'all' or 'forms') */}
        {
          filterType !== 'all' && filterType !== 'forms' && flatFilteredAssets.length > 0 && (
            <div className="mt-4">
              <div className={`grid gap-3 ${filterType === 'videos' || filterType === 'images' || filterType === 'products' || filterType === 'books'
                ? 'grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5'
                : 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3'
                }`}>
                {flatFilteredAssets.map(asset => {
                  // Helper to check if asset has visual preview
                  const hasVisualPreview = () => {
                    if (asset.type === 'table') return false;
                    if (!asset.url && asset.type !== 'book' && asset.type !== 'product' && asset.type !== 'doc') return false;
                    const visualTypes = ['header', 'slide', 'notemap', 'social'];
                    if (visualTypes.includes(asset.type)) return true;
                    if (asset.type === 'video') return true;
                    if (asset.type === 'book') return true;
                    if (asset.type === 'doc' && asset.url) return true;
                    if (asset.type === 'product' && (asset.data as StripeProduct)?.images?.[0]) return true;
                    return false;
                  };

                  // Get preview URL for asset
                  const getPreviewUrl = (): string | null => {
                    if (asset.type === 'book') {
                      const book = asset.data as BookAsset;
                      if (book?.pages?.[0]?.imageUrl) return book.pages[0].imageUrl;
                      return null;
                    }
                    if (asset.type === 'product' && (asset.data as StripeProduct)?.images?.[0]) {
                      return (asset.data as StripeProduct).images[0];
                    }
                    return asset.url || null;
                  };

                  const isVisual = filterType === 'videos' || filterType === 'images' || filterType === 'products' || filterType === 'books' || filterType === 'docs';

                  return (
                    <div
                      key={asset.id}
                      role="button"
                      tabIndex={0}
                      onClick={() => handleAssetClick(asset)}
                      className={`group relative overflow-hidden transition-all cursor-pointer ${isVisual
                        ? `rounded-xl ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60 hover:border-[#636366]' : 'bg-white border border-gray-200 hover:border-gray-300 shadow-sm'}`
                        : `rounded-xl p-4 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]/60 hover:border-[#636366]' : 'bg-white border border-gray-200 hover:border-gray-300 shadow-sm'}`
                        }`}
                    >
                      {/* Visual Preview (Images, Videos, Products, Books, Docs, Tables) */}
                      {isVisual && hasVisualPreview() && (
                        <div className="aspect-square overflow-hidden bg-gray-100 relative">
                          {asset.type === 'video' ? (
                            <video
                              src={asset.url}
                              className="w-full h-full object-cover"
                              muted
                              playsInline
                            />
                          ) : asset.type === 'book' && !((asset.data as BookAsset)?.pages?.[0]?.imageUrl) && asset.url ? (
                            // PDF Iframe Thumbnail
                            <div className="w-full h-full relative pointer-events-none">
                              <iframe
                                src={`${asset.url}#toolbar=0&navpanes=0&scrollbar=0&view=FitH`}
                                className="w-[150%] h-[150%] origin-top-left scale-[0.67] border-none"
                                tabIndex={-1}
                                title="PDF Preview"
                              />
                            </div>
                          ) : asset.type === 'book' && (asset.data as BookAsset)?.isInteractive && !((asset.data as BookAsset)?.pages?.[0]?.imageUrl) ? (
                            /* Interactive PDF Placeholder Thumbnail */
                            <div className={`w-full h-full flex flex-col items-center justify-center p-4 text-center ${isDarkMode ? 'bg-gradient-to-br from-indigo-500/20 to-purple-500/20' : 'bg-gradient-to-br from-indigo-50 to-purple-50'}`}>
                              <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-2 ${isDarkMode ? 'bg-indigo-500/40 text-white' : 'bg-indigo-600 text-white'}`}>
                                <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                              </div>
                              <span className={`text-[10px] font-bold uppercase tracking-widest ${isDarkMode ? 'text-indigo-400' : 'text-indigo-700'}`}>Interactive PDF</span>
                            </div>
                          ) : (asset.type === 'doc') && asset.url ? (
                            // Doc/Table Thumbnail (Google Viewer or Native)
                            <div className="w-full h-full relative pointer-events-none bg-white">
                              {asset.title.endsWith('.txt') || asset.title.endsWith('.md') ? (
                                <iframe
                                  src={asset.url}
                                  className="w-[150%] h-[150%] origin-top-left scale-[0.67] border-none"
                                  tabIndex={-1}
                                  title="Text Preview"
                                />
                              ) : (
                                <iframe
                                  src={`https://docs.google.com/viewer?url=${encodeURIComponent(asset.url)}&embedded=true`}
                                  className="w-[150%] h-[150%] origin-top-left scale-[0.67] border-none"
                                  tabIndex={-1}
                                  title="Doc Preview"
                                />
                              )}
                            </div>
                          ) : (
                            <img
                              src={getPreviewUrl() || ''}
                              alt={asset.title || 'Asset'}
                              className="w-full h-full object-cover"
                            />
                          )}
                        </div>
                      )}

                      {/* Hover Actions Overlay for Visual Assets */}
                      {isVisual && (
                        <>
                          {/* Mobile Action Toggle */}
                          <button
                            type="button"
                            onClick={(e) => {
                              e.stopPropagation();
                              setMobileMenuAssetId(mobileMenuAssetId === asset.id ? null : asset.id);
                            }}
                            className="sm:hidden absolute bottom-2 right-2 p-3 rounded-full bg-black/50 text-white z-20"
                          >
                            <svg className={`w-6 h-6 transition-transform ${mobileMenuAssetId === asset.id ? 'rotate-45' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                          </button>

                          {/* Desktop Hover / Mobile Menu Overlay Buttons */}
                          <div className={`absolute top-2 right-2 flex flex-row-reverse items-center gap-1.5 transition-opacity ${mobileMenuAssetId === asset.id ? '!opacity-100 z-10' : 'opacity-0 group-hover:opacity-100'}`}>
                            {/* Delete button */}
                            <button
                              type="button"
                              onClick={e => {
                                e.stopPropagation();
                                handleDeleteAsset(asset.id);
                              }}
                              className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-red-500/80 transition-colors"
                              aria-label="Delete asset"
                            >
                              <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>

                            {/* Edit Image button overlay (for images only) */}
                            {(['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) && !asset.type.startsWith('video') && (
                              <button
                                type="button"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleEditImage(asset);
                                }}
                                className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-emerald-500/80 transition-colors"
                                title="Edit Image (Use as Reference)"
                              >
                                <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                              </button>
                            )}

                            {/* Edit Video Button (Luma) */}
                            {(asset.type === 'video' || asset.type.startsWith('video/')) && (
                              <button
                                type="button"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setVideoType('edit');
                                  setLumaVideoAssetId(asset.id);
                                  setLumaVideoPreviewUrl(asset.url);
                                  setLumaVideoTitle(asset.title);
                                  setLumaVideoFile(null);
                                  setIsLumaVideoPickerOpen(false);
                                }}
                                className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-emerald-500/80 transition-colors"
                                title="Edit Video (Extend/Modify)"
                              >
                                <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                              </button>
                            )}

                            {/* Share button */}
                            {onShareToX && (
                              ['blog', 'video', 'header', 'slide', 'notemap', 'social'].includes(asset.type) ||
                              asset.type.startsWith('video/') ||
                              asset.type.startsWith('image/')
                            ) && (
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    onShareToX(asset);
                                  }}
                                  className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors"
                                  title="Share to Social"
                                >
                                  <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                  </svg>
                                </button>
                              )}

                            {/* Generate Video button overlay (for images only) */}
                            {((['header', 'slide', 'notemap', 'social'].includes(asset.type) || asset.type.startsWith('image/')) && !asset.type.startsWith('video')) && (
                              <button
                                type="button"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleGenerateVideoFromImage(asset);
                                }}
                                className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-purple-500/80 transition-colors"
                                title="Generate Video (Sora/Veo)"
                              >
                                <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                              </button>
                            )}

                            {/* PDF Download Button */}
                            {asset.type === 'book' && (
                              <button
                                type="button"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  handleDownloadBookPdf(asset);
                                }}
                                disabled={downloadingBookPdf === asset.id}
                                className="p-2 sm:p-1.5 rounded-full bg-black/60 text-white/70 hover:text-white hover:bg-blue-500/80 transition-colors disabled:opacity-50 disabled:cursor-wait"
                                title="Download PDF"
                              >
                                {downloadingBookPdf === asset.id ? (
                                  <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="12" cy="12" r="10" strokeWidth="4" className="opacity-25" />
                                    <path d="M4 12a8 8 0 018-8" strokeWidth="4" className="opacity-75" />
                                  </svg>
                                ) : (
                                  <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                  </svg>
                                )}
                              </button>
                            )}

                            {/* Pin button (Swapped position) */}
                            <button
                              type="button"
                              onClick={e => handleTogglePin(asset.id, e)}
                              className={`p-2 sm:p-1.5 rounded-full transition-colors ${(project.pinnedAssetIds || []).includes(asset.id)
                                ? 'bg-amber-500/80 text-white hover:bg-amber-600/80'
                                : 'bg-black/60 text-white/70 hover:text-white hover:bg-amber-500/80'
                                }`}
                              aria-label={(project.pinnedAssetIds || []).includes(asset.id) ? 'Unpin asset' : 'Pin asset'}
                              title={(project.pinnedAssetIds || []).includes(asset.id) ? 'Unpin' : 'Pin to top'}
                            >
                              <svg className="w-5 h-5 sm:w-3.5 sm:h-3.5" fill={(project.pinnedAssetIds || []).includes(asset.id) ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                              </svg>
                            </button>
                          </div>
                        </>
                      )}

                      {/* Title/Meta Area */}
                      <div className={isVisual ? 'p-2' : ''}>
                        {/* Type Icon for non-visual */}
                        {!isVisual && (
                          <div className="flex items-start gap-3 mb-2">
                            <div className={`flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center ${isDarkMode ? 'bg-white/10' : 'bg-gray-100'}`}>
                              {getTypeIcon(asset.type)}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="flex items-start justify-between gap-1">
                                <p className={`text-sm font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                  {asset.title}
                                </p>
                                {asset.type === 'book' && (
                                  <button
                                    type="button"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleDownloadBookPdf(asset);
                                    }}
                                    disabled={downloadingBookPdf === asset.id}
                                    className={`flex-shrink-0 p-1.5 rounded-lg transition-colors ${isDarkMode
                                      ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/40'
                                      : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100'
                                      }`}
                                    title="Download PDF"
                                  >
                                    {downloadingBookPdf === asset.id ? (
                                      <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <circle cx="12" cy="12" r="10" strokeWidth="4" className="opacity-25" />
                                        <path d="M4 12a8 8 0 018-8" strokeWidth="4" className="opacity-75" />
                                      </svg>
                                    ) : (
                                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                      </svg>
                                    )}
                                  </button>
                                )}
                              </div>
                              <p className={`text-xs truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                {formatDate(asset.timestamp)}
                              </p>
                            </div>
                            {/* Share button for blogs */}
                            {asset.type === 'blog' && onShareToX && (
                              <button
                                type="button"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  onShareToX(asset);
                                }}
                                className={`p-1.5 mr-1 rounded-full transition-colors ${isDarkMode ? 'text-[#636366] hover:text-green-500 hover:bg-green-500/10' : 'text-gray-400 hover:text-green-600 hover:bg-green-50'}`}
                                title="Share Blog"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                              </button>
                            )}
                            {/* Website-specific buttons: Custom Domain, Copy Link, Download */}
                            {asset.type === 'website' && (
                              <>
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleOpenCustomDomainModal(asset);
                                  }}
                                  className={`p-1.5 rounded-full transition-colors ${isDarkMode ? 'text-[#636366] hover:text-purple-400 hover:bg-purple-500/10' : 'text-gray-400 hover:text-purple-600 hover:bg-purple-50'}`}
                                  title="Custom Domain"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                                  </svg>
                                </button>
                                <button
                                  type="button"
                                  onClick={e => handleShareWebsite(asset, e)}
                                  disabled={websiteShareLoading === asset.id}
                                  className={`p-1.5 rounded-full transition-colors ${isDarkMode ? 'text-[#636366] hover:text-blue-400 hover:bg-blue-500/10' : 'text-gray-400 hover:text-blue-600 hover:bg-blue-50'} ${websiteShareLoading === asset.id ? 'opacity-50 cursor-wait' : ''}`}
                                  title="Copy Link"
                                >
                                  {websiteShareLoading === asset.id ? (
                                    <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                      <circle cx="12" cy="12" r="10" className="opacity-25" />
                                      <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                    </svg>
                                  ) : (
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                    </svg>
                                  )}
                                </button>
                                <button
                                  type="button"
                                  onClick={e => handleDownloadWebsite(asset, e)}
                                  className={`p-1.5 rounded-full transition-colors ${isDarkMode ? 'text-[#636366] hover:text-green-400 hover:bg-green-500/10' : 'text-gray-400 hover:text-green-600 hover:bg-green-50'}`}
                                  title="Download HTML"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                  </svg>
                                </button>
                                <button
                                  type="button"
                                  onClick={e => {
                                    e.stopPropagation();
                                    setSelectedWebsite(asset.data as SavedWebsiteVersion);
                                    setIsEditingWebsite(true);
                                    setWebsiteEditPrompt('');
                                    setWebsiteEditError(null);
                                  }}
                                  className={`p-1.5 rounded-full transition-colors ${isDarkMode ? 'text-[#636366] hover:text-orange-400 hover:bg-orange-500/10' : 'text-gray-400 hover:text-orange-600 hover:bg-orange-50'}`}
                                  title="Edit with AI"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                  </svg>
                                </button>
                              </>
                            )}
                            {/* Delete button for non-visual */}
                            <button
                              type="button"
                              onClick={e => {
                                e.stopPropagation();
                                handleDeleteAsset(asset.id);
                              }}
                              className={`p-1.5 rounded-full transition-colors ${isDarkMode ? 'text-[#636366] hover:text-red-400 hover:bg-red-500/10' : 'text-gray-400 hover:text-red-500 hover:bg-red-50'}`}
                              aria-label="Delete asset"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </div>
                        )}

                        {/* Visual asset title */}
                        {isVisual && (
                          <>
                            <p className={`text-xs font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                              {asset.title}
                            </p>
                            <p className={`text-[10px] truncate mt-0.5 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                              {formatDate(asset.timestamp)}
                            </p>

                            {/* Product Specific UI */}
                            {asset.type === 'product' && (
                              <div className="mt-2 space-y-2">
                                {/* Price */}
                                <p className={`text-xs font-semibold ${isDarkMode ? 'text-[#0071e3]' : 'text-[#0071e3]'}`}>
                                  ${((asset.data as StripeProduct)?.unitAmount / 100).toFixed(2)} {((asset.data as StripeProduct)?.currency || 'USD').toUpperCase()}
                                </p>

                                {/* View Orders Button */}
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const productData = asset.data as StripeProduct;
                                    if (!productData?.priceId) return;

                                    if (expandedProductOrders === productData.id) {
                                      setExpandedProductOrders(null);
                                    } else {
                                      setExpandedProductOrders(productData.id);
                                      fetchOrders(productData.id, productData.priceId);
                                    }
                                  }}
                                  className={`w-full px-2 py-1.5 rounded text-[10px] font-medium transition-colors ${isDarkMode
                                    ? 'bg-[#0071e3] hover:bg-[#0077ED] text-white'
                                    : 'bg-[#0071e3] hover:bg-[#0077ED] text-white'
                                    }`}
                                >
                                  {expandedProductOrders === asset.id ? 'Hide Orders' : ' View Orders'}
                                </button>

                                {/* Orders List */}
                                {expandedProductOrders === asset.id && (
                                  <div className={`pt-2 border-t ${isDarkMode ? 'border-[#3d3d3f]/60' : 'border-gray-200'}`}>
                                    {(!productOrders[asset.id] || productOrders[asset.id].length === 0) ? (
                                      <p className={`text-[10px] ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                        {loadingOrders ? 'Loading orders...' : 'No orders found yet.'}
                                      </p>
                                    ) : (
                                      <div className="space-y-2">
                                        <div className="flex items-center justify-between">
                                          <p className={`text-[10px] font-medium ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                            {productOrders[asset.id].length} Orders
                                          </p>
                                          <button
                                            type="button"
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              handleEmailAllCustomers();
                                            }}
                                            className={`text-[10px] font-medium text-[#0071e3] hover:underline`}
                                          >
                                            Email All
                                          </button>
                                        </div>

                                        <div className="max-h-40 overflow-y-auto pr-1 space-y-1.5 custom-scrollbar">
                                          {productOrders[asset.id].map(order => (
                                            <div key={order.id} className={`p-1.5 rounded-lg ${isDarkMode ? 'bg-white/5' : 'bg-gray-50'}`}>
                                              <div className="flex justify-between items-start gap-2">
                                                <div className="min-w-0">
                                                  <p className={`text-[10px] font-medium truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                                    {order.customerName || 'Customer'}
                                                  </p>
                                                  <p className={`text-[9px] truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                                                    {order.customerEmail}
                                                  </p>
                                                </div>
                                                <div className="flex gap-1">
                                                  <button
                                                    onClick={async (e) => {
                                                      e.stopPropagation();
                                                      const isConnected = emailProvider === 'gmail' ? gmailConnected : outlookConnected;
                                                      if (!isConnected) {
                                                        alert(`Please connect your ${emailProvider === 'gmail' ? 'Gmail' : 'Outlook'} account first.`);
                                                        return;
                                                      }
                                                      if (!confirm(`Send email to ${order.customerEmail}?`)) return;

                                                      try {
                                                        await authFetch(`/api/email?op=send&provider=${emailProvider}`, {
                                                          method: 'POST',
                                                          headers: { 'Content-Type': 'application/json' },
                                                          body: JSON.stringify({
                                                            to: order.customerEmail,
                                                            subject: `Order Update #${order.id.slice(-6)}`,
                                                            html: `<p>Hi ${order.customerName || 'there'},</p><p>Here is an update regarding your order.</p>`
                                                          })
                                                        });
                                                        setSentEmailCustomers(prev => new Set(prev).add(order.customerEmail));
                                                        alert('Email sent!');
                                                      } catch (err) {
                                                        alert('Failed to send email');
                                                      }
                                                    }}
                                                    className={`p-1 rounded hover:bg-black/10 transition-colors ${sentEmailCustomers.has(order.customerEmail) ? 'text-green-500' : isDarkMode ? 'text-[#86868b]' : 'text-gray-400'}`}
                                                    title="Send Update Email"
                                                  >
                                                    <svg className="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                                                      <path d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z" />
                                                      <path d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z" />
                                                    </svg>
                                                  </button>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setSelectedOrder(order);
                                                      setIsFulfillmentModalOpen(true);
                                                    }}
                                                    className={`p-1 rounded hover:bg-black/10 transition-colors ${isDarkMode ? 'text-[#86868b]' : 'text-gray-400'}`}
                                                    title="Fulfill Order"
                                                  >
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                  </button>
                                                </div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            )}
                          </>
                        )}

                        {/* Description for non-visual */}
                        {!isVisual && asset.description && (
                          <p className={`text-xs line-clamp-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                            {asset.description}
                          </p>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Empty State */}
              {flatFilteredAssets.length === 0 && (
                <div className={`text-center py-12 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                  <p className="text-sm">No {filterType} found</p>
                </div>
              )}
            </div>
          )
        }

        {
          selectedWebsite && createPortal(
            <div
              className="fixed inset-0 z-[200] bg-black p-0 m-0"
              onClick={() => setSelectedWebsite(null)}
            >
              {websiteSaveMessage && (
                <div className="absolute top-20 left-1/2 -translate-x-1/2 z-20 px-4 py-2 bg-black/80 border border-white/20 rounded-full text-white text-sm animate-in fade-in slide-in-from-top-2">
                  {websiteSaveMessage}
                </div>
              )}
              <div className="absolute top-4 right-4 z-10 flex items-center gap-2">
                <span className="text-white/60 text-sm bg-black/50 px-3 py-1 rounded-full">
                  {selectedWebsite.description}
                </span>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    const asset: AssetItem = {
                      id: `project-website-${selectedWebsite.id}`,
                      type: 'website',
                      title: selectedWebsite.description,
                      data: selectedWebsite,
                      researchId: 'project-assets',
                      researchTopic: project.name,
                      timestamp: selectedWebsite.timestamp
                    };
                    handleDownloadWebsite(asset);
                  }}
                  className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors"
                  title="Download HTML"
                >
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    const asset: AssetItem = {
                      id: `project-website-${selectedWebsite.id}`,
                      type: 'website',
                      title: selectedWebsite.description,
                      data: selectedWebsite,
                      researchId: 'project-assets',
                      researchTopic: project.name,
                      timestamp: selectedWebsite.timestamp
                    };
                    handleConvertWebsiteToPdf(asset);
                  }}
                  disabled={convertingPdf === `project-website-${selectedWebsite.id}`}
                  className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  title="Convert to PDF"
                >
                  {convertingPdf === `project-website-${selectedWebsite.id}` ? (
                    <svg className="w-6 h-6 text-white animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10" className="opacity-25" />
                      <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                    </svg>
                  ) : (
                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                  )}
                </button>
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    const asset = {
                      id: `project-website-${selectedWebsite.id}`,
                      type: 'website' as const,
                      title: selectedWebsite.description,
                      data: selectedWebsite,
                      researchTopic: project.name,
                      timestamp: selectedWebsite.timestamp,
                      researchId: 'project-assets', // Default to assets
                    };

                    // Try to find the real researchId
                    if (project.researchSessions) {
                      for (const s of project.researchSessions) {
                        if (s.websiteVersions?.some(v => v.id === selectedWebsite.id)) {
                          asset.researchId = s.id;
                          break;
                        }
                      }
                    }

                    handleShareWebsite(asset);
                  }}
                  disabled={websiteShareLoading === `project-website-${selectedWebsite.id}`}
                  className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors"
                  title="Get public link"
                >
                  {websiteShareLoading === `project-website-${selectedWebsite.id}` ? (
                    <svg className="w-6 h-6 text-white animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10" className="opacity-25" />
                      <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                    </svg>
                  ) : (
                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                  )}
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setIsEditingWebsite(!isEditingWebsite);
                    setWebsiteEditPrompt('');
                    setWebsiteEditError(null);
                  }}
                  className={`p-2 rounded-full transition-colors ${isEditingWebsite ? 'bg-orange-500 hover:bg-orange-600' : 'bg-white/10 hover:bg-white/20'}`}
                  title={isEditingWebsite ? 'Close Edit Panel' : 'Edit with AI'}
                >
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                </button>
                <button
                  onClick={() => { setSelectedWebsite(null); setIsEditingWebsite(false); }}
                  className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors"
                >
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="absolute inset-0 pt-16 pb-4 px-4 flex items-center justify-center">
                <div className="w-full h-full max-w-6xl bg-white rounded-2xl overflow-hidden shadow-2xl relative">
                  <iframe
                    srcDoc={selectedWebsite.html}
                    className="w-full h-full border-none"
                    title={selectedWebsite.description}
                    sandbox="allow-scripts allow-forms allow-popups allow-same-origin"
                  />
                </div>
              </div>

              {/* Edit with AI Input Panel */}
              {isEditingWebsite && (
                <div
                  className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/95 to-transparent pt-8 pb-4 px-4"
                  onClick={e => e.stopPropagation()}
                >
                  <div className="max-w-3xl mx-auto">
                    {/* Media Preview Row */}
                    {(websiteMediaFiles.length > 0 || selectedWebsiteAssetIds.length > 0) && (
                      <div className="flex items-center gap-2 mb-4 bg-white/5 p-2 rounded-xl border border-white/10">
                        <div className="flex -space-x-2 overflow-hidden py-0.5 pl-0.5">
                          {(() => {
                            const MAX_PREVIEWS = 6;
                            const totalCount = websiteMediaFiles.length + selectedWebsiteAssetIds.length;
                            const showOverflow = totalCount > MAX_PREVIEWS;
                            const distinctItems = [
                              ...websiteMediaFiles.map(f => ({ type: 'file' as const, data: f })),
                              ...selectedWebsiteAssetIds.map(id => ({ type: 'asset' as const, data: id }))
                            ].slice(0, MAX_PREVIEWS);

                            return (
                              <>
                                {distinctItems.map((item, i) => {
                                  if (item.type === 'file') {
                                    const file = item.data as File;
                                    return (
                                      <div key={`edit-file-${i}`} className="relative w-8 h-8 rounded-full ring-2 ring-black bg-gray-800 overflow-hidden shrink-0">
                                        {file.type.startsWith('image/') ? (
                                          <img src={URL.createObjectURL(file)} className="w-full h-full object-cover" alt="upload" />
                                        ) : (
                                          <div className="w-full h-full flex items-center justify-center text-[10px]"></div>
                                        )}
                                      </div>
                                    );
                                  } else {
                                    const id = item.data as string;
                                    const asset = allAssets.find(a => a.id === id);
                                    const isVideo = asset?.type === 'video' || (asset?.type === 'social' && asset?.data?.videoUrl);
                                    const displayUrl = isVideo ? (asset?.data?.imageUrl || asset?.data?.thumbnail) : (asset?.url || asset?.data?.imageUrl);

                                    return (
                                      <div key={`edit-asset-${i}`} className="relative w-8 h-8 rounded-full ring-2 ring-black bg-gray-800 overflow-hidden shrink-0 flex items-center justify-center">
                                        {displayUrl ? (
                                          <img src={displayUrl} className="w-full h-full object-cover" alt="asset" onError={(e) => {
                                            e.currentTarget.style.display = 'none';
                                            e.currentTarget.parentElement?.querySelector('.fallback-icon')?.classList.remove('hidden');
                                          }} />
                                        ) : null}
                                        <div className={`fallback-icon ${displayUrl ? 'hidden' : 'flex'} absolute inset-0 items-center justify-center text-[10px]`}>
                                          {isVideo ? '' : ''}
                                        </div>
                                      </div>
                                    );
                                  }
                                })}
                                {showOverflow && (
                                  <div className="relative w-8 h-8 rounded-full ring-2 ring-black bg-gray-800 flex items-center justify-center text-[10px] font-medium text-white shrink-0">
                                    +{totalCount - MAX_PREVIEWS}
                                  </div>
                                )}
                              </>
                            );
                          })()}
                        </div>
                        <span className="text-[10px] text-white/40 ml-1">Included media</span>
                        <button
                          type="button"
                          onClick={() => {
                            setWebsiteMediaFiles([]);
                            setSelectedWebsiteAssetIds([]);
                          }}
                          className="p-1 rounded-full hover:bg-white/10 text-white/40 hover:text-white/60 ml-auto"
                          title="Clear attached media"
                        >
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    )}
                    <p className="text-xs text-white/60 mb-2">Describe the changes you want to make:</p>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={websiteEditPrompt}
                        onChange={e => setWebsiteEditPrompt(e.target.value)}
                        placeholder="e.g., 'Change the hero headline to Welcome to the Future', 'Make the button blue', 'Add a footer section'"
                        className="flex-1 text-sm rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white/10 border border-white/20 text-white placeholder:text-white/40"
                        onKeyDown={e => {
                          if (e.key === 'Enter' && websiteEditPrompt.trim() && !isApplyingEdit) {
                            const asset: AssetItem = {
                              id: `project-website-${selectedWebsite.id}`,
                              type: 'website',
                              title: selectedWebsite.description,
                              data: selectedWebsite,
                              researchId: 'project-assets',
                              researchTopic: project.name,
                              timestamp: selectedWebsite.timestamp
                            };
                            handleApplyWebsiteEdit(asset);
                          }
                        }}
                      />
                      <button
                        onClick={() => {
                          const asset: AssetItem = {
                            id: `project-website-${selectedWebsite.id}`,
                            type: 'website',
                            title: selectedWebsite.description,
                            data: selectedWebsite,
                            researchId: 'project-assets',
                            researchTopic: project.name,
                            timestamp: selectedWebsite.timestamp
                          };
                          handleApplyWebsiteEdit(asset);
                        }}
                        disabled={isApplyingEdit || !websiteEditPrompt.trim()}
                        className={`px-6 py-3 rounded-xl text-sm font-semibold transition-all shrink-0 ${isApplyingEdit || !websiteEditPrompt.trim()
                          ? 'bg-white/5 text-white/20 cursor-not-allowed'
                          : 'bg-orange-500 hover:bg-orange-600 text-white shadow-lg shadow-orange-500/20'
                          }`}
                      >
                        {isApplyingEdit ? (
                          <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <circle cx="12" cy="12" r="10" className="opacity-25" />
                              <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                            </svg>
                            <span>Applying...</span>
                          </div>
                        ) : 'Apply Edit'}
                      </button>
                    </div>
                    {websiteEditError && (
                      <p className="text-xs text-red-400 mt-2">{websiteEditError}</p>
                    )}
                    <p className="text-[10px] text-white/40 mt-2"> 10 credits per edit  Changes will preview in a diff before applying</p>
                  </div>
                </div>
              )}
            </div>,
            document.body
          )
        }

        {
          selectedForm && createPortal(
            <div
              className="fixed inset-0 z-[200] bg-black p-0 m-0"
              onClick={() => setSelectedForm(null)}
            >
              {leadFormSaveMessage && (
                <div className="absolute top-20 left-1/2 -translate-x-1/2 z-20 px-4 py-2 bg-black/80 border border-white/20 rounded-full text-white text-sm animate-in fade-in slide-in-from-top-2">
                  {leadFormSaveMessage}
                </div>
              )}

              {/* Toolbar */}
              <div className="absolute top-4 right-4 z-10 flex items-center gap-2">
                <span className="text-white/60 text-sm bg-black/50 px-3 py-1 rounded-full">
                  {(selectedForm.data as any).title || 'Lead Form'}
                </span>

                {/* Copy Link */}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    const data = selectedForm.data as any;
                    if (data?.publicUrl) {
                      navigator.clipboard.writeText(data.publicUrl);
                      alert('Link copied!');
                    }
                  }}
                  className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors"
                  title="Copy Link"
                >
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                  </svg>
                </button>

                {/* Download HTML */}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    const blob = new Blob([(selectedForm.data as any).html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${(selectedForm.data as any).title || 'lead-form'}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                  }}
                  className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors"
                  title="Download HTML"
                >
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                </button>

                {/* Edit with AI */}
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setIsEditingForm(!isEditingForm);
                    setFormEditPrompt('');
                    setFormEditError(null);
                  }}
                  className={`p-2 rounded-full transition-colors ${isEditingForm ? 'bg-orange-500 hover:bg-orange-600' : 'bg-white/10 hover:bg-white/20'}`}
                  title={isEditingForm ? 'Close Edit Panel' : 'Edit with AI'}
                >
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                </button>

                {/* Close */}
                <button onClick={() => { setSelectedForm(null); setIsEditingForm(false); }} className="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors">
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              {/* Iframe */}
              <div className="absolute inset-0 pt-16 pb-4 px-4 flex items-center justify-center">
                <div className="w-full h-full max-w-6xl bg-white rounded-2xl overflow-hidden shadow-2xl relative">
                  <iframe
                    srcDoc={(selectedForm.data as any).html}
                    className="w-full h-full border-none"
                    title="Lead Form"
                    sandbox="allow-scripts allow-forms allow-popups allow-same-origin"
                  />
                </div>
              </div>

              {/* Edit Input Panel */}
              {isEditingForm && (
                <div
                  className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/95 to-transparent pt-8 pb-4 px-4"
                  onClick={e => e.stopPropagation()}
                >
                  <div className="max-w-3xl mx-auto">
                    <p className="text-xs text-white/60 mb-2">Describe the changes you want to make:</p>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={formEditPrompt}
                        onChange={e => setFormEditPrompt(e.target.value)}
                        placeholder="e.g., 'Change inputs to rounded style', 'Add red border', 'Make button blue'"
                        className="flex-1 text-sm rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white/10 border border-white/20 text-white placeholder:text-white/40"
                        onKeyDown={e => {
                          if (e.key === 'Enter' && formEditPrompt.trim() && !isApplyingEdit) {
                            handleApplyLeadFormEdit(selectedForm);
                          }
                        }}
                      />
                      <button
                        onClick={() => {
                          handleApplyLeadFormEdit(selectedForm);
                        }}
                        disabled={isApplyingEdit || !formEditPrompt.trim()}
                        className={`px-6 py-3 rounded-xl text-sm font-semibold transition-all shrink-0 ${isApplyingEdit || !formEditPrompt.trim()
                          ? 'bg-white/5 text-white/20 cursor-not-allowed'
                          : 'bg-orange-500 hover:bg-orange-600 text-white shadow-lg shadow-orange-500/20'
                          }`}
                      >
                        {isApplyingEdit ? (
                          <div className="flex items-center gap-2">
                            <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <circle cx="12" cy="12" r="10" className="opacity-25" />
                              <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                            </svg>
                            <span>Applying...</span>
                          </div>
                        ) : 'Apply Edit'}
                      </button>
                    </div>
                    {formEditError && (
                      <p className="text-xs text-red-400 mt-2">{formEditError}</p>
                    )}
                    <p className="text-[10px] text-white/40 mt-2"> 10 credits per edit  Changes will preview in a diff before applying</p>
                  </div>
                </div>
              )}
            </div>,
            document.body
          )
        }

        {
          selectedVideo && selectedVideo.url && createPortal(
            <div
              className="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4"
              onClick={() => setSelectedVideo(null)}
            >
              <button
                onClick={handlePrevAsset}
                className="absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur-md transition-all z-20 group"
              >
                <svg className="w-8 h-8 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
              </button>
              <button
                onClick={handleNextAsset}
                className="absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur-md transition-all z-20 group"
              >
                <svg className="w-8 h-8 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
              </button>
              <button
                onClick={() => setSelectedVideo(null)}
                className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors z-10"
              >
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>

              <div
                className="w-full max-w-4xl"
                onClick={e => e.stopPropagation()}
              >
                <div className="aspect-video bg-black rounded-2xl overflow-hidden">
                  <video
                    src={selectedVideo.url}
                    className="w-full h-full object-contain"
                    controls
                    autoPlay
                    playsInline
                  />
                </div>
                <div className="mt-4 text-center">
                  <h3 className="text-lg font-medium text-white">{selectedVideo.title}</h3>
                  <p className="text-sm mt-1 text-[#86868b]">{selectedVideo.researchTopic}</p>
                  {selectedVideo.description && (
                    <p className="text-xs mt-2 max-w-xl mx-auto text-[#636366]">
                      {selectedVideo.description}
                    </p>
                  )}
                  {onShareToX && (
                    <div className="mt-4 flex justify-center">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onShareToX(selectedVideo);
                        }}
                        className="px-6 py-2 rounded-full bg-[#0071e3] text-white text-sm font-semibold hover:bg-[#0077ed] transition-colors flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                        </svg>
                        Share to Social
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>,
            document.body
          )
        }

        {
          selectedImage && createPortal(
            <div
              className="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4"
              onClick={() => setSelectedImage(null)}
            >
              <>
                <button
                  onClick={handlePrevAsset}
                  className="absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur-md transition-all z-20 group"
                >
                  <svg className="w-8 h-8 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                </button>
                <button
                  onClick={handleNextAsset}
                  className="absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur-md transition-all z-20 group"
                >
                  <svg className="w-8 h-8 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                </button>
              </>
              <button
                onClick={() => setSelectedImage(null)}
                className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors z-10"
              >
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>

              {selectedImage.type === 'blog' ? (
                <div
                  className={`rounded-2xl max-w-3xl max-h-[90vh] overflow-y-auto w-full ${isDarkMode ? 'bg-[#1d1d1f]' : 'bg-white'}`}
                  onClick={(e) => e.stopPropagation()}
                >
                  {selectedImage.url && (
                    <img
                      src={selectedImage.url}
                      alt={selectedImage.title}
                      className="w-full h-64 object-cover rounded-t-2xl"
                    />
                  )}
                  <div className="p-6">
                    <h2 className={`text-2xl font-bold mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{selectedImage.data?.title}</h2>
                    <p className={`mb-4 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>{selectedImage.data?.subtitle}</p>
                    <div className={isDarkMode ? 'prose prose-invert max-w-none' : 'prose max-w-none'}>
                      <ReactMarkdown className={isDarkMode ? 'text-[#e5e5ea]' : 'text-gray-800'}>
                        {selectedImage.data?.content || ''}
                      </ReactMarkdown>
                    </div>
                  </div>
                </div>
              ) : selectedImage.type === 'book' ? (
                ((selectedImage.data as BookAsset)?.isInteractive || !(selectedImage.data as BookAsset)?.pages?.length) ? (
                  <div
                    className={`w-full max-w-5xl h-[90vh] flex flex-col relative rounded-3xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1c1c1e]' : 'bg-white'}`}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <div className={`px-6 py-4 flex items-center justify-between border-b ${isDarkMode ? 'border-white/10' : 'border-gray-100'}`}>
                      <h3 className={`text-lg font-semibold truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{selectedImage.title}</h3>
                      <button
                        onClick={() => setSelectedImage(null)}
                        className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-white' : 'hover:bg-gray-100 text-gray-900'}`}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                    <div className="flex-1 bg-gray-100 relative">
                      <iframe
                        src={selectedImage.url}
                        srcDoc={(selectedImage.data as BookAsset)?.html}
                        className="w-full h-full border-none"
                        title={selectedImage.title}
                        sandbox="allow-scripts allow-forms allow-popups allow-same-origin"
                      />
                    </div>
                  </div>
                ) : (
                  <div
                    className={`w-full max-w-6xl max-h-[90vh] flex flex-col relative overflow-hidden rounded-3xl shadow-2xl ${isDarkMode ? 'bg-[#1c1c1e]' : 'bg-white'}`}
                    onClick={(e) => e.stopPropagation()}
                  >
                    {/* Header Area */}
                    <div className={`px-6 py-4 flex items-center justify-between border-b ${isDarkMode ? 'border-white/10' : 'border-gray-100'}`}>
                      <div className="flex flex-col min-w-0">
                        <h3 className={`text-lg font-semibold truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                          {selectedImage.title}
                        </h3>
                        <p className={`text-xs truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                          {selectedImage.researchTopic}
                        </p>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className={`text-xs font-medium px-3 py-1 rounded-full ${isDarkMode ? 'bg-white/10 text-white' : 'bg-gray-100 text-gray-700'}`}>
                          Page {currentBookPage + 1} of {(selectedImage.data as BookAsset)?.pages?.length || 0}
                        </span>
                        <button
                          onClick={() => setSelectedImage(null)}
                          className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-white' : 'hover:bg-gray-100 text-gray-900'}`}
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 flex flex-col lg:flex-row min-h-0 overflow-y-auto lg:overflow-hidden">
                      {/* Left Side: Image with Navigation Arrows */}
                      <div className={`lg:w-1/2 relative flex items-center justify-center p-6 bg-black/20 ${isDarkMode ? 'bg-black/40' : 'bg-gray-50'}`}>
                        <div className="relative w-full h-full flex items-center justify-center">
                          <img
                            src={(selectedImage.data as BookAsset)?.pages?.[currentBookPage]?.imageUrl || ''}
                            alt={`${selectedImage.title} - Page ${currentBookPage + 1}`}
                            className="max-w-full max-h-full object-contain rounded-xl shadow-2xl transition-all duration-300 transform"
                          />

                          {/* Side Arrows */}
                          {currentBookPage > 0 && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setCurrentBookPage(prev => Math.max(0, prev - 1));
                              }}
                              className="absolute left-2 lg:-left-4 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur-md shadow-xl transition-all hover:scale-110 z-20 group"
                            >
                              <svg className="w-6 h-6 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                              </svg>
                            </button>
                          )}

                          {currentBookPage < ((selectedImage.data as BookAsset)?.pages?.length || 0) - 1 && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setCurrentBookPage(prev => Math.min(((selectedImage.data as BookAsset)?.pages?.length || 0) - 1, prev + 1));
                              }}
                              className="absolute right-2 lg:-right-4 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full backdrop-blur-md shadow-xl transition-all hover:scale-110 z-20 group"
                            >
                              <svg className="w-6 h-6 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                              </svg>
                            </button>
                          )}

                          {/* Action Overlays */}
                          <div className="absolute top-4 right-4 flex flex-col gap-2">
                            {onShareToX && (
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  onShareToX(selectedImage);
                                }}
                                className="p-2.5 bg-[#0071e3] text-white rounded-full shadow-lg hover:bg-[#0077ed] transition-all"
                                title="Share Book"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                              </button>
                            )}
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                handleDownloadBookPdf(selectedImage);
                              }}
                              disabled={downloadingBookPdf === selectedImage.id}
                              className={`p-2.5 rounded-full shadow-lg transition-all ${isDarkMode ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-white hover:bg-gray-50 text-gray-900'} disabled:opacity-50`}
                              title="Download PDF"
                            >
                              {downloadingBookPdf === selectedImage.id ? (
                                <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <circle cx="12" cy="12" r="10" className="opacity-25" />
                                  <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                </svg>
                              ) : (
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                              )}
                            </button>
                          </div>
                        </div>
                      </div>

                      {/* Right Side: Text Area */}
                      <div className="lg:w-1/2 p-8 lg:overflow-y-auto flex flex-col">
                        <div className="flex-1">
                          <h4 className={`text-sm font-bold uppercase tracking-widest mb-4 ${isDarkMode ? 'text-white/40' : 'text-gray-400'}`}>
                            Page Content
                          </h4>
                          <p className={`text-lg leading-relaxed whitespace-pre-wrap ${isDarkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                            {(selectedImage.data as BookAsset)?.pages?.[currentBookPage]?.text || ''}
                          </p>
                        </div>

                        {/* Page Summary / Metadata if needed */}
                        <div className={`mt-8 pt-6 border-t ${isDarkMode ? 'border-white/10' : 'border-gray-100'}`}>
                          <div className="flex items-center justify-between text-xs text-[#86868b]">
                            <span>{(selectedImage.data as BookAsset)?.title || 'Book'}</span>
                            <span>{(selectedImage.data as BookAsset)?.pages?.length || 0} Pages Total</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )) : (
                <div
                  className="max-w-4xl max-h-[90vh] flex flex-col overflow-y-auto"
                  onClick={(e) => e.stopPropagation()}
                >
                  <div className="relative inline-block mx-auto">
                    {selectedImage.url ? (
                      <img
                        src={selectedImage.url}
                        alt={selectedImage.title}
                        className="max-w-full max-h-[70vh] object-contain rounded-xl shadow-xl"
                      />
                    ) : null}
                    {/* Generate Video Action Overlay */}
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleGenerateVideoFromImage(selectedImage);
                        setSelectedImage(null);
                      }}
                      className="absolute bottom-3 right-3 flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-full bg-black/60 text-white hover:bg-black/80 backdrop-blur-md border border-white/10 shadow-lg transition-all hover:scale-105 z-10"
                      title="Generate Video from this Image"
                    >
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      <span>Generate Video</span>
                    </button>
                    {onShareToX && (
                      <button
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          onShareToX(selectedImage);
                        }}
                        className="absolute bottom-3 left-3 flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-full bg-[#0071e3] text-white hover:bg-[#0077ed] backdrop-blur-md border border-white/10 shadow-lg transition-all hover:scale-105 z-10"
                        title="Share to social media"
                      >
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                        </svg>
                        <span>Share</span>
                      </button>
                    )}
                  </div>

                  <div className="mt-4 text-center">
                    {/* Existing Nano Banana Image Editing UI (Moved above Title) */}
                    <div className="mb-6 pt-0 border-t-0">
                      <div className="flex flex-col gap-3">
                        <p className="text-xs font-medium text-left text-white/60">
                          Edit this image using AI
                        </p>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={nanoBananaEditPrompt}
                            onChange={(e) => setNanoBananaEditPrompt(e.target.value)}
                            placeholder="e.g. 'Make it a sketch', 'Add a hat', 'Change to sunset colors'"
                            className="flex-1 text-sm rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] bg-white/10 border border-white/10 text-white placeholder:text-white/30"
                            onKeyDown={(e) => {
                              if (e.key === 'Enter' && nanoBananaEditPrompt.trim() && !isNanoBananaEditing) {
                                handleEditImageNano();
                              }
                            }}
                          />
                          <button
                            onClick={handleEditImageNano}
                            disabled={isNanoBananaEditing || !nanoBananaEditPrompt.trim()}
                            className={`px-6 py-2 rounded-xl text-sm font-semibold transition-all shrink-0 ${isNanoBananaEditing || !nanoBananaEditPrompt.trim()
                              ? 'bg-white/5 text-white/20'
                              : 'bg-[#0071e3] hover:bg-[#0077ed] text-white shadow-lg shadow-[#0071e3]/20'
                              }`}
                          >
                            {isNanoBananaEditing ? (
                              <div className="flex items-center gap-2">
                                <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <circle cx="12" cy="12" r="10" className="opacity-25" />
                                  <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                </svg>
                                <span>Editing...</span>
                              </div>
                            ) : 'Apply Edit'}
                          </button>
                        </div>
                        {nanoBananaError && (
                          <p className="text-xs text-red-500 text-left">{nanoBananaError}</p>
                        )}
                      </div>
                    </div>

                    <h3 className="text-lg font-medium text-white">{selectedImage.title}</h3>
                    <p className="text-sm mt-1 text-[#86868b]">{selectedImage.researchTopic}</p>
                    {selectedImage.description && (
                      <p className="text-xs mt-2 max-w-lg mx-auto text-[#636366]">
                        {selectedImage.description}
                      </p>
                    )}
                  </div>
                </div>
              )}
            </div>,
            document.body
          )
        }

        {
          !onPlayPodcast && activePodcast && activePodcast.url && (
            <div
              className={`fixed bottom-4 right-4 z-40 max-w-sm w-[320px] rounded-2xl shadow-lg border ${isDarkMode ? 'bg-[#1d1d1f] border-[#3d3d3f]' : 'bg-white border-gray-200'}`}
            >
              <div className="flex items-center justify-between px-4 pt-3">
                <div className="flex items-center gap-2 flex-1 min-w-0">
                  <span className={`w-7 h-7 rounded-full flex items-center justify-center ${getTypeColor('podcast')}`}>
                    {getTypeIcon('podcast')}
                  </span>
                  <div className="flex flex-col min-w-0 max-w-full">
                    <span className={`text-xs font-semibold truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      {activePodcast.title}
                    </span>
                    <span className={`text-[11px] truncate ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                      {activePodcast.researchTopic}
                    </span>
                  </div>
                </div>
                <button
                  onClick={() => setActivePodcast(null)}
                  className={`p-1 rounded-full ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                  aria-label="Close podcast player"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="px-3 pb-3 pt-1">
                <audio
                  src={activePodcast.url}
                  controls
                  autoPlay
                  preload="auto"
                  ref={audioRef}
                  className="w-full"
                />
              </div>
            </div>
          )
        }

        {/* Video Reference Image Asset Picker Modal */}
        {
          isVideoAssetPickerOpen && (
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setIsVideoAssetPickerOpen(false)}
            >
              <div
                className={`w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'
                  }`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        {assetPickerTarget === 'sora' ? 'Select Video Reference Image' :
                          assetPickerTarget === 'luma-source' ? 'Select Source Video' :
                            'Select Reference Images'}
                      </h3>
                      <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {assetPickerTarget === 'sora'
                          ? 'Choose one image from your project assets.'
                          : assetPickerTarget === 'luma-source'
                            ? 'Choose a video to modify.'
                            : assetPickerTarget === 'image'
                              ? `Choose up to ${MAX_DATA_REFERENCES - imageReferenceFiles.length} more images (${imageReferenceFiles.length}/${MAX_DATA_REFERENCES} selected)`
                              : `Choose up to ${3 - videoReferenceFiles.length} more images (${videoReferenceFiles.length}/3 selected)`}
                      </p>
                    </div>
                    <div className="flex items-center gap-2">
                      {assetPickerTarget === 'veo' && (
                        <button
                          onClick={() => setIsVideoAssetPickerOpen(false)}
                          className="px-3 py-1.5 text-xs font-medium text-white bg-[#0071e3] rounded-full hover:bg-[#0077ED] transition-colors"
                        >
                          Done
                        </button>
                      )}
                      <button
                        onClick={() => setIsVideoAssetPickerOpen(false)}
                        className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* Search */}
                  <div className="mt-3">
                    <input
                      type="text"
                      value={videoAssetSearch}
                      onChange={(e) => setVideoAssetSearch(e.target.value)}
                      placeholder="Search images..."
                      className={`w-full text-sm rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                        ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]'
                        : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'
                        }`}
                    />
                  </div>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto max-h-[calc(80vh-200px)]">
                  {(() => {
                    // Filter image assets
                    const imageAssets = assetsBySession
                      .flatMap((session) => session.assets)
                      .filter((asset) => {
                        // For Luma Source, only include videos
                        if (assetPickerTarget === 'luma-source') {
                          return asset.type === 'video' || asset.type.startsWith('video/');
                        }

                        // Only include image types for others
                        if (!['header', 'slide', 'notemap', 'social'].includes(asset.type) && !asset.type.startsWith('image/')) {
                          return false;
                        }
                        // Filter by search
                        if (videoAssetSearch.trim()) {
                          const query = videoAssetSearch.toLowerCase();
                          const title = (asset.title || '').toLowerCase();
                          const desc = (asset.description || '').toLowerCase();
                          return title.includes(query) || desc.includes(query);
                        }
                        return true;
                      });

                    if (imageAssets.length === 0) {
                      return (
                        <div className="text-center py-12">
                          <p className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                            {videoAssetSearch ? 'No images found matching your search' : 'No image assets available'}
                          </p>
                        </div>
                      );
                    }

                    return (
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {imageAssets.map((asset) => {
                          const imageUrl = asset.url || asset.data?.imageUrl;
                          if (!imageUrl) return null;

                          const isVideo = asset.type === 'video' || asset.type.startsWith('video/');

                          return (
                            <button
                              key={asset.id}
                              onClick={async () => {
                                // Use ref to get current target (avoids stale closure)
                                const currentTarget = assetPickerTargetRef.current;

                                // Selection limit check
                                if (currentTarget === 'sora') {
                                  // Sora 2 is single selection
                                } else if (currentTarget === 'image') {
                                  if (imageReferenceFiles.length >= MAX_DATA_REFERENCES) return;
                                } else if (videoReferenceFiles.length >= 3) {
                                  return;
                                }

                                setIsLoadingVideoAsset(true);
                                try {
                                  const res = await fetch(imageUrl);
                                  const blob = await res.blob();
                                  const ext = (blob.type || '').includes('jpeg') ? 'jpg' :
                                    (blob.type || '').includes('png') ? 'png' :
                                      (blob.type || '').includes('mp4') ? 'mp4' :
                                        (blob.type || '').includes('quicktime') ? 'mov' : 'bin';

                                  const fileName = `${asset.title || 'asset'}-${Date.now()}.${ext}`;
                                  // Determine mime type, default to image/png if not video
                                  const mimeType = blob.type || (isVideo ? 'video/mp4' : 'image/png');

                                  const file = new File([blob], fileName, { type: mimeType });

                                  if (currentTarget === 'sora') {
                                    setVideoImageFile(file);
                                    setIsVideoAssetPickerOpen(false);
                                    setVideoAssetSearch('');
                                    setLumaVideoFile(file);
                                    setLumaVideoAssetId(asset.id);
                                    setLumaVideoTitle(asset.title || file.name);
                                    setLumaVideoPreviewUrl(imageUrl);
                                    setIsVideoAssetPickerOpen(false);
                                    setVideoAssetSearch('');
                                  } else if (currentTarget === 'image') {
                                    setImageReferenceFiles((prev) => [...prev, file]);
                                    // Close modal after adding image for better UX
                                    setIsVideoAssetPickerOpen(false);
                                    setVideoAssetSearch('');
                                  } else {
                                    // Veo
                                    setVideoReferenceFiles((prev) => [...prev, file]);
                                    if (videoReferenceFiles.length >= 2) {
                                      setIsVideoAssetPickerOpen(false);
                                      setVideoAssetSearch('');
                                    }
                                  }
                                } catch (error) {
                                  console.error('Failed to load asset:', error);
                                  setVideoError('Failed to load selected asset');
                                } finally {
                                  setIsLoadingVideoAsset(false);
                                }
                              }}
                              disabled={isLoadingVideoAsset || (
                                assetPickerTarget === 'image' ? imageReferenceFiles.length >= MAX_DATA_REFERENCES :
                                  assetPickerTarget === 'veo' ? videoReferenceFiles.length >= 3 : false
                              )}
                              className={`group relative aspect-video rounded-xl overflow-hidden border-2 transition-all ${isLoadingVideoAsset || (
                                assetPickerTarget === 'image' ? imageReferenceFiles.length >= MAX_DATA_REFERENCES :
                                  assetPickerTarget === 'veo' ? videoReferenceFiles.length >= 3 : false
                              )
                                ? isDarkMode
                                  ? 'border-[#3d3d3f]/30 opacity-50 cursor-not-allowed'
                                  : 'border-gray-200 opacity-50 cursor-not-allowed'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] hover:border-[#0071e3] cursor-pointer'
                                  : 'border-gray-200 hover:border-[#0071e3] cursor-pointer'
                                }`}
                            >
                              {isVideo ? (
                                <video
                                  src={imageUrl}
                                  className="w-full h-full object-cover"
                                  muted
                                  onMouseOver={e => e.currentTarget.play().catch(() => { })}
                                  onMouseOut={e => { e.currentTarget.pause(); e.currentTarget.currentTime = 0; }}
                                />
                              ) : (
                                <img
                                  src={imageUrl}
                                  alt={asset.title}
                                  className="w-full h-full object-cover transition-transform group-hover:scale-105"
                                />
                              )}
                              {isVideo && (
                                <div className="absolute top-2 left-2 bg-black/60 text-white rounded-full px-2 py-1 text-[10px] font-medium backdrop-blur-sm">
                                  VIDEO
                                </div>
                              )}
                              {asset.title && (
                                <div className={`absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t ${isDarkMode ? 'from-black/80' : 'from-gray-900/80'}`}>
                                  <p className="text-xs text-white font-medium truncate">{asset.title}</p>
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )
        }



        {/* Image Generator Reference Asset Picker Modal */}
        {
          (console.log('RENDER Image Picker Check:', { isImageAssetPickerOpen, assetPickerTarget, isVideoAssetPickerOpen }), isImageAssetPickerOpen && !isLumaVideoPickerOpen && assetPickerTarget !== 'luma-source') && (
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => {
                setIsImageAssetPickerOpen(false);
                setImageAssetSearch('');
                setSelectedImageAssetIds([]);
                setSelectedVeoAssetIds([]);
              }}
            >
              <div
                className={`w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'
                  }`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        {assetPickerTarget === 'sora' ? 'Select Video Reference Image' :
                          assetPickerTarget === 'veo' ? 'Select Video Reference Images' :
                            assetPickerTarget === 'luma-first-frame' ? 'Select First Frame Reference' :
                              'Select Reference Images'}
                      </h3>
                      <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {assetPickerTarget === 'sora'
                          ? 'Choose one image from your project assets.'
                          : assetPickerTarget === 'luma-first-frame'
                            ? 'Choose an image to define the first frame style.'
                            : assetPickerTarget === 'veo'
                              ? `Choose up to 3 images from your project assets (${selectedVeoAssetIds.length}/3 selected)`
                              : `Choose images from your project assets (${selectedImageAssetIds.length}/${MAX_DATA_REFERENCES} selected)`}
                      </p>
                    </div>
                    <div className="flex items-center gap-2">
                      {(assetPickerTarget === 'veo' || assetPickerTarget === 'image') && (
                        <button
                          onClick={() => {
                            setIsImageAssetPickerOpen(false);
                            setImageAssetSearch('');
                            // Clear selection tracking on close
                            setSelectedImageAssetIds([]);
                            setSelectedVeoAssetIds([]);
                          }}
                          className="px-3 py-1.5 text-xs font-medium text-white bg-[#0071e3] rounded-full hover:bg-[#0077ED] transition-colors"
                        >
                          Done
                        </button>
                      )}
                      <button
                        onClick={() => {
                          setIsImageAssetPickerOpen(false);
                          setImageAssetSearch('');
                          // Clear selection tracking on close
                          setSelectedImageAssetIds([]);
                          setSelectedVeoAssetIds([]);
                        }}
                        className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* Search */}
                  <div className="mt-3">
                    <input
                      type="text"
                      value={imageAssetSearch}
                      onChange={(e) => setImageAssetSearch(e.target.value)}
                      placeholder="Search images..."
                      className={`w-full text-sm rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                        ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]'
                        : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'
                        }`}
                    />
                  </div>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto max-h-[calc(80vh-200px)]">
                  {(() => {
                    // Filter image assets
                    const imageAssets = assetsBySession
                      .flatMap((session) => session.assets)
                      .filter((asset) => {
                        // Only include image types
                        if (!['header', 'slide', 'notemap', 'social'].includes(asset.type) && !asset.type.startsWith('image/')) {
                          return false;
                        }
                        // Filter by search
                        if (imageAssetSearch.trim()) {
                          const query = imageAssetSearch.toLowerCase();
                          const title = (asset.title || '').toLowerCase();
                          const desc = (asset.description || '').toLowerCase();
                          return title.includes(query) || desc.includes(query);
                        }
                        return true;
                      });

                    if (imageAssets.length === 0) {
                      return (
                        <div className="text-center py-12">
                          <p className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                            {imageAssetSearch ? 'No images found matching your search' : 'No image assets available'}
                          </p>
                        </div>
                      );
                    }

                    return (
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {imageAssets.map((asset) => {
                          const imageUrl = asset.url || asset.data?.imageUrl;
                          if (!imageUrl) return null;

                          const currentTarget = assetPickerTargetRef.current;
                          // Use proper ID-based selection tracking
                          const isVeoSelected = currentTarget === 'veo' && selectedVeoAssetIds.includes(asset.id);
                          const isImageSelected = currentTarget === 'image' && selectedImageAssetIds.includes(asset.id);
                          const isSelected = isVeoSelected || isImageSelected;

                          // Check if at limit (use state arrays for accurate count)
                          const isAtLimit = currentTarget === 'image'
                            ? selectedImageAssetIds.length >= MAX_DATA_REFERENCES
                            : currentTarget === 'veo'
                              ? selectedVeoAssetIds.length >= 3
                              : false;

                          return (
                            <button
                              key={asset.id}
                              onClick={async () => {
                                // Prevent selecting already-selected items
                                if (isSelected) return;
                                // Selection limit checks
                                if (isAtLimit) return;

                                setIsLoadingImageAsset(true);
                                try {
                                  const res = await fetch(imageUrl);
                                  const blob = await res.blob();
                                  const ext = (blob.type || '').includes('jpeg') ? 'jpg' : 'png';
                                  const fileName = `${asset.title || 'asset'}-${asset.id}-${Date.now()}.${ext}`;
                                  const file = new File([blob], fileName, { type: blob.type || 'image/png' });

                                  if (currentTarget === 'sora') {
                                    // Sora: Single selection only, auto-close immediately
                                    setVideoImageFile(file);
                                    setIsImageAssetPickerOpen(false);
                                    setImageAssetSearch('');
                                    // Clear selection tracking on close
                                    setSelectedImageAssetIds([]);
                                    setSelectedVeoAssetIds([]);
                                  } else if (currentTarget === 'veo') {
                                    // Veo: Multi-selection (up to 3), manual close via Done
                                    setSelectedVeoAssetIds(prev => [...prev, asset.id]);
                                    setVideoReferenceFiles((prev) => [...prev, file]);
                                  } else if (currentTarget === 'luma-first-frame') {
                                    setLumaFirstFrameFile(file);
                                    setLumaFirstFrameAssetId(asset.id);
                                    setLumaFirstFramePreviewUrl(imageUrl);
                                    setIsImageAssetPickerOpen(false);
                                    setImageAssetSearch('');
                                  } else if (currentTarget === 'live-video-image') {
                                    setLiveVideoImageFile(file);
                                    setLiveVideoImagePreviewUrl(imageUrl);
                                    setIsImageAssetPickerOpen(false);
                                    setImageAssetSearch('');
                                  } else {
                                    // Image: Multi-selection (up to 14), manual close via Done
                                    setSelectedImageAssetIds(prev => [...prev, asset.id]);
                                    setImageReferenceFiles((prev) => [...prev, file]);
                                  }
                                } catch (error) {
                                  console.error('Failed to load image:', error);
                                  if (currentTarget === 'sora' || currentTarget === 'veo') {
                                    setVideoError('Failed to load selected image');
                                  } else {
                                    setImageError('Failed to load selected image');
                                  }
                                } finally {
                                  setIsLoadingImageAsset(false);
                                }
                              }}
                              disabled={isLoadingImageAsset || isSelected || isAtLimit}
                              className={`group relative aspect-square rounded-xl overflow-hidden border-2 transition-all ${isSelected
                                ? 'border-[#0071e3] border-4'
                                : isLoadingImageAsset || isAtLimit
                                  ? isDarkMode
                                    ? 'border-[#3d3d3f]/30 opacity-50 cursor-not-allowed'
                                    : 'border-gray-200 opacity-50 cursor-not-allowed'
                                  : isDarkMode
                                    ? 'border-[#3d3d3f] hover:border-[#0071e3] cursor-pointer'
                                    : 'border-gray-200 hover:border-[#0071e3] cursor-pointer'
                                }`}
                            >
                              <img
                                src={imageUrl}
                                alt={asset.title}
                                className="w-full h-full object-cover transition-transform group-hover:scale-105"
                              />
                              {/* Visual selection indicator */}
                              {isSelected && (
                                <div className="absolute top-2 right-2 bg-[#0071e3] text-white rounded-full w-6 h-6 flex items-center justify-center">
                                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                  </svg>
                                </div>
                              )}
                              {asset.title && (
                                <div className={`absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t ${isDarkMode ? 'from-black/80' : 'from-gray-900/80'}`}>
                                  <p className="text-xs text-white font-medium truncate">{asset.title}</p>
                                </div>
                              )}
                              {isLoadingImageAsset && (
                                <div className="absolute inset-0 flex items-center justify-center bg-black/40">
                                  <svg className="w-6 h-6 animate-spin text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10" className="opacity-25" />
                                    <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                  </svg>
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )
        }
        {
          isFormAssetPickerOpen && (
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setIsFormAssetPickerOpen(false)}
            >
              <div
                className={`w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'
                  }`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Select Images for Form
                      </h3>
                      <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {selectedFormAssetIds.length > 0
                          ? `${selectedFormAssetIds.length} images selected`
                          : 'Choose images from your project assets to provide context for the form generation.'}
                      </p>
                    </div>
                    <div className="flex items-center gap-3">
                      {selectedFormAssetIds.length > 0 && (
                        <button
                          onClick={async () => {
                            setIsLoadingFormAsset(true);
                            try {
                              const imageAssets = assetsBySession
                                .flatMap((session) => session.assets)
                                .filter((asset) => selectedFormAssetIds.includes(asset.id));

                              const files = await Promise.all(imageAssets.map(async (asset) => {
                                const imageUrl = asset.url || asset.data?.imageUrl;
                                if (!imageUrl) return null;
                                const res = await fetch(imageUrl);
                                const blob = await res.blob();
                                const ext = (blob.type || '').includes('jpeg') ? 'jpg' : 'png';
                                const fileName = `${asset.title || 'asset'}-${Date.now()}-${Math.random().toString(36).slice(2, 7)}.${ext}`;
                                return new File([blob], fileName, { type: blob.type || 'image/png' });
                              }));

                              const validFiles = files.filter((f): f is File => f !== null);
                              setLeadFormImages((prev) => [...prev, ...validFiles]);
                              setIsFormAssetPickerOpen(false);
                              setSelectedFormAssetIds([]);
                              setFormAssetSearch('');
                            } catch (error) {
                              console.error('Failed to load images:', error);
                              setLeadFormError('Failed to load selected images');
                            } finally {
                              setIsLoadingFormAsset(false);
                            }
                          }}
                          disabled={isLoadingFormAsset}
                          className={`px-4 py-1.5 rounded-full text-xs font-medium transition-colors ${isDarkMode ? 'bg-[#0071e3] text-white hover:bg-[#0077ed]' : 'bg-[#0071e3] text-white hover:bg-[#0077ed]'
                            }`}
                        >
                          {isLoadingFormAsset ? 'Loading...' : `Import ${selectedFormAssetIds.length} ${selectedFormAssetIds.length === 1 ? 'Image' : 'Images'}`}
                        </button>
                      )}
                      <button
                        onClick={() => setIsFormAssetPickerOpen(false)}
                        className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* Search */}
                  <div className="mt-3">
                    <input
                      type="text"
                      value={formAssetSearch}
                      onChange={(e) => setFormAssetSearch(e.target.value)}
                      placeholder="Search images..."
                      className={`w-full text-sm rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                        ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]'
                        : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'
                        }`}
                    />
                  </div>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto max-h-[calc(80vh-160px)]">
                  {(() => {
                    // Filter image assets
                    const imageAssets = assetsBySession
                      .flatMap((session) => session.assets)
                      .filter((asset) => {
                        // Only include image types
                        if (!['header', 'slide', 'notemap', 'social'].includes(asset.type) && !asset.type.startsWith('image/')) {
                          return false;
                        }
                        // Filter by search
                        if (formAssetSearch.trim()) {
                          const query = formAssetSearch.toLowerCase();
                          const title = (asset.title || '').toLowerCase();
                          const desc = (asset.description || '').toLowerCase();
                          return title.includes(query) || desc.includes(query);
                        }
                        return true;
                      });

                    if (imageAssets.length === 0) {
                      return (
                        <div className="text-center py-12">
                          <p className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                            {formAssetSearch ? 'No images found matching your search' : 'No image assets available'}
                          </p>
                        </div>
                      );
                    }

                    return (
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {imageAssets.map((asset) => {
                          const imageUrl = asset.url || asset.data?.imageUrl;
                          if (!imageUrl) return null;

                          return (
                            <button
                              key={asset.id}
                              onClick={() => {
                                setSelectedFormAssetIds(prev =>
                                  prev.includes(asset.id)
                                    ? prev.filter(id => id !== asset.id)
                                    : [...prev, asset.id]
                                );
                              }}
                              className={`group relative aspect-square rounded-xl overflow-hidden border-2 transition-all ${selectedFormAssetIds.includes(asset.id)
                                ? 'border-[#0071e3] ring-2 ring-[#0071e3]/20'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] hover:border-[#636366]'
                                  : 'border-gray-200 hover:border-gray-300'
                                }`}
                            >
                              <img
                                src={imageUrl}
                                alt={asset.title}
                                className="w-full h-full object-cover transition-transform group-hover:scale-105"
                              />
                              {/* Selection Overlay */}
                              <div className={`absolute top-2 right-2 w-5 h-5 rounded-full border-2 transition-all flex items-center justify-center ${selectedFormAssetIds.includes(asset.id)
                                ? 'bg-[#0071e3] border-[#0071e3]'
                                : 'bg-black/20 border-white/50 border-dashed'
                                }`}>
                                {selectedFormAssetIds.includes(asset.id) && (
                                  <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                  </svg>
                                )}
                              </div>
                              {asset.title && (
                                <div className={`absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t ${isDarkMode ? 'from-black/80' : 'from-gray-900/80'}`}>
                                  <p className="text-xs text-white font-medium truncate">{asset.title}</p>
                                </div>
                              )}
                              {isLoadingFormAsset && (
                                <div className="absolute inset-0 flex items-center justify-center bg-black/40">
                                  <svg className="w-6 h-6 animate-spin text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <circle cx="12" cy="12" r="10" className="opacity-25" />
                                    <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                                  </svg>
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )
        }

        {/* Product Asset Picker Modal */}
        {
          isProductAssetPickerOpen && (
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setIsProductAssetPickerOpen(false)}
            >
              <div
                className={`w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Select Product Image
                      </h3>
                      <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {selectedProductAssetIds.length > 0
                          ? `1 image selected`
                          : 'Choose an image from your project assets for this product.'}
                      </p>
                    </div>
                    <div className="flex items-center gap-3">
                      {selectedProductAssetIds.length > 0 && (
                        <button
                          onClick={async () => {
                            try {
                              const imageAssets = assetsBySession
                                .flatMap((session) => session.assets)
                                .filter((asset) => selectedProductAssetIds.includes(asset.id));

                              const files = await Promise.all(imageAssets.map(async (asset) => {
                                const imageUrl = asset.url || asset.data?.imageUrl;
                                if (!imageUrl) return null;
                                const res = await fetch(imageUrl);
                                const blob = await res.blob();
                                const ext = (blob.type || '').includes('jpeg') ? 'jpg' : 'png';
                                const fileName = `${asset.title || 'product'}-${Date.now()}-${Math.random().toString(36).slice(2, 7)}.${ext}`;
                                return new File([blob], fileName, { type: blob.type || 'image/png' });
                              }));

                              const validFiles = files.filter((f): f is File => f !== null);
                              setProductImages(validFiles); // Replace existing images with the new selection
                              setIsProductAssetPickerOpen(false);
                              setProductAssetSearch('');
                            } catch (error) {
                              console.error('Failed to load images:', error);
                              setProductError('Failed to load selected images');
                            }
                          }}
                          className="px-4 py-2 rounded-xl text-sm font-medium bg-[#0071e3] text-white hover:bg-[#0077ED] transition-colors"
                        >
                          Select Image
                        </button>
                      )}
                      <button
                        onClick={() => {
                          setIsProductAssetPickerOpen(false);
                          setProductAssetSearch('');
                        }}
                        className={`p-2 rounded-xl transition-colors ${isDarkMode ? 'hover:bg-white/10 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  {/* Search */}
                  <div className="mt-3">
                    <input
                      type="text"
                      placeholder="Search images..."
                      value={productAssetSearch}
                      onChange={(e) => setProductAssetSearch(e.target.value)}
                      className={`w-full text-sm rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]' : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'}`}
                    />
                  </div>
                </div>
                {/* Content */}
                <div className="p-6 overflow-y-auto max-h-[60vh]">
                  {(() => {
                    const imageAssets = assetsBySession
                      .flatMap((session) => session.assets)
                      .filter((asset) => {
                        if (!['header', 'slide', 'notemap', 'social'].includes(asset.type) && !asset.type.startsWith('image/')) {
                          return false;
                        }
                        if (productAssetSearch.trim()) {
                          const query = productAssetSearch.toLowerCase();
                          const title = (asset.title || '').toLowerCase();
                          const desc = (asset.description || '').toLowerCase();
                          return title.includes(query) || desc.includes(query);
                        }
                        return true;
                      });

                    if (imageAssets.length === 0) {
                      return (
                        <div className="text-center py-12">
                          <p className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                            {productAssetSearch ? 'No images found matching your search' : 'No image assets available'}
                          </p>
                        </div>
                      );
                    }

                    return (
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {imageAssets.map((asset) => {
                          const imageUrl = asset.url || asset.data?.imageUrl;
                          if (!imageUrl) return null;

                          return (
                            <button
                              key={asset.id}
                              onClick={() => {
                                // Single selection mode for product images
                                setSelectedProductAssetIds([asset.id]);
                              }}
                              className={`group relative aspect-square rounded-xl overflow-hidden border-2 transition-all ${selectedProductAssetIds.includes(asset.id)
                                ? 'border-[#0071e3] ring-2 ring-[#0071e3]/20'
                                : isDarkMode
                                  ? 'border-[#3d3d3f] hover:border-[#636366]'
                                  : 'border-gray-200 hover:border-gray-300'
                                }`}
                            >
                              <img
                                src={imageUrl}
                                alt={asset.title}
                                className="w-full h-full object-cover transition-transform group-hover:scale-105"
                              />
                              <div className={`absolute top-2 right-2 w-5 h-5 rounded-full border-2 transition-all flex items-center justify-center ${selectedProductAssetIds.includes(asset.id)
                                ? 'bg-[#0071e3] border-[#0071e3]'
                                : 'bg-black/20 border-white/50 border-dashed'
                                }`}>
                                {selectedProductAssetIds.includes(asset.id) && (
                                  <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                  </svg>
                                )}
                              </div>
                              {asset.title && (
                                <div className={`absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t ${isDarkMode ? 'from-black/80' : 'from-gray-900/80'}`}>
                                  <p className="text-xs text-white font-medium truncate">{asset.title}</p>
                                </div>
                              )}
                            </button>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>
          )
        }

        {/* Order Fulfillment Modal */}
        {
          isFulfillmentModalOpen && selectedOrder && (
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setIsFulfillmentModalOpen(false)}
            >
              <div
                className={`w-full max-w-md rounded-2xl shadow-2xl p-6 ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                <div className="flex justify-between items-center mb-4">
                  <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                    Fulfill Order
                  </h3>
                  <button onClick={() => setIsFulfillmentModalOpen(false)}>
                    <svg className={`w-5 h-5 ${isDarkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-900'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                <div className="space-y-4">
                  {/* Gmail Connect */}
                  <div className="space-y-4">
                    {/* Gmail Connect */}
                    <div className={`p-3 rounded-lg border flex justify-between items-center ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                      <div className="flex items-center gap-2">
                        <div className={`w-2 h-2 rounded-full ${gmailConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <span className={`text-sm font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>Gmail</span>
                      </div>
                      <div className="flex gap-2">
                        {gmailConnected && (
                          <button
                            onClick={() => setEmailProvider('gmail')}
                            className={`text-xs px-2 py-1 rounded border ${emailProvider === 'gmail' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-transparent text-gray-500'}`}
                          >
                            Use
                          </button>
                        )}
                        {!gmailConnected ? (
                          <button
                            onClick={async () => {
                              setCheckingGmail(true);
                              try {
                                const res = await authFetch('/api/email?op=auth-url&provider=gmail&returnTo=' + encodeURIComponent(window.location.pathname));
                                const data = await res.json();
                                if (data.url) {
                                  const width = 600;
                                  const height = 700;
                                  const left = window.screen.width / 2 - width / 2;
                                  const top = window.screen.height / 2 - height / 2;
                                  window.open(data.url, 'Connect Gmail', `width=${width},height=${height},left=${left},top=${top}`);
                                }
                              } catch (e) { console.error(e); }
                              finally { setCheckingGmail(false); }
                            }}
                            disabled={checkingGmail}
                            className="text-xs px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
                          >
                            Connect
                          </button>
                        ) : (
                          <span className="text-xs text-green-600 font-medium self-center">Connected</span>
                        )}
                      </div>
                    </div>

                    {/* Outlook Connect */}
                    <div className={`p-3 rounded-lg border flex justify-between items-center ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-gray-50 border-gray-200'}`}>
                      <div className="flex items-center gap-2">
                        <div className={`w-2 h-2 rounded-full ${outlookConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <span className={`text-sm font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>Outlook</span>
                      </div>
                      <div className="flex gap-2">
                        {outlookConnected && (
                          <button
                            onClick={() => setEmailProvider('outlook')}
                            className={`text-xs px-2 py-1 rounded border ${emailProvider === 'outlook' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'border-transparent text-gray-500'}`}
                          >
                            Use
                          </button>
                        )}
                        {!outlookConnected ? (
                          <button
                            onClick={async () => {
                              setCheckingGmail(true);
                              try {
                                const res = await authFetch('/api/email?op=auth-url&provider=outlook&returnTo=' + encodeURIComponent(window.location.pathname));
                                const data = await res.json();
                                if (data.url) {
                                  const width = 600;
                                  const height = 700;
                                  const left = window.screen.width / 2 - width / 2;
                                  const top = window.screen.height / 2 - height / 2;
                                  window.open(data.url, 'Connect Outlook', `width=${width},height=${height},left=${left},top=${top}`);
                                }
                              } catch (e) { console.error(e); }
                              finally { setCheckingGmail(false); }
                            }}
                            disabled={checkingGmail}
                            className="text-xs px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
                          >
                            Connect
                          </button>
                        ) : (
                          <span className="text-xs text-green-600 font-medium self-center">Connected</span>
                        )}
                      </div>
                    </div>

                    {/* Provider Selection Hint */}
                    {(gmailConnected || outlookConnected) && (
                      <p className="text-xs text-gray-400 text-right">
                        Sending via: <span className="font-semibold text-blue-500 uppercase">{emailProvider}</span>
                      </p>
                    )}
                  </div>

                  <div>
                    <label className={`block text-xs font-medium mb-1.5 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>Customer</label>
                    <p className={`text-sm ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      {selectedOrder.customerName || 'Customer'} <span className="opacity-50">&lt;{selectedOrder.customerEmail}&gt;</span>
                    </p>
                  </div>

                  <div>
                    <label className={`block text-xs font-medium mb-1.5 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>Files to Send</label>
                    <label className={`cursor-pointer flex flex-col items-center justify-center w-full h-24 rounded-xl border-2 border-dashed transition-colors ${isDarkMode
                      ? 'border-[#3d3d3f] hover:border-[#636366] bg-[#111111]'
                      : 'border-gray-200 hover:border-gray-300 bg-gray-50'
                      }`}>
                      {fulfillmentFile ? (
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium truncate max-w-[200px]">{fulfillmentFile.name}</span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setFulfillmentFile(null);
                            }}
                            className="p-1 rounded-full bg-red-500/10 text-red-500 hover:bg-red-500/20"
                          >
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                          </button>
                        </div>
                      ) : (
                        <>
                          <svg className="w-6 h-6 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                          </svg>
                          <span className="text-xs text-gray-400">Click to upload file</span>
                        </>
                      )}
                      <input
                        type="file"
                        className="hidden"
                        onChange={(e) => {
                          if (e.target.files && e.target.files[0]) {
                            setFulfillmentFile(e.target.files[0]);
                          }
                        }}
                      />
                    </label>
                  </div>

                  <div>
                    <label className={`block text-xs font-medium mb-1.5 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>Message (optional)</label>
                    <textarea
                      value={fulfillmentMessage}
                      onChange={(e) => setFulfillmentMessage(e.target.value)}
                      placeholder="Here is your requested file..."
                      rows={3}
                      className={`w-full text-sm rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                        ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]'
                        : 'bg-white border border-gray-200 text-gray-900 placeholder:text-gray-500'
                        }`}
                    />
                  </div>

                  {fulfillmentError && (
                    <p className="text-xs text-red-500 bg-red-500/10 p-2 rounded-lg">{fulfillmentError}</p>
                  )}
                  {fulfillmentSuccess && (
                    <p className="text-xs text-green-500 bg-green-500/10 p-2 rounded-lg">{fulfillmentSuccess}</p>
                  )}

                  <div className="flex justify-end gap-2 pt-2">
                    <button
                      onClick={() => setIsFulfillmentModalOpen(false)}
                      className={`px-4 py-2 rounded-xl text-sm font-medium transition-colors ${isDarkMode
                        ? 'bg-[#2d2d2f] text-white hover:bg-[#3d3d3f]'
                        : 'bg-gray-100 text-gray-900 hover:bg-gray-200'
                        }`}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleSendFulfillment}
                      disabled={isSendingFulfillment || !fulfillmentFile}
                      className="px-4 py-2 rounded-xl text-sm font-medium bg-[#0071e3] text-white hover:bg-[#0077ED] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                    >
                      {isSendingFulfillment && (
                        <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10" className="opacity-25" />
                          <path d="M4 12a8 8 0 018-8" className="opacity-75" />
                        </svg>
                      )}
                      {isSendingFulfillment ? 'Sending...' : 'Send Email'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )
        }



        {
          insufficientCreditsModal && (
            <InsufficientCreditsModal
              isOpen={insufficientCreditsModal.isOpen}
              onClose={() => setInsufficientCreditsModal(null)}
              onUpgrade={() => {
                setInsufficientCreditsModal(null);
                // Handle upgrade navigation if needed
              }}
              isDarkMode={isDarkMode}
              operation={insufficientCreditsModal.operation}
              creditsNeeded={insufficientCreditsModal.cost}
              currentCredits={insufficientCreditsModal.current}
            />
          )
        }

        {
          usageLimitModal && (
            <UsageLimitModal
              isOpen={usageLimitModal.isOpen}
              onClose={() => setUsageLimitModal(null)}
              onUpgrade={() => setUsageLimitModal(null)}
              isDarkMode={isDarkMode}
              usageType={usageLimitModal.usageType}
              current={usageLimitModal.current}
              limit={usageLimitModal.limit}
              isSubscribed={isSubscribed}
            />
          )
        }

        {/* Lead Email Modal */}
        {
          isLeadEmailModalOpen && (selectedLead || isBulkEmail) && createPortal(
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setIsLeadEmailModalOpen(false)}
            >
              <div
                className={`w-full max-w-lg max-h-[90vh] flex flex-col rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        {isBulkEmail ? `Email ${emailRecipients.length} Recipients` : 'Send Email'}
                      </h3>
                      <p className={`text-sm mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {isBulkEmail
                          ? `Sending to ${emailRecipients.length} people`
                          : `Send an email to ${selectedLead?.data?.email || selectedLead?.data?.Email || 'this lead'}`
                        }
                      </p>
                    </div>
                    <button
                      onClick={() => setIsLeadEmailModalOpen(false)}
                      className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>

                {/* Content */}
                <div className="p-6 space-y-4 overflow-y-auto flex-1 min-h-0">
                  {/* Provider Selection */}
                  <div>
                    <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      Send via
                    </label>
                    <div className="flex gap-3">
                      <button
                        onClick={() => setEmailProvider('gmail')}
                        className={`flex-1 py-2 px-4 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2 ${emailProvider === 'gmail'
                          ? 'bg-[#EA4335]/20 border-2 border-[#EA4335] text-[#EA4335]'
                          : isDarkMode
                            ? 'bg-white/5 border border-[#3d3d3f] text-[#86868b] hover:bg-white/10'
                            : 'bg-gray-100 border border-gray-200 text-gray-600 hover:bg-gray-200'
                          }`}
                      >
                        <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z" />
                        </svg>
                        Gmail
                        {gmailConnected && (
                          <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                          </svg>
                        )}
                      </button>
                      <button
                        onClick={() => setEmailProvider('outlook')}
                        className={`flex-1 py-2 px-4 rounded-xl text-sm font-medium transition-all flex items-center justify-center gap-2 ${emailProvider === 'outlook'
                          ? 'bg-[#0078D4]/20 border-2 border-[#0078D4] text-[#0078D4]'
                          : isDarkMode
                            ? 'bg-white/5 border border-[#3d3d3f] text-[#86868b] hover:bg-white/10'
                            : 'bg-gray-100 border border-gray-200 text-gray-600 hover:bg-gray-200'
                          }`}
                      >
                        <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.86t.1-.87q.1-.43.34-.76.22-.34.59-.54.36-.2.87-.2t.86.2q.35.21.57.55.22.34.31.77.1.43.1.88m-.25-4.82h8.98l.03.95H7.67l-.04-.95M14.12 5h-4.4q-.83 0-1.5.58-.66.57-.7 1.38l.001.52h8.8V5m-4.4 12.35V22H5.62V8.2q0-.75.57-1.32.57-.58 1.33-.58h4.4m0-1.12h-4.4q-.94 0-1.63.64-.68.65-.68 1.58V22H7.6V8.98q0-.64.43-1.07.44-.43 1.06-.43h4.4V17.35M22 8.13V22H9.72V17.35h7.88V8.13H22m-2.4 13.27h-4.07v-4.02l4.07-.001v4.021" />
                        </svg>
                        Outlook
                        {outlookConnected && (
                          <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                          </svg>
                        )}
                      </button>
                    </div>

                    {/* Connect buttons */}
                    <div className="mt-3 flex gap-2">
                      {!gmailConnected && (
                        <button
                          onClick={async () => {
                            const res = await authFetch(`/api/email?op=auth-url&provider=gmail&returnTo=${encodeURIComponent(window.location.pathname)}`);
                            const data = await res.json();
                            if (data.url) {
                              const width = 600;
                              const height = 700;
                              const left = window.screen.width / 2 - width / 2;
                              const top = window.screen.height / 2 - height / 2;
                              window.open(data.url, 'Connect Gmail', `width=${width},height=${height},left=${left},top=${top}`);
                            }
                          }}
                          className="flex-1 py-2 px-3 rounded-lg text-xs font-medium bg-[#EA4335] text-white hover:bg-[#D33426] transition-colors"
                        >
                          Connect Gmail
                        </button>
                      )}
                      {!outlookConnected && (
                        <button
                          onClick={async () => {
                            const res = await authFetch(`/api/email?op=auth-url&provider=outlook&returnTo=${encodeURIComponent(window.location.pathname)}`);
                            const data = await res.json();
                            if (data.url) {
                              const width = 600;
                              const height = 700;
                              const left = window.screen.width / 2 - width / 2;
                              const top = window.screen.height / 2 - height / 2;
                              window.open(data.url, 'Connect Outlook', `width=${width},height=${height},left=${left},top=${top}`);
                            }
                          }}
                          className="flex-1 py-2 px-3 rounded-lg text-xs font-medium bg-[#0078D4] text-white hover:bg-[#006CBE] transition-colors"
                        >
                          Connect Outlook
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Template & Subject Area */}
                  <div className="space-y-4">

                    {/* Templates Controls */}
                    <div className="flex items-end gap-2">
                      <div className="flex-1">
                        <label className={`block text-xs font-medium mb-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                          Load Template
                        </label>
                        <select
                          onChange={(e) => handleSelectTemplate(e.target.value)}
                          className={`w-full rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                            ? 'bg-[#111111] border border-[#3d3d3f] text-white'
                            : 'bg-white border border-gray-200 text-gray-900'
                            }`}
                          defaultValue=""
                        >
                          <option value="" disabled>Select a template...</option>
                          {(project.emailTemplates || []).map(t => (
                            <option key={t.id} value={t.id}>{t.name}</option>
                          ))}
                        </select>
                      </div>
                    </div>

                    {/* Subject */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Subject
                      </label>
                      <input
                        type="text"
                        value={leadEmailSubject}
                        onChange={(e) => setLeadEmailSubject(e.target.value)}
                        placeholder="Email subject..."
                        className={`w-full rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                          ? 'bg-[#111111] border border-[#3d3d3f] text-white placeholder:text-[#636366]'
                          : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'
                          }`}
                      />
                    </div>

                    {/* Body */}
                    <div>
                      <div className="flex justify-between items-center mb-2">
                        <label className={`block text-sm font-medium ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                          Message
                        </label>
                        <div className="flex bg-gray-100 rounded-lg p-1 dark:bg-white/5">
                          <button
                            onClick={() => setShowPreview(true)}
                            className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${showPreview
                              ? 'bg-white text-gray-900 shadow-sm dark:bg-white/10 dark:text-white'
                              : 'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'
                              }`}
                          >
                            Visual
                          </button>
                          <button
                            onClick={() => setShowPreview(false)}
                            className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${!showPreview
                              ? 'bg-white text-gray-900 shadow-sm dark:bg-white/10 dark:text-white'
                              : 'text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'
                              }`}
                          >
                            Code
                          </button>
                        </div>
                      </div>
                      {showPreview ? (
                        <div
                          className={`w-full rounded-xl px-4 py-2.5 text-sm min-h-[192px] max-h-[400px] overflow-y-auto ${isDarkMode
                            ? 'bg-[#111111] border border-[#3d3d3f] text-white'
                            : 'bg-gray-50 border border-gray-200 text-gray-900'
                            }`}
                          dangerouslySetInnerHTML={{ __html: leadEmailBody }}
                        />
                      ) : (
                        <textarea
                          value={leadEmailBody}
                          onChange={(e) => setLeadEmailBody(e.target.value)}
                          placeholder="Write your message..."
                          rows={8}
                          className={`w-full rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#0071e3] resize-none ${isDarkMode
                            ? 'bg-[#111111] border border-[#3d3d3f] text-white placeholder:text-[#636366]'
                            : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'
                            }`}
                        />
                      )}
                    </div>

                    {/* Attachments */}
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Attachments
                      </label>
                      <div className="flex flex-col gap-2">
                        <input
                          type="file"
                          multiple
                          onChange={(e) => {
                            if (e.target.files) {
                              setEmailAttachments(Array.from(e.target.files));
                            }
                          }}
                          className={`block w-full text-sm ${isDarkMode ? 'text-gray-300' : 'text-gray-500'}
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100
                        `}
                        />
                        {emailAttachments.length > 0 && (
                          <div className="flex flex-wrap gap-2">
                            {emailAttachments.map((file, index) => (
                              <span key={index} className={`text-xs px-2 py-1 rounded-md flex items-center gap-1 ${isDarkMode ? 'bg-white/10 text-white' : 'bg-gray-100 text-gray-700'}`}>
                                {file.name}
                                <button
                                  onClick={() => setEmailAttachments(prev => prev.filter((_, i) => i !== index))}
                                  className="hover:text-red-500"
                                >
                                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Save Template Control */}
                    <div>
                      {!showSaveTemplateInput ? (
                        <button
                          onClick={() => setShowSaveTemplateInput(true)}
                          className={`text-xs font-medium ${isDarkMode ? 'text-[#0071e3]' : 'text-blue-600'} hover:underline`}
                        >
                          + Save as new template
                        </button>
                      ) : (
                        <div className="flex items-center gap-2 mt-2">
                          <input
                            type="text"
                            value={templateName}
                            onChange={(e) => setTemplateName(e.target.value)}
                            placeholder="Template name..."
                            className={`flex-1 rounded-lg px-3 py-1.5 text-sm ${isDarkMode
                              ? 'bg-[#111111] border border-[#3d3d3f] text-white'
                              : 'bg-white border border-gray-200'}`}
                          />
                          <button
                            onClick={handleSaveTemplate}
                            disabled={!templateName.trim() || isSavingTemplate}
                            className="px-3 py-1.5 rounded-lg bg-[#0071e3] text-white text-xs font-medium disabled:opacity-50"
                          >
                            Save
                          </button>
                          <button
                            onClick={() => setShowSaveTemplateInput(false)}
                            className={`px-3 py-1.5 rounded-lg text-xs font-medium ${isDarkMode ? 'bg-white/10' : 'bg-gray-200'}`}
                          >
                            Cancel
                          </button>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Schedule Mode Toggle */}
                  <div>
                    <label className={`block text-xs font-semibold uppercase tracking-wider mb-2 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Delivery
                    </label>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setLeadEmailScheduleMode('now')}
                        className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors ${leadEmailScheduleMode === 'now'
                          ? 'bg-green-600 text-white'
                          : isDarkMode
                            ? 'bg-white/5 border border-[#3d3d3f] text-[#86868b]'
                            : 'bg-gray-100 text-gray-600'
                          }`}
                      >
                        Send Now
                      </button>
                      <button
                        onClick={() => setLeadEmailScheduleMode('schedule')}
                        className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors ${leadEmailScheduleMode === 'schedule'
                          ? 'bg-purple-600 text-white'
                          : isDarkMode
                            ? 'bg-white/5 border border-[#3d3d3f] text-[#86868b]'
                            : 'bg-gray-100 text-gray-600'
                          }`}
                      >
                         Schedule
                      </button>
                    </div>
                  </div>

                  {/* Schedule DateTime Picker */}
                  {leadEmailScheduleMode === 'schedule' && (
                    <div>
                      <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Schedule Date & Time
                      </label>
                      <input
                        type="datetime-local"
                        value={leadEmailScheduledDateTime}
                        onChange={(e) => setLeadEmailScheduledDateTime(e.target.value)}
                        min={new Date(Date.now() + 10 * 60 * 1000).toISOString().slice(0, 16)}
                        max={new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16)}
                        className={`w-full px-3 py-2 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 ${isDarkMode
                          ? 'bg-[#111111] border border-[#3d3d3f] text-white'
                          : 'bg-gray-50 border border-gray-200 text-gray-900'
                          }`}
                      />
                      <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-400'}`}>
                        Schedule between 10 minutes and 7 days from now
                      </p>
                    </div>
                  )}

                  {/* Error/Success messages */}
                  {leadEmailError && (
                    <p className="text-sm text-red-500">{leadEmailError}</p>
                  )}
                  {leadEmailSuccess && (
                    <p className="text-sm text-green-500">{leadEmailSuccess}</p>
                  )}
                </div>

                {/* Footer */}
                <div className={`px-6 py-4 border-t ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'} flex justify-end gap-3`}>
                  <button
                    onClick={() => {
                      setIsLeadEmailModalOpen(false);
                      setEmailAttachments([]);
                    }}
                    className={`px-4 py-2 rounded-xl text-sm font-medium ${isDarkMode
                      ? 'bg-white/5 text-[#86868b] hover:bg-white/10'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={leadEmailScheduleMode === 'schedule' ? handleScheduleLeadEmail : handleSendEmail}
                    disabled={(isSendingLeadEmail || isSchedulingLeadEmail) || (!gmailConnected && !outlookConnected) || (leadEmailScheduleMode === 'schedule' && !leadEmailScheduledDateTime)}
                    className={`px-6 py-2 rounded-xl text-sm font-semibold transition-all ${(isSendingLeadEmail || isSchedulingLeadEmail) || (!gmailConnected && !outlookConnected) || (leadEmailScheduleMode === 'schedule' && !leadEmailScheduledDateTime)
                      ? 'bg-gray-400/50 text-white/50 cursor-not-allowed'
                      : leadEmailScheduleMode === 'schedule' ? 'bg-purple-600 text-white hover:bg-purple-700 shadow-lg shadow-purple-600/20' : 'bg-[#0071e3] text-white hover:bg-[#0077ED] shadow-lg shadow-[#0071e3]/20'
                      }`}
                  >
                    {isSchedulingLeadEmail
                      ? 'Scheduling...'
                      : isSendingLeadEmail
                        ? 'Sending...'
                        : leadEmailScheduleMode === 'schedule'
                          ? ` Schedule Email`
                          : 'Send Email'
                    }
                  </button>
                </div>
              </div>
            </div >,
            document.body
          )
        }

        {/* E-commerce Product Picker Modal */}
        {
          isEcommerceProductPickerOpen && createPortal(
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setIsEcommerceProductPickerOpen(false)}
            >
              <div
                className={`w-full max-w-3xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                        Select Products for Store
                      </h3>
                      <p className={`text-sm mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {selectedEcommerceProductIds.length} products selected
                      </p>
                    </div>
                    <button
                      onClick={() => setIsEcommerceProductPickerOpen(false)}
                      className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto max-h-[calc(80vh-180px)]">
                  {(project.stripeProducts || []).length === 0 ? (
                    <div className={`text-center py-12 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                      <svg className="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                      </svg>
                      <p className="text-sm">No products available</p>
                      <p className="text-xs mt-1">Create products in the Products tab first</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      {(project.stripeProducts || []).map(product => {
                        const isSelected = selectedEcommerceProductIds.includes(product.id);
                        return (
                          <button
                            key={product.id}
                            onClick={() => {
                              setSelectedEcommerceProductIds(prev =>
                                isSelected
                                  ? prev.filter(id => id !== product.id)
                                  : [...prev, product.id]
                              );
                            }}
                            className={`p-4 rounded-xl border-2 text-left transition-all ${isSelected
                              ? 'border-[#0071e3] bg-[#0071e3]/10'
                              : isDarkMode
                                ? 'border-[#3d3d3f] hover:border-[#5d5d5f] bg-[#111111]'
                                : 'border-gray-200 hover:border-gray-300 bg-gray-50'
                              }`}
                          >
                            <div className="flex gap-4">
                              {/* Product Image */}
                              <div className={`w-16 h-16 rounded-lg overflow-hidden flex-shrink-0 ${isDarkMode ? 'bg-[#2d2d2f]' : 'bg-gray-100'}`}>
                                {product.images?.[0] ? (
                                  <img src={product.images[0]} alt={product.name} className="w-full h-full object-cover" />
                                ) : (
                                  <div className="w-full h-full flex items-center justify-center">
                                    <svg className="w-6 h-6 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg>
                                  </div>
                                )}
                              </div>

                              {/* Product Info */}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-start justify-between gap-2">
                                  <h4 className={`font-medium text-sm truncate ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                                    {product.name}
                                  </h4>
                                  {isSelected && (
                                    <svg className="w-5 h-5 text-[#0071e3] flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                    </svg>
                                  )}
                                </div>
                                <p className={`text-xs mt-1 line-clamp-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                                  {product.description || 'No description'}
                                </p>
                                <p className={`text-sm font-semibold mt-2 ${isDarkMode ? 'text-[#30d158]' : 'text-green-600'}`}>
                                  {(product.unitAmount / 100).toFixed(2)} {product.currency.toUpperCase()}
                                </p>
                              </div>
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Footer */}
                <div className={`px-6 py-4 border-t ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'} flex justify-end gap-3`}>
                  <button
                    onClick={() => setSelectedEcommerceProductIds([])}
                    className={`px-4 py-2 rounded-xl text-sm font-medium ${isDarkMode
                      ? 'bg-white/5 text-[#86868b] hover:bg-white/10'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                  >
                    Clear All
                  </button>
                  <button
                    onClick={() => setIsEcommerceProductPickerOpen(false)}
                    className="px-6 py-2 rounded-xl text-sm font-semibold bg-[#0071e3] text-white hover:bg-[#0077ED] shadow-lg shadow-[#0071e3]/20"
                  >
                    Done ({selectedEcommerceProductIds.length})
                  </button>
                </div>
              </div>
            </div>,
            document.body
          )
        }

        {/* Custom Domain Modal */}
        {
          customDomainModalOpen && createPortal(
            <div
              className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
              onClick={() => setCustomDomainModalOpen(null)}
            >
              <div
                className={`w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
                onClick={(e) => e.stopPropagation()}
              >
                {/* Header */}
                <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                         Custom Domain
                      </h3>
                      <p className={`text-sm mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        Map your own domain to this website
                      </p>
                    </div>
                    <button
                      onClick={() => setCustomDomainModalOpen(null)}
                      className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>

                {/* Content */}
                <div className="p-6 space-y-4">
                  {customDomainLoading ? (
                    <div className="flex items-center justify-center py-8">
                      <svg className="animate-spin w-6 h-6 text-[#0071e3]" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                      </svg>
                    </div>
                  ) : customDomainStatus?.hasDomain ? (
                    /* Domain already configured */
                    <div className="space-y-4">
                      <div className={`p-4 rounded-xl ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]' : 'bg-gray-50 border border-gray-200'}`}>
                        <div className="flex items-center justify-between">
                          <div>
                            <p className={`text-xs font-medium uppercase tracking-wider ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>
                              Current Domain
                            </p>
                            <p className={`text-lg font-semibold mt-1 ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                              {customDomainStatus.domain}
                            </p>
                          </div>
                          <div className={`px-3 py-1 rounded-full text-xs font-medium ${customDomainStatus.verified
                            ? 'bg-green-500/20 text-green-400'
                            : 'bg-yellow-500/20 text-yellow-400'
                            }`}>
                            {customDomainStatus.verified ? ' Verified' : ' Pending'}
                          </div>
                        </div>
                      </div>

                      {!customDomainStatus.verified && customDomainStatus.verification && (
                        <div className={`p-4 rounded-xl ${isDarkMode ? 'bg-yellow-500/10 border border-yellow-500/20' : 'bg-yellow-50 border border-yellow-200'}`}>
                          <p className={`text-sm font-medium mb-2 ${isDarkMode ? 'text-yellow-400' : 'text-yellow-800'}`}>
                             DNS Configuration Required
                          </p>
                          <p className={`text-xs mb-3 ${isDarkMode ? 'text-yellow-400/70' : 'text-yellow-700'}`}>
                            Add one of the following DNS records to verify your domain:
                          </p>
                          {customDomainStatus.verification.map((v, idx) => (
                            <div key={idx} className={`p-3 rounded-lg text-xs font-mono ${isDarkMode ? 'bg-black/30' : 'bg-white'}`}>
                              <p className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Type: <span className="text-white font-semibold">{v.type}</span></p>
                              <p className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Name: <span className="text-white font-semibold">{v.domain}</span></p>
                              <p className={isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}>Value: <span className="text-white font-semibold break-all">{v.value}</span></p>
                            </div>
                          ))}
                        </div>
                      )}

                      <div className={`p-4 rounded-xl ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]' : 'bg-blue-50 border border-blue-200'}`}>
                        <p className={`text-sm font-medium mb-3 ${isDarkMode ? 'text-[#86868b]' : 'text-blue-800'}`}>
                           Quick DNS Setup Guide
                        </p>
                        <div className={`text-xs space-y-3 ${isDarkMode ? 'text-[#86868b]' : 'text-blue-700'}`}>
                          <div>
                            <p className="mb-1 font-medium text-[13px]">For root domains (e.g. example.com):</p>
                            <div className={`font-mono p-2.5 rounded-lg border ${isDarkMode ? 'bg-black/30 border-white/5' : 'bg-white border-blue-100'} flex items-center justify-between`}>
                              <span>A Record</span>
                              <span className="font-semibold select-all">76.76.21.21</span>
                            </div>
                          </div>
                          <div>
                            <p className="mb-1 font-medium text-[13px]">For subdomains (e.g. shop.example.com):</p>
                            <div className={`font-mono p-2.5 rounded-lg border ${isDarkMode ? 'bg-black/30 border-white/5' : 'bg-white border-blue-100'} flex items-center justify-between`}>
                              <span>CNAME Record</span>
                              <span className="font-semibold select-all">cname.vercel-dns.com</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={handleCheckDomainStatus}
                          disabled={customDomainLoading}
                          className={`flex-1 px-4 py-2.5 rounded-xl text-sm font-medium transition-colors ${isDarkMode
                            ? 'bg-white/5 text-white hover:bg-white/10'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                        >
                           Check Status
                        </button>
                        <button
                          onClick={handleRemoveCustomDomain}
                          disabled={customDomainLoading}
                          className="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors"
                        >
                           Remove Domain
                        </button>
                      </div>
                    </div>
                  ) : (
                    /* Add new domain */
                    <div className="space-y-4">
                      <div>
                        <label className={`block text-sm font-medium mb-2 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-700'}`}>
                          Enter your domain
                        </label>
                        <input
                          type="text"
                          value={customDomainInput}
                          onChange={(e) => setCustomDomainInput(e.target.value)}
                          placeholder="example.com or www.example.com"
                          className={`w-full px-4 py-3 rounded-xl text-sm ${isDarkMode
                            ? 'bg-[#111111] border border-[#3d3d3f] text-white placeholder-[#636366] focus:border-[#0071e3]'
                            : 'bg-gray-50 border border-gray-300 text-gray-900 placeholder-gray-400 focus:border-[#0071e3]'
                            } outline-none transition-colors`}
                        />
                      </div>

                      <div className={`p-4 rounded-xl ${isDarkMode ? 'bg-[#111111] border border-[#3d3d3f]' : 'bg-blue-50 border border-blue-200'}`}>
                        <p className={`text-sm font-medium mb-2 ${isDarkMode ? 'text-[#86868b]' : 'text-blue-800'}`}>
                           After adding your domain, you'll need to:
                        </p>
                        <ol className={`text-xs space-y-1 list-decimal list-inside ${isDarkMode ? 'text-[#86868b]' : 'text-blue-700'}`}>
                          <li>Log in to your domain registrar (GoDaddy, Namecheap, etc.)</li>
                          <li>Add a DNS record pointing to Vercel</li>
                          <li>Wait for DNS propagation (usually 5-30 minutes)</li>
                          <li>Click "Check Status" to verify</li>
                        </ol>
                      </div>

                      {customDomainError && (
                        <div className="p-3 rounded-xl bg-red-500/20 text-red-400 text-sm">
                           {customDomainError}
                        </div>
                      )}

                      <button
                        onClick={handleAddCustomDomain}
                        disabled={customDomainLoading || !customDomainInput.trim()}
                        className={`w-full px-4 py-3 rounded-xl text-sm font-semibold transition-all ${customDomainLoading || !customDomainInput.trim()
                          ? 'bg-[#0071e3]/50 text-white/50 cursor-not-allowed'
                          : 'bg-[#0071e3] text-white hover:bg-[#0077ED] shadow-lg shadow-[#0071e3]/20'
                          }`}
                      >
                        {customDomainLoading ? 'Adding...' : ' Add Custom Domain'}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>,
            document.body
          )
        }
      </div>

      {
        isWebsiteAssetPickerOpen && (
          <div
            className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
            onClick={() => setIsWebsiteAssetPickerOpen(false)}
          >
            <div
              className={`w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                <div className="flex items-center justify-between gap-4">
                  <div>
                    <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                      Select Media for Website
                    </h3>
                    <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                      Choose images and videos ({selectedWebsiteAssetIds.length} selected)
                    </p>
                  </div>

                  <div className="flex-1 max-w-xs">
                    <div className={`relative flex items-center px-3 py-2 rounded-lg border ${isDarkMode ? 'bg-[#1c1c1e] border-[#3d3d3f]' : 'bg-gray-50 border-gray-200'}`}>
                      <svg className={`w-4 h-4 mr-2 ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                      <input
                        type="text"
                        className={`w-full bg-transparent text-sm outline-none ${isDarkMode ? 'text-white placeholder-gray-500' : 'text-gray-900 placeholder-gray-400'}`}
                        placeholder="Search assets..."
                        value={mediaPickerSearch}
                        onChange={(e) => setMediaPickerSearch(e.target.value)}
                      />
                    </div>
                  </div>

                  <button
                    onClick={() => setIsWebsiteAssetPickerOpen(false)}
                    className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
              <div className="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
                {(() => {
                  const mediaAssets = allAssets
                    .filter((asset) => {
                      // Filter by type - broaden to include all visual media with URLs
                      const isVisualType = !['table', 'podcast', 'leadform', 'vibe'].includes(asset.type);
                      const hasResolvedUrl = !!(asset.url || (asset.data as any)?.url || (asset.data as any)?.uri);

                      const isMedia = isVisualType && hasResolvedUrl;

                      // Filter by search
                      if (!mediaPickerSearch.trim()) return isMedia;
                      const searchLower = mediaPickerSearch.toLowerCase();
                      return isMedia && (
                        (asset.title && asset.title.toLowerCase().includes(searchLower)) ||
                        (asset.description && asset.description.toLowerCase().includes(searchLower))
                      );
                    });

                  if (mediaAssets.length === 0) {
                    return (
                      <div className="text-center py-12">
                        <p className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                          No media assets available
                        </p>
                      </div>
                    );
                  }

                  return (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                      {mediaAssets.map((asset) => {
                        const mediaUrl = asset.url || asset.data?.imageUrl || asset.data?.videoUrl;
                        if (!mediaUrl) return null;
                        const isSelected = selectedWebsiteAssetIds.includes(asset.id);
                        const isVideo = asset.type === 'video' || asset.type.startsWith('video/');

                        return (
                          <button
                            key={asset.id}
                            onClick={() => {
                              setSelectedWebsiteAssetIds(prev =>
                                prev.includes(asset.id) ? prev.filter(id => id !== asset.id) : [...prev, asset.id]
                              );
                            }}
                            className={`group relative aspect-square rounded-xl overflow-hidden border-2 transition-all ${isSelected ? 'border-[#0071e3] ring-2 ring-[#0071e3]/30' : isDarkMode ? 'border-[#3d3d3f] hover:border-[#0071e3]' : 'border-gray-200 hover:border-[#0071e3]'}`}
                          >
                            {isVideo ? (
                              <video src={mediaUrl} className="w-full h-full object-cover" muted />
                            ) : (
                              <img src={mediaUrl} alt={asset.title} className="w-full h-full object-cover transition-transform group-hover:scale-105" />
                            )}
                            {isVideo && (
                              <div className="absolute top-2 left-2 bg-black/60 text-white rounded-full px-2 py-1 text-[10px] font-medium">VIDEO</div>
                            )}
                            {isSelected && (
                              <div className="absolute top-2 right-2 bg-[#0071e3] text-white rounded-full w-6 h-6 flex items-center justify-center">
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                </svg>
                              </div>
                            )}
                            {asset.title && (
                              <div className={`absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t ${isDarkMode ? 'from-black/80' : 'from-gray-900/80'}`}>
                                <p className="text-xs text-white font-medium truncate">{asset.title}</p>
                              </div>
                            )}
                          </button>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>
            </div>
          </div>
        )
      }

      {/* AI Website Edit Diff Preview Modal */}
      {
        editDiffHtml && createPortal(
          <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
            <div className={`w-full max-w-6xl max-h-[90vh] flex flex-col rounded-2xl overflow-hidden shadow-2xl ${isDarkMode ? 'bg-[#1c1c1e] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}>
              {/* Header */}
              <div className={`px-6 py-4 border-b flex items-center justify-between ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                <div>
                  <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>Review Changes</h3>
                  {editSummary && <p className={`text-sm mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-500'}`}>{editSummary}</p>}
                </div>
                <button
                  onClick={() => {
                    if (selectedForm) handleRejectLeadFormEdit();
                    else handleRejectWebsiteEdit();
                  }}
                  className={`p-2 rounded-full ${isDarkMode ? 'hover:bg-white/10' : 'hover:bg-gray-100'}`}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              {/* Diff Content */}
              <div className="flex-1 overflow-auto p-4">
                <style>{`
                  .diff2html-wrapper .d2h-file-wrapper {
                      border: 1px solid ${isDarkMode ? '#3d3d3f' : '#e5e7eb'};
                      border-radius: 0.75rem;
                      background-color: ${isDarkMode ? '#1c1c1e' : '#ffffff'};
                      margin-bottom: 0;
                      overflow: hidden;
                      overflow-x: auto;
                      box-shadow: ${isDarkMode ? 'none' : '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)'};
                  }
                  .diff2html-wrapper .d2h-files-diff {
                      display: block;
                      width: 100%;
                      overflow-x: auto;
                  }
                  .diff2html-wrapper .d2h-file-header {
                      background-color: ${isDarkMode ? '#2c2c2e' : '#f9fafb'};
                      border-bottom: 1px solid ${isDarkMode ? '#3d3d3f' : '#e5e7eb'};
                      color: ${isDarkMode ? '#e5e5ea' : '#1f2937'};
                      padding: 0.75rem 1rem;
                  }
                  .diff2html-wrapper .d2h-file-name-wrapper {
                      color: ${isDarkMode ? '#e5e5ea' : '#1f2937'};
                      font-weight: 600;
                      font-size: 0.875rem;
                      display: flex;
                      align-items: center;
                  }
                  .diff2html-wrapper .d2h-file-stats {
                      display: none;
                  }
                  .diff2html-wrapper .d2h-diff-table {
                      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
                      font-size: 12px;
                  }
                  .diff2html-wrapper .d2h-code-line-ctn {
                      color: ${isDarkMode ? '#e5e5ea' : '#1f2937'};
                  }
                  .diff2html-wrapper .d2h-code-side-line {
                      padding: 0 8px;
                  }
                  .diff2html-wrapper .d2h-code-side-emptyplaceholder {
                      background-color: ${isDarkMode ? '#151516' : '#f9fafb'};
                      border-color: ${isDarkMode ? '#3d3d3f' : '#e5e7eb'};
                  }
                  .diff2html-wrapper .d2h-code-line-prefix {
                      color: ${isDarkMode ? '#86868b' : '#9ca3af'};
                      padding-right: 8px;
                  }
                  .diff2html-wrapper .d2h-code-linenumber {
                      background-color: ${isDarkMode ? '#2c2c2e' : '#f9fafb'};
                      border-color: ${isDarkMode ? '#3d3d3f' : '#e5e7eb'};
                      color: ${isDarkMode ? '#86868b' : '#9ca3af'};
                  }
                  /* Insertions */
                  .diff2html-wrapper .d2h-ins {
                      background-color: ${isDarkMode ? 'rgba(48, 209, 88, 0.15)' : '#dcfce7'};
                      border-color: ${isDarkMode ? 'rgba(48, 209, 88, 0.3)' : '#86efac'};
                  }
                  .diff2html-wrapper .d2h-code-side-line.d2h-ins {
                    background-color: ${isDarkMode ? 'rgba(48, 209, 88, 0.1)' : '#f0fdf4'};
                  }
                  /* Deletions */
                  .diff2html-wrapper .d2h-del {
                      background-color: ${isDarkMode ? 'rgba(255, 69, 58, 0.15)' : '#fee2e2'};
                      border-color: ${isDarkMode ? 'rgba(255, 69, 58, 0.3)' : '#fca5a5'};
                  }
                  .diff2html-wrapper .d2h-code-side-line.d2h-del {
                    background-color: ${isDarkMode ? 'rgba(255, 69, 58, 0.1)' : '#fef2f2'};
                  }
                  
                  .diff2html-wrapper .d2h-code-line del, .diff2html-wrapper .d2h-code-line ins {
                      background-color: transparent;
                      font-weight: 600;
                      text-decoration: none;
                  }
                  .diff2html-wrapper .d2h-info {
                      background-color: ${isDarkMode ? '#2c2c2e' : '#f3f4f6'};
                      border-color: ${isDarkMode ? '#3d3d3f' : '#e5e7eb'};
                      color: ${isDarkMode ? '#86868b' : '#6b7280'};
                  }
                  .diff2html-wrapper .d2h-icon {
                    display: none;
                  }
                `}</style>
                <div
                  className="diff2html-wrapper text-xs"
                  dangerouslySetInnerHTML={{ __html: editDiffHtml }}
                />
              </div>

              {/* Footer with Accept/Reject */}
              <div className={`px-6 py-4 border-t flex justify-end gap-3 ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
                <button
                  onClick={() => {
                    if (selectedForm) handleRejectLeadFormEdit();
                    else handleRejectWebsiteEdit();
                  }}
                  className={`px-5 py-2.5 rounded-xl text-sm font-medium ${isDarkMode ? 'bg-white/5 text-[#86868b] hover:bg-white/10' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                >
                  Reject Changes
                </button>
                <button
                  onClick={() => {
                    if (selectedForm) {
                      handleAcceptLeadFormEdit(selectedForm);
                    } else {
                      // Find the asset to update
                      const websiteAssets = [...localProjectWebsites, ...(project.researchSessions?.flatMap(s => s.websiteVersions?.map(w => ({ id: w.id, type: 'website' as const, title: w.description, data: w, researchId: s.id, researchTopic: s.topic, timestamp: w.timestamp })) || []) || [])];
                      const targetAsset = websiteAssets.find(a => (a.data as SavedWebsiteVersion)?.html && pendingEditHtml);
                      if (targetAsset) handleAcceptWebsiteEdit(targetAsset);
                    }
                  }}
                  className="px-5 py-2.5 rounded-xl text-sm font-semibold bg-green-600 text-white hover:bg-green-700 shadow-lg shadow-green-600/20"
                >
                   Accept Changes
                </button>
              </div>
            </div>
          </div>,
          document.body
        )
      }


      {/* Dedicated Luma Video Asset Picker Modal */}
      {isLumaVideoPickerOpen && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
          onClick={() => {
            setIsLumaVideoPickerOpen(false);
            setLumaVideoAssetSearch('');
          }}
        >
          <div
            className={`w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden ${isDarkMode ? 'bg-[#1d1d1f] border border-[#3d3d3f]' : 'bg-white border border-gray-200'}`}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className={`px-6 py-4 border-b ${isDarkMode ? 'border-[#3d3d3f]' : 'border-gray-200'}`}>
              <div className="flex items-center justify-between">
                <div>
                  <h3 className={`text-lg font-semibold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>
                    Select Luma Source Video
                  </h3>
                  <p className={`text-xs mt-1 ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                    Choose a video from your project assets to modify.
                  </p>
                </div>
                <button
                  onClick={() => {
                    setIsLumaVideoPickerOpen(false);
                    setLumaVideoAssetSearch('');
                  }}
                  className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-white/10 text-[#86868b]' : 'hover:bg-gray-100 text-gray-500'}`}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              {/* Search */}
              <div className="mt-3">
                <input
                  type="text"
                  value={lumaVideoAssetSearch}
                  onChange={(e) => setLumaVideoAssetSearch(e.target.value)}
                  placeholder="Search videos..."
                  className={`w-full text-sm rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0071e3] ${isDarkMode
                    ? 'bg-[#111111] border border-[#3d3d3f]/60 text-white placeholder:text-[#636366]'
                    : 'bg-gray-50 border border-gray-200 text-gray-900 placeholder:text-gray-500'
                    }`}
                />
              </div>
            </div>

            {/* Content */}
            <div className="p-6 overflow-y-auto max-h-[calc(80vh-200px)]">
              {(() => {
                const videoAssets = assetsBySession
                  .flatMap((session) => session.assets)
                  .filter((asset) => {
                    // Filter ensuring it's a video
                    if (asset.type !== 'video' && !asset.type.startsWith('video/')) {
                      return false;
                    }
                    if (lumaVideoAssetSearch.trim()) {
                      const query = lumaVideoAssetSearch.toLowerCase();
                      const title = (asset.title || '').toLowerCase();
                      const desc = (asset.description || '').toLowerCase();
                      return title.includes(query) || desc.includes(query);
                    }
                    return true;
                  });

                if (videoAssets.length === 0) {
                  return (
                    <div className="text-center py-12">
                      <p className={`text-sm ${isDarkMode ? 'text-[#86868b]' : 'text-gray-600'}`}>
                        {lumaVideoAssetSearch ? 'No videos found matching your search' : 'No video assets available'}
                      </p>
                    </div>
                  );
                }

                return (
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    {videoAssets.map((asset) => {
                      const videoUrl = asset.url || asset.data?.videoUrl;
                      if (!videoUrl) return null;

                      return (
                        <button
                          key={asset.id}
                          onClick={async () => {
                            setIsLoadingLumaVideoAsset(true);
                            try {
                              const res = await fetch(videoUrl);
                              const blob = await res.blob();
                              const ext = (blob.type || '').includes('quicktime') ? 'mov' : 'mp4';
                              const fileName = `${asset.title || 'video'}-${Date.now()}.${ext}`;
                              const file = new File([blob], fileName, { type: blob.type || 'video/mp4' });

                              setLumaVideoFile(file);
                              setLumaVideoAssetId(asset.id);
                              setLumaVideoTitle(asset.title || file.name);
                              setLumaVideoPreviewUrl(videoUrl); // Use URL directly for preview
                              setIsLumaVideoPickerOpen(false);
                              setLumaVideoAssetSearch('');
                            } catch (error) {
                              console.error('Failed to load video asset:', error);
                            } finally {
                              setIsLoadingLumaVideoAsset(false);
                            }
                          }}
                          className={`group relative aspect-video rounded-xl overflow-hidden border text-left transition-all ${isDarkMode ? 'border-[#3d3d3f] hover:border-[#636366]' : 'border-gray-200 hover:border-gray-300'
                            }`}
                          title={asset.title}
                          disabled={isLoadingLumaVideoAsset}
                        >
                          <div className={`w-full h-full bg-black flex items-center justify-center`}>
                            <video
                              src={videoUrl}
                              className="w-full h-full object-contain pointer-events-none"
                            />
                          </div>
                          <div className={`absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t ${isDarkMode ? 'from-black/80' : 'from-gray-900/80'}`}>
                            <p className="text-xs text-white font-medium truncate">{asset.title}</p>
                          </div>
                          {isLoadingLumaVideoAsset && (
                            <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                              <svg className="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                              </svg>
                            </div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                );
              })()}
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default ProjectAssets;
